<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `src/db/mod.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>mod.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../../normalize.css"><link rel="stylesheet" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../../ayu.css" disabled><link rel="stylesheet" href="../../../dark.css" disabled><link rel="stylesheet" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script defer src="../../../source-script.js"></script><script defer src="../../../source-files.js"></script><script defer src="../../../main.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../goatns/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../goatns/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../goatns/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="example-wrap"><pre class="line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
<span id="597">597</span>
<span id="598">598</span>
<span id="599">599</span>
<span id="600">600</span>
<span id="601">601</span>
<span id="602">602</span>
<span id="603">603</span>
<span id="604">604</span>
<span id="605">605</span>
<span id="606">606</span>
<span id="607">607</span>
<span id="608">608</span>
<span id="609">609</span>
<span id="610">610</span>
<span id="611">611</span>
<span id="612">612</span>
<span id="613">613</span>
<span id="614">614</span>
<span id="615">615</span>
<span id="616">616</span>
<span id="617">617</span>
<span id="618">618</span>
<span id="619">619</span>
<span id="620">620</span>
<span id="621">621</span>
<span id="622">622</span>
<span id="623">623</span>
<span id="624">624</span>
<span id="625">625</span>
<span id="626">626</span>
<span id="627">627</span>
<span id="628">628</span>
<span id="629">629</span>
<span id="630">630</span>
<span id="631">631</span>
<span id="632">632</span>
<span id="633">633</span>
<span id="634">634</span>
<span id="635">635</span>
<span id="636">636</span>
<span id="637">637</span>
<span id="638">638</span>
<span id="639">639</span>
<span id="640">640</span>
<span id="641">641</span>
<span id="642">642</span>
<span id="643">643</span>
<span id="644">644</span>
<span id="645">645</span>
<span id="646">646</span>
<span id="647">647</span>
<span id="648">648</span>
<span id="649">649</span>
<span id="650">650</span>
<span id="651">651</span>
<span id="652">652</span>
<span id="653">653</span>
<span id="654">654</span>
<span id="655">655</span>
<span id="656">656</span>
<span id="657">657</span>
<span id="658">658</span>
<span id="659">659</span>
<span id="660">660</span>
<span id="661">661</span>
<span id="662">662</span>
<span id="663">663</span>
<span id="664">664</span>
<span id="665">665</span>
<span id="666">666</span>
<span id="667">667</span>
<span id="668">668</span>
<span id="669">669</span>
<span id="670">670</span>
<span id="671">671</span>
<span id="672">672</span>
<span id="673">673</span>
<span id="674">674</span>
<span id="675">675</span>
<span id="676">676</span>
<span id="677">677</span>
<span id="678">678</span>
<span id="679">679</span>
<span id="680">680</span>
<span id="681">681</span>
<span id="682">682</span>
<span id="683">683</span>
<span id="684">684</span>
<span id="685">685</span>
<span id="686">686</span>
<span id="687">687</span>
<span id="688">688</span>
<span id="689">689</span>
<span id="690">690</span>
<span id="691">691</span>
<span id="692">692</span>
<span id="693">693</span>
<span id="694">694</span>
<span id="695">695</span>
<span id="696">696</span>
<span id="697">697</span>
<span id="698">698</span>
<span id="699">699</span>
<span id="700">700</span>
<span id="701">701</span>
<span id="702">702</span>
<span id="703">703</span>
<span id="704">704</span>
<span id="705">705</span>
<span id="706">706</span>
<span id="707">707</span>
<span id="708">708</span>
<span id="709">709</span>
<span id="710">710</span>
<span id="711">711</span>
<span id="712">712</span>
<span id="713">713</span>
<span id="714">714</span>
<span id="715">715</span>
<span id="716">716</span>
<span id="717">717</span>
<span id="718">718</span>
<span id="719">719</span>
<span id="720">720</span>
<span id="721">721</span>
<span id="722">722</span>
<span id="723">723</span>
<span id="724">724</span>
<span id="725">725</span>
<span id="726">726</span>
<span id="727">727</span>
<span id="728">728</span>
<span id="729">729</span>
<span id="730">730</span>
<span id="731">731</span>
<span id="732">732</span>
<span id="733">733</span>
<span id="734">734</span>
<span id="735">735</span>
<span id="736">736</span>
<span id="737">737</span>
<span id="738">738</span>
<span id="739">739</span>
<span id="740">740</span>
<span id="741">741</span>
<span id="742">742</span>
<span id="743">743</span>
<span id="744">744</span>
<span id="745">745</span>
<span id="746">746</span>
<span id="747">747</span>
<span id="748">748</span>
<span id="749">749</span>
<span id="750">750</span>
<span id="751">751</span>
<span id="752">752</span>
<span id="753">753</span>
<span id="754">754</span>
<span id="755">755</span>
<span id="756">756</span>
<span id="757">757</span>
<span id="758">758</span>
<span id="759">759</span>
<span id="760">760</span>
<span id="761">761</span>
<span id="762">762</span>
<span id="763">763</span>
<span id="764">764</span>
<span id="765">765</span>
<span id="766">766</span>
<span id="767">767</span>
<span id="768">768</span>
<span id="769">769</span>
<span id="770">770</span>
<span id="771">771</span>
<span id="772">772</span>
<span id="773">773</span>
<span id="774">774</span>
<span id="775">775</span>
<span id="776">776</span>
<span id="777">777</span>
<span id="778">778</span>
<span id="779">779</span>
<span id="780">780</span>
<span id="781">781</span>
<span id="782">782</span>
<span id="783">783</span>
<span id="784">784</span>
<span id="785">785</span>
<span id="786">786</span>
<span id="787">787</span>
<span id="788">788</span>
<span id="789">789</span>
<span id="790">790</span>
<span id="791">791</span>
<span id="792">792</span>
<span id="793">793</span>
<span id="794">794</span>
<span id="795">795</span>
<span id="796">796</span>
<span id="797">797</span>
<span id="798">798</span>
<span id="799">799</span>
<span id="800">800</span>
<span id="801">801</span>
<span id="802">802</span>
<span id="803">803</span>
<span id="804">804</span>
<span id="805">805</span>
<span id="806">806</span>
<span id="807">807</span>
<span id="808">808</span>
<span id="809">809</span>
<span id="810">810</span>
<span id="811">811</span>
<span id="812">812</span>
<span id="813">813</span>
<span id="814">814</span>
<span id="815">815</span>
<span id="816">816</span>
<span id="817">817</span>
<span id="818">818</span>
<span id="819">819</span>
<span id="820">820</span>
<span id="821">821</span>
<span id="822">822</span>
<span id="823">823</span>
<span id="824">824</span>
<span id="825">825</span>
<span id="826">826</span>
<span id="827">827</span>
<span id="828">828</span>
<span id="829">829</span>
<span id="830">830</span>
<span id="831">831</span>
<span id="832">832</span>
<span id="833">833</span>
<span id="834">834</span>
<span id="835">835</span>
<span id="836">836</span>
<span id="837">837</span>
<span id="838">838</span>
<span id="839">839</span>
<span id="840">840</span>
<span id="841">841</span>
<span id="842">842</span>
<span id="843">843</span>
<span id="844">844</span>
<span id="845">845</span>
<span id="846">846</span>
<span id="847">847</span>
<span id="848">848</span>
<span id="849">849</span>
<span id="850">850</span>
<span id="851">851</span>
<span id="852">852</span>
<span id="853">853</span>
<span id="854">854</span>
<span id="855">855</span>
<span id="856">856</span>
<span id="857">857</span>
<span id="858">858</span>
<span id="859">859</span>
<span id="860">860</span>
<span id="861">861</span>
<span id="862">862</span>
<span id="863">863</span>
<span id="864">864</span>
<span id="865">865</span>
<span id="866">866</span>
<span id="867">867</span>
<span id="868">868</span>
<span id="869">869</span>
<span id="870">870</span>
<span id="871">871</span>
<span id="872">872</span>
<span id="873">873</span>
<span id="874">874</span>
</pre><pre class="rust"><code><span class="kw">use </span>std::str::FromStr;
<span class="kw">use </span>std::time::Duration;

<span class="kw">use </span><span class="kw">crate</span>::config::ConfigFile;
<span class="kw">use </span><span class="kw">crate</span>::enums::{RecordClass, RecordType};

<span class="kw">use </span><span class="kw">crate</span>::resourcerecord::InternalResourceRecord;
<span class="kw">use </span><span class="kw">crate</span>::zones::{FileZone, FileZoneRecord};
<span class="kw">use </span>async_trait::async_trait;

<span class="kw">use </span>serde::{Deserialize, Serialize};
<span class="kw">use </span>sqlx::pool::PoolConnection;
<span class="kw">use </span>sqlx::sqlite::{SqliteArguments, SqliteConnectOptions, SqliteRow};
<span class="kw">use </span>sqlx::{Arguments, ConnectOptions, Connection, Pool, Row, Sqlite, SqlitePool, Transaction};

<span class="attribute">#[cfg(test)]
</span><span class="kw">mod </span>test;

<span class="kw">const </span>SQL_VIEW_RECORDS: <span class="kw-2">&amp;</span>str = <span class="string">&quot;records_merged&quot;</span>;

<span class="kw">pub async fn </span>get_conn(config: <span class="kw-2">&amp;</span>ConfigFile) -&gt; <span class="prelude-ty">Result</span>&lt;Pool&lt;Sqlite&gt;, String&gt; {
    <span class="kw">let </span>db_path: <span class="kw-2">&amp;</span>str = <span class="kw-2">&amp;</span>shellexpand::full(<span class="kw-2">&amp;</span>config.sqlite_path).unwrap();
    <span class="kw">let </span>db_url = <span class="macro">format!</span>(<span class="string">&quot;sqlite://{db_path}?mode=rwc&quot;</span>);
    <span class="macro">log::debug!</span>(<span class="string">&quot;Opening Database: {db_url}&quot;</span>);

    <span class="kw">let </span><span class="kw-2">mut </span>options = <span class="kw">match </span>SqliteConnectOptions::from_str(<span class="kw-2">&amp;</span>db_url) {
        <span class="prelude-val">Ok</span>(value) =&gt; value,
        <span class="prelude-val">Err</span>(error) =&gt; <span class="kw">return </span><span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;connection failed: {error:?}&quot;</span>)),
    };
    options.log_statements(log::LevelFilter::Trace);
    <span class="comment">// log anything that takes longer than 1s
    // TODO: make this configurable
    </span>options.log_slow_statements(log::LevelFilter::Warn, Duration::from_secs(<span class="number">1</span>));

    <span class="kw">match </span>SqlitePool::connect_with(options).<span class="kw">await </span>{
        <span class="prelude-val">Ok</span>(value) =&gt; <span class="prelude-val">Ok</span>(value),
        <span class="prelude-val">Err</span>(err) =&gt; <span class="prelude-val">Err</span>(<span class="macro">format!</span>(<span class="string">&quot;Error opening SQLite DB ({db_url:?}): {err:?}&quot;</span>)),
    }
}

<span class="doccomment">/// Do the basic setup and checks (if we write any)
</span><span class="kw">pub async fn </span>start_db(pool: <span class="kw-2">&amp;</span>SqlitePool) -&gt; <span class="prelude-ty">Result</span>&lt;(), sqlx::Error&gt; {
    create_zones_table(pool).<span class="kw">await</span><span class="question-mark">?</span>;
    create_users_table(pool).<span class="kw">await</span><span class="question-mark">?</span>;
    create_records_table(pool).<span class="kw">await</span><span class="question-mark">?</span>;
    create_ownership_table(pool).<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="macro">log::info!</span>(<span class="string">&quot;Completed DB Startup!&quot;</span>);
    <span class="prelude-val">Ok</span>(())
}

<span class="kw">pub async fn </span>create_users_table(pool: <span class="kw-2">&amp;</span>SqlitePool) -&gt; <span class="prelude-ty">Result</span>&lt;(), sqlx::Error&gt; {
    <span class="macro">log::info!</span>(<span class="string">&quot;Ensuring DB Users table exists&quot;</span>);
    sqlx::query(
        <span class="string">r#&quot;CREATE TABLE IF NOT EXISTS
        users (
            id  INTEGER PRIMARY KEY,
            username TEXT NOT NULL,
            email TEXT NOT NULL,
            disabled BOOL NOT NULL
        )&quot;#</span>,
    )
    .execute(<span class="kw-2">&amp;mut </span>pool.acquire().<span class="kw">await</span><span class="question-mark">?</span>)
    .<span class="kw">await</span><span class="question-mark">?</span>;

    sqlx::query(
        <span class="string">&quot;CREATE UNIQUE INDEX IF NOT EXISTS
        ind_users_fields
        ON users ( username, email )&quot;</span>,
    )
    .execute(<span class="kw-2">&amp;mut </span>pool.acquire().<span class="kw">await</span><span class="question-mark">?</span>)
    .<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="prelude-val">Ok</span>(())
}

<span class="attribute">#[derive(Clone, Deserialize, Serialize, Debug, Default)]
</span><span class="kw">pub struct </span>User {
    <span class="attribute">#[serde(default)]
    </span><span class="kw">pub </span>id: u64,
    <span class="kw">pub </span>username: String,
    <span class="kw">pub </span>email: String,
    <span class="attribute">#[serde(default)]
    </span><span class="kw">pub </span>owned_zones: Vec&lt;u64&gt;,
}

<span class="kw">impl </span>User {
    <span class="attribute">#[allow(dead_code, unused_variables)]
    </span><span class="kw">pub async fn </span>create(<span class="kw-2">&amp;</span><span class="self">self</span>, pool: <span class="kw-2">&amp;</span>SqlitePool) -&gt; <span class="prelude-ty">Result</span>&lt;usize, sqlx::Error&gt; {
        <span class="comment">// TODO: test user create
        </span><span class="kw">let </span>res = sqlx::query(<span class="string">&quot;INSERT into users (username, email, disabled) VALUES(?, ?, ?)&quot;</span>)
            .bind(<span class="kw-2">&amp;</span><span class="self">self</span>.username)
            .bind(<span class="kw-2">&amp;</span><span class="self">self</span>.email)
            .bind(<span class="bool-val">false</span>)
            .execute(<span class="kw-2">&amp;mut </span>pool.acquire().<span class="kw">await</span><span class="question-mark">?</span>)
            .<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(<span class="number">1</span>)
    }
    <span class="attribute">#[allow(dead_code, unused_variables)]
    </span><span class="kw">pub async fn </span>delete(<span class="kw-2">&amp;</span><span class="self">self</span>, pool: <span class="kw-2">&amp;</span>SqlitePool) -&gt; <span class="prelude-ty">Result</span>&lt;(), sqlx::Error&gt; {
        <span class="comment">// TODO: test user delete
        </span><span class="kw">let </span><span class="kw-2">mut </span>txn = pool.begin().<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="kw">let </span>res = sqlx::query(<span class="string">&quot;DELETE FROM ownership WHERE userid = ?&quot;</span>)
            .bind(<span class="self">self</span>.id <span class="kw">as </span>i64)
            .execute(<span class="kw-2">&amp;mut *</span>txn)
            .<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="kw">let </span>res = sqlx::query(<span class="string">&quot;DELETE FROM users WHERE id = ?&quot;</span>)
            .bind(<span class="self">self</span>.id <span class="kw">as </span>i64)
            .execute(<span class="kw-2">&amp;mut *</span>txn)
            .<span class="kw">await</span><span class="question-mark">?</span>;

        txn.commit().<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(())
    }
}

<span class="attribute">#[derive(Deserialize, Serialize, Debug)]
</span><span class="kw">pub struct </span>ZoneOwnership {
    <span class="attribute">#[serde(default)]
    </span>id: u64,
    <span class="kw">pub </span>userid: u64,
    <span class="kw">pub </span>zoneid: u64,
}

<span class="kw">impl </span>ZoneOwnership {
    <span class="attribute">#[allow(dead_code, unused_variables)]
    </span><span class="kw">pub async fn </span>create(<span class="kw-2">&amp;</span><span class="self">self</span>, pool: <span class="kw-2">&amp;</span>SqlitePool) -&gt; <span class="prelude-ty">Result</span>&lt;(), sqlx::Error&gt; {
        <span class="comment">// TODO: test ownership create
        </span>sqlx::query(
            <span class="string">&quot;INSERT INTO ownership (zoneid, userid) VALUES ( ?, ? ) ON CONFLICT DO NOTHING&quot;</span>,
        )
        .bind(<span class="self">self</span>.zoneid <span class="kw">as </span>i64)
        .bind(<span class="self">self</span>.userid <span class="kw">as </span>i64)
        .execute(<span class="kw-2">&amp;mut </span>pool.acquire().<span class="kw">await</span><span class="question-mark">?</span>)
        .<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(())
    }
    <span class="attribute">#[allow(dead_code, unused_variables)]
    </span><span class="kw">pub async fn </span>delete(<span class="kw-2">&amp;</span><span class="self">self</span>, pool: <span class="kw-2">&amp;</span>SqlitePool) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt; {
        <span class="comment">// TODO: test ownership delete
        </span><span class="kw">let </span>res = sqlx::query(<span class="string">&quot;DELETE FROM ownership WHERE zoneid = ? AND userid = ?&quot;</span>)
            .bind(<span class="self">self</span>.zoneid <span class="kw">as </span>i64)
            .bind(<span class="self">self</span>.userid <span class="kw">as </span>i64)
            .execute(<span class="kw-2">&amp;mut </span>pool.acquire().<span class="kw">await</span><span class="question-mark">?</span>)
            .<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(res.rows_affected())
    }
    <span class="attribute">#[allow(dead_code, unused_variables)]
    </span><span class="kw">pub async fn </span>delete_for_user(<span class="self">self</span>, pool: <span class="kw-2">&amp;</span>SqlitePool) -&gt; <span class="prelude-ty">Result</span>&lt;User, sqlx::Error&gt; {
        <span class="comment">// TODO: test user delete
        // TODO: delete all ownership records
        </span><span class="macro">todo!</span>();
    }
}

<span class="kw">pub async fn </span>create_ownership_table(pool: <span class="kw-2">&amp;</span>SqlitePool) -&gt; <span class="prelude-ty">Result</span>&lt;(), sqlx::Error&gt; {
    <span class="kw">let </span><span class="kw-2">mut </span>tx = pool.begin().<span class="kw">await</span>.unwrap();

    <span class="attribute">#[cfg(test)]
    </span><span class="macro">eprintln!</span>(<span class="string">&quot;Ensuring DB Ownership table exists&quot;</span>);
    <span class="macro">log::info!</span>(<span class="string">&quot;Ensuring DB Ownership table exists&quot;</span>);
    sqlx::query(
        <span class="string">r#&quot;CREATE TABLE IF NOT EXISTS
        ownership (
            id   INTEGER PRIMARY KEY,
            zoneid INTEGER NOT NULL,
            userid INTEGER NOT NULL,
            FOREIGN KEY(zoneid) REFERENCES zones(id),
            FOREIGN KEY(userid) REFERENCES users(id)
        )&quot;#</span>,
    )
    .execute(<span class="kw-2">&amp;mut </span>tx)
    .<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="attribute">#[cfg(test)]
    </span><span class="macro">eprintln!</span>(<span class="string">&quot;Ensuring DB Ownership index exists&quot;</span>);
    sqlx::query(
        <span class="string">&quot;CREATE UNIQUE INDEX
        IF NOT EXISTS
        ind_ownership
        ON ownership (
            zoneid,
            userid
        )&quot;</span>,
    )
    .execute(<span class="kw-2">&amp;mut </span>tx)
    .<span class="kw">await</span><span class="question-mark">?</span>;

    tx.commit().<span class="kw">await
</span>}

<span class="kw">pub async fn </span>create_zones_table(pool: <span class="kw-2">&amp;</span>SqlitePool) -&gt; <span class="prelude-ty">Result</span>&lt;(), sqlx::Error&gt; {
    <span class="kw">let </span><span class="kw-2">mut </span>tx = pool.begin().<span class="kw">await</span>.unwrap();

    <span class="macro">log::info!</span>(<span class="string">&quot;Ensuring DB Zones table exists&quot;</span>);
    sqlx::query(
        <span class="string">r#&quot;CREATE TABLE IF NOT EXISTS
        zones (
            id   INTEGER PRIMARY KEY,
            name TEXT NOT NULL,
            rname TEXT NOT NULL,
            serial INTEGER NOT NULL,
            refresh INTEGER NOT NULL,
            retry INTEGER NOT NULL,
            expire INTEGER NOT NULL,
            minimum INTEGER NOT NULL
        )&quot;#</span>,
    )
    .execute(<span class="kw-2">&amp;mut </span>tx)
    .<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="comment">// .execute(tx).await;
    </span><span class="macro">log::info!</span>(<span class="string">&quot;Ensuring DB Records index exists&quot;</span>);
    sqlx::query(
        <span class="string">&quot;CREATE UNIQUE INDEX
        IF NOT EXISTS
        ind_zones
        ON zones (
            id,name
        )&quot;</span>,
    )
    .execute(<span class="kw-2">&amp;mut </span>tx)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    tx.commit().<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(())
}

<span class="kw">pub async fn </span>create_records_table(pool: <span class="kw-2">&amp;</span>SqlitePool) -&gt; <span class="prelude-ty">Result</span>&lt;(), sqlx::Error&gt; {
    <span class="macro">log::info!</span>(<span class="string">&quot;Ensuring DB Records table exists&quot;</span>);

    <span class="kw">let </span><span class="kw-2">mut </span>tx = pool.begin().<span class="kw">await</span>.unwrap();

    sqlx::query(
        <span class="string">&quot;CREATE TABLE IF NOT EXISTS
        records (
            id      INTEGER PRIMARY KEY,
            zoneid  INTEGER NOT NULL,
            name    TEXT, /* this can be null for apex records */
            ttl     INTEGER,
            rrtype  INTEGER NOT NULL,
            rclass  INTEGER NOT NULL,
            rdata   TEXT NOT NULL,
            FOREIGN KEY(zoneid) REFERENCES zones(id)
        )&quot;</span>,
    )
    .execute(<span class="kw-2">&amp;mut </span>tx)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="macro">log::info!</span>(<span class="string">&quot;Ensuring DB Records index exists&quot;</span>);
    sqlx::query(
        <span class="string">&quot;CREATE UNIQUE INDEX
        IF NOT EXISTS
        ind_records
        ON records (
            id,zoneid,name,rrtype,rclass
        )&quot;</span>,
    )
    .execute(<span class="kw-2">&amp;mut </span>tx)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="macro">log::info!</span>(<span class="string">&quot;Ensuring DB Records view exists&quot;</span>);
    <span class="comment">// this view lets us query based on the full name
    </span>sqlx::query(
        <span class="kw-2">&amp;</span><span class="macro">format!</span>(<span class="string">&quot;CREATE VIEW IF NOT EXISTS {} ( record_id, zone_id, rrtype, rclass, rdata, name, ttl ) as
        SELECT records.id as record_id, zones.id as zone_id, records.rrtype, records.rclass ,records.rdata,
        CASE
            WHEN records.name is NULL THEN zones.name
            ELSE records.name || &#39;.&#39; || zones.name
        END AS name,
        CASE WHEN records.ttl is NULL then zones.minimum
            WHEN records.ttl &gt; zones.minimum THEN records.ttl
            ELSE records.ttl
        END AS ttl
        from records, zones where records.zoneid = zones.id&quot;</span>, SQL_VIEW_RECORDS)
    ).execute(<span class="kw-2">&amp;mut </span>tx).<span class="kw">await</span><span class="question-mark">?</span>;
    tx.commit().<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(())
}

<span class="comment">// pub async fn create_zone_with_conn(
//     conn: &amp;mut SqliteConnection,
//     zone: FileZone,
// ) -&gt; Result&lt;u64, sqlx::Error&gt; {

//     zone.create
//     let mut args = SqliteArguments::default();
//     let serial = zone.serial.to_string();
//     let refresh = zone.refresh.to_string();
//     let retry = zone.retry.to_string();
//     let expire = zone.expire.to_string();
//     let minimum = zone.minimum.to_string();
//     for arg in [
//         &amp;zone.name,
//         &amp;zone.rname,
//         &amp;serial,
//         &amp;refresh,
//         &amp;retry,
//         &amp;expire,
//         &amp;minimum,
//     ] {
//         args.add(arg);
//     }

//     let result = sqlx::query_with(
//         &quot;INSERT INTO zones (name, rname, serial, refresh, retry, expire, minimum)
//             VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7)&quot;,
//         args,
//     )
//     .execute(conn)
//     .await?;
//     Ok(result.rows_affected())
// }

// /// create a resource record within a zone
// pub async fn create_record(pool: &amp;SqlitePool, record: FileZoneRecord) -&gt; Result&lt;u64, sqlx::Error&gt; {
//     let mut txn = pool.begin().await?;
//     let res = create_record_with_conn(&amp;mut txn, record).await?;
//     txn.commit().await?;
//     Ok(res)
// }

// /// create a resource record within a zone
// pub async fn create_record_with_conn(
//     txn: &amp;mut Transaction&lt;&#39;_, Sqlite&gt;,
//     record: FileZoneRecord,
// ) -&gt; Result&lt;u64, sqlx::Error&gt; {
//     let rclass: u16 = record.class as u16;
//     let rrtype = RecordType::from(record.rrtype);
//     let rrtype = rrtype as u16;

//     let record_name = match record.name.len() {
//         0 =&gt; None,
//         _ =&gt; Some(record.name),
//     };

//     let mut args = SqliteArguments::default();
//     let input_args: Vec&lt;Option&lt;String&gt;&gt; = vec![
//         Some(record.zoneid.to_string()),
//         record_name,
//         Some(record.ttl.to_string()),
//         Some(rrtype.to_string()),
//         Some(rclass.to_string()),
//         Some(record.rdata),
//     ];
//     for arg in input_args {
//         args.add(arg);
//     }
//     let result = sqlx::query_with(
//         &quot;INSERT INTO records (zoneid, name, ttl,rrtype, rclass, rdata)
//                 VALUES (?1, ?2, ?3, ?4, ?5, ?6)&quot;,
//         args,
//     )
//     .execute(&amp;mut *txn)
//     .await?;
//     Ok(result.rows_affected())
// }

</span><span class="doccomment">/// Query the zones table, name_or_id can be the zoneid or the name - if they match then you&#39;re bad and you should feel bacd.
</span><span class="kw">pub async fn </span>get_zone_with_txn(
    txn: <span class="kw-2">&amp;mut </span>Transaction&lt;<span class="lifetime">&#39;_</span>, Sqlite&gt;,
    name_or_id: <span class="kw-2">&amp;</span>str,
) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;FileZone&gt;, sqlx::Error&gt; {
    <span class="comment">// let mut args = SqliteArguments::default();
    // args.add(name);

    </span><span class="kw">let </span>result = sqlx::query(
        <span class="string">&quot;SELECT
        id, name, rname, serial, refresh, retry, expire, minimum
        FROM zones
        WHERE name = ? or id = ? LIMIT 1&quot;</span>,
    )
    .bind(name_or_id)
    .bind(name_or_id)
    .fetch_optional(<span class="kw-2">&amp;mut *</span>txn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="kw">let </span><span class="kw-2">mut </span>zone = <span class="kw">match </span>result {
        <span class="prelude-val">None </span>=&gt; <span class="kw">return </span><span class="prelude-val">Ok</span>(<span class="prelude-val">None</span>),
        <span class="prelude-val">Some</span>(row) =&gt; {
            <span class="kw">let </span>id: i64 = row.get(<span class="number">0</span>);
            <span class="attribute">#[cfg(test)]
            </span><span class="macro">eprintln!</span>(<span class="string">&quot;Building FileZone&quot;</span>);
            FileZone {
                id: id <span class="kw">as </span>u64,
                name: row.get(<span class="number">1</span>),
                rname: row.get(<span class="number">2</span>),
                serial: row.get(<span class="number">3</span>),
                refresh: row.get(<span class="number">4</span>),
                retry: row.get(<span class="number">5</span>),
                expire: row.get(<span class="number">6</span>),
                minimum: row.get(<span class="number">7</span>),
                records: <span class="macro">vec!</span>[],
            }
        }
    };

    <span class="kw">let </span>result = sqlx::query(
        <span class="string">&quot;SELECT
        id, zoneid, name, ttl, rrtype, rclass, rdata
        FROM records
        WHERE zoneid = ?&quot;</span>,
    )
    .bind(zone.id <span class="kw">as </span>i64)
    .fetch_all(<span class="kw-2">&amp;mut *</span>txn)
    .<span class="kw">await</span><span class="question-mark">?</span>;

    zone.records = result
        .into_iter()
        .filter_map(|r| <span class="kw">match </span>FileZoneRecord::try_from(r) {
            <span class="prelude-val">Ok</span>(val) =&gt; <span class="prelude-val">Some</span>(val),
            <span class="prelude-val">Err</span>(<span class="kw">_</span>) =&gt; <span class="prelude-val">None</span>,
        })
        .collect();
    <span class="prelude-val">Ok</span>(<span class="prelude-val">Some</span>(zone))
}

<span class="kw">pub async fn </span>get_zone(pool: <span class="kw-2">&amp;</span>SqlitePool, name: String) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;FileZone&gt;, sqlx::Error&gt; {
    <span class="kw">let </span><span class="kw-2">mut </span>txn = pool.begin().<span class="kw">await</span><span class="question-mark">?</span>;

    get_zone_with_txn(<span class="kw-2">&amp;mut </span>txn, <span class="kw-2">&amp;</span>name).<span class="kw">await
</span>}

<span class="attribute">#[allow(dead_code)]
</span><span class="kw">pub async fn </span>update_zone(pool: <span class="kw-2">&amp;</span>SqlitePool, zone: FileZone) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt; {
    <span class="kw">let </span><span class="kw-2">mut </span>txn = pool.begin().<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="kw">let </span>res = update_zone_with_conn(<span class="kw-2">&amp;mut </span>txn, zone).<span class="kw">await</span><span class="question-mark">?</span>;
    txn.commit().<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="attribute">#[allow(dead_code)]
</span><span class="kw">pub async fn </span>update_zone_with_conn(
    txn: <span class="kw-2">&amp;mut </span>Transaction&lt;<span class="lifetime">&#39;_</span>, Sqlite&gt;,
    zone: FileZone,
) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt; {
    <span class="comment">// let mut tx = pool.begin().await?;

    </span><span class="kw">let </span><span class="kw-2">mut </span>args = SqliteArguments::default();
    args.add(zone.rname);
    args.add(zone.serial);
    args.add(zone.refresh);
    args.add(zone.retry);
    args.add(zone.expire);
    args.add(zone.minimum);
    args.add(zone.id <span class="kw">as </span>i64);

    <span class="kw">let </span>qry = sqlx::query_with(
        <span class="string">&quot;UPDATE zones
        set rname = ?, serial = ?, refresh = ?, retry = ?, expire = ?, minimum =?
        WHERE id = ?&quot;</span>,
        args,
    )
    .execute(<span class="kw-2">&amp;mut *</span>txn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="macro">println!</span>(<span class="string">&quot;Rows updated: {}&quot;</span>, qry.rows_affected());
    <span class="prelude-val">Ok</span>(qry.rows_affected())
}

<span class="kw">impl </span>TryFrom&lt;SqliteRow&gt; <span class="kw">for </span>InternalResourceRecord {
    <span class="kw">type </span>Error = String;
    <span class="kw">fn </span>try_from(row: SqliteRow) -&gt; <span class="prelude-ty">Result</span>&lt;InternalResourceRecord, String&gt; {
        <span class="kw">let </span>record_id: i64 = row.get(<span class="number">0</span>);
        <span class="kw">let </span>zoneid: i64 = row.get(<span class="number">1</span>);
        <span class="kw">let </span>zoneid: u64 = zoneid.try_into().unwrap_or(<span class="number">0</span>);
        <span class="kw">let </span>record_name: String = row.get(<span class="number">2</span>);
        <span class="kw">let </span>record_class: u16 = row.get(<span class="number">3</span>);
        <span class="kw">let </span>record_type: u16 = row.get(<span class="number">4</span>);
        <span class="kw">let </span>rrtype: <span class="kw-2">&amp;</span>str = RecordType::from(<span class="kw-2">&amp;</span>record_type).into();
        <span class="kw">let </span>rdata: String = row.get(<span class="number">5</span>);
        <span class="kw">let </span>ttl: u32 = row.get(<span class="number">6</span>);
        InternalResourceRecord::try_from(FileZoneRecord {
            name: record_name,
            ttl,
            zoneid,
            id: record_id <span class="kw">as </span>u64,
            rrtype: rrtype.to_string(),
            class: RecordClass::from(<span class="kw-2">&amp;</span>record_class),
            rdata,
        })
    }
}

<span class="kw">pub async fn </span>get_records(
    conn: <span class="kw-2">&amp;</span>Pool&lt;Sqlite&gt;,
    name: String,
    rrtype: RecordType,
    rclass: RecordClass,
) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;InternalResourceRecord&gt;, sqlx::Error&gt; {
    <span class="kw">let </span>res = sqlx::query(<span class="kw-2">&amp;</span><span class="macro">format!</span>(
        <span class="string">&quot;SELECT
        record_id, zone_id, name, rclass, rrtype, rdata, ttl
        FROM {}
        WHERE name = ? AND rrtype = ? AND rclass = ?&quot;</span>,
        SQL_VIEW_RECORDS
    ))
    .bind(<span class="kw-2">&amp;</span>name)
    .bind(rrtype <span class="kw">as </span>u16)
    .bind(rclass)
    .fetch_all(<span class="kw-2">&amp;mut </span>conn.acquire().<span class="kw">await</span><span class="question-mark">?</span>)
    .<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="kw">if </span>res.is_empty() {
        <span class="macro">eprintln!</span>(<span class="string">&quot;No results returned for {name} {rrtype} {rclass}&quot;</span>);
        <span class="macro">log::trace!</span>(<span class="string">&quot;No results returned for {name} &quot;</span>);
    }

    <span class="kw">let </span><span class="kw-2">mut </span>results: Vec&lt;InternalResourceRecord&gt; = <span class="macro">vec!</span>[];
    <span class="kw">for </span>row <span class="kw">in </span>res {
        <span class="attribute">#[cfg(test)]
        </span><span class="macro">eprintln!</span>(<span class="string">&quot;Checking row =&gt; IRR&quot;</span>);
        <span class="kw">if let </span><span class="prelude-val">Ok</span>(irr) = InternalResourceRecord::try_from(row) {
            results.push(irr);
        }
    }
    <span class="macro">log::trace!</span>(<span class="string">&quot;results: {results:?}&quot;</span>);
    <span class="prelude-val">Ok</span>(results)
}

<span class="kw">impl </span>FileZone {
    <span class="doccomment">///Hand it a filezone and it&#39;ll update the things
    </span><span class="comment">// pub async fn load_zone(
    //     &amp;self,
    //     mut conn: PoolConnection&lt;Sqlite&gt;,
    // ) -&gt; Result&lt;u64, sqlx::Error&gt; {
    //     let mut txn = conn.begin().await?;
    //     let res = self.create_with_txn(&amp;mut txn).await?;

    //     txn.commit().await?;
    //     Ok(res)
    // }
    </span><span class="kw">pub async fn </span>get_zone_records(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        txn: <span class="kw-2">&amp;mut </span>Transaction&lt;<span class="lifetime">&#39;_</span>, Sqlite&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;FileZoneRecord&gt;, sqlx::Error&gt; {
        <span class="kw">let </span>res = sqlx::query(
            <span class="string">&quot;SELECT
            id, zoneid, name, ttl, rrtype, rclass, rdata
            FROM records
            WHERE zoneid = ?&quot;</span>,
        )
        .bind(<span class="self">self</span>.id <span class="kw">as </span>i64)
        .fetch_all(<span class="kw-2">&amp;mut *</span>txn)
        .<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="kw">if </span>res.is_empty() {
            <span class="macro">log::trace!</span>(<span class="string">&quot;No results returned for zone_id={}&quot;</span>, <span class="self">self</span>.id);
        }

        <span class="kw">let </span><span class="kw-2">mut </span>results: Vec&lt;FileZoneRecord&gt; = <span class="macro">vec!</span>[];
        <span class="kw">for </span>row <span class="kw">in </span>res {
            <span class="kw">if let </span><span class="prelude-val">Ok</span>(irr) = FileZoneRecord::try_from(row) {
                results.push(irr);
            }
        }

        <span class="macro">log::trace!</span>(<span class="string">&quot;results: {results:?}&quot;</span>);
        <span class="prelude-val">Ok</span>(results)
    }
}

<span class="doccomment">/// export a zone!
</span><span class="kw">pub async fn </span>export_zone(
    <span class="kw-2">mut </span>conn: PoolConnection&lt;Sqlite&gt;,
    zone_id: u64,
) -&gt; <span class="prelude-ty">Result</span>&lt;FileZone, sqlx::Error&gt; {
    <span class="attribute">#[cfg(test)]
    </span><span class="macro">println!</span>(<span class="string">&quot;Started export_zone&quot;</span>);
    <span class="kw">let </span><span class="kw-2">mut </span>txn = conn.begin().<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="kw">let </span><span class="kw-2">mut </span>zone = <span class="kw">match </span>get_zone_with_txn(<span class="kw-2">&amp;mut </span>txn, <span class="kw-2">&amp;</span>zone_id.to_string()).<span class="kw">await</span><span class="question-mark">? </span>{
        <span class="prelude-val">None </span>=&gt; {
            <span class="attribute">#[cfg(test)]
            </span><span class="macro">println!</span>(<span class="string">&quot;Couldn&#39;t find zone with id: {zone_id}&quot;</span>);
            <span class="kw">return </span><span class="prelude-val">Err</span>(sqlx::Error::RowNotFound);
        }
        <span class="prelude-val">Some</span>(value) =&gt; value,
    };
    <span class="attribute">#[cfg(test)]
    </span><span class="macro">println!</span>(<span class="string">&quot;Getting zone records...&quot;</span>);
    <span class="kw">let </span>zone_records = zone.get_zone_records(<span class="kw-2">&amp;mut </span>txn).<span class="kw">await</span><span class="question-mark">?</span>;
    zone.records = zone_records;
    <span class="prelude-val">Ok</span>(zone)
}

<span class="kw">pub async fn </span>export_zone_json(
    conn: PoolConnection&lt;Sqlite&gt;,
    zone_id: u64,
) -&gt; <span class="prelude-ty">Result</span>&lt;String, String&gt; {
    <span class="kw">let </span>zone = export_zone(conn, zone_id)
        .<span class="kw">await
        </span>.map_err(|e| <span class="macro">format!</span>(<span class="string">&quot;{e:?}&quot;</span>))<span class="question-mark">?</span>;

    zone.json()
}

<span class="attribute">#[async_trait]
</span><span class="kw">impl </span>DBEntity <span class="kw">for </span>FileZone {
    <span class="kw">fn </span>table_name(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span>str {
        <span class="string">&quot;zones&quot;
    </span>}

    <span class="doccomment">/// save the entity to the database
    </span><span class="kw">async fn </span>save(<span class="kw-2">&amp;</span><span class="self">self</span>, pool: <span class="kw-2">&amp;</span>Pool&lt;Sqlite&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>txn = pool.begin().<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="self">self</span>.save_with_txn(<span class="kw-2">&amp;mut </span>txn).<span class="kw">await</span><span class="question-mark">?</span>;
        txn.commit().<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(<span class="number">1</span>)
    }

    <span class="doccomment">/// save the entity to the database, but you&#39;re in a transaction
    </span><span class="kw">async fn </span>save_with_txn&lt;<span class="lifetime">&#39;t</span>&gt;(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        txn: <span class="kw-2">&amp;mut </span>Transaction&lt;<span class="lifetime">&#39;t</span>, Sqlite&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt; {
        <span class="comment">// check the zone exists
        </span><span class="kw">let </span>find_zone = <span class="kw">match </span>get_zone_with_txn(txn, <span class="kw-2">&amp;</span><span class="self">self</span>.name).<span class="kw">await </span>{
            <span class="prelude-val">Ok</span>(val) =&gt; {
                <span class="macro">log::trace!</span>(<span class="string">&quot;Found existing zone&quot;</span>);
                val
            }
            <span class="prelude-val">Err</span>(err) =&gt; {
                <span class="comment">// failed to query the DB
                </span><span class="kw">return </span><span class="prelude-val">Err</span>(err);
            }
        };

        <span class="kw">let </span>updated_zone: FileZone = <span class="kw">match </span>find_zone {
            <span class="prelude-val">None </span>=&gt; {
                <span class="comment">// if it&#39;s new, add it
                </span><span class="attribute">#[cfg(test)]
                </span><span class="macro">eprintln!</span>(<span class="string">&quot;Creating zone {self:?}&quot;</span>);
                <span class="macro">log::debug!</span>(<span class="string">&quot;Creating zone {self:?}&quot;</span>);

                <span class="comment">// zone.create
                </span><span class="kw">let </span><span class="kw-2">mut </span>args = SqliteArguments::default();
                <span class="kw">let </span>serial = <span class="self">self</span>.serial.to_string();
                <span class="kw">let </span>refresh = <span class="self">self</span>.refresh.to_string();
                <span class="kw">let </span>retry = <span class="self">self</span>.retry.to_string();
                <span class="kw">let </span>expire = <span class="self">self</span>.expire.to_string();
                <span class="kw">let </span>minimum = <span class="self">self</span>.minimum.to_string();
                <span class="kw">for </span>arg <span class="kw">in </span>[
                    <span class="kw-2">&amp;</span><span class="self">self</span>.name,
                    <span class="kw-2">&amp;</span><span class="self">self</span>.rname,
                    <span class="kw-2">&amp;</span>serial,
                    <span class="kw-2">&amp;</span>refresh,
                    <span class="kw-2">&amp;</span>retry,
                    <span class="kw-2">&amp;</span>expire,
                    <span class="kw-2">&amp;</span>minimum,
                ] {
                    args.add(arg);
                }

                sqlx::query_with(
                    <span class="string">&quot;INSERT INTO zones (name, rname, serial, refresh, retry, expire, minimum)
                        VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7)&quot;</span>,
                    args,
                )
                .execute(<span class="kw-2">&amp;mut *</span>txn)
                .<span class="kw">await</span><span class="question-mark">?</span>;

                <span class="attribute">#[cfg(test)]
                </span><span class="macro">eprintln!</span>(<span class="string">&quot;Done creating zone&quot;</span>);
                get_zone_with_txn(txn, <span class="kw-2">&amp;</span><span class="self">self</span>.name).<span class="kw">await</span><span class="question-mark">?</span>.unwrap()
            }
            <span class="prelude-val">Some</span>(ez) =&gt; {
                <span class="kw">if </span>!<span class="self">self</span>.matching_data(<span class="kw-2">&amp;</span>ez) {
                    <span class="comment">// update it if it&#39;s wrong

                    </span><span class="attribute">#[cfg(test)]
                    </span><span class="macro">eprintln!</span>(<span class="string">&quot;Updating zone&quot;</span>);
                    <span class="macro">log::debug!</span>(<span class="string">&quot;Updating zone&quot;</span>);
                    <span class="kw">let </span><span class="kw-2">mut </span>new_zone = <span class="self">self</span>.clone();
                    new_zone.id = ez.id;

                    <span class="kw">let </span>updated = update_zone_with_conn(txn, new_zone).<span class="kw">await</span><span class="question-mark">?</span>;
                    <span class="attribute">#[cfg(test)]
                    </span><span class="macro">eprintln!</span>(<span class="string">&quot;Updated: {:?} record&quot;</span>, updated);
                    <span class="macro">log::debug!</span>(<span class="string">&quot;Updated: {:?} record&quot;</span>, updated);
                }
                get_zone_with_txn(txn, <span class="kw-2">&amp;</span><span class="self">self</span>.name).<span class="kw">await</span>.unwrap().unwrap()
            }
        };
        <span class="attribute">#[cfg(test)]
        </span><span class="macro">eprintln!</span>(<span class="string">&quot;Zone after update: {updated_zone:?}&quot;</span>);
        <span class="macro">log::trace!</span>(<span class="string">&quot;Zone after update: {updated_zone:?}&quot;</span>);

        <span class="comment">// drop all the records
        </span><span class="kw">let </span><span class="kw-2">mut </span>args = SqliteArguments::default();
        args.add(updated_zone.id <span class="kw">as </span>i64);

        <span class="attribute">#[cfg(test)]
        </span><span class="macro">eprintln!</span>(<span class="string">&quot;Dropping all records for zone {self:?}&quot;</span>);
        <span class="macro">log::debug!</span>(<span class="string">&quot;Dropping all records for zone {self:?}&quot;</span>);
        sqlx_core::query::query_with(<span class="string">&quot;delete from records where zoneid = ?&quot;</span>, args)
            .execute(<span class="kw-2">&amp;mut *</span>txn)
            .<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="comment">// add the records
        </span><span class="kw">for </span><span class="kw-2">mut </span>record <span class="kw">in </span><span class="self">self</span>.records.clone() {
            <span class="attribute">#[cfg(test)]
            </span><span class="macro">eprintln!</span>(<span class="string">&quot;Creating new zone record: {record:?}&quot;</span>);
            <span class="macro">log::trace!</span>(<span class="string">&quot;Creating new zone record: {record:?}&quot;</span>);
            record.zoneid = updated_zone.id;
            <span class="kw">if </span>record.name == <span class="string">&quot;@&quot; </span>{
                record.name = <span class="string">&quot;&quot;</span>.to_string();
            }
            record.save_with_txn(txn).<span class="kw">await</span><span class="question-mark">?</span>;
        }
        <span class="attribute">#[cfg(test)]
        </span><span class="macro">println!</span>(<span class="string">&quot;Done creating zone!&quot;</span>);
        <span class="prelude-val">Ok</span>(<span class="number">1u64</span>)
    }

    <span class="doccomment">/// delete the entity from the database
    </span><span class="kw">async fn </span>delete(<span class="kw-2">&amp;</span><span class="self">self</span>, pool: <span class="kw-2">&amp;</span>Pool&lt;Sqlite&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>txn = pool.begin().<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="self">self</span>.delete_with_txn(<span class="kw-2">&amp;mut </span>txn).<span class="kw">await</span><span class="question-mark">?</span>;
        txn.commit().<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(<span class="number">1</span>)
    }
    <span class="doccomment">/// delete the entity from the database, but you&#39;re in a transaction
    </span><span class="kw">async fn </span>delete_with_txn(<span class="kw-2">&amp;</span><span class="self">self</span>, txn: <span class="kw-2">&amp;mut </span>Transaction&lt;<span class="lifetime">&#39;_</span>, Sqlite&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt; {
        <span class="kw">let </span>zone_id = <span class="self">self</span>.id <span class="kw">as </span>i64;
        <span class="comment">// delete all the records
        </span>sqlx::query(<span class="string">&quot;DELETE FROM records where zoneid = ?&quot;</span>)
            .bind(zone_id)
            .execute(<span class="kw-2">&amp;mut *</span>txn)
            .<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="comment">// delete all the ownership records
        </span>sqlx::query(<span class="string">&quot;DELETE FROM ownership where zoneid = ?&quot;</span>)
            .bind(zone_id)
            .execute(<span class="kw-2">&amp;mut *</span>txn)
            .<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="comment">// finally delete the zone
        </span><span class="kw">let </span>query = <span class="macro">format!</span>(<span class="string">&quot;DELETE FROM {} where id = ?&quot;</span>, <span class="self">self</span>.table_name());
        sqlx::query(<span class="kw-2">&amp;</span>query).bind(zone_id).execute(<span class="kw-2">&amp;mut *</span>txn).<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="prelude-val">Ok</span>(<span class="number">1</span>)
    }
}

<span class="attribute">#[async_trait]
</span><span class="kw">pub trait </span>DBEntity: Send {
    <span class="kw">fn </span>table_name(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span>str;

    <span class="doccomment">/// save the entity to the database
    </span><span class="kw">async fn </span>save(<span class="kw-2">&amp;</span><span class="self">self</span>, pool: <span class="kw-2">&amp;</span>Pool&lt;Sqlite&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt;;
    <span class="doccomment">/// save the entity to the database, but you&#39;re in a transaction
    </span><span class="kw">async fn </span>save_with_txn&lt;<span class="lifetime">&#39;t</span>&gt;(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        txn: <span class="kw-2">&amp;mut </span>Transaction&lt;<span class="lifetime">&#39;t</span>, Sqlite&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt;;

    <span class="doccomment">/// delete the entity from the database
    </span><span class="kw">async fn </span>delete(<span class="kw-2">&amp;</span><span class="self">self</span>, pool: <span class="kw-2">&amp;</span>Pool&lt;Sqlite&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt;;
    <span class="doccomment">/// delete the entity from the database, but you&#39;re in a transaction
    </span><span class="kw">async fn </span>delete_with_txn(<span class="kw-2">&amp;</span><span class="self">self</span>, txn: <span class="kw-2">&amp;mut </span>Transaction&lt;<span class="lifetime">&#39;_</span>, Sqlite&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt;;

    <span class="kw">fn </span>json(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;String, String&gt;
    <span class="kw">where
        </span><span class="self">Self</span>: Serialize,
    {
        serde_json::to_string_pretty(<span class="kw-2">&amp;</span><span class="self">self</span>).map_err(|e| e.to_string())
    }
}

<span class="attribute">#[async_trait]
</span><span class="kw">impl </span>DBEntity <span class="kw">for </span>FileZoneRecord {
    <span class="kw">fn </span>json(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;String, String&gt;
    <span class="kw">where
        </span><span class="self">Self</span>: Serialize,
    {
        serde_json::to_string_pretty(<span class="kw-2">&amp;</span><span class="self">self</span>).map_err(|e| e.to_string())
    }

    <span class="kw">fn </span>table_name(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span>str {
        <span class="string">&quot;records&quot;
    </span>}

    <span class="kw">async fn </span>save(<span class="kw-2">&amp;</span><span class="self">self</span>, pool: <span class="kw-2">&amp;</span>Pool&lt;Sqlite&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt; {
        <span class="attribute">#[cfg(test)]
        </span><span class="macro">eprintln!</span>(<span class="string">&quot;Starting save&quot;</span>);
        <span class="kw">let </span><span class="kw-2">mut </span>txn = pool.begin().<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="kw">let </span>res = <span class="kw-2">&amp;</span><span class="self">self</span>.save_with_txn(<span class="kw-2">&amp;mut </span>txn).<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="kw">match </span>txn.commit().<span class="kw">await </span>{
            <span class="prelude-val">Err</span>(err) =&gt; {
                <span class="macro">eprintln!</span>(<span class="string">&quot;Failed to commit transaction: {err:?}&quot;</span>);
                <span class="kw">return </span><span class="prelude-val">Err</span>(err);
            }
            <span class="prelude-val">Ok</span>(<span class="kw">_</span>) =&gt; <span class="macro">eprintln!</span>(<span class="string">&quot;Successfully saved {self:?} to the db&quot;</span>),
        };
        <span class="prelude-val">Ok</span>(res.to_owned())
    }

    <span class="kw">async fn </span>save_with_txn&lt;<span class="lifetime">&#39;t</span>&gt;(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        txn: <span class="kw-2">&amp;mut </span>Transaction&lt;<span class="lifetime">&#39;t</span>, Sqlite&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt; {
        <span class="attribute">#[cfg(test)]
        </span><span class="macro">eprintln!</span>(<span class="string">&quot;Starting save_with_txn&quot;</span>);

        <span class="comment">// TODO: check if there&#39;s an existing one
        </span><span class="kw">let </span>record_name = <span class="kw">match </span><span class="self">self</span>.name.len() {
            <span class="number">0 </span>=&gt; <span class="prelude-val">None</span>,
            <span class="kw">_ </span>=&gt; <span class="prelude-val">Some</span>(<span class="self">self</span>.to_owned().name),
        };
        <span class="kw">let </span>existing_record = sqlx::query(<span class="string">&quot;SELECT id, zoneid, name, ttl, rrtype, rclass, rdata from records WHERE
        id = ? AND  zoneid = ? AND  name = ? AND  ttl = ? AND  rrtype = ? AND  rclass = ? AND rdata = ? LIMIT 1&quot;</span>)
            .bind(<span class="self">self</span>.id <span class="kw">as </span>i64)
            .bind(<span class="self">self</span>.zoneid <span class="kw">as </span>i64)
            .bind(<span class="kw-2">&amp;</span>record_name)
            .bind(<span class="self">self</span>.ttl)
            .bind(RecordType::from(<span class="self">self</span>.rrtype.clone()))
            .bind(<span class="self">self</span>.class)
            .bind(<span class="self">self</span>.rdata.to_string())
            .fetch_optional(<span class="kw-2">&amp;mut *</span>txn).<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>args = SqliteArguments::default();
        args.add(<span class="self">self</span>.zoneid <span class="kw">as </span>i64);
        args.add(record_name);
        args.add(<span class="self">self</span>.ttl);
        args.add(RecordType::from(<span class="self">self</span>.rrtype.clone()));
        args.add(<span class="self">self</span>.class);
        args.add(<span class="self">self</span>.clone().rdata);

        <span class="kw">if let </span><span class="prelude-val">Some</span>(er) = <span class="kw-2">&amp;</span>existing_record {
            <span class="kw">let </span>id: i64 = er.get(<span class="string">&quot;id&quot;</span>);
            args.add(id);
        }

        <span class="kw">let </span>query = <span class="kw">match </span>existing_record {
            <span class="prelude-val">Some</span>(<span class="kw">_</span>) =&gt; {
                <span class="attribute">#[cfg(test)]
                </span><span class="macro">eprintln!</span>(<span class="string">&quot;Found an existing record while saving!&quot;</span>);
                sqlx::query_with(
                    <span class="string">&quot;UPDATE records set zoneid = ?1, name = ?2, ttl = ?3, rrtype = ?4, rclass = ?5, rdata = ?6
                            WHERE id =?
                        &quot;</span>,
                    args,
                )
            }
            <span class="prelude-val">None </span>=&gt; sqlx::query_with(
                <span class="string">&quot;INSERT INTO records (zoneid, name, ttl, rrtype, rclass, rdata)
                            VALUES (?1, ?2, ?3, ?4, ?5, ?6)
                        &quot;</span>,
                args,
            ),
        };
        <span class="attribute">#[cfg(test)]
        </span><span class="macro">println!</span>(<span class="string">&quot;Saving record...&quot;</span>);
        <span class="kw">let </span>result = query.execute(<span class="kw-2">&amp;mut *</span>txn).<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="attribute">#[cfg(test)]
        </span><span class="macro">eprintln!</span>(
            <span class="string">&quot;Finished fzr save_with_txn, wrote {} rows&quot;</span>,
            result.rows_affected()
        );
        <span class="prelude-val">Ok</span>(result.rows_affected())
    }

    <span class="kw">async fn </span>delete(<span class="kw-2">&amp;</span><span class="self">self</span>, pool: <span class="kw-2">&amp;</span>Pool&lt;Sqlite&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt; {
        <span class="kw">let </span><span class="kw-2">mut </span>txn = pool.begin().<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="self">self</span>.delete_with_txn(<span class="kw-2">&amp;mut </span>txn).<span class="kw">await
    </span>}

    <span class="kw">async fn </span>delete_with_txn(<span class="kw-2">&amp;</span><span class="self">self</span>, txn: <span class="kw-2">&amp;mut </span>Transaction&lt;<span class="lifetime">&#39;_</span>, Sqlite&gt;) -&gt; <span class="prelude-ty">Result</span>&lt;u64, sqlx::Error&gt; {
        <span class="kw">let </span>res = sqlx::query(<span class="macro">format!</span>(<span class="string">&quot;DELETE FROM {} WHERE id = ?&quot;</span>, <span class="kw-2">&amp;</span><span class="self">self</span>.table_name()).as_str())
            .bind(<span class="self">self</span>.id <span class="kw">as </span>i64)
            .execute(<span class="kw-2">&amp;mut *</span>txn)
            .<span class="kw">await</span><span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(res.rows_affected())
    }
}
</code></pre></div>
</section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="goatns" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0 (897e37553 2022-11-02)" ></div></body></html>