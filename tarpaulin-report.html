<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","Users","yaleman","Projects","goatns","benches","baselines.rs"],"content":"use criterion::{black_box, criterion_group, criterion_main, Criterion};\n\nfn fibonacci(n: u64) -\u003e u64 {\n    match n {\n        0 =\u003e 1,\n        1 =\u003e 1,\n        n =\u003e fibonacci(n - 1) + fibonacci(n - 2),\n    }\n}\n\nfn criterion_benchmark(c: \u0026mut Criterion) {\n    c.bench_function(\"calculate the fibonacci number of 20\", |b| {\n        b.iter(|| fibonacci(black_box(20)))\n    });\n}\n\ncriterion_group!(benches, criterion_benchmark);\ncriterion_main!(benches);\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","benches","datastore.rs"],"content":"use criterion::{black_box, criterion_group, criterion_main, Criterion}; // ,Bencher\n\n// use std::process::Termination;\nuse goatns::utils::name_as_bytes;\n\nfn criterion_benchmark(c: \u0026mut Criterion) {\n    c.bench_function(\"name as bytes\", |b| {\n        b.iter(|| bench_resourcerecord_short_name_to_bytes(black_box(\"cheese\".as_bytes())))\n    });\n}\n\nfn bench_resourcerecord_short_name_to_bytes(rdata: \u0026[u8]) {\n    assert_eq!(\n        name_as_bytes(rdata, None, None).expect(\"failed to convert to bytes\"),\n        [6, 99, 104, 101, 101, 115, 101, 0]\n    );\n}\n\ncriterion_group!(benches, criterion_benchmark);\ncriterion_main!(benches);\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","benches","parsers.rs"],"content":"use criterion::{black_box, criterion_group, criterion_main, Criterion}; // ,Bencher\n\n// use std::process::Termination;\nuse goatns::get_question_qname;\n\nfn criterion_benchmark(c: \u0026mut Criterion) {\n    let input = [7, 101, 120, 97, 109, 112, 108, 101, 3, 99, 111, 109, 0].to_vec();\n    c.bench_function(\"name_as_bytes\", |b| {\n        b.iter(|| get_question_qname(black_box(\u0026input)))\n    });\n}\n\n// fn bench_get_question_qname(rdata: Vec\u003cu8\u003e) {\n//     assert!(get_question_qname(\u0026[23, 0]).is_err());\n\n//     let sample_data = vec![7, 101, 120, 97, 109, 112, 108, 101, 3, 99, 111, 109, 0];\n//     eprintln!(\"{:?}\", sample_data);\n//     let result = get_question_qname(\u0026sample_data);\n//     assert_eq!(\n//         result,\n//         Ok(vec![101, 120, 97, 109, 112, 108, 101, 46, 99, 111, 109])\n//     );\n// }\n\ncriterion_group!(benches, criterion_benchmark);\ncriterion_main!(benches);\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","goat-lib","src","constants.rs"],"content":"/// Default for the LOC record horizontal value\npub const DEFAULT_LOC_HORIZ_PRE: u32 = 10000;\n/// Default for the LOC record vertical value\npub const DEFAULT_LOC_VERT_PRE: u32 = 10;\n/// Default for the LOC record size value\npub const DEFAULT_LOC_SIZE: u32 = 1;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","goat-lib","src","lib.rs"],"content":"pub mod constants;\npub mod validators;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","goat-lib","src","validators.rs"],"content":"use lazy_static::lazy_static;\nuse regex::Regex;\n\nlazy_static! {\n    pub static ref CAA_TAG_VALIDATOR: Regex =\n        Regex::new(r\"[a-zA-Z0-9]\").expect(\"Failed to parse an internal regex!\");\n    pub static ref URI_RECORD: Regex =\n        Regex::new(r\"^(?P\u003cpriority\u003e\\d+) (?P\u003cweight\u003e\\d+) (?P\u003ctarget\u003e.*)\")\n            .expect(\"Failed to parse an internal regex!\");\n}\n\npub fn dns_name(name: \u0026str) -\u003e bool {\n    if !name.contains('.') {\n        return false;\n    }\n    if name.len() \u003e 253 {\n        return false;\n    }\n    if name.is_empty() {\n        return false;\n    }\n\n    for part in name.split('.') {\n        if part.is_empty() {\n            return false;\n        }\n        if part.len() \u003e 63 {\n            return false;\n        }\n        if !part.chars().all(|c| c.is_alphanumeric() || c == '-') {\n            return false;\n        }\n    }\n    true\n}\n","traces":[{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":15},{"path":["/","Users","yaleman","Projects","goatns","goatns-macros","src","lib.rs"],"content":"extern crate proc_macro;\nuse proc_macro::TokenStream;\n\n#[proc_macro]\npub fn check_api_auth(_item: TokenStream) -\u003e TokenStream {\n    // TODO: This is terrible\n    r#\"\n    let user: User = match session.get(\"user\").await.expect(\"This shouldn't happen!\") {\n        Some(val) =\u003e val,\n        None =\u003e {\n            #[cfg(test)]\n            println!(\"User not found in api_create call\");\n            #[cfg(not(test))]\n            log::debug!(\"User not found in api_create call\");\n            return error_result_json!(\"\", StatusCode::FORBIDDEN);\n        }\n    };\n\n    \"#\n    .parse()\n    .expect(\"Failed to parse code\")\n}\n\n// TODO: go back and revisit this weirdness.\n// #[proc_macro]\n// /// Add a strict-transport-security header via a middleware ref: [Mozilla: Strict-Transport-Security headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security)\n// ///\n// /// max_age: Number of seconds before this header should expire in the client's cache\n// ///\n// /// preload: Ref [preloading STS](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security#preloading_strict_transport_security) When using preload, the max-age directive must be at least 31536000 (1 year), and the includeSubDomains directive must be present. Not part of the specification.\n// pub fn generate_sts_middleware(\n//     input: TokenStream,\n//     // max_age: u64,\n//     // preload: Option\u003cbool\u003e,\n//     // include_subdomains: Option\u003cbool\u003e,\n// ) -\u003e TokenStream {\n//     let signature = syn::parse_macro_input!(input as Signature);\n//     println!(\"// signature {:?}\", signature);\n\n//     let max_age = 12345;\n//     let preload = Some(false);\n//     let include_subdomains = None;\n\n//     let mut header_string = format!(\"max-age={max_age}\");\n//     if let Some(include_subdomains) = include_subdomains {\n//         if include_subdomains {\n//             header_string.push_str(\"; includeSubDomains\");\n//         }\n//     }\n//     if let Some(preload) = preload {\n//         if max_age \u003c 31536000 {\n//             panic!(\"max_age must be at least 31536000 (1 year) when preload is set!\");\n//         }\n//         if let Some(subdomains) = include_subdomains {\n//             if !subdomains {\n//                 panic!(\"include_subdomainsm must be set when preload is enabled\");\n//             }\n//         }\n//         if preload {\n//             header_string.push_str(\"; preload\");\n//         }\n//     }\n\n//     format!(\n//         \"\n// // Middleware that adds a strict-transport-security header\n// pub async fn add_sts_headers\u003cB\u003e(mut req: Request\u003cB\u003e, next: Next\u003cB\u003e) -\u003e impl IntoResponse {{\n//     let mut response = next.run(req).await;\n//     let headers = response.headers_mut();\n//     headers.insert(\\\"Strict-Transport-Security\\\", \\\"{}\\\".parse());\n//     response\n// }}\",\n//         header_string\n//     )\n//     .parse()\n//\n// }\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","cli.rs"],"content":"//! Code related to CLI things\n//!\n\nuse clap::{arg, command, value_parser, Arg, ArgMatches};\nuse dialoguer::theme::ColorfulTheme;\nuse dialoguer::{Confirm, Input};\nuse tokio::io::AsyncWriteExt;\nuse tokio::sync::{mpsc, oneshot};\nuse tokio::time::sleep;\n\nuse crate::config::ConfigFile;\nuse crate::datastore::Command;\nuse crate::enums::SystemState;\nuse crate::zones::FileZone;\n\n/// Handles the command-line arguments.\npub fn clap_parser() -\u003e ArgMatches {\n    command!()\n        .arg(\n            arg!(\n                -c --config \u003cFILE\u003e \"Sets a custom config file\"\n            )\n            .required(false)\n            .value_parser(value_parser!(String)),\n        )\n        .arg(\n            Arg::new(\"configcheck\")\n                .short('t')\n                .long(\"configcheck\")\n                .help(\"Check the config file, show it and then quit.\")\n                .action(clap::ArgAction::SetTrue),\n        )\n        .arg(\n            Arg::new(\"export_config\")\n                .long(\"export-default-config\")\n                .help(\"Export a default config file.\")\n                .action(clap::ArgAction::SetTrue),\n        )\n        .arg(\n            Arg::new(\"export_zone\")\n                .short('e')\n                .long(\"export-zone\")\n                .help(\"Export a single zone.\")\n                .value_parser(value_parser!(String)),\n        )\n        .arg(\n            Arg::new(\"import_zones\")\n                .short('i')\n                .long(\"import-zones\")\n                .help(\"Import a single zone file.\")\n                .action(clap::ArgAction::SetTrue),\n        )\n        .arg(\n            Arg::new(\"import_zone\")\n                .long(\"import-zone\")\n                .help(\"Import a single zone from a file.\")\n                .value_parser(value_parser!(String)),\n        )\n        .arg(\n            Arg::new(\"filename\")\n                .short('f')\n                .long(\"filename\")\n                .help(\"Filename to save to (used in other commands).\")\n                .value_parser(value_parser!(String)),\n        )\n        .arg(\n            Arg::new(\"add_admin\")\n                .long(\"add-admin\")\n                .help(\"Add a new admin user.\")\n                .action(clap::ArgAction::SetTrue),\n        )\n        .arg(\n            Arg::new(\"use_zonefile\")\n                .long(\"using-zonefile\")\n                .help(\"Load the zone file into the DB on startup, typically used for testing.\")\n                .action(clap::ArgAction::SetTrue),\n        )\n        .get_matches()\n}\n\n/// Turns the clap inputs into actions.\npub async fn cli_commands(\n    tx: mpsc::Sender\u003cCommand\u003e,\n    clap_results: \u0026ArgMatches,\n    zone_file: \u0026Option\u003cString\u003e,\n) -\u003e Result\u003cSystemState, String\u003e {\n    if clap_results.get_flag(\"add_admin\") {\n        let _ = add_admin_user(tx).await;\n        return Ok(SystemState::ShuttingDown);\n    }\n    if clap_results.get_flag(\"export_config\") {\n        default_config();\n        return Ok(SystemState::ShuttingDown);\n    }\n\n    // Load the specified zone file on startup\n    if clap_results.get_flag(\"use_zonefile\") {\n        if let Some(zone_file) = zone_file {\n            if let Err(error) = import_zones(tx.clone(), zone_file.to_owned(), None).await {\n                log::error!(\"Failed to import zone file! {error:?}\");\n                return Ok(SystemState::ShuttingDown);\n            }\n        }\n    }\n\n    if let Some(zone_name) = clap_results.get_one::\u003cString\u003e(\"export_zone\") {\n        if let Some(output_filename) = clap_results.get_one::\u003cString\u003e(\"filename\") {\n            log::info!(\"Exporting zone {zone_name} to {output_filename}\");\n            let res = export_zone_file(tx, zone_name, output_filename).await;\n            if let Err(err) = res {\n                log::error!(\"{err}\");\n            }\n            return Ok(SystemState::Export);\n        } else {\n            log::error!(\"You need to specify a a filename to save to.\");\n            return Ok(SystemState::ShuttingDown);\n        }\n    };\n\n    if clap_results.get_flag(\"import_zones\") {\n        if let Some(filename) = clap_results.get_one::\u003cString\u003e(\"filename\") {\n            log::info!(\"Importing zones from {filename}\");\n            import_zones(tx, filename.to_owned(), None)\n                .await\n                .map_err(|e| format!(\"Error importing {filename}: {e:?}\"))?;\n\n            return Ok(SystemState::Import);\n        } else {\n            log::error!(\"You need to specify a a filename to save to.\");\n            return Ok(SystemState::ShuttingDown);\n        }\n    };\n    if let Some(zone_name) = clap_results.get_one::\u003cString\u003e(\"import_zone\") {\n        if let Some(filename) = clap_results.get_one::\u003cString\u003e(\"filename\") {\n            log::info!(\"Importing zones from {filename}\");\n            import_zones(tx, filename.to_owned(), Some(zone_name.to_owned()))\n                .await\n                .map_err(|e| format!(\"Error importing {filename}: {e:?}\"))?;\n\n            return Ok(SystemState::Import);\n        } else {\n            log::error!(\"You need to specify a a filename to save to.\");\n            return Ok(SystemState::ShuttingDown);\n        }\n    };\n    Ok(SystemState::Server)\n}\n\n/// Output a default configuration file, based on the [crate::config::ConfigFile] object.\npub fn default_config() {\n    let output = match serde_json::to_string_pretty(\u0026ConfigFile::default()) {\n        Ok(value) =\u003e value,\n        Err(_) =\u003e {\n            log::error!(\"I don't know how, but we couldn't parse our own config file def.\");\n            \"\".to_string()\n        }\n    };\n    println!(\"{output}\");\n}\n\n/// Dump a zone to a file\npub async fn export_zone_file(\n    tx: mpsc::Sender\u003cCommand\u003e,\n    zone_name: \u0026String,\n    filename: \u0026String,\n) -\u003e Result\u003c(), String\u003e {\n    // make a channel\n\n    let (tx_oneshot, rx_oneshot) = oneshot::channel();\n    let ds_req: Command = Command::GetZone {\n        id: None,\n        name: Some(zone_name.clone()),\n        resp: tx_oneshot,\n    };\n    if let Err(error) = tx.send(ds_req).await {\n        return Err(format!(\n            \"failed to send to datastore from export_zone_file {error:?}\"\n        ));\n    };\n\n    let zone: Option\u003cFileZone\u003e = match rx_oneshot.await {\n        Ok(value) =\u003e value,\n        Err(err) =\u003e return Err(format!(\"rx from ds failed {err:?}\")),\n    };\n    eprintln!(\"Got filezone: {zone:?}\");\n\n    let zone_bytes = match zone {\n        None =\u003e {\n            log::warn!(\"Couldn't find the zone {zone_name}\");\n            return Ok(());\n        }\n        Some(zone) =\u003e serde_json::to_string_pretty(\u0026zone).map_err(|err| {\n            format!(\n                \"Failed to serialize zone {zone_name} to json: {err:?}\",\n                zone_name = zone_name,\n                err = err\n            )\n        })?,\n    };\n\n    // open the file\n    let mut file = tokio::fs::File::create(filename)\n        .await\n        .map_err(|e| format!(\"Failed to open file {e:?}\"))?;\n    // write the thing\n    file.write_all(zone_bytes.as_bytes())\n        .await\n        .map_err(|e| format!(\"Failed to write file: {e:?}\"))?;\n    // make some cake\n\n    Ok(())\n}\n\n/// Import zones from a file\npub async fn import_zones(\n    tx: mpsc::Sender\u003cCommand\u003e,\n    filename: String,\n    zone_name: Option\u003cString\u003e,\n) -\u003e Result\u003c(), String\u003e {\n    let (tx_oneshot, mut rx_oneshot) = oneshot::channel();\n    let msg = Command::ImportFile {\n        filename,\n        resp: tx_oneshot,\n        zone_name,\n    };\n    if let Err(err) = tx.send(msg).await {\n        log::error!(\"Failed to send message to datastore: {err:?}\");\n    }\n    loop {\n        let res = rx_oneshot.try_recv();\n        match res {\n            Err(error) =\u003e {\n                if let oneshot::error::TryRecvError::Closed = error {\n                    break;\n                }\n            }\n            Ok(()) =\u003e break,\n        };\n        sleep(std::time::Duration::from_micros(500)).await;\n    }\n    Ok(())\n    // rx_oneshot.await.map_err(|e| format!(\"Failed to receive result: {e:?}\"))\n}\n\n/// Presents the CLI UI to add an admin user.\npub async fn add_admin_user(tx: mpsc::Sender\u003cCommand\u003e) -\u003e Result\u003c(), ()\u003e {\n    // prompt for the username\n    println!(\"Creating admin user, please enter their username from the identity provider\");\n    let username: String = Input::with_theme(\u0026ColorfulTheme::default())\n        .with_prompt(\"Username\")\n        .interact_text()\n        .map_err(|e| {\n            log::error!(\"Failed to get username from user: {e:?}\");\n        })?;\n\n    println!(\n        \"The authentication reference is the unique user identifier in the Identity Provider.\"\n    );\n    let authref: String = Input::with_theme(\u0026ColorfulTheme::default())\n        .with_prompt(\"Authentication Reference:\")\n        .interact_text()\n        .map_err(|e| {\n            log::error!(\"Failed to get auth reference from user: {e:?}\");\n        })?;\n\n    println!(\n        r#\"\n\nCreating the following user:\n\n\nUsername: {username}\nAuthref:  {authref}\n\n\"#\n    );\n    // show the details and confirm them\n    let confirm = Confirm::with_theme(\u0026ColorfulTheme::default())\n        .with_prompt(\"Do these details look correct?\")\n        .interact_opt();\n\n    match confirm {\n        Ok(Some(true)) =\u003e {}\n        Ok(Some(false)) | Ok(None) | Err(_) =\u003e {\n            log::warn!(\"Cancelled user creation\");\n            return Err(());\n        }\n    }\n\n    // create oneshot\n    let (tx_oneshot, rx_oneshot) = oneshot::channel();\n\n    let new_user = Command::CreateUser {\n        username: username.clone(),\n        authref: authref.clone(),\n        admin: true,\n        disabled: false,\n        resp: tx_oneshot,\n    };\n    // send command\n    if let Err(error) = tx.send(new_user).await {\n        log::error!(\"Failed to send new user command for username {username:?}: {error:?}\");\n        return Err(());\n    };\n    // wait for the response\n    match rx_oneshot.await {\n        Ok(res) =\u003e match res {\n            true =\u003e {\n                log::info!(\"Successfully created user!\");\n                Ok(())\n            }\n            false =\u003e {\n                log::error!(\"Failed to create user! Check datastore logs.\");\n                Err(())\n            }\n        },\n        Err(error) =\u003e {\n            log::debug!(\"Failed to rx result from datastore: {error:?}\");\n            Err(())\n        }\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":160},{"path":["/","Users","yaleman","Projects","goatns","src","config.rs"],"content":"use axum_server::tls_rustls::RustlsConfig;\nuse clap::ArgMatches;\nuse concread::cowcell::asynch::{CowCell, CowCellReadTxn, CowCellWriteTxn};\nuse config::{Config, File};\nuse flexi_logger::filter::{LogLineFilter, LogLineWriter};\nuse flexi_logger::{DeferredNow, LoggerHandle};\nuse gethostname::gethostname;\nuse rand::distributions::{Alphanumeric, DistString};\nuse serde::{Deserialize, Serialize};\nuse std::fmt::Display;\nuse std::io::ErrorKind;\nuse std::net::IpAddr;\nuse std::net::SocketAddr;\nuse std::path::PathBuf;\nuse std::str::FromStr;\nuse url::Url;\n\nuse crate::enums::ContactDetails;\nuse crate::error::GoatNsError;\nuse crate::web::utils::Urls;\n\n#[derive(Deserialize, Serialize, Debug, Eq, PartialEq, Clone, Default)]\n/// Allow-listing ranges for making particular kinds of requests\npub struct IPAllowList {\n    // Allow CH TXT VERSION.BIND or VERSION requests\n    // pub version: Vec\u003cIpAddr\u003e,\n    /// IPs allowed to make AXFR requests\n    // pub axfr: Vec\u003cIpNet\u003e,\n    // TODO: Change shutdown from IpAddr to ipnet\n    /// A list of allowed IPs which can send a \"shutdown CH\" request\n    pub shutdown: Vec\u003cIpAddr\u003e,\n}\n\n#[derive(Debug, Deserialize, Eq, PartialEq, Clone, Serialize)]\n/// The main config blob for GoatNS, write this as a JSON file and load it and it'll make things go.\npub struct ConfigFile {\n    /// The server's hostname when generating an SOA record, defaults to the results of gethostname()\n    pub hostname: String,\n    /// DNS listener address, default is 127.0.0.1\n    pub address: String,\n    /// Listen for DNS queries on this port, default is 15353\n    pub port: u16,\n    /// If we should capture packets on request/response\n    pub capture_packets: bool,\n    /// Default is \"DEBUG\"\n    pub log_level: String,\n    /// How long until we drop TCP client connections, defaults to 5 seconds.\n    pub tcp_client_timeout: u64,\n    /// Enable a HINFO record at hinfo.goat\n    pub enable_hinfo: bool,\n    /// The location for the zone sqlite file\n    pub sqlite_path: String,\n    /// Where the JSON zone file is\n    pub zone_file: Option\u003cString\u003e,\n    /// List of \"valid\" TLDs - if this is empty let anything be created\n    pub allowed_tlds: Vec\u003cString\u003e,\n    /// IP Allow lists\n    #[serde(flatten)]\n    pub ip_allow_lists: IPAllowList,\n    /// Do you really want an API?\n    pub enable_api: bool,\n    /// API / Web UI Port\n    pub api_port: u16,\n    /// Certificate path\n    pub api_tls_cert: PathBuf,\n    /// TLS key path\n    pub api_tls_key: PathBuf,\n    /// Static File Directory for api things\n    pub api_static_dir: String,\n    /// Secret for cookie storage - it'll randomly generate on startup by default\n    #[serde(default = \"generate_cookie_secret\", skip_serializing)]\n    api_cookie_secret: String,\n    /// OAuth2 Resource server name\n    pub oauth2_client_id: String,\n    /// If your instance is behind a proxy/load balancer/whatever, you need to specify this, eg `https://example.com:12345`\n    pub oauth2_redirect_url: Url,\n    #[serde(skip_serializing)]\n    /// Oauth2 Secret\n    pub oauth2_secret: String,\n    /// OIDC Discovery URL, eg for Kanidm you'd use `https://idm.example.com/oauth2/openid/:client_id:/.well-known/openid-configuration`\n    #[serde(default)]\n    pub oauth2_config_url: String,\n    #[serde(default)]\n    /// A list of scopes to request from the IdP\n    pub oauth2_user_scopes: Vec\u003cString\u003e,\n    /// Log things sometimes\n    pub sql_log_statements: bool,\n    /// When queries take more than this many seconds, log them\n    pub sql_log_slow_duration: u64,\n    /// Clean up sessions table every n seconds\n    pub sql_db_cleanup_seconds: u64,\n    /// Administrator contact details\n    pub admin_contact: ContactDetails,\n    /// Allow auto-provisioning of users\n    pub user_auto_provisioning: bool,\n}\n\nfn generate_cookie_secret() -\u003e String {\n    Alphanumeric.sample_string(\u0026mut rand::thread_rng(), 64)\n}\n\nimpl ConfigFile {\n    /// JSONify the configfile in a pretty way using serde\n    pub fn as_json_pretty(\u0026self) -\u003e Result\u003cString, String\u003e {\n        serde_json::to_string_pretty(self).map_err(|e| format!(\"Failed to serialize config: {e:?}\"))\n    }\n\n    /// Get a bindable SocketAddr for use in the DNS listeners\n    pub fn dns_listener_address(\u0026self) -\u003e Result\u003cSocketAddr, Option\u003cString\u003e\u003e {\n        let listen_addr = format!(\"{}:{}\", \u0026self.address, \u0026self.port);\n\n        listen_addr.parse::\u003cSocketAddr\u003e().map_err(|e| {\n            log::error!(\"Failed to parse address: {e:?}\");\n            None\n        })\n    }\n\n    /// get a string version of the listener address\n    pub fn api_listener_address(\u0026self) -\u003e Result\u003cSocketAddr, GoatNsError\u003e {\n        Ok(SocketAddr::new(\n            self.address.parse().map_err(|err| {\n                GoatNsError::StartupError(format!(\"Failed to parse IP {:?}\", err))\n            })?,\n            self.api_port,\n        ))\n    }\n\n    /// It's a sekret!\n    pub fn api_cookie_secret(\u0026self) -\u003e \u0026[u8] {\n        self.api_cookie_secret.as_bytes()\n    }\n\n    /// Return the URL for the status endpoint\n    #[cfg(test)]\n    pub fn status_url(\u0026self) -\u003e Url {\n        Url::from_str(\u0026format!(\n            \"https://{}:{}/status\",\n            self.hostname, self.api_port\n        ))\n        .expect(\"Failed to generate a status URL!\")\n    }\n\n    /// Get the TLS config for the API server\n    pub async fn get_tls_config(\u0026self) -\u003e Result\u003cRustlsConfig, String\u003e {\n        log::trace!(\n            \"tls config: cert={:?} key={:?}\",\n            self.api_tls_cert,\n            self.api_tls_key\n        );\n        RustlsConfig::from_pem_file(self.api_tls_cert.clone(), self.api_tls_key.clone())\n            .await\n            .map_err(|e| format!(\"Failed to load TLS config: {e:?}\"))\n    }\n\n    /// Check the configuration for errors\n    pub async fn check_config(\n        mut config: CowCellWriteTxn\u003c'_, ConfigFile\u003e,\n    ) -\u003e Result\u003c(), Vec\u003cString\u003e\u003e {\n        let mut errors: Vec\u003cString\u003e = vec![];\n\n        if config.api_tls_cert.starts_with(\"~\") {\n            #[cfg(test)]\n            eprintln!(\n                \"updating tls cert from {:#?} to shellex\",\n                config.api_tls_cert\n            );\n\n            config.api_tls_cert = PathBuf::from(\n                shellexpand::tilde(\u0026config.api_tls_cert.to_string_lossy()).to_string(),\n            );\n        }\n        if config.api_tls_key.starts_with(\"~\") {\n            #[cfg(test)]\n            eprintln!(\"updating tls key from {:#?} to shellex\", config.api_tls_key);\n            config.api_tls_key = PathBuf::from(\n                shellexpand::tilde(\u0026config.api_tls_key.to_string_lossy()).to_string(),\n            );\n        }\n\n        if !config.api_tls_key.exists() {\n            errors.push(format!(\n                \"Failed to find API TLS Key file: {:?}\",\n                config.api_tls_key\n            ));\n        };\n\n        if !config.api_tls_cert.exists() {\n            errors.push(format!(\n                \"Failed to find API TLS cert file: {:?}\",\n                config.api_tls_cert\n            ));\n        };\n\n        config.commit();\n        match errors.is_empty() {\n            true =\u003e Ok(()),\n            false =\u003e Err(errors),\n        }\n    }\n\n    /// Uses [Self::try_from] and wraps it in a CowCell (moo)\n    ///\n    /// The default locations are `~/.config/goatns.json` and `./goatns.json`.\n    pub fn try_as_cowcell(\n        config_path: Option\u003c\u0026String\u003e,\n    ) -\u003e Result\u003cCowCell\u003cConfigFile\u003e, std::io::Error\u003e {\n        Ok(CowCell::new(ConfigFile::try_from(config_path)?))\n    }\n\n    /// Loads the configuration from a given file or from some default locations.\n    ///\n    /// The default locations are `~/.config/goatns.json` and `./goatns.json`.\n    pub fn try_from(config_path: Option\u003c\u0026String\u003e) -\u003e Result\u003cConfigFile, std::io::Error\u003e {\n        let file_locations = match config_path {\n            Some(value) =\u003e vec![value.to_owned()],\n            None =\u003e CONFIG_LOCATIONS.iter().map(|x| x.to_string()).collect(),\n        };\n\n        // clean up the file paths and filter them by the ones that exist\n        let found_files: Vec\u003cString\u003e = file_locations\n            .iter()\n            .filter_map(|f| {\n                let path = shellexpand::tilde(\u0026f).into_owned();\n                let filepath = std::path::Path::new(\u0026path);\n                match filepath.exists() {\n                    false =\u003e {\n                        eprintln!(\"Config file {path} doesn't exist, skipping.\");\n                        None\n                    }\n                    true =\u003e Some(path),\n                }\n            })\n            .collect();\n\n        if found_files.is_empty() {\n            eprintln!(\n                \"No configuration files exist, giving up! Tried: {}\",\n                file_locations.join(\", \")\n            );\n            return Err(std::io::Error::new(\n                ErrorKind::NotFound,\n                \"No configuration files found\",\n            ));\n        }\n\n        // check that at least one config file exists\n        for filepath in found_files {\n            let config_filename: String = shellexpand::tilde(\u0026filepath).into_owned();\n\n            let builder = Config::builder()\n                .add_source(File::new(\u0026config_filename, config::FileFormat::Json))\n                .add_source(config::Environment::with_prefix(\"goatns\"));\n\n            let config = builder.build().map_err(|e| {\n                std::io::Error::new(\n                    std::io::ErrorKind::Other,\n                    format!(\"Couldn't load config from {config_filename}: {e:?}\"),\n                )\n            });\n\n            match config {\n                Ok(config) =\u003e {\n                    eprintln!(\"Successfully loaded config from: {}\", config_filename);\n                    return Ok(ConfigFile::from(config));\n                }\n                Err(err) =\u003e eprintln!(\"{err:?}\"),\n            }\n        }\n\n        Ok(ConfigFile::default())\n    }\n}\n\nimpl Default for ConfigFile {\n    fn default() -\u003e Self {\n        let hostname = gethostname();\n        let hostname = hostname.into_string().unwrap_or(\"example.com\".to_string());\n        Self {\n            hostname,\n            address: \"127.0.0.1\".to_string(),\n            port: 15353,\n            capture_packets: false,\n            log_level: \"INFO\".to_string(),\n            tcp_client_timeout: 5,\n            enable_hinfo: false,\n            allowed_tlds: vec![],\n            ip_allow_lists: IPAllowList {\n                // axfr: vec![],\n                shutdown: vec![],\n            },\n            sqlite_path: String::from(\"~/.cache/goatns.sqlite\"),\n            zone_file: None,\n            enable_api: false,\n            api_port: 9000,\n            api_tls_cert: PathBuf::from(\"./certificates/cert.pem\"),\n            api_tls_key: PathBuf::from(\"./certificates/key.pem\"),\n            api_static_dir: String::from(\"./static_files/\"),\n            api_cookie_secret: generate_cookie_secret(),\n            oauth2_client_id: String::from(\"\"),\n            // TODO: this should be auto-generated from stuff\n            #[allow(clippy::expect_used)]\n            oauth2_redirect_url: Url::from_str(\"https://example.com\")\n                .expect(\"Internal error parsing example.com into a URL\"),\n            oauth2_secret: String::from(\"\"),\n            oauth2_config_url: String::from(\"\"),\n            oauth2_user_scopes: vec![\"openid\".to_string(), \"email\".to_string()],\n            sql_log_slow_duration: 5,\n            sql_log_statements: false,\n            sql_db_cleanup_seconds: 3600, // one hour\n            admin_contact: Default::default(),\n            user_auto_provisioning: false,\n        }\n    }\n}\n\nimpl Display for ConfigFile {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        let api_details = match self.enable_api {\n            false =\u003e format!(\"enable_api={}\", self.enable_api),\n            true =\u003e {\n                format!(\n                    \"enable_api={}  api_endpoint=\\\"https://{}\\\" tls_cert={:?} tls_key={:?}\",\n                    self.enable_api,\n                    self.api_listener_address()\n                        .map(|x| x.to_string())\n                        .unwrap_or(\"\u003cFAILED TO PARSE ADDRESS\u003e\".to_string()),\n                    self.api_tls_cert,\n                    self.api_tls_key\n                )\n            }\n        };\n        f.write_fmt(format_args!(\n            \"hostname=\\\"{}\\\" listening_address=\\\"{}:{}\\\" capturing_pcaps={} Log_level={}, admin_contact={:?} {api_details} oauth2_redirect_url={}\",\n            self.hostname, self.address, self.port, self.capture_packets, self.log_level, self.admin_contact, self.oauth2_redirect_url\n        ))\n    }\n}\n\nimpl From\u003cConfig\u003e for ConfigFile {\n    fn from(config: Config) -\u003e Self {\n        let hostname = config.get(\"hostname\").unwrap_or(Self::default().hostname);\n        let api_port = config.get(\"api_port\").unwrap_or(Self::default().api_port);\n\n        // The OAuth2 redirect URL is a magical pony.\n\n        // TODO: test this with different values\n        let oauth2_redirect_url: Option\u003cUrl\u003e = match config.get(\"oauth2_redirect_url\") {\n            Ok(value) =\u003e {\n                // println!(\"Found url in config: {:?}\", value);\n                Some(value)\n            }\n            Err(_) =\u003e None,\n        };\n        let oauth2_redirect_url = match oauth2_redirect_url {\n            Some(mut url) =\u003e {\n                // update the URL with the final auth path\n                if !url.path().ends_with(Urls::Login.as_ref()) {\n                    url.set_path(Urls::Login.as_ref());\n                }\n                url\n            }\n            None =\u003e {\n                // if they haven't set it in config, build it automagically\n                let baseurl = match api_port {\n                    443 =\u003e format!(\"https://{}\", hostname),\n                    _ =\u003e format!(\"https://{}:{}\", hostname, api_port),\n                };\n                #[allow(clippy::expect_used)]\n                let mut url =\n                    Url::from_str(\u0026baseurl).expect(\"Failed to parse known-sensible URL as URL\");\n                url.set_path(Urls::Login.as_ref());\n                url\n            }\n        };\n\n        ConfigFile {\n            hostname,\n            address: config.get(\"address\").unwrap_or(Self::default().address),\n            port: config.get(\"port\").unwrap_or_default(),\n            capture_packets: config.get(\"capture_packets\").unwrap_or_default(),\n            log_level: config.get(\"log_level\").unwrap_or(Self::default().log_level),\n            enable_hinfo: config\n                .get(\"enable_hinfo\")\n                .unwrap_or(Self::default().enable_hinfo),\n            ip_allow_lists: config\n                .get(\"ip_allow_lists\")\n                .unwrap_or(Self::default().ip_allow_lists),\n            tcp_client_timeout: config\n                .get(\"tcp_client_timeout\")\n                .unwrap_or(Self::default().tcp_client_timeout),\n            sqlite_path: config\n                .get(\"sqlite_path\")\n                .unwrap_or(Self::default().sqlite_path),\n            allowed_tlds: config\n                .get(\"allowed_tlds\")\n                .unwrap_or(Self::default().allowed_tlds),\n            zone_file: config.get(\"zone_file\").unwrap_or(Self::default().zone_file),\n            enable_api: config\n                .get(\"enable_api\")\n                .unwrap_or(Self::default().enable_api),\n            api_port,\n            api_tls_cert: config\n                .get(\"api_tls_cert\")\n                .unwrap_or(Self::default().api_tls_cert),\n            api_tls_key: config\n                .get(\"api_tls_key\")\n                .unwrap_or(Self::default().api_tls_key),\n            api_static_dir: config\n                .get(\"api_static_dir\")\n                .unwrap_or(Self::default().api_static_dir),\n            api_cookie_secret: config\n                .get(\"api_cookie_secret\")\n                .unwrap_or(Self::default().api_cookie_secret),\n            oauth2_client_id: config\n                .get(\"oauth2_client_id\")\n                .unwrap_or(Self::default().oauth2_client_id),\n            oauth2_redirect_url,\n            oauth2_secret: config\n                .get(\"oauth2_secret\")\n                .unwrap_or(Self::default().oauth2_secret),\n            oauth2_config_url: config\n                .get(\"oauth2_config_url\")\n                .unwrap_or(Self::default().oauth2_config_url),\n            oauth2_user_scopes: config\n                .get(\"oauth2_user_scopes\")\n                .unwrap_or(Self::default().oauth2_user_scopes),\n            sql_log_slow_duration: config\n                .get(\"sql_log_slow_duration\")\n                .unwrap_or(Self::default().sql_log_slow_duration),\n            sql_log_statements: config\n                .get(\"sql_log_statements\")\n                .unwrap_or(Self::default().sql_log_statements),\n            sql_db_cleanup_seconds: config\n                .get(\"sql_db_cleanup_seconds\")\n                .unwrap_or(Self::default().sql_db_cleanup_seconds),\n            admin_contact: config\n                .get(\"admin_contact\")\n                .unwrap_or(Self::default().admin_contact),\n            user_auto_provisioning: config\n                .get(\"user_auto_provisioning\")\n                .unwrap_or(Self::default().user_auto_provisioning),\n        }\n    }\n}\n\nimpl FromStr for ConfigFile {\n    type Err = String;\n\n    fn from_str(input: \u0026str) -\u003e Result\u003cSelf, Self::Err\u003e {\n        // let res =Config::try_from(\u0026input);\n\n        let configfile = File::from_str(input, config::FileFormat::Json);\n\n        let res = Config::builder()\n            .add_source(configfile)\n            .build()\n            .map_err(|e| format!(\"{e:?}\"))?;\n\n        let res: ConfigFile = res.into();\n        Ok(res)\n    }\n}\n\nconst CONFIG_LOCATIONS: [\u0026str; 2] = [\"./goatns.json\", \"~/.config/goatns.json\"];\n\n/// Sets up logging for the platform\npub async fn setup_logging(\n    config: CowCellReadTxn\u003cConfigFile\u003e,\n    clap_results: \u0026ArgMatches,\n) -\u003e Result\u003cLoggerHandle, std::io::Error\u003e {\n    // force the log level to info if we're testing config\n    let log_level = match clap_results.get_flag(\"configcheck\") {\n        true =\u003e \"info\".to_string(),\n        false =\u003e config.log_level.to_ascii_lowercase(),\n    };\n\n    let logger = flexi_logger::Logger::try_with_str(log_level).map_err(|e| {\n        std::io::Error::new(\n            std::io::ErrorKind::Other,\n            format!(\"Failed to start logger! {e:?}\"),\n        )\n    })?;\n\n    logger\n        .write_mode(flexi_logger::WriteMode::Async)\n        .filter(Box::new(LogFilter {\n            filters: vec![\n                \"h2\",\n                \"hyper::proto\",\n                \"hyper::client\",\n                \"rustls\",\n                \"h2::proto\",\n                // \"tower_http::trace::make_span\",\n                \"tokio_util::codec::framed_impl\",\n            ],\n        }))\n        .set_palette(\"b1;3;2;6;5\".to_string())\n        .start()\n        .map_err(|e| {\n            std::io::Error::new(\n                std::io::ErrorKind::Other,\n                format!(\"Failed to start logger! {e:?}\"),\n            )\n        })\n}\n\n/// A filter for log lines\npub struct LogFilter {\n    filters: Vec\u003c\u0026'static str\u003e,\n}\n\nimpl LogLineFilter for LogFilter {\n    fn write(\n        \u0026self,\n        now: \u0026mut DeferredNow,\n        record: \u0026log::Record,\n        log_line_writer: \u0026dyn LogLineWriter,\n    ) -\u003e std::io::Result\u003c()\u003e {\n        if self\n            .filters\n            .iter()\n            .any(|r| record.module_path().unwrap_or(\"\").contains(r))\n        {\n            return Ok(());\n        }\n\n        log_line_writer.write(now, record)?;\n        Ok(())\n    }\n}\n","traces":[{"line":98,"address":[],"length":0,"stats":{"Line":288}},{"line":99,"address":[],"length":0,"stats":{"Line":288}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":19}},{"line":110,"address":[],"length":0,"stats":{"Line":19}},{"line":112,"address":[],"length":0,"stats":{"Line":19}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":20}},{"line":120,"address":[],"length":0,"stats":{"Line":20}},{"line":121,"address":[],"length":0,"stats":{"Line":20}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":20}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":1}},{"line":136,"address":[],"length":0,"stats":{"Line":1}},{"line":137,"address":[],"length":0,"stats":{"Line":1}},{"line":138,"address":[],"length":0,"stats":{"Line":1}},{"line":144,"address":[],"length":0,"stats":{"Line":20}},{"line":145,"address":[],"length":0,"stats":{"Line":10}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":10}},{"line":151,"address":[],"length":0,"stats":{"Line":20}},{"line":152,"address":[],"length":0,"stats":{"Line":20}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":10}},{"line":207,"address":[],"length":0,"stats":{"Line":10}},{"line":213,"address":[],"length":0,"stats":{"Line":10}},{"line":214,"address":[],"length":0,"stats":{"Line":20}},{"line":215,"address":[],"length":0,"stats":{"Line":10}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":10}},{"line":222,"address":[],"length":0,"stats":{"Line":20}},{"line":223,"address":[],"length":0,"stats":{"Line":10}},{"line":224,"address":[],"length":0,"stats":{"Line":10}},{"line":225,"address":[],"length":0,"stats":{"Line":10}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":10}},{"line":235,"address":[],"length":0,"stats":{"Line":10}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":20}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":10}},{"line":263,"address":[],"length":0,"stats":{"Line":10}},{"line":264,"address":[],"length":0,"stats":{"Line":10}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":288}},{"line":276,"address":[],"length":0,"stats":{"Line":288}},{"line":277,"address":[],"length":0,"stats":{"Line":288}},{"line":280,"address":[],"length":0,"stats":{"Line":288}},{"line":283,"address":[],"length":0,"stats":{"Line":288}},{"line":286,"address":[],"length":0,"stats":{"Line":288}},{"line":287,"address":[],"length":0,"stats":{"Line":288}},{"line":291,"address":[],"length":0,"stats":{"Line":288}},{"line":295,"address":[],"length":0,"stats":{"Line":288}},{"line":296,"address":[],"length":0,"stats":{"Line":288}},{"line":297,"address":[],"length":0,"stats":{"Line":288}},{"line":298,"address":[],"length":0,"stats":{"Line":288}},{"line":299,"address":[],"length":0,"stats":{"Line":288}},{"line":302,"address":[],"length":0,"stats":{"Line":288}},{"line":304,"address":[],"length":0,"stats":{"Line":288}},{"line":305,"address":[],"length":0,"stats":{"Line":288}},{"line":306,"address":[],"length":0,"stats":{"Line":288}},{"line":310,"address":[],"length":0,"stats":{"Line":288}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":12}},{"line":341,"address":[],"length":0,"stats":{"Line":12}},{"line":342,"address":[],"length":0,"stats":{"Line":12}},{"line":347,"address":[],"length":0,"stats":{"Line":24}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":12}},{"line":354,"address":[],"length":0,"stats":{"Line":24}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":12}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":12}},{"line":449,"address":[],"length":0,"stats":{"Line":2}},{"line":452,"address":[],"length":0,"stats":{"Line":2}},{"line":454,"address":[],"length":0,"stats":{"Line":4}},{"line":455,"address":[],"length":0,"stats":{"Line":2}},{"line":457,"address":[],"length":0,"stats":{"Line":4}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}}],"covered":65,"coverable":158},{"path":["/","Users","yaleman","Projects","goatns","src","datastore.rs"],"content":"use std::str::from_utf8;\nuse std::sync::Arc;\nuse std::time::Duration;\n\nuse crate::db::{self, DBEntity, User, ZoneOwnership};\nuse crate::enums::{RecordClass, RecordType};\nuse crate::error::GoatNsError;\nuse crate::zones::{FileZone, ZoneRecord};\nuse log::debug;\nuse sqlx::{Pool, Sqlite};\nuse tokio::sync::mpsc;\nuse tokio::sync::oneshot;\nuse tracing::{error, instrument};\n\ntype Responder\u003cT\u003e = oneshot::Sender\u003cT\u003e;\n\n#[derive(Debug)]\n/// Commands that can be sent to the datastore\npub enum Command {\n    /// Query a record from the database\n    GetRecord {\n        /// Reversed vec of the name\n        name: Vec\u003cu8\u003e,\n        /// The type of record to get\n        rrtype: RecordType,\n        /// The class of record to get\n        rclass: RecordClass,\n        /// The response channel\n        resp: Responder\u003cOption\u003cZoneRecord\u003e\u003e,\n    },\n    /// Query a zone from the database\n    GetZone {\n        /// If you know the ID supply it\n        id: Option\u003ci64\u003e,\n        /// If you know the name supply it\n        name: Option\u003cString\u003e,\n        /// The response channel\n        resp: Responder\u003cOption\u003cFileZone\u003e\u003e,\n    },\n    /// Query a list of zones from the database\n    GetZoneNames {\n        /// Filter by user\n        user: User,\n        /// The offset to start at\n        offset: i64,\n        /// The number of records to return\n        limit: i64,\n        /// The response channel\n        resp: Responder\u003cVec\u003cFileZone\u003e\u003e,\n    },\n    /// Import a file directly into the database\n    ImportFile {\n        /// Filename to load\n        filename: String,\n        /// If you only want to import a single zone, specify the name\n        zone_name: Option\u003cString\u003e,\n        /// The response channel\n        resp: Responder\u003c()\u003e,\n    },\n    /// Shutdown the datastore\n    Shutdown,\n    /// Create a new zone\n    CreateZone {\n        /// Zone data\n        zone: FileZone,\n\n        /// Zone ownership\n        userid: i64,\n\n        /// The response channel\n        resp: Responder\u003cFileZone\u003e,\n    },\n    /// Delete a zone\n    DeleteZone,\n    /// update a zone\n    UpdateZone,\n    /// Delete user\n    DeleteUser,\n    /// Create a new user\n    CreateUser {\n        /// Username\n        username: String,\n        /// Reference from OIDC\n        authref: String,\n        /// Is this user an admin?\n        admin: bool,\n        /// Is this user disabled?\n        disabled: bool,\n        /// The response channel\n        resp: Responder\u003cbool\u003e,\n    },\n    /// Get a user\n    GetUser {\n        /// Database ID if you have it\n        id: Option\u003ci64\u003e,\n        /// username if you have it\n        username: Option\u003cString\u003e,\n        /// The response channel\n        resp: Responder\u003c()\u003e,\n    },\n    /// Update a user\n    UpdateUser,\n    /// Remove zone ownership (optionally include a user)\n    DeleteOwnership {\n        /// Zone ID\n        zoneid: i64,\n        /// User ID (db ID)\n        userid: Option\u003ci64\u003e,\n        /// The response channel\n        resp: Responder\u003c()\u003e,\n    },\n    /// Get ownership of a zone, or zones for a user\n    GetOwnership {\n        /// Zone ID\n        zoneid: Option\u003ci64\u003e,\n        /// User ID\n        userid: Option\u003ci64\u003e,\n        /// The response channel\n        resp: Responder\u003cVec\u003cArc\u003cZoneOwnership\u003e\u003e\u003e,\n    },\n    /// Create ownership of a zone\n    PostOwnership {\n        /// Zone ID\n        zoneid: i64,\n        /// User ID\n        userid: i64,\n        /// The response channel\n        resp: Responder\u003cZoneOwnership\u003e,\n    },\n}\n\nasync fn handle_get_command(\n    // database pool\n    conn: \u0026Pool\u003cSqlite\u003e,\n    // this is the result from the things in memory\n    // zone_get: Option\u003c\u0026ZoneRecord\u003e,\n    name: Vec\u003cu8\u003e,\n    rrtype: RecordType,\n    rclass: RecordClass,\n    resp: oneshot::Sender\u003cOption\u003cZoneRecord\u003e\u003e,\n) -\u003e Result\u003c(), String\u003e {\n    debug!(\n        \"query name={:?} rrtype={rrtype:?} rclass={rclass}\",\n        from_utf8(\u0026name).unwrap_or(\"-\"),\n    );\n\n    // query the database\n    let db_name =\n        from_utf8(\u0026name).map_err(|e| format!(\"Failed to convert name to utf8 - {e:?}\"))?;\n\n    let mut zr = ZoneRecord {\n        name: name.clone(),\n        typerecords: vec![],\n    };\n\n    match db::get_records(conn, db_name.to_string(), rrtype, rclass, true).await {\n        Ok(value) =\u003e zr.typerecords.extend(value),\n        Err(err) =\u003e {\n            log::error!(\"Failed to query db: {err:?}\")\n        }\n    };\n\n    // if let Some(value) = zone_get {\n    //     // check if the type we want is in there, and only return the matching records\n    //     let res: Vec\u003cInternalResourceRecord\u003e = value\n    //         .to_owned()\n    //         .typerecords\n    //         .into_iter()\n    //         .filter(|r| r == \u0026rrtype \u0026\u0026 r == \u0026rclass)\n    //         .collect();\n    //     zr.typerecords.extend(res);\n    // };\n\n    let result = match zr.typerecords.is_empty() {\n        true =\u003e None,\n        false =\u003e Some(zr),\n    };\n\n    if let Err(error) = resp.send(result) {\n        debug!(\"error sending response from data store: {:?}\", error)\n    };\n    Ok(())\n}\n\n/// Import a file directly into the database. Normally, you shouldn't use this directly, call it through calls to the datastore.\npub async fn handle_import_file(\n    pool: \u0026Pool\u003cSqlite\u003e,\n    filename: String,\n    zone_name: Option\u003cString\u003e,\n) -\u003e Result\u003c(), GoatNsError\u003e {\n    let mut txn = pool.begin().await?;\n\n    let zones: Vec\u003cFileZone\u003e = crate::zones::load_zones(\u0026filename)?;\n\n    let zones = match zone_name {\n        Some(name) =\u003e zones.into_iter().filter(|z| z.name == name).collect(),\n        None =\u003e zones,\n    };\n\n    if zones.is_empty() {\n        log::warn!(\"No zones to import!\");\n        return Err(GoatNsError::EmptyFile);\n    }\n\n    for zone in zones {\n        let _saved_zone = zone\n            .save_with_txn(\u0026mut txn)\n            .await\n            .inspect_err(|err| error!(\"Failed to save zone {}: {err:?}\", zone.name))?;\n        log::info!(\"Imported {}\", zone.name);\n    }\n    txn.commit()\n        .await\n        .inspect_err(|err| log::error!(\"Failed to commit transaction! {:?}\", err))?;\n    log::info!(\"Completed import process\");\n    Ok(())\n}\n\nasync fn handle_get_zone(\n    tx: oneshot::Sender\u003cOption\u003cFileZone\u003e\u003e,\n    pool: \u0026Pool\u003cSqlite\u003e,\n    id: Option\u003ci64\u003e,\n    name: Option\u003cString\u003e,\n) -\u003e Result\u003c(), GoatNsError\u003e {\n    let mut txn = pool.begin().await?;\n\n    let zone = crate::db::get_zone_with_txn(\u0026mut txn, id, name).await?;\n\n    tx.send(zone).map_err(|e| {\n        GoatNsError::SendError(format!(\"Failed to send response on tokio channel: {:?}\", e))\n    })\n}\n\nasync fn handle_get_zone_names(\n    user: User,\n    tx: oneshot::Sender\u003cVec\u003cFileZone\u003e\u003e,\n    pool: \u0026Pool\u003cSqlite\u003e,\n    offset: i64,\n    limit: i64,\n) -\u003e Result\u003c(), GoatNsError\u003e {\n    let mut txn = pool.begin().await?;\n\n    log::debug!(\"handle_get_zone_names: user={user:?}\");\n    let zones = user.get_zones_for_user(\u0026mut txn, offset, limit).await?;\n\n    log::debug!(\"handle_get_zone_names: {zones:?}\");\n    tx.send(zones).map_err(|e| {\n        GoatNsError::SendError(format!(\"Failed to send response on tokio channel: {:?}\", e))\n    })\n}\n\n#[instrument(level = \"info\", skip(connpool))]\npub(crate) async fn handle_message(cmd: Command, connpool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003c(), String\u003e {\n    match cmd {\n        Command::GetZone { id, name, resp } =\u003e {\n            let res = handle_get_zone(resp, connpool, id, name).await;\n            if let Err(e) = res {\n                log::error!(\"{e:?}\")\n            };\n        }\n        Command::GetZoneNames {\n            resp,\n            user,\n            offset,\n            limit,\n        } =\u003e {\n            let res = handle_get_zone_names(user, resp, connpool, offset, limit).await;\n            if let Err(e) = res {\n                log::error!(\"{e:?}\")\n            };\n        }\n        Command::Shutdown =\u003e {\n            #[cfg(test)]\n            println!(\"### Datastore was sent shutdown message, shutting down.\");\n            log::info!(\"Datastore was sent shutdown message, shutting down.\");\n            return Err(\"Datastore was sent shutdown message, shutting down.\".to_string());\n        }\n        Command::ImportFile {\n            filename,\n            resp,\n            zone_name,\n        } =\u003e {\n            handle_import_file(connpool, filename, zone_name)\n                .await\n                .map_err(|e| format!(\"{e:?}\"))?;\n            match resp.send(()) {\n                Ok(_) =\u003e log::info!(\"DS Sent Success\"),\n                Err(err) =\u003e {\n                    let res = format!(\"Failed to send response: {err:?}\");\n                    log::info!(\"{res}\");\n                }\n            }\n        }\n        Command::GetRecord {\n            name,\n            rrtype,\n            rclass,\n            resp,\n        } =\u003e {\n            let res = handle_get_command(connpool, name, rrtype, rclass, resp).await;\n            if let Err(e) = res {\n                log::error!(\"{e:?}\")\n            };\n        }\n        Command::CreateZone { zone, userid, resp } =\u003e {\n            match zone.save(connpool).await {\n                Ok(zone) =\u003e {\n                    // TODO: create the ownership\n                    if let Some(zoneid) = zone.id {\n                        ZoneOwnership {\n                            id: None,\n                            userid,\n                            zoneid,\n                        }\n                        .save(connpool)\n                        .await\n                        .map_err(|e| format!(\"{e:?}\"))?;\n                    }\n\n                    if let Err(err) = resp.send(*zone.clone()) {\n                        log::error!(\"Failed to send message back to caller after creating zone {zone:?}: {err:?}\");\n                    } else {\n                        log::info!(\"Created zone: {:?}\", zone);\n                    }\n                }\n                Err(err) =\u003e {\n                    log::error!(\"Failed to create zone: {zone:?} {err:?}\");\n                }\n            };\n        }\n        Command::DeleteZone =\u003e {\n            error!(\"Unimplemented: Command::DeleteZone\")\n        }\n        Command::UpdateZone =\u003e {\n            error!(\"Unimplemented: Command::PatchZone\")\n        }\n        Command::CreateUser {\n            username,\n            authref,\n            admin,\n            disabled,\n            resp,\n        } =\u003e {\n            let new_user = User {\n                username: username.clone(),\n                authref: Some(authref.clone()),\n                admin,\n                disabled,\n                ..Default::default()\n            };\n            log::debug!(\"Creating: {new_user:?}\");\n            let res = match new_user.save(connpool).await {\n                Ok(_) =\u003e true,\n                Err(error) =\u003e {\n                    log::error!(\"Failed to create {username}: {error:?}\");\n                    false\n                }\n            };\n            if let Err(error) = resp.send(res) {\n                log::error!(\"Failed to send message back to caller: {error:?}\");\n            }\n        }\n        Command::DeleteUser =\u003e error!(\"Unimplemented: Command::DeleteUser\"),\n        Command::GetUser { .. } =\u003e error!(\"Unimplemented: Command::GetUser\"),\n        Command::UpdateUser =\u003e error!(\"Unimplemented: Command::PatchUser\"),\n        Command::DeleteOwnership { .. } =\u003e error!(\"Unimplemented: Command::DeleteOwnership\"),\n        Command::GetOwnership {\n            zoneid: _,\n            userid,\n            resp,\n        } =\u003e {\n            if let Some(userid) = userid {\n                match ZoneOwnership::get_all_user(connpool, userid).await {\n                    Ok(zone) =\u003e {\n                        if let Err(err) = resp.send(zone) {\n                            error!(\"Failed to send zone_ownership response: {err:?}\")\n                        };\n                    }\n                    Err(err) =\u003e {\n                        error!(\"Failed to get all zone_ownership for user {userid}: {err:?}\")\n                    }\n                }\n            } else {\n                error!(\"Unmatched arm in getownership\")\n            }\n        }\n        Command::PostOwnership { .. } =\u003e {\n            error!(\"Unimplemented command: Command::PostOwnership\")\n        }\n    }\n    Ok(())\n}\n\n/// Manages the datastore, waits for signals from the server instances and responds with data\npub async fn manager(\n    mut rx: mpsc::Receiver\u003ccrate::datastore::Command\u003e,\n    connpool: Pool\u003cSqlite\u003e,\n    cron_db_cleanup_timer: Option\u003cDuration\u003e,\n) -\u003e Result\u003c(), String\u003e {\n    if let Some(timer) = cron_db_cleanup_timer {\n        log::debug!(\"Spawning DB cron cleanup task\");\n        tokio::spawn(db::cron_db_cleanup(connpool.clone(), timer, None));\n    }\n\n    while let Some(cmd) = rx.recv().await {\n        if handle_message(cmd, \u0026connpool).await.is_err() {\n            break;\n        };\n    }\n    #[cfg(test)]\n    println!(\"### manager is done!\");\n    Ok(())\n}\n","traces":[{"line":132,"address":[],"length":0,"stats":{"Line":2}},{"line":142,"address":[],"length":0,"stats":{"Line":2}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":2}},{"line":149,"address":[],"length":0,"stats":{"Line":2}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":4}},{"line":157,"address":[],"length":0,"stats":{"Line":2}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":2}},{"line":175,"address":[],"length":0,"stats":{"Line":2}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":2}},{"line":186,"address":[],"length":0,"stats":{"Line":3}},{"line":191,"address":[],"length":0,"stats":{"Line":12}},{"line":193,"address":[],"length":0,"stats":{"Line":6}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":9}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":9}},{"line":206,"address":[],"length":0,"stats":{"Line":3}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":124}},{"line":209,"address":[],"length":0,"stats":{"Line":6}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":3}},{"line":213,"address":[],"length":0,"stats":{"Line":3}},{"line":214,"address":[],"length":0,"stats":{"Line":6}},{"line":215,"address":[],"length":0,"stats":{"Line":3}},{"line":216,"address":[],"length":0,"stats":{"Line":3}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":10}},{"line":400,"address":[],"length":0,"stats":{"Line":10}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":16}},{"line":406,"address":[],"length":0,"stats":{"Line":8}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}}],"covered":26,"coverable":60},{"path":["/","Users","yaleman","Projects","goatns","src","db","entities","mod.rs"],"content":"//! `SeaORM` Entity. Generated by sea-orm-codegen 0.12.15\n\npub mod prelude;\n\npub mod ownership;\npub mod records;\npub mod sessions;\npub mod user_tokens;\npub mod users;\npub mod zones;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","db","entities","ownership.rs"],"content":"//! `SeaORM` Entity. Generated by sea-orm-codegen 0.12.15\n\nuse sea_orm::entity::prelude::*;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Eq)]\n#[sea_orm(table_name = \"ownership\")]\npub struct Model {\n    #[sea_orm(primary_key, auto_increment = false)]\n    pub id: u64,\n    pub zoneid: i32,\n    pub userid: i32,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::users::Entity\",\n        from = \"Column::Userid\",\n        to = \"super::users::Column::Id\",\n        on_update = \"Cascade\",\n        on_delete = \"Cascade\"\n    )]\n    Users,\n    #[sea_orm(\n        belongs_to = \"super::zones::Entity\",\n        from = \"Column::Zoneid\",\n        to = \"super::zones::Column::Id\",\n        on_update = \"Cascade\",\n        on_delete = \"Cascade\"\n    )]\n    Zones,\n}\n\nimpl Related\u003csuper::users::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Users.def()\n    }\n}\n\nimpl Related\u003csuper::zones::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Zones.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","Users","yaleman","Projects","goatns","src","db","entities","prelude.rs"],"content":"//! `SeaORM` Entity. Generated by sea-orm-codegen 0.12.15\n\n// pub(crate) use super::ownership::Entity as Ownership;\n// pub(crate) use super::records::Entity as Records;\n// pub(crate) use super::sessions::Entity as Sessions;\n// pub(crate) use super::user_tokens::Entity as UserTokens;\n// pub(crate) use super::users::Entity as Users;\n// pub(crate) use super::zones::Entity as Zones;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","db","entities","records.rs"],"content":"//! `SeaORM` Entity. Generated by sea-orm-codegen 0.12.15\n\nuse sea_orm::entity::prelude::*;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Eq)]\n#[sea_orm(table_name = \"records\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: u64,\n    pub zoneid: i32,\n    pub name: Option\u003cString\u003e,\n    pub ttl: Option\u003ci32\u003e,\n    pub rrtype: i32,\n    pub rclass: i32,\n    pub rdata: String,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::zones::Entity\",\n        from = \"Column::Zoneid\",\n        to = \"super::zones::Column::Id\",\n        on_update = \"Cascade\",\n        on_delete = \"Cascade\"\n    )]\n    Zones,\n}\n\nimpl Related\u003csuper::zones::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Zones.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","Users","yaleman","Projects","goatns","src","db","entities","sessions.rs"],"content":"//! `SeaORM` Entity. Generated by sea-orm-codegen 0.12.15\n\nuse sea_orm::entity::prelude::*;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Eq)]\n#[sea_orm(table_name = \"sessions\")]\npub struct Model {\n    #[sea_orm(primary_key, auto_increment = false)]\n    pub id: String,\n    pub data: Vec\u003cu8\u003e,\n    pub expiry_date: i32,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","db","entities","user_tokens.rs"],"content":"//! `SeaORM` Entity. Generated by sea-orm-codegen 0.12.15\n\nuse sea_orm::entity::prelude::*;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Eq)]\n#[sea_orm(table_name = \"user_tokens\")]\npub struct Model {\n    #[sea_orm(primary_key, auto_increment = false)]\n    pub id: u64,\n    pub name: String,\n    pub issued: String,\n    pub expiry: Option\u003cString\u003e,\n    pub tokenkey: String,\n    pub tokenhash: String,\n    pub userid: i32,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::users::Entity\",\n        from = \"Column::Userid\",\n        to = \"super::users::Column::Id\",\n        on_update = \"Cascade\",\n        on_delete = \"Cascade\"\n    )]\n    Users,\n}\n\nimpl Related\u003csuper::users::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Users.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","Users","yaleman","Projects","goatns","src","db","entities","users.rs"],"content":"//! `SeaORM` Entity. Generated by sea-orm-codegen 0.12.15\n\nuse sea_orm::entity::prelude::*;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Eq)]\n#[sea_orm(table_name = \"users\")]\npub struct Model {\n    #[sea_orm(primary_key, auto_increment = false)]\n    pub id: u64,\n    pub displayname: String,\n    pub username: String,\n    pub email: String,\n    pub disabled: Vec\u003cu8\u003e,\n    pub authref: Option\u003cString\u003e,\n    pub admin: Option\u003cVec\u003cu8\u003e\u003e,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(has_many = \"super::ownership::Entity\")]\n    Ownership,\n    #[sea_orm(has_many = \"super::user_tokens::Entity\")]\n    UserTokens,\n}\n\nimpl Related\u003csuper::ownership::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Ownership.def()\n    }\n}\n\nimpl Related\u003csuper::user_tokens::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::UserTokens.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","Users","yaleman","Projects","goatns","src","db","entities","zones.rs"],"content":"//! `SeaORM` Entity. Generated by sea-orm-codegen 0.12.15\n\nuse sea_orm::entity::prelude::*;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Eq)]\n#[sea_orm(table_name = \"zones\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: u64,\n    pub name: String,\n    pub rname: String,\n    pub serial: i32,\n    pub refresh: i32,\n    pub retry: i32,\n    pub expire: i32,\n    pub minimum: i32,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(has_many = \"super::ownership::Entity\")]\n    Ownership,\n    #[sea_orm(has_many = \"super::records::Entity\")]\n    Records,\n}\n\nimpl Related\u003csuper::ownership::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Ownership.def()\n    }\n}\n\nimpl Related\u003csuper::records::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Records.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["/","Users","yaleman","Projects","goatns","src","db","mod.rs"],"content":"use crate::error::GoatNsError;\nuse crate::resourcerecord::SetTTL;\nuse std::str::FromStr;\nuse std::sync::Arc;\nuse std::time::Duration;\n\nuse crate::config::ConfigFile;\nuse crate::enums::{RecordClass, RecordType};\n\nuse crate::resourcerecord::InternalResourceRecord;\nuse crate::zones::{FileZone, FileZoneRecord};\nuse async_trait::async_trait;\nuse chrono::{DateTime, Utc};\nuse concread::cowcell::asynch::CowCellReadTxn;\nuse openidconnect::SubjectIdentifier;\nuse serde::{Deserialize, Serialize};\nuse sqlx::sqlite::{SqliteArguments, SqliteConnectOptions, SqliteRow};\nuse sqlx::{Arguments, ConnectOptions, FromRow, Pool, Row, Sqlite, SqliteConnection, SqlitePool};\nuse tokio::time;\nuse tracing::{debug, error, instrument};\n\npub(crate) mod entities;\n#[cfg(test)]\npub mod test;\n\nconst SQL_VIEW_RECORDS: \u0026str = \"records_merged\";\n\n/// Setup the database connection and pool\npub async fn get_conn(\n    config_reader: CowCellReadTxn\u003cConfigFile\u003e,\n) -\u003e Result\u003cSqlitePool, GoatNsError\u003e {\n    let db_path: \u0026str = \u0026shellexpand::full(\u0026config_reader.sqlite_path)\n        .map_err(|err| GoatNsError::StartupError(err.to_string()))?;\n    let db_url = format!(\"sqlite://{db_path}?mode=rwc\");\n    log::debug!(\"Opening Database: {db_url}\");\n\n    let options = SqliteConnectOptions::from_str(\u0026db_url)?;\n    let options = if config_reader.sql_log_statements {\n        options.log_statements(log::LevelFilter::Trace)\n    } else {\n        options.log_statements(log::LevelFilter::Off)\n    };\n    // log anything that takes longer than 1s\n    let options = options.log_slow_statements(\n        log::LevelFilter::Warn,\n        Duration::from_secs(config_reader.sql_log_slow_duration),\n    );\n\n    SqlitePool::connect_with(options).await.map_err(|err| {\n        error!(\"Error opening SQLite DB ({db_url:?}): {err:?}\");\n        err.into()\n    })\n}\n\n/// Do the basic setup and checks (if we write any)\npub async fn start_db(pool: \u0026SqlitePool) -\u003e Result\u003c(), GoatNsError\u003e {\n    FileZone::create_table(pool).await?;\n    User::create_table(pool).await?;\n    UserAuthToken::create_table(pool).await?;\n    FileZoneRecord::create_table(pool).await?;\n    ZoneOwnership::create_table(pool).await?;\n    log::info!(\"Completed DB Startup!\");\n    Ok(())\n}\n\n#[derive(Clone, Deserialize, Serialize, Debug)]\n/// DB Representation of a user\npub struct User {\n    /// the user's ID\n    pub id: Option\u003ci64\u003e,\n    /// the user's display name\n    pub displayname: String,\n    /// the user's username\n    pub username: String,\n    /// the user's email address\n    pub email: String,\n    /// is the user disabled?\n    pub disabled: bool,\n    /// the user's authref from OIDC\n    pub authref: Option\u003cString\u003e,\n    /// is the user an admin?\n    pub admin: bool,\n}\n\nimpl Default for User {\n    fn default() -\u003e Self {\n        User {\n            id: None,\n            displayname: \"Anonymous Kid\".to_string(),\n            username: \"\".to_string(),\n            email: \"\".to_string(),\n            disabled: true,\n            authref: None,\n            admin: false,\n        }\n    }\n}\n\nimpl User {\n    // Query the DB looking for a user\n    // pub async fn get_by_email(pool: \u0026SqlitePool, email: String) -\u003e Result\u003cSelf, GoatNsError\u003e {\n    //     let res = sqlx::query(\n    //         \"\n    //         select * from users\n    //         where email = ?\n    //         \",\n    //     )\n    //     .bind(email)\n    //     .fetch_one(pool)\n    //     .await?;\n\n    //     Ok(User::from(res))\n    // }\n\n    /// Query the DB looking for a user\n    pub async fn get_by_subject(\n        pool: \u0026SqlitePool,\n        subject: \u0026SubjectIdentifier,\n    ) -\u003e Result\u003cOption\u003cSelf\u003e, GoatNsError\u003e {\n        match sqlx::query(\n            \"\n            select * from users\n            where authref = ?\n            \",\n        )\n        .bind(subject.to_string())\n        .fetch_one(pool)\n        .await\n        {\n            Ok(val) =\u003e Ok(Some(val.into())),\n            Err(sqlx::Error::RowNotFound) =\u003e Ok(None),\n            Err(err) =\u003e Err(err.into()),\n        }\n    }\n\n    #[instrument(skip(txn))]\n    pub async fn get_zones_for_user(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n        offset: i64,\n        limit: i64,\n    ) -\u003e Result\u003cVec\u003cFileZone\u003e, GoatNsError\u003e {\n        let query_string = match self.admin {\n            true =\u003e {\n                \"SELECT *\n                    FROM zones\n                    LIMIT ?1 OFFSET ?2\"\n            }\n            false =\u003e {\n                \"SELECT *\n                    FROM zones, ownership\n                    WHERE zones.id = ownership.zoneid\n                        AND ownership.userid = ?3\n                    LIMIT ?1 OFFSET ?2\"\n            }\n        };\n        log::trace!(\n            \"get_zones_for_user query: {:?}\",\n            query_string.replace('\\n', \"\")\n        );\n        log::trace!(\"Building query\");\n        let query = sqlx::query(query_string).bind(limit).bind(offset);\n        let query = match self.admin {\n            true =\u003e query,\n            false =\u003e query.bind(self.id),\n        };\n        log::trace!(\"About to send query\");\n\n        let rows: Vec\u003cFileZone\u003e = match query.fetch_all(txn).await {\n            Err(error) =\u003e {\n                log::error!(\"Error: {error:?}\");\n                vec![]\n            }\n            Ok(rows) =\u003e rows.into_iter().map(|row| row.into()).collect(),\n        };\n        Ok(rows)\n    }\n\n    #[instrument(skip(pool))]\n    pub async fn get_token(\n        pool: \u0026mut Pool\u003cSqlite\u003e,\n        tokenkey: \u0026str,\n    ) -\u003e Result\u003cTokenSearchRow, GoatNsError\u003e {\n        let mut txn = pool.begin().await?;\n        let res: TokenSearchRow = sqlx::query_as(\n            \"SELECT users.id as userid, users.displayname,  users.username, users.authref, users.email, users.disabled, users.authref, users.admin, tokenhash, tokenkey\n            FROM user_tokens, users\n            WHERE\n                users.disabled=0 AND\n                user_tokens.tokenkey=? AND\n                user_tokens.userid=users.id\")\n            .bind(tokenkey)\n            .fetch_one(\u0026mut * txn).await?;\n\n        Ok(res)\n    }\n}\n\n#[derive(Debug, Deserialize, Serialize)]\npub struct TokenSearchRow {\n    pub tokenhash: String,\n    pub user: User,\n    pub tokenkey: String,\n}\n\nimpl FromRow\u003c'_, SqliteRow\u003e for TokenSearchRow {\n    fn from_row(input: \u0026SqliteRow) -\u003e Result\u003cSelf, sqlx::Error\u003e {\n        let user = User {\n            id: input.get(\"userid\"),\n            displayname: input.get(\"displayname\"),\n            username: input.get(\"username\"),\n            email: input.get(\"email\"),\n            disabled: input.get(\"disabled\"),\n            authref: input.get(\"authref\"),\n            admin: input.get(\"admin\"),\n        };\n        Ok(TokenSearchRow {\n            tokenkey: input.get(\"tokenkey\"),\n            tokenhash: input.get(\"tokenhash\"),\n            user,\n        })\n    }\n}\n\nimpl From\u003cSqliteRow\u003e for User {\n    fn from(row: SqliteRow) -\u003e Self {\n        let id: i64 = row.get(\"id\");\n        let displayname: String = row.get(\"displayname\");\n        let username: String = row.get(\"username\");\n        let email: String = row.get(\"email\");\n        let disabled: bool = row.get(\"disabled\");\n        let authref: Option\u003cString\u003e = row.get(\"authref\");\n        let admin: bool = row.get(\"admin\");\n        User {\n            id: Some(id),\n            displayname,\n            username,\n            email,\n            disabled,\n            authref,\n            admin,\n        }\n    }\n}\n\n#[derive(Deserialize, Serialize, Debug)]\npub struct ZoneOwnership {\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub id: Option\u003ci64\u003e,\n    pub userid: i64,\n    pub zoneid: i64,\n}\n\nimpl ZoneOwnership {\n    #[allow(dead_code, unused_variables)]\n    pub async fn delete(\u0026self, pool: \u0026SqlitePool) -\u003e Result\u003c(), GoatNsError\u003e {\n        // TODO: test ownership delete\n        let res = sqlx::query(\"DELETE FROM ownership WHERE zoneid = ? AND userid = ?\")\n            .bind(self.zoneid)\n            .bind(self.userid)\n            .execute(\u0026mut *pool.acquire().await?)\n            .await?;\n        Ok(())\n    }\n    #[allow(dead_code, unused_variables)]\n    pub async fn delete_for_user(self, pool: \u0026SqlitePool) -\u003e Result\u003cUser, GoatNsError\u003e {\n        // TODO: test user delete\n        // TODO: delete all ownership records\n        error!(\"Unimplemented: ZoneOwnership::delete_for_user\");\n        Err(sqlx::Error::RowNotFound.into())\n    }\n\n    // get the thing by the other thing\n    pub async fn get_ownership_by_userid\u003c't\u003e(\n        txn: \u0026mut SqliteConnection,\n        userid: \u0026i64,\n        zoneid: \u0026i64,\n    ) -\u003e Result\u003cOption\u003cZoneOwnership\u003e, GoatNsError\u003e {\n        match sqlx::query(\n            \"select users.username, zones.name, zones.id as zoneid, ownership.id as id, userid\n        from users, ownership, zones\n        where ownership.userid = ? AND ownership.zoneid = ? AND (ownership.userid = users.id AND\n            users.disabled=0 and\n            (zones.id = ownership.zoneid OR\n            users.admin=1\n            ))\",\n        )\n        .bind(userid)\n        .bind(zoneid)\n        .fetch_one(txn)\n        .await\n        {\n            Ok(val) =\u003e Ok(Some(val.into())),\n            Err(sqlx::Error::RowNotFound) =\u003e Ok(None),\n            Err(err) =\u003e Err(err.into()),\n        }\n    }\n}\n\n/// Query the zones table, name_or_id can be the zoneid or the name - if they match then you're bad and you should feel bad.\npub async fn get_zone_with_txn(\n    txn: \u0026mut SqliteConnection,\n    id: Option\u003ci64\u003e,\n    name: Option\u003cString\u003e,\n) -\u003e Result\u003cOption\u003cFileZone\u003e, GoatNsError\u003e {\n    let result = sqlx::query(\n        \"SELECT\n        id, name, rname, serial, refresh, retry, expire, minimum\n        FROM zones\n        WHERE name = ? or id = ? LIMIT 1\",\n    )\n    .bind(name)\n    .bind(id)\n    .fetch_optional(\u0026mut *txn)\n    .await?;\n    let mut zone = match result {\n        None =\u003e return Ok(None),\n        Some(row) =\u003e {\n            #[cfg(test)]\n            eprintln!(\"Building FileZone\");\n            FileZone {\n                id: row.get(\"id\"),\n                name: row.get(1),\n                rname: row.get(2),\n                serial: row.get(3),\n                refresh: row.get(4),\n                retry: row.get(5),\n                expire: row.get(6),\n                minimum: row.get(7),\n                records: vec![],\n            }\n        }\n    };\n\n    let zone_id = match zone.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            return Err(GoatNsError::InvalidValue(\"Zone ID is None\".to_string()));\n        }\n    };\n\n    let result = sqlx::query(\n        \"SELECT\n        id, zoneid, name, ttl, rrtype, rclass, rdata\n        FROM records\n        WHERE zoneid = ?\",\n    )\n    .bind(zone_id)\n    .fetch_all(\u0026mut *txn)\n    .await?;\n\n    zone.records = result\n        .iter()\n        .filter_map(|r| match FileZoneRecord::try_from(r) {\n            Ok(val) =\u003e Some(val),\n            Err(_) =\u003e None,\n        })\n        .collect();\n    Ok(Some(zone))\n}\n\nimpl TryFrom\u003cSqliteRow\u003e for InternalResourceRecord {\n    type Error = GoatNsError;\n    fn try_from(row: SqliteRow) -\u003e Result\u003cInternalResourceRecord, Self::Error\u003e {\n        let record_id: i64 = row.get(0);\n        let record_class: u16 = row.get(3);\n        let record_type: u16 = row.get(4);\n        let rrtype: \u0026str = RecordType::from(\u0026record_type).into();\n        let rdata: String = row.get(5);\n        let ttl: u32 = row.get(6);\n        InternalResourceRecord::try_from(FileZoneRecord {\n            name: row.get(\"name\"),\n            ttl,\n            zoneid: row.get(\"zoneid\"),\n            id: Some(record_id),\n            rrtype: rrtype.to_string(),\n            class: RecordClass::from(\u0026record_class),\n            rdata,\n        })\n    }\n}\n\n/// Pull a vec of [InternalResourceRecord]s directly from the database\n///\n/// Setting normalize_ttls=true sets the TTL on all records to the LOWEST of the returned records.\npub async fn get_records(\n    conn: \u0026Pool\u003cSqlite\u003e,\n    name: String,\n    rrtype: RecordType,\n    rclass: RecordClass,\n    normalize_ttls: bool,\n) -\u003e Result\u003cVec\u003cInternalResourceRecord\u003e, GoatNsError\u003e {\n    let query = format!(\n        \"SELECT\n        record_id, zoneid, name, rclass, rrtype, rdata, ttl\n        FROM {}\n        WHERE name = ? AND rrtype = ? AND rclass = ?\",\n        SQL_VIEW_RECORDS\n    );\n\n    let res = sqlx::query(\u0026query)\n        .bind(\u0026name)\n        .bind(rrtype as u16)\n        .bind(rclass)\n        .fetch_all(\u0026mut *conn.acquire().await?)\n        .await?;\n\n    if res.is_empty() {\n        eprintln!(\"No results returned for {name} {rrtype} {rclass}\");\n        log::trace!(\"No results returned for {name} \");\n    }\n\n    let mut results: Vec\u003cInternalResourceRecord\u003e = vec![];\n    for row in res {\n        if let Ok(irr) = InternalResourceRecord::try_from(row) {\n            results.push(irr);\n        }\n    }\n\n    // skip the normalisation step if we've got 0 or 1 result.\n    if results.len() \u003c= 1 {\n        return Ok(results);\n    }\n\n    let results = match normalize_ttls {\n        true =\u003e {\n            let min_ttl = results.iter().map(|r| r.ttl()).min();\n            let min_ttl = match min_ttl {\n                Some(val) =\u003e val.to_owned(),\n                None =\u003e {\n                    log::error!(\"Somehow failed to get minimum TTL from query\");\n                    1\n                }\n            };\n\n            results\n                .to_vec()\n                .iter()\n                .map(|r| r.clone().set_ttl(min_ttl))\n                .collect()\n        }\n        false =\u003e {\n            #[cfg(test)]\n            println!(\"not normalizing ttls...\");\n            results\n        }\n    };\n    Ok(results)\n}\n\nimpl FileZone {\n    pub async fn with_zone_records(self, txn: \u0026mut SqliteConnection) -\u003e Self {\n        let records: Vec\u003cFileZoneRecord\u003e = match sqlx::query(\n            \"SELECT\n            id, zoneid, name, ttl, rrtype, rclass, rdata\n            FROM records\n            WHERE zoneid = ?\",\n        )\n        .bind(self.id)\n        .fetch_all(txn)\n        .await\n        {\n            Ok(val) =\u003e {\n                let res: Vec\u003cFileZoneRecord\u003e = val.into_iter().flat_map(|v| v.try_into()).collect();\n                res\n            }\n            Err(_) =\u003e vec![],\n        };\n\n        Self { records, ..self }\n    }\n\n    /// the records for the zone\n    pub async fn get_zone_records(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cVec\u003cFileZoneRecord\u003e, GoatNsError\u003e {\n        match self.id {\n            Some(id) =\u003e {\n                let res = sqlx::query(\n                    \"SELECT\n                    id, zoneid, name, ttl, rrtype, rclass, rdata\n                    FROM records\n                    WHERE zoneid = ?\",\n                )\n                .bind(id)\n                .fetch_all(\u0026mut *txn)\n                .await?;\n\n                if res.is_empty() {\n                    log::trace!(\"No results returned for zoneid={:?}\", id);\n                }\n\n                let results: Vec\u003cFileZoneRecord\u003e = res\n                    .iter()\n                    .filter_map(|r| FileZoneRecord::try_from(r).ok())\n                    .collect();\n\n                log::trace!(\"results: {results:?}\");\n                Ok(results)\n            }\n            None =\u003e Err(GoatNsError::InvalidValue(\"Zone ID is None\".to_string())),\n        }\n    }\n\n    pub async fn get_orphans(pool: \u0026SqlitePool) -\u003e Result\u003cVec\u003cFileZone\u003e, GoatNsError\u003e {\n        let res = sqlx::query(\n            \"\n            SELECT name, userid from zones\n            LEFT OUTER JOIN ownership on zones.id = ownership.zoneid\n            where userid IS NULL\",\n        )\n        .fetch_all(\u0026mut *pool.acquire().await?)\n        .await?;\n        let res: Vec\u003cFileZone\u003e = res.into_iter().map(|r| r.into()).collect();\n        Ok(res)\n    }\n}\n\npub async fn export_zone_json(pool: \u0026SqlitePool, id: i64) -\u003e Result\u003cString, String\u003e {\n    let zone = FileZone::get(pool, id)\n        .await\n        .map_err(|e| format!(\"{e:?}\"))?;\n    zone.json()\n}\n\n#[async_trait]\npub trait DBEntity: Send {\n    const TABLE: \u0026'static str;\n\n    async fn create_table(pool: \u0026SqlitePool) -\u003e Result\u003c(), GoatNsError\u003e;\n\n    /// Get the entity\n    async fn get(pool: \u0026Pool\u003cSqlite\u003e, id: i64) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e;\n    async fn get_with_txn\u003c't\u003e(\n        _txn: \u0026mut SqliteConnection,\n        _id: \u0026i64,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e;\n    async fn get_by_name\u003c't\u003e(\n        txn: \u0026mut SqliteConnection,\n        name: \u0026str,\n    ) -\u003e Result\u003cOption\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e;\n    async fn get_all_by_name\u003c't\u003e(\n        txn: \u0026mut SqliteConnection,\n        name: \u0026str,\n    ) -\u003e Result\u003cVec\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e;\n    async fn get_all_user(pool: \u0026Pool\u003cSqlite\u003e, id: i64) -\u003e Result\u003cVec\u003cArc\u003cSelf\u003e\u003e, GoatNsError\u003e;\n    /// save the entity to the database\n\n    async fn save(\u0026self, pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e;\n    /// save the entity to the database, but you're in a transaction\n\n    async fn save_with_txn\u003c't\u003e(\u0026self, txn: \u0026mut SqliteConnection)\n        -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e;\n    /// create from scratch\n    async fn create_with_txn\u003c't\u003e(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e;\n    /// create from scratch\n    async fn update_with_txn\u003c't\u003e(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e;\n\n    /// delete the entity from the database\n    async fn delete(\u0026self, pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003c(), GoatNsError\u003e;\n    /// delete the entity from the database, but you're in a transaction\n    async fn delete_with_txn(\u0026self, txn: \u0026mut SqliteConnection) -\u003e Result\u003c(), GoatNsError\u003e;\n\n    fn json(\u0026self) -\u003e Result\u003cString, String\u003e\n    where\n        Self: Serialize,\n    {\n        serde_json::to_string_pretty(\u0026self).map_err(|e| e.to_string())\n    }\n}\n\n#[async_trait]\nimpl DBEntity for FileZone {\n    const TABLE: \u0026'static str = \"zones\";\n\n    async fn create_table(pool: \u0026SqlitePool) -\u003e Result\u003c(), GoatNsError\u003e {\n        let mut tx = pool.begin().await?;\n\n        log::debug!(\"Ensuring DB Zones table exists\");\n        sqlx::query(\n            r#\"CREATE TABLE IF NOT EXISTS\n            zones (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                name TEXT NOT NULL,\n                rname TEXT NOT NULL,\n                serial INTEGER NOT NULL,\n                refresh INTEGER NOT NULL,\n                retry INTEGER NOT NULL,\n                expire INTEGER NOT NULL,\n                minimum INTEGER NOT NULL\n            )\"#,\n        )\n        .execute(\u0026mut *tx)\n        .await?;\n\n        // .execute(tx).await;\n        log::debug!(\"Ensuring DB Records index exists\");\n        sqlx::query(\n            \"CREATE UNIQUE INDEX\n            IF NOT EXISTS\n            ind_zones\n            ON zones (\n                id,name\n            )\",\n        )\n        .execute(\u0026mut *tx)\n        .await?;\n        tx.commit().await?;\n        Ok(())\n    }\n\n    /// Get by id\n    async fn get(pool: \u0026Pool\u003cSqlite\u003e, id: i64) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let mut txn = pool.begin().await?;\n        Self::get_with_txn(\u0026mut txn, \u0026id).await\n    }\n\n    async fn get_with_txn\u003c't\u003e(\n        txn: \u0026mut SqliteConnection,\n        id: \u0026i64,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let res = sqlx::query(\n            \"SELECT\n            *\n            FROM zones\n            WHERE id = ? LIMIT 1\",\n        )\n        .bind(id)\n        .fetch_one(\u0026mut *txn)\n        .await?;\n        let mut zone: FileZone = res.into();\n        log::debug!(\"got a zone: {zone:?}\");\n\n        if zone.id.is_none() {\n            return Err(sqlx::Error::RowNotFound.into());\n        }\n\n        let records = sqlx::query(\n            \"SELECT\n            id, zoneid, name, ttl, rrtype, rclass, rdata\n            FROM records\n            WHERE zoneid = ?\",\n        )\n        .bind(zone.id)\n        .fetch_all(txn)\n        .await?;\n\n        zone.records = records\n            .into_iter()\n            .filter_map(|r| match FileZoneRecord::try_from(r) {\n                Ok(val) =\u003e Some(val),\n                Err(_) =\u003e None,\n            })\n            .collect();\n        Ok(Box::new(zone))\n    }\n\n    async fn get_by_name\u003c't\u003e(\n        txn: \u0026mut SqliteConnection,\n        name: \u0026str,\n    ) -\u003e Result\u003cOption\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        match sqlx::query(\u0026format!(\"SELECT * from {} where name=?\", Self::TABLE))\n            .bind(name)\n            .fetch_one(\u0026mut *txn)\n            .await\n        {\n            Ok(val) =\u003e Ok(Some(Box::new(val.into()))),\n            Err(sqlx::Error::RowNotFound) =\u003e Ok(None),\n            Err(err) =\u003e Err(err.into()),\n        }\n    }\n    async fn get_all_by_name\u003c't\u003e(\n        _txn: \u0026mut SqliteConnection,\n        _name: \u0026str,\n    ) -\u003e Result\u003cVec\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        unimplemented!()\n    }\n    async fn get_all_user(\n        _pool: \u0026Pool\u003cSqlite\u003e,\n        _userid: i64,\n    ) -\u003e Result\u003cVec\u003cArc\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        unimplemented!()\n    }\n\n    /// save the entity to the database\n    async fn save(\u0026self, pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let mut txn = pool.begin().await?;\n        let res = self.save_with_txn(\u0026mut txn).await?;\n        txn.commit().await?;\n        // TODO: this needs to include the id\n        Ok(res)\n    }\n\n    /// save the entity to the database, but you're in a transaction\n    async fn save_with_txn\u003c't\u003e(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        // check the zone exists\n        let find_zone = match get_zone_with_txn(txn, None, Some(self.name.clone())).await {\n            Ok(val) =\u003e {\n                log::trace!(\"Found existing zone\");\n                val\n            }\n            Err(err) =\u003e {\n                // failed to query the DB\n                return Err(err);\n            }\n        };\n\n        let updated_zone: FileZone = match find_zone {\n            None =\u003e {\n                // if it's new, add it\n                #[cfg(test)]\n                eprintln!(\"Creating zone {self:?}\");\n                log::debug!(\"Creating zone {self:?}\");\n\n                // zone.create\n                let serial = self.serial.to_string();\n                let refresh = self.refresh.to_string();\n                let retry = self.retry.to_string();\n                let expire = self.expire.to_string();\n                let minimum = self.minimum.to_string();\n\n                sqlx::query(\n                    \"INSERT INTO zones (id, name, rname, serial, refresh, retry, expire, minimum)\n                        VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8)\",\n                )\n                .bind(self.id)\n                .bind(\u0026self.name)\n                .bind(\u0026self.rname)\n                .bind(\u0026serial)\n                .bind(\u0026refresh)\n                .bind(\u0026retry)\n                .bind(\u0026expire)\n                .bind(\u0026minimum)\n                .execute(\u0026mut *txn)\n                .await?;\n\n                #[cfg(not(test))]\n                log::debug!(\"Insert statement succeeded\");\n                #[cfg(test)]\n                eprintln!(\"Done creating zone\");\n                match get_zone_with_txn(txn, None, Some(self.name.clone())).await? {\n                    Some(val) =\u003e val,\n                    None =\u003e {\n                        return Err(sqlx::Error::RowNotFound.into());\n                    }\n                }\n            }\n            Some(ez) =\u003e {\n                if !self.matching_data(\u0026ez) {\n                    // update it if it's wrong\n\n                    log::debug!(\"Updating zone\");\n                    let mut new_zone = self.clone();\n                    new_zone.id = ez.id;\n\n                    let updated = new_zone.update_with_txn(txn).await?;\n\n                    log::debug!(\"Updated: {:?} record\", updated);\n                } else {\n                    log::debug!(\"Zone data is fine\")\n                }\n                match get_zone_with_txn(txn, None, Some(self.name.clone())).await? {\n                    Some(val) =\u003e val,\n                    None =\u003e {\n                        return Err(sqlx::Error::RowNotFound.into());\n                    }\n                }\n            }\n        };\n        log::trace!(\"Zone after update: {updated_zone:?}\");\n\n        // drop all the records\n        debug!(\"Dropping all records for zone {self:?}\");\n        // log::debug!(\"Dropping all records for zone {self:?}\");\n        sqlx::query(\"delete from records where zoneid = ?\")\n            .bind(updated_zone.id)\n            .execute(\u0026mut *txn)\n            .await?;\n\n        // add the records for the zone\n        for mut record in self.records.clone() {\n            record.zoneid = updated_zone.id;\n            #[cfg(test)]\n            eprintln!(\"Creating new zone record: {record:?}\");\n            log::trace!(\"Creating new zone record: {record:?}\");\n            if record.name == \"@\" {\n                record.name = \"\".to_string();\n            }\n            record.save_with_txn(txn).await?;\n        }\n\n        debug!(\"Done creating zone!\");\n\n        let res = Self {\n            id: updated_zone.id,\n            ..self.to_owned()\n        };\n        Ok(Box::new(res))\n    }\n\n    /// create from scratch\n    async fn create_with_txn\u003c't\u003e(\n        \u0026self,\n        _txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        error!(\"Unimplemented: FileZone::create_with_txn\");\n        Err(sqlx::Error::RowNotFound.into())\n    }\n    /// create from scratch\n    async fn update_with_txn\u003c't\u003e(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let _res = sqlx::query(\n            \"UPDATE zones\n            set rname = ?, serial = ?, refresh = ?, retry = ?, expire = ?, minimum =?\n            WHERE id = ?\",\n        )\n        .bind(\u0026self.rname)\n        .bind(self.serial)\n        .bind(self.refresh)\n        .bind(self.retry)\n        .bind(self.expire)\n        .bind(self.minimum)\n        .bind(self.id)\n        .execute(txn)\n        .await?;\n        Ok(Box::new(self.to_owned()))\n    }\n    /// delete the entity from the database\n    async fn delete(\u0026self, pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003c(), GoatNsError\u003e {\n        let mut txn = pool.begin().await?;\n        self.delete_with_txn(\u0026mut txn).await?;\n        txn.commit().await?;\n        Ok(())\n    }\n    /// Delete the entity from the database, when you're in a transaction.\n    ///\n    /// This one happens in the order ownership -\u003e records -\u003e zone because at the very least,\n    /// if it fails after the ownership thing, then non-admin users can't see the zone\n    /// and admins will just have to clean it up manually\n    async fn delete_with_txn(\u0026self, txn: \u0026mut SqliteConnection) -\u003e Result\u003c(), GoatNsError\u003e {\n        // delete all the ownership records\n        sqlx::query(\"DELETE FROM ownership where zoneid = ?\")\n            .bind(self.id)\n            .execute(\u0026mut *txn)\n            .await?;\n\n        // delete all the records\n        sqlx::query(\"DELETE FROM records where zoneid = ?\")\n            .bind(self.id)\n            .execute(\u0026mut *txn)\n            .await?;\n\n        // finally delete the zone\n        let query = format!(\"DELETE FROM {} where id = ?\", FileZone::TABLE);\n        sqlx::query(\u0026query).bind(self.id).execute(\u0026mut *txn).await?;\n\n        Ok(())\n    }\n}\n\nimpl From\u003cSqliteRow\u003e for FileZone {\n    fn from(input: SqliteRow) -\u003e Self {\n        FileZone {\n            id: input.get(\"id\"),\n            name: input.get(\"name\"),\n            rname: input.get(\"rname\"),\n            serial: input.get(\"serial\"),\n            refresh: input.get(\"refresh\"),\n            retry: input.get(\"retry\"),\n            expire: input.get(\"expire\"),\n            minimum: input.get(\"minimum\"),\n            records: vec![], // can't fill this out yet\n        }\n    }\n}\n\n#[async_trait]\nimpl DBEntity for FileZoneRecord {\n    const TABLE: \u0026'static str = \"records\";\n\n    async fn create_table(pool: \u0026SqlitePool) -\u003e Result\u003c(), GoatNsError\u003e {\n        log::debug!(\"Ensuring DB Records table exists\");\n\n        let mut tx = pool.begin().await?;\n\n        sqlx::query(\n            \"CREATE TABLE IF NOT EXISTS\n        records (\n            id      INTEGER PRIMARY KEY AUTOINCREMENT ,\n            zoneid  INTEGER NOT NULL,\n            name    TEXT, /* this can be null for apex records */\n            ttl     INTEGER,\n            rrtype  INTEGER NOT NULL,\n            rclass  INTEGER NOT NULL,\n            rdata   TEXT NOT NULL,\n            FOREIGN KEY(zoneid) REFERENCES zones(id)\n        )\",\n        )\n        .execute(\u0026mut *tx)\n        .await?;\n        log::debug!(\"Ensuring DB Records index exists\");\n        sqlx::query(\n            \"CREATE UNIQUE INDEX\n        IF NOT EXISTS\n        ind_records\n        ON records (\n            id,zoneid,name,rrtype,rclass\n        )\",\n        )\n        .execute(\u0026mut *tx)\n        .await?;\n        log::debug!(\"Ensuring DB Records view exists\");\n        // this view lets us query based on the full name\n        sqlx::query(\n        \u0026format!(\"CREATE VIEW IF NOT EXISTS {} ( record_id, zoneid, rrtype, rclass, rdata, name, ttl ) as\n        SELECT records.id as record_id, zones.id as zoneid, records.rrtype, records.rclass ,records.rdata,\n        CASE\n            WHEN records.name is NULL THEN zones.name\n            ELSE records.name || '.' || zones.name\n        END AS name,\n        CASE WHEN records.ttl is NULL then zones.minimum\n            WHEN records.ttl \u003e zones.minimum THEN records.ttl\n            ELSE records.ttl\n        END AS ttl\n        from records, zones where records.zoneid = zones.id\", SQL_VIEW_RECORDS)\n    ).execute(\u0026mut *tx).await?;\n        tx.commit().await?;\n        Ok(())\n    }\n\n    /// Get by id\n    async fn get(_pool: \u0026Pool\u003cSqlite\u003e, _id: i64) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        error!(\"Unimplemented: FileZoneRecord::get\");\n        Err(sqlx::Error::RowNotFound.into())\n    }\n\n    async fn get_with_txn\u003c't\u003e(\n        txn: \u0026mut SqliteConnection,\n        id: \u0026i64,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let res = sqlx::query(\"select * from records where id = ?\")\n            .bind(id)\n            .fetch_one(txn)\n            .await?;\n\n        let res = Self::try_from(res)?;\n\n        Ok(Box::new(res))\n    }\n\n    async fn get_by_name\u003c't\u003e(\n        _txn: \u0026mut SqliteConnection,\n        _name: \u0026str,\n    ) -\u003e Result\u003cOption\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        unimplemented!();\n    }\n\n    async fn get_all_by_name\u003c't\u003e(\n        txn: \u0026mut SqliteConnection,\n        name: \u0026str,\n    ) -\u003e Result\u003cVec\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        let res = sqlx::query(\u0026format!(\n            \"select * from {} where name = ?\",\n            SQL_VIEW_RECORDS\n        ))\n        .bind(name)\n        .fetch_all(txn)\n        .await?;\n        let res = res\n            .iter()\n            .filter_map(|r| match FileZoneRecord::try_from(r) {\n                Ok(val) =\u003e Some(Box::from(val)),\n                Err(err) =\u003e {\n                    error!(\"Failed to turn sql row into FileZoneRecord: {:?}\", err);\n                    None\n                }\n            })\n            .collect();\n        Ok(res)\n    }\n\n    async fn get_all_user(\n        _pool: \u0026Pool\u003cSqlite\u003e,\n        _userid: i64,\n    ) -\u003e Result\u003cVec\u003cArc\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        error!(\"Unimplemented: FileZoneRecord::get_all_user\");\n        Err(sqlx::Error::RowNotFound.into())\n    }\n\n    async fn save(\u0026self, pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        #[cfg(test)]\n        eprintln!(\"Starting save\");\n        let mut txn = pool.begin().await?;\n        let res = \u0026self.save_with_txn(\u0026mut txn).await?;\n        match txn.commit().await {\n            Err(err) =\u003e {\n                eprintln!(\"Failed to commit transaction: {err:?}\");\n                return Err(err.into());\n            }\n            Ok(_) =\u003e eprintln!(\"Successfully saved {self:?} to the db\"),\n        };\n        Ok(res.to_owned())\n    }\n\n    async fn save_with_txn\u003c't\u003e(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        #[cfg(test)]\n        eprintln!(\"Starting save_with_txn for {self:?}\");\n        log::trace!(\"Starting save_with_txn for {self:?}\");\n        let record_name = match self.name.len() {\n            0 =\u003e None,\n            _ =\u003e Some(self.to_owned().name),\n        };\n        #[cfg(test)]\n        eprintln!(\n            \"save_with_txn rtype: {} =\u003e {}\",\n            self.rrtype.clone(),\n            RecordType::from(self.rrtype.clone())\n        );\n        let existing_record = sqlx::query(\"SELECT id, zoneid, name, ttl, rrtype, rclass, rdata from records WHERE\n        id = ? AND  zoneid = ? AND  name = ? AND  ttl = ? AND  rrtype = ? AND  rclass = ? AND rdata = ? LIMIT 1\")\n            .bind(self.id) // TODO id could be a none, which would work out bad\n            .bind(self.zoneid) // TODO zoneid could be a none, which would work out bad\n            .bind(\u0026record_name)\n            .bind(self.ttl)\n            .bind(RecordType::from(self.rrtype.clone()))\n            .bind(self.class)\n            .bind(self.rdata.to_string())\n            .fetch_optional(\u0026mut *txn).await?;\n\n        let mut args = SqliteArguments::default();\n        args.add(self.zoneid);\n        args.add(record_name);\n        args.add(self.ttl);\n        args.add(RecordType::from(self.rrtype.clone()));\n        args.add(self.class);\n        args.add(self.clone().rdata);\n\n        if let Some(er) = \u0026existing_record {\n            let id: i64 = er.get(\"id\");\n            args.add(id);\n        }\n\n        let query = match existing_record {\n            Some(_) =\u003e {\n                #[cfg(test)]\n                eprintln!(\"Found an existing record while saving!\");\n                sqlx::query_with(\n                    \"UPDATE records set zoneid = ?1, name = ?2, ttl = ?3, rrtype = ?4, rclass = ?5, rdata = ?6\n                            WHERE id =?\n                        \",\n                    args,\n                )\n            }\n            None =\u003e match self.id {\n                Some(id) =\u003e sqlx::query(\n                    \"INSERT INTO records (id, zoneid, name, ttl, rrtype, rclass, rdata)\n                                    VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7)\n                                \",\n                )\n                .bind(id)\n                .bind(self.zoneid)\n                .bind(self.name.clone())\n                .bind(self.ttl)\n                .bind(RecordType::from(self.rrtype.clone()))\n                .bind(self.class)\n                .bind(self.rdata.clone()),\n                None =\u003e sqlx::query(\n                    \"INSERT INTO records (zoneid, name, ttl, rrtype, rclass, rdata)\n                                        VALUES (?1, ?2, ?3, ?4, ?5, ?6)\n                                    \",\n                )\n                .bind(self.zoneid)\n                .bind(self.name.clone())\n                .bind(self.ttl)\n                .bind(RecordType::from(self.rrtype.clone()))\n                .bind(self.class)\n                .bind(self.rdata.clone()),\n            },\n        };\n        #[cfg(test)]\n        println!(\"Saving record...\");\n        let res = Self {\n            id: Some(query.execute(\u0026mut *txn).await?.last_insert_rowid()),\n            ..self.to_owned()\n        };\n\n        Ok(Box::new(res))\n    }\n\n    /// create from scratch\n    async fn create_with_txn\u003c't\u003e(\n        \u0026self,\n        _txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        error!(\"Unimplemented: FileZoneRecord::create_with_txn\");\n        Err(sqlx::Error::RowNotFound.into())\n    }\n    /// create from scratch\n    async fn update_with_txn\u003c't\u003e(\n        \u0026self,\n        _txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        error!(\"Unimplemented: FileZoneRecord::update_with_txn\");\n        Err(sqlx::Error::RowNotFound.into())\n    }\n    async fn delete(\u0026self, pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003c(), GoatNsError\u003e {\n        let mut txn = pool.begin().await?;\n        self.delete_with_txn(\u0026mut txn).await\n    }\n\n    async fn delete_with_txn(\u0026self, txn: \u0026mut SqliteConnection) -\u003e Result\u003c(), GoatNsError\u003e {\n        sqlx::query(format!(\"DELETE FROM {} WHERE id = ?\", Self::TABLE).as_str())\n            .bind(self.id)\n            .execute(\u0026mut *txn)\n            .await?;\n        Ok(())\n    }\n\n    fn json(\u0026self) -\u003e Result\u003cString, String\u003e\n    where\n        Self: Serialize,\n    {\n        serde_json::to_string_pretty(\u0026self).map_err(|e| e.to_string())\n    }\n}\n\n#[async_trait]\nimpl DBEntity for ZoneOwnership {\n    const TABLE: \u0026'static str = \"ownership\";\n\n    async fn create_table(pool: \u0026SqlitePool) -\u003e Result\u003c(), GoatNsError\u003e {\n        let mut tx = pool.begin().await?;\n\n        #[cfg(test)]\n        eprintln!(\"Ensuring DB {} table exists\", Self::TABLE);\n        log::debug!(\"Ensuring DB {} table exists\", Self::TABLE);\n        sqlx::query(\u0026format!(\n            r#\"CREATE TABLE IF NOT EXISTS\n                {} (\n                    id   INTEGER PRIMARY KEY NOT NULL,\n                    zoneid INTEGER NOT NULL,\n                    userid INTEGER NOT NULL,\n                    FOREIGN KEY(zoneid) REFERENCES zones(id),\n                    FOREIGN KEY(userid) REFERENCES users(id)\n                )\"#,\n            Self::TABLE\n        ))\n        .execute(\u0026mut *tx)\n        .await?;\n\n        #[cfg(test)]\n        eprintln!(\"Ensuring DB Ownership index exists\");\n        log::debug!(\"Ensuring DB Ownership index exists\");\n        sqlx::query(\n            \"CREATE UNIQUE INDEX\n                IF NOT EXISTS\n                ind_ownership\n                ON ownership (\n                    zoneid,\n                    userid\n                )\",\n        )\n        .execute(\u0026mut *tx)\n        .await?;\n\n        tx.commit().await.map_err(|e| e.into())\n    }\n\n    /// Get an ownership record by its id\n    async fn get(pool: \u0026Pool\u003cSqlite\u003e, id: i64) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let mut conn = pool.acquire().await?;\n\n        let res: ZoneOwnership =\n            sqlx::query(\"SELECT id, zoneid, userid from ownership where id = ?\")\n                .bind(id)\n                .fetch_one(\u0026mut *conn)\n                .await?\n                .into();\n        Ok(Box::new(res))\n    }\n\n    /// This getter is by zoneid, since it should return less results\n    async fn get_with_txn\u003c't\u003e(\n        _txn: \u0026mut SqliteConnection,\n        _id: \u0026i64,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        error!(\"Unimplemented: ZoneOwnership::get_with_txn\");\n        Err(sqlx::Error::RowNotFound.into())\n    }\n\n    async fn get_by_name\u003c't\u003e(\n        _txn: \u0026mut SqliteConnection,\n        _name: \u0026str,\n    ) -\u003e Result\u003cOption\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        // TODO implement ZoneOwnership get_by_name which gets by zone name\n        unimplemented!(\"Not applicable for this!\");\n    }\n    async fn get_all_by_name\u003c't\u003e(\n        _txn: \u0026mut SqliteConnection,\n        _name: \u0026str,\n    ) -\u003e Result\u003cVec\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        unimplemented!()\n    }\n    /// Get an ownership record by its id\n    async fn get_all_user(pool: \u0026Pool\u003cSqlite\u003e, id: i64) -\u003e Result\u003cVec\u003cArc\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        let mut conn = pool.acquire().await?;\n\n        let res = sqlx::query(\"SELECT * from ownership where id = ?\")\n            .bind(id)\n            .fetch_all(\u0026mut *conn)\n            .await?;\n        let result: Vec\u003cArc\u003cZoneOwnership\u003e\u003e = res.into_iter().map(|z| Arc::new(z.into())).collect();\n        Ok(result)\n    }\n\n    /// save the entity to the database\n    async fn save(\u0026self, pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let mut txn = pool.begin().await?;\n        let res = self.save_with_txn(\u0026mut txn).await?;\n        txn.commit().await?;\n        Ok(res)\n    }\n\n    /// save the entity to the database, but you're in a transaction\n    async fn save_with_txn\u003c't\u003e(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let res = sqlx::query(\u0026format!(\n            \"INSERT INTO {} (zoneid, userid) values ( ?, ? )\",\n            Self::TABLE\n        ))\n        .bind(self.zoneid)\n        .bind(self.userid)\n        .execute(txn)\n        .await?;\n        // TODO: set the ID to the new ID\n        let id: i64 = res.last_insert_rowid();\n        let res = Self {\n            id: Some(id),\n            ..*self\n        };\n        Ok(Box::new(res))\n    }\n\n    /// create new, this just calls save_with_txn\n    async fn create_with_txn\u003c't\u003e(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        self.save_with_txn(txn).await\n    }\n    /// create from scratch\n    async fn update_with_txn\u003c't\u003e(\n        \u0026self,\n        _txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        unimplemented!(\"this should never be updated\");\n    }\n    /// delete the entity from the database\n    async fn delete(\u0026self, _pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003c(), GoatNsError\u003e {\n        todo!()\n    }\n\n    /// delete the entity from the database, but you're in a transaction\n    async fn delete_with_txn(\u0026self, _txn: \u0026mut SqliteConnection) -\u003e Result\u003c(), GoatNsError\u003e {\n        todo!();\n    }\n\n    fn json(\u0026self) -\u003e Result\u003cString, String\u003e\n    where\n        Self: Serialize,\n    {\n        serde_json::to_string_pretty(\u0026self).map_err(|e| e.to_string())\n    }\n}\nimpl From\u003cSqliteRow\u003e for ZoneOwnership {\n    fn from(row: SqliteRow) -\u003e Self {\n        let id: i64 = row.get(\"id\");\n        let userid: i64 = row.get(\"userid\");\n        let zoneid: i64 = row.get(\"zoneid\");\n\n        ZoneOwnership {\n            id: Some(id),\n            zoneid,\n            userid,\n        }\n    }\n}\n\n#[async_trait]\nimpl DBEntity for User {\n    const TABLE: \u0026'static str = \"users\";\n\n    async fn create_table(pool: \u0026SqlitePool) -\u003e Result\u003c(), GoatNsError\u003e {\n        log::debug!(\"Ensuring DB Users table exists\");\n        sqlx::query(\u0026format!(\n            r#\"CREATE TABLE IF NOT EXISTS\n        {} (\n            id  INTEGER PRIMARY KEY NOT NULL,\n            displayname TEXT NOT NULL,\n            username TEXT NOT NULL,\n            email TEXT NOT NULL,\n            disabled BOOL NOT NULL,\n            authref TEXT,\n            admin BOOL DEFAULT 0\n        )\"#,\n            Self::TABLE\n        ))\n        .execute(\u0026mut *pool.acquire().await?)\n        .await?;\n\n        sqlx::query(\n            \"CREATE UNIQUE INDEX IF NOT EXISTS\n        ind_users_fields\n        ON users ( username, email )\",\n        )\n        .execute(\u0026mut *pool.acquire().await?)\n        .await?;\n\n        Ok(())\n    }\n    /// Get an ownership record by its id\n    async fn get(pool: \u0026Pool\u003cSqlite\u003e, id: i64) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let mut conn = pool.acquire().await?;\n\n        let res: User = sqlx::query(\u0026format!(\n            \"SELECT id, displayname, username, email, disabled from {} where id = ?\",\n            Self::TABLE\n        ))\n        .bind(id)\n        .fetch_one(\u0026mut *conn)\n        .await?\n        .into();\n        Ok(Box::new(res))\n    }\n    async fn get_with_txn\u003c't\u003e(\n        _txn: \u0026mut SqliteConnection,\n        _id: \u0026i64,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        unimplemented!()\n    }\n    async fn get_by_name\u003c't\u003e(\n        txn: \u0026mut SqliteConnection,\n        name: \u0026str,\n    ) -\u003e Result\u003cOption\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        let res = sqlx::query(\u0026format!(\n            \"SELECT id, displayname, username, email, disabled, authref, admin from {} where username = ?\",\n            Self::TABLE\n        ))\n        .bind(name)\n        .fetch_one(\u0026mut *txn)\n        .await?;\n        let result: Box\u003cSelf\u003e = Box::new(res.into());\n        Ok(Some(result))\n    }\n    async fn get_all_by_name\u003c't\u003e(\n        _txn: \u0026mut SqliteConnection,\n        _name: \u0026str,\n    ) -\u003e Result\u003cVec\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        unimplemented!()\n    }\n    /// Get an ownership record by its id, which is slightly ironic in this case\n    async fn get_all_user(pool: \u0026Pool\u003cSqlite\u003e, id: i64) -\u003e Result\u003cVec\u003cArc\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        let mut conn = pool.acquire().await?;\n\n        let res = sqlx::query(\u0026format!(\n            \"SELECT id, zoneid, userid from {} where id = ?\",\n            Self::TABLE\n        ))\n        .bind(id)\n        .fetch_all(\u0026mut *conn)\n        .await?;\n        let result: Vec\u003cArc\u003cSelf\u003e\u003e = res.into_iter().map(|z| Arc::new(z.into())).collect();\n        Ok(result)\n    }\n\n    /// save the entity to the database\n    async fn save(\u0026self, pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let mut txn = pool.begin().await?;\n        let res = self.save_with_txn(\u0026mut txn).await?;\n        txn.commit().await?;\n        Ok(res)\n    }\n\n    /// save the entity to the database, but you're in a transaction\n    async fn save_with_txn\u003c't\u003e(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let res = sqlx::query(\n            \"INSERT INTO users\n            (id, displayname, username, email, disabled, authref, admin)\n            VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7)\",\n        )\n        .bind(self.id)\n        .bind(\u0026self.displayname)\n        .bind(\u0026self.username)\n        .bind(\u0026self.email)\n        .bind(self.disabled)\n        .bind(\u0026self.authref)\n        .bind(self.admin)\n        .execute(txn)\n        .await?;\n        let res = Self {\n            id: Some(res.last_insert_rowid()),\n            ..self.to_owned()\n        };\n        Ok(Box::new(res))\n    }\n\n    /// create from scratch\n    async fn create_with_txn\u003c't\u003e(\n        \u0026self,\n        _txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        todo!();\n    }\n\n    async fn update_with_txn\u003c't\u003e(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let query = format!(\"UPDATE {} set displayname = ?, username = ?, email = ?, disabled = ?, authref = ?, admin = ? WHERE id = ?\", Self::TABLE);\n        sqlx::query(\u0026query)\n            .bind(\u0026self.displayname)\n            .bind(\u0026self.username)\n            .bind(\u0026self.email)\n            .bind(self.disabled)\n            .bind(\u0026self.authref)\n            .bind(self.admin)\n            .bind(self.id)\n            .execute(txn)\n            .await?;\n        Ok(Box::new(self.to_owned()))\n    }\n\n    /// delete the entity from the database\n    async fn delete(\u0026self, _pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003c(), GoatNsError\u003e {\n        todo!()\n    }\n\n    /// delete the entity from the database, but you're in a transaction\n    async fn delete_with_txn(\u0026self, _txn: \u0026mut SqliteConnection) -\u003e Result\u003c(), GoatNsError\u003e {\n        todo!();\n    }\n\n    fn json(\u0026self) -\u003e Result\u003cString, String\u003e\n    where\n        Self: Serialize,\n    {\n        serde_json::to_string_pretty(\u0026self).map_err(|e| e.to_string())\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct UserAuthToken {\n    pub id: Option\u003ci64\u003e,\n    pub name: String,\n    pub issued: DateTime\u003cUtc\u003e,\n    pub expiry: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub userid: i64,\n    pub tokenkey: String,\n    pub tokenhash: String,\n}\n\nimpl UserAuthToken {\n    pub async fn get_authtoken(\n        pool: \u0026SqlitePool,\n        tokenkey: String,\n    ) -\u003e Result\u003cUserAuthToken, GoatNsError\u003e {\n        let res = sqlx::query(\u0026format!(\n            \"select id, issued, expiry, tokenkey, tokenhash, userid from {} where tokenkey = ?\",\n            Self::TABLE\n        ))\n        .bind(tokenkey)\n        .fetch_one(\u0026mut *pool.acquire().await?)\n        .await?;\n        res.try_into()\n    }\n\n    pub async fn cleanup(pool: \u0026SqlitePool) -\u003e Result\u003c(), GoatNsError\u003e {\n        let current_time = Utc::now();\n        log::debug!(\n            \"Starting cleanup of {} table for sessions expiring before {}\",\n            Self::TABLE,\n            current_time.to_rfc3339()\n        );\n\n        match sqlx::query(\u0026format!(\n            \"DELETE FROM {} where expiry NOT NULL and expiry \u003c ?\",\n            Self::TABLE\n        ))\n        .bind(current_time.timestamp())\n        .execute(\u0026mut *pool.acquire().await?)\n        .await\n        {\n            Ok(res) =\u003e {\n                log::info!(\n                    \"Cleanup of {} table complete, {} rows deleted.\",\n                    Self::TABLE,\n                    res.rows_affected()\n                );\n                Ok(())\n            }\n            Err(error) =\u003e {\n                log::error!(\n                    \"Failed to complete cleanup of {} table: {error:?}\",\n                    Self::TABLE\n                );\n                Err(error.into())\n            }\n        }\n    }\n}\n\n#[async_trait]\nimpl DBEntity for UserAuthToken {\n    const TABLE: \u0026'static str = \"user_tokens\";\n\n    async fn create_table(pool: \u0026SqlitePool) -\u003e Result\u003c(), GoatNsError\u003e {\n        let mut conn = pool.acquire().await?;\n        log::debug!(\"Ensuring DB {} table exists\", Self::TABLE);\n\n        match sqlx::query(\u0026format!(\n            \"SELECT name FROM sqlite_master WHERE type='table' AND name='{}'\",\n            Self::TABLE\n        ))\n        .fetch_optional(\u0026mut *conn)\n        .await?\n        {\n            None =\u003e {\n                log::debug!(\"Creating {} table\", Self::TABLE);\n                sqlx::query(\u0026format!(\n                    r#\"CREATE TABLE IF NOT EXISTS\n                    {} (\n                        id INTEGER PRIMARY KEY NOT NULL,\n                        name TEXT NOT NULL,\n                        issued TEXT NOT NULL,\n                        expiry TEXT,\n                        tokenkey TEXT NOT NULL,\n                        tokenhash TEXT NOT NULL,\n                        userid INTEGER NOT NULL,\n                        FOREIGN KEY(userid) REFERENCES users(id)\n                    )\"#,\n                    Self::TABLE\n                ))\n                .execute(\u0026mut *conn)\n                .await?;\n            }\n            Some(_) =\u003e {\n                log::debug!(\"Updating the table\");\n                // get the columns in the table\n                let res = sqlx::query(\u0026format!(\"PRAGMA table_info({})\", Self::TABLE))\n                    .fetch_all(\u0026mut *conn)\n                    .await?;\n\n                let mut found_name = false;\n                let mut found_tokenkey = false;\n                for row in res.iter() {\n                    let rowname: \u0026str = row.get(\"name\");\n                    if rowname == \"name\" {\n                        log::debug!(\"Found the name column in the {} table\", Self::TABLE);\n                        found_name = true;\n                    }\n\n                    let rowname: \u0026str = row.get(\"name\");\n                    if rowname == \"tokenkey\" {\n                        log::debug!(\"Found the tokenkey column in the {} table\", Self::TABLE);\n                        found_tokenkey = true;\n                    }\n                }\n\n                if !found_name {\n                    log::info!(\"Adding the name column to the {} table\", Self::TABLE);\n                    sqlx::query(\u0026format!(\n                        \"ALTER TABLE \\\"{}\\\" ADD COLUMN name TEXT NOT NULL DEFAULT \\\"Token Name\\\"\",\n                        Self::TABLE\n                    ))\n                    .execute(\u0026mut *conn)\n                    .await?;\n                }\n                if !found_tokenkey {\n                    log::info!(\"Adding the tokenkey column to the {} table, this will drop the contents of the API tokens table, because of the format change.\", Self::TABLE);\n\n                    match dialoguer::Confirm::new()\n                        .with_prompt(\"Please confirm that you want to take this action\")\n                        .interact()\n                    {\n                        Ok(value) =\u003e {\n                            if !value {\n                                return Err(sqlx::Error::Protocol(\"Cancelled\".to_string()).into());\n                                // TODO: replace these with proper errors\n                            }\n                        }\n                        Err(error) =\u003e {\n                            log::error!(\"Cancelled! {error:?}\");\n                            return Err(sqlx::Error::Protocol(\"Cancelled\".to_string()).into());\n                            // TODO: replace these with proper errors\n                        }\n                    };\n                    sqlx::query(\u0026format!(\"DELETE FROM {}\", Self::TABLE))\n                        .execute(\u0026mut *conn)\n                        .await?;\n                    sqlx::query(\u0026format!(\n                        \"ALTER TABLE \\\"{}\\\" ADD COLUMN tokenkey TEXT NOT NULL DEFAULT \\\"old_tokenkey\\\"\",\n                        Self::TABLE\n                    ))\n                    .execute(\u0026mut *conn)\n                    .await?;\n                }\n            }\n        };\n\n        match sqlx::query(\u0026format!(\"DROP INDEX ind_{}_fields\", Self::TABLE))\n            .execute(\u0026mut *conn)\n            .await\n        {\n            Ok(_) =\u003e log::trace!(\n                \"Didn't find  ind_{}_fields index, no action required\",\n                Self::TABLE\n            ),\n            Err(err) =\u003e match err {\n                sqlx::Error::Database(ref zzz) =\u003e {\n                    if zzz.message() != \"no such index: ind_user_tokens_fields\" {\n                        log::error!(\"Database Error: {:?}\", zzz);\n                        return Err(err.into());\n                    }\n                }\n                _ =\u003e {\n                    log::error!(\"{err:?}\");\n                    return Err(err.into());\n                }\n            },\n        };\n\n        sqlx::query(\u0026format!(\n            \"CREATE UNIQUE INDEX IF NOT EXISTS\n        ind_{0}_findit\n        ON {0} ( userid, tokenkey, tokenhash )\",\n            Self::TABLE\n        ))\n        .execute(\u0026mut *conn)\n        .await?;\n\n        Ok(())\n    }\n\n    /// Get the entity\n    async fn get(pool: \u0026Pool\u003cSqlite\u003e, id: i64) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let res: Self = sqlx::query(\u0026format!(\"SELECT * from {} where id = ?\", Self::TABLE))\n            .bind(id)\n            .fetch_one(pool)\n            .await?\n            .try_into()?;\n\n        Ok(Box::new(res))\n    }\n\n    async fn get_with_txn\u003c't\u003e(\n        _txn: \u0026mut SqliteConnection,\n        _id: \u0026i64,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        unimplemented!()\n    }\n    // TODO: maybe get by name gets it by the username?\n    async fn get_by_name\u003c't\u003e(\n        _txn: \u0026mut SqliteConnection,\n        _name: \u0026str,\n    ) -\u003e Result\u003cOption\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        unimplemented!()\n    }\n    async fn get_all_by_name\u003c't\u003e(\n        _txn: \u0026mut SqliteConnection,\n        _name: \u0026str,\n    ) -\u003e Result\u003cVec\u003cBox\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        unimplemented!()\n    }\n\n    async fn get_all_user(pool: \u0026Pool\u003cSqlite\u003e, id: i64) -\u003e Result\u003cVec\u003cArc\u003cSelf\u003e\u003e, GoatNsError\u003e {\n        let res = sqlx::query(\u0026format!(\"SELECT * from {} where userid = ?\", Self::TABLE))\n            .bind(id)\n            .fetch_all(pool)\n            .await?;\n        let res: Vec\u003cArc\u003cUserAuthToken\u003e\u003e = res\n            .into_iter()\n            .filter_map(|r| match UserAuthToken::try_from(r) {\n                Ok(r) =\u003e Some(Arc::new(r)),\n                Err(e) =\u003e {\n                    log::error!(\"Failed to convert row to UserAuthToken: {e:?}\");\n                    None\n                }\n            })\n            .collect();\n        Ok(res)\n    }\n\n    /// save the entity to the database\n    async fn save(\u0026self, pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let mut txn = pool.begin().await?;\n        let res = self.save_with_txn(\u0026mut txn).await?;\n        txn.commit().await?;\n        Ok(res)\n    }\n\n    /// save the entity to the database, but you're in a transaction\n    async fn save_with_txn\u003c't\u003e(\n        \u0026self,\n        txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        let expiry = self.expiry.map(|v| v.timestamp());\n        let issued = self.issued.timestamp();\n\n        let res = sqlx::query(\u0026format!(\n            \"INSERT INTO {} (id, name, issued, expiry, userid, tokenkey, tokenhash) VALUES (?, ?, ?, ?, ?, ?, ?)\",\n            Self::TABLE\n        ))\n        .bind(self.id)\n        .bind(\u0026self.name)\n        .bind(issued)\n        .bind(expiry)\n        .bind(self.userid)\n        .bind(\u0026self.tokenkey)\n        .bind(\u0026self.tokenhash)\n        .execute(txn)\n        .await?;\n\n        let res = Self {\n            id: Some(res.last_insert_rowid()),\n            ..self.to_owned()\n        };\n\n        Ok(Box::new(res))\n    }\n\n    /// create from scratch\n    async fn create_with_txn\u003c't\u003e(\n        \u0026self,\n        _txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        todo!();\n    }\n    /// create from scratch\n    async fn update_with_txn\u003c't\u003e(\n        \u0026self,\n        _txn: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cBox\u003cSelf\u003e, GoatNsError\u003e {\n        todo!();\n    }\n\n    /// delete the entity from the database\n    async fn delete(\u0026self, pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003c(), GoatNsError\u003e {\n        let mut txn = pool.begin().await?;\n        self.delete_with_txn(\u0026mut txn).await?;\n        txn.commit().await?;\n        Ok(())\n    }\n    /// delete the entity from the database, but you're in a transaction\n    async fn delete_with_txn(\u0026self, txn: \u0026mut SqliteConnection) -\u003e Result\u003c(), GoatNsError\u003e {\n        sqlx::query(\u0026format!(\"DELETE FROM {} where id = ?\", \u0026Self::TABLE))\n            .bind(self.id)\n            .execute(txn)\n            .await?;\n        Ok(())\n    }\n\n    fn json(\u0026self) -\u003e Result\u003cString, String\u003e\n    where\n        Self: Serialize,\n    {\n        serde_json::to_string_pretty(\u0026self).map_err(|e| e.to_string())\n    }\n}\n\nimpl TryFrom\u003cSqliteRow\u003e for UserAuthToken {\n    type Error = GoatNsError;\n    fn try_from(input: SqliteRow) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let expiry: Option\u003cString\u003e = input.get(\"expiry\");\n        let expiry: Option\u003cDateTime\u003cUtc\u003e\u003e = match expiry {\n            None =\u003e None,\n            Some(val) =\u003e {\n                let expiry = chrono::NaiveDateTime::parse_from_str(\u0026val, \"%s\")?;\n                let expiry: DateTime\u003cUtc\u003e = chrono::TimeZone::from_utc_datetime(\u0026Utc, \u0026expiry);\n                Some(expiry)\n            }\n        };\n\n        let issued: String = input.get(\"issued\");\n\n        let issued = chrono::NaiveDateTime::parse_from_str(\u0026issued, \"%s\")?;\n        let issued: DateTime\u003cUtc\u003e = chrono::TimeZone::from_utc_datetime(\u0026Utc, \u0026issued);\n\n        Ok(Self {\n            id: input.get(\"id\"),\n            name: input.get(\"name\"),\n            issued,\n            expiry,\n            userid: input.get(\"userid\"),\n            tokenkey: input.get(\"tokenkey\"),\n            tokenhash: input.get(\"tokenhash\"),\n        })\n    }\n}\n\n/// Run this periodically to clean up expired DB things\npub async fn cron_db_cleanup(pool: Pool\u003cSqlite\u003e, period: Duration, max_iter: Option\u003cusize\u003e) {\n    let mut interval = time::interval(period);\n    let mut iterations = 0;\n    loop {\n        interval.tick().await;\n\n        if let Err(error) = UserAuthToken::cleanup(\u0026pool).await {\n            log::error!(\"Failed to clean up UserAuthToken objects in DB cron: {error:?}\");\n        }\n        if let Some(max_iter) = max_iter {\n            iterations += 1;\n            if iterations \u003e= max_iter {\n                break;\n            }\n        }\n    }\n}\n\npub async fn get_zones_with_txn(\n    txn: \u0026mut SqliteConnection,\n    lim: i64,\n    offset: i64,\n) -\u003e Result\u003cVec\u003cFileZone\u003e, GoatNsError\u003e {\n    let result = sqlx::query(\n        \"SELECT\n        *\n        FROM zones\n        LIMIT ? OFFSET ? \",\n    )\n    .bind(lim)\n    .bind(offset)\n    .fetch_all(\u0026mut *txn)\n    .await?;\n\n    let rows: Vec\u003cFileZone\u003e = result\n        .into_iter()\n        .map(|row| {\n            #[cfg(test)]\n            eprintln!(\"Building FileZone\");\n            row.into()\n        })\n        .collect();\n    Ok(rows)\n}\n\nimpl TryFrom\u003c\u0026SqliteRow\u003e for FileZoneRecord {\n    type Error = GoatNsError;\n    fn try_from(row: \u0026SqliteRow) -\u003e Result\u003cSelf, Self::Error\u003e {\n        row.to_owned().try_into()\n    }\n}\n\nimpl TryFrom\u003cSqliteRow\u003e for FileZoneRecord {\n    type Error = GoatNsError;\n    fn try_from(row: SqliteRow) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let name: String = row.get(\"name\");\n        let rrtype: i32 = row.get(\"rrtype\");\n        let rrtype = RecordType::from(\u0026(rrtype as u16));\n        let class: u16 = row.get(\"rclass\");\n        let rdata: String = row.get(\"rdata\");\n        let ttl: u32 = row.get(\"ttl\");\n\n        if let RecordType::ANY = rrtype {\n            return Err(GoatNsError::RFC8482);\n        }\n\n        Ok(FileZoneRecord {\n            zoneid: row.get(\"zoneid\"),\n            id: row.get(\"id\"),\n            name,\n            rrtype: rrtype.to_string(),\n            class: RecordClass::from(\u0026class),\n            rdata,\n            ttl,\n        })\n    }\n}\n\npub async fn get_all_fzr_by_name\u003c't\u003e(\n    txn: \u0026mut SqliteConnection,\n    name: \u0026str,\n    rrtype: u16,\n) -\u003e Result\u003cVec\u003cFileZoneRecord\u003e, GoatNsError\u003e {\n    let res = sqlx::query(\u0026format!(\n        \"select *, record_id as id from {} where name = ? AND rrtype = ?\",\n        SQL_VIEW_RECORDS\n    ))\n    .bind(name)\n    .bind(rrtype)\n    .fetch_all(txn)\n    .await?;\n\n    let res = res.into_iter().filter_map(|r| r.try_into().ok()).collect();\n    Ok(res)\n}\n","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":32,"address":[],"length":0,"stats":{"Line":2}},{"line":33,"address":[],"length":0,"stats":{"Line":2}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":2}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":1}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":3}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":42}},{"line":57,"address":[],"length":0,"stats":{"Line":128}},{"line":58,"address":[],"length":0,"stats":{"Line":130}},{"line":59,"address":[],"length":0,"stats":{"Line":130}},{"line":60,"address":[],"length":0,"stats":{"Line":148}},{"line":61,"address":[],"length":0,"stats":{"Line":121}},{"line":62,"address":[],"length":0,"stats":{"Line":21}},{"line":63,"address":[],"length":0,"stats":{"Line":21}},{"line":86,"address":[],"length":0,"stats":{"Line":1}},{"line":89,"address":[],"length":0,"stats":{"Line":1}},{"line":90,"address":[],"length":0,"stats":{"Line":1}},{"line":91,"address":[],"length":0,"stats":{"Line":1}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":5}},{"line":209,"address":[],"length":0,"stats":{"Line":5}},{"line":210,"address":[],"length":0,"stats":{"Line":5}},{"line":211,"address":[],"length":0,"stats":{"Line":5}},{"line":212,"address":[],"length":0,"stats":{"Line":5}},{"line":213,"address":[],"length":0,"stats":{"Line":5}},{"line":214,"address":[],"length":0,"stats":{"Line":5}},{"line":215,"address":[],"length":0,"stats":{"Line":5}},{"line":217,"address":[],"length":0,"stats":{"Line":5}},{"line":218,"address":[],"length":0,"stats":{"Line":5}},{"line":219,"address":[],"length":0,"stats":{"Line":5}},{"line":220,"address":[],"length":0,"stats":{"Line":5}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":4}},{"line":279,"address":[],"length":0,"stats":{"Line":4}},{"line":280,"address":[],"length":0,"stats":{"Line":4}},{"line":281,"address":[],"length":0,"stats":{"Line":4}},{"line":282,"address":[],"length":0,"stats":{"Line":4}},{"line":283,"address":[],"length":0,"stats":{"Line":4}},{"line":284,"address":[],"length":0,"stats":{"Line":4}},{"line":285,"address":[],"length":0,"stats":{"Line":4}},{"line":286,"address":[],"length":0,"stats":{"Line":4}},{"line":288,"address":[],"length":0,"stats":{"Line":4}},{"line":289,"address":[],"length":0,"stats":{"Line":4}},{"line":290,"address":[],"length":0,"stats":{"Line":4}},{"line":291,"address":[],"length":0,"stats":{"Line":4}},{"line":293,"address":[],"length":0,"stats":{"Line":4}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":34}},{"line":312,"address":[],"length":0,"stats":{"Line":34}},{"line":313,"address":[],"length":0,"stats":{"Line":34}},{"line":314,"address":[],"length":0,"stats":{"Line":34}},{"line":315,"address":[],"length":0,"stats":{"Line":34}},{"line":316,"address":[],"length":0,"stats":{"Line":53}},{"line":317,"address":[],"length":0,"stats":{"Line":15}},{"line":335,"address":[],"length":0,"stats":{"Line":19}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":19}},{"line":352,"address":[],"length":0,"stats":{"Line":19}},{"line":353,"address":[],"length":0,"stats":{"Line":19}},{"line":354,"address":[],"length":0,"stats":{"Line":19}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":19}},{"line":359,"address":[],"length":0,"stats":{"Line":19}},{"line":364,"address":[],"length":0,"stats":{"Line":8}},{"line":365,"address":[],"length":0,"stats":{"Line":8}},{"line":366,"address":[],"length":0,"stats":{"Line":8}},{"line":367,"address":[],"length":0,"stats":{"Line":8}},{"line":368,"address":[],"length":0,"stats":{"Line":8}},{"line":369,"address":[],"length":0,"stats":{"Line":8}},{"line":370,"address":[],"length":0,"stats":{"Line":8}},{"line":371,"address":[],"length":0,"stats":{"Line":8}},{"line":372,"address":[],"length":0,"stats":{"Line":8}},{"line":373,"address":[],"length":0,"stats":{"Line":8}},{"line":374,"address":[],"length":0,"stats":{"Line":8}},{"line":375,"address":[],"length":0,"stats":{"Line":8}},{"line":376,"address":[],"length":0,"stats":{"Line":8}},{"line":377,"address":[],"length":0,"stats":{"Line":8}},{"line":378,"address":[],"length":0,"stats":{"Line":8}},{"line":386,"address":[],"length":0,"stats":{"Line":6}},{"line":393,"address":[],"length":0,"stats":{"Line":6}},{"line":398,"address":[],"length":0,"stats":{"Line":6}},{"line":401,"address":[],"length":0,"stats":{"Line":12}},{"line":402,"address":[],"length":0,"stats":{"Line":6}},{"line":403,"address":[],"length":0,"stats":{"Line":6}},{"line":404,"address":[],"length":0,"stats":{"Line":6}},{"line":405,"address":[],"length":0,"stats":{"Line":13}},{"line":406,"address":[],"length":0,"stats":{"Line":7}},{"line":408,"address":[],"length":0,"stats":{"Line":6}},{"line":409,"address":[],"length":0,"stats":{"Line":3}},{"line":410,"address":[],"length":0,"stats":{"Line":3}},{"line":413,"address":[],"length":0,"stats":{"Line":6}},{"line":414,"address":[],"length":0,"stats":{"Line":22}},{"line":415,"address":[],"length":0,"stats":{"Line":16}},{"line":416,"address":[],"length":0,"stats":{"Line":8}},{"line":421,"address":[],"length":0,"stats":{"Line":6}},{"line":422,"address":[],"length":0,"stats":{"Line":3}},{"line":425,"address":[],"length":0,"stats":{"Line":3}},{"line":427,"address":[],"length":0,"stats":{"Line":4}},{"line":428,"address":[],"length":0,"stats":{"Line":1}},{"line":429,"address":[],"length":0,"stats":{"Line":1}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":3}},{"line":445,"address":[],"length":0,"stats":{"Line":2}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":2}},{"line":453,"address":[],"length":0,"stats":{"Line":2}},{"line":454,"address":[],"length":0,"stats":{"Line":1}},{"line":455,"address":[],"length":0,"stats":{"Line":1}},{"line":456,"address":[],"length":0,"stats":{"Line":1}},{"line":457,"address":[],"length":0,"stats":{"Line":1}},{"line":459,"address":[],"length":0,"stats":{"Line":1}},{"line":460,"address":[],"length":0,"stats":{"Line":1}},{"line":461,"address":[],"length":0,"stats":{"Line":250}},{"line":463,"address":[],"length":0,"stats":{"Line":1}},{"line":464,"address":[],"length":0,"stats":{"Line":1002}},{"line":465,"address":[],"length":0,"stats":{"Line":1}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":4}},{"line":521,"address":[],"length":0,"stats":{"Line":4}},{"line":522,"address":[],"length":0,"stats":{"Line":13}},{"line":523,"address":[],"length":0,"stats":{"Line":4}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":2}},{"line":575,"address":[],"length":0,"stats":{"Line":4}},{"line":583,"address":[],"length":0,"stats":{"Line":50}},{"line":584,"address":[],"length":0,"stats":{"Line":99}},{"line":586,"address":[],"length":0,"stats":{"Line":25}},{"line":600,"address":[],"length":0,"stats":{"Line":25}},{"line":601,"address":[],"length":0,"stats":{"Line":29}},{"line":604,"address":[],"length":0,"stats":{"Line":25}},{"line":613,"address":[],"length":0,"stats":{"Line":25}},{"line":614,"address":[],"length":0,"stats":{"Line":27}},{"line":615,"address":[],"length":0,"stats":{"Line":50}},{"line":616,"address":[],"length":0,"stats":{"Line":25}},{"line":620,"address":[],"length":0,"stats":{"Line":3}},{"line":621,"address":[],"length":0,"stats":{"Line":12}},{"line":622,"address":[],"length":0,"stats":{"Line":57}},{"line":635,"address":[],"length":0,"stats":{"Line":4}},{"line":636,"address":[],"length":0,"stats":{"Line":4}},{"line":637,"address":[],"length":0,"stats":{"Line":4}},{"line":638,"address":[],"length":0,"stats":{"Line":4}},{"line":639,"address":[],"length":0,"stats":{"Line":4}},{"line":641,"address":[],"length":0,"stats":{"Line":4}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":652,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":52}},{"line":655,"address":[],"length":0,"stats":{"Line":4}},{"line":656,"address":[],"length":0,"stats":{"Line":4}},{"line":657,"address":[],"length":0,"stats":{"Line":217}},{"line":658,"address":[],"length":0,"stats":{"Line":213}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":4}},{"line":662,"address":[],"length":0,"stats":{"Line":4}},{"line":669,"address":[],"length":0,"stats":{"Line":13}},{"line":670,"address":[],"length":0,"stats":{"Line":13}},{"line":671,"address":[],"length":0,"stats":{"Line":13}},{"line":672,"address":[],"length":0,"stats":{"Line":13}},{"line":674,"address":[],"length":0,"stats":{"Line":11}},{"line":675,"address":[],"length":0,"stats":{"Line":2}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":11}},{"line":694,"address":[],"length":0,"stats":{"Line":43}},{"line":695,"address":[],"length":0,"stats":{"Line":106}},{"line":696,"address":[],"length":0,"stats":{"Line":22}},{"line":698,"address":[],"length":0,"stats":{"Line":11}},{"line":707,"address":[],"length":0,"stats":{"Line":53}},{"line":708,"address":[],"length":0,"stats":{"Line":17}},{"line":709,"address":[],"length":0,"stats":{"Line":17}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":714,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[],"length":0,"stats":{"Line":17}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":723,"address":[],"length":0,"stats":{"Line":15}},{"line":726,"address":[],"length":0,"stats":{"Line":15}},{"line":727,"address":[],"length":0,"stats":{"Line":15}},{"line":728,"address":[],"length":0,"stats":{"Line":15}},{"line":729,"address":[],"length":0,"stats":{"Line":15}},{"line":730,"address":[],"length":0,"stats":{"Line":15}},{"line":736,"address":[],"length":0,"stats":{"Line":15}},{"line":737,"address":[],"length":0,"stats":{"Line":15}},{"line":738,"address":[],"length":0,"stats":{"Line":15}},{"line":739,"address":[],"length":0,"stats":{"Line":15}},{"line":740,"address":[],"length":0,"stats":{"Line":15}},{"line":741,"address":[],"length":0,"stats":{"Line":15}},{"line":742,"address":[],"length":0,"stats":{"Line":15}},{"line":743,"address":[],"length":0,"stats":{"Line":15}},{"line":744,"address":[],"length":0,"stats":{"Line":15}},{"line":745,"address":[],"length":0,"stats":{"Line":16}},{"line":748,"address":[],"length":0,"stats":{"Line":0}},{"line":751,"address":[],"length":0,"stats":{"Line":45}},{"line":752,"address":[],"length":0,"stats":{"Line":15}},{"line":753,"address":[],"length":0,"stats":{"Line":0}},{"line":754,"address":[],"length":0,"stats":{"Line":0}},{"line":758,"address":[],"length":0,"stats":{"Line":2}},{"line":759,"address":[],"length":0,"stats":{"Line":2}},{"line":762,"address":[],"length":0,"stats":{"Line":2}},{"line":763,"address":[],"length":0,"stats":{"Line":2}},{"line":764,"address":[],"length":0,"stats":{"Line":2}},{"line":766,"address":[],"length":0,"stats":{"Line":4}},{"line":768,"address":[],"length":0,"stats":{"Line":2}},{"line":770,"address":[],"length":0,"stats":{"Line":0}},{"line":772,"address":[],"length":0,"stats":{"Line":6}},{"line":773,"address":[],"length":0,"stats":{"Line":2}},{"line":774,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":0}},{"line":780,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":17}},{"line":785,"address":[],"length":0,"stats":{"Line":17}},{"line":786,"address":[],"length":0,"stats":{"Line":17}},{"line":787,"address":[],"length":0,"stats":{"Line":17}},{"line":788,"address":[],"length":0,"stats":{"Line":18}},{"line":791,"address":[],"length":0,"stats":{"Line":84}},{"line":792,"address":[],"length":0,"stats":{"Line":67}},{"line":795,"address":[],"length":0,"stats":{"Line":67}},{"line":796,"address":[],"length":0,"stats":{"Line":87}},{"line":797,"address":[],"length":0,"stats":{"Line":20}},{"line":799,"address":[],"length":0,"stats":{"Line":135}},{"line":802,"address":[],"length":0,"stats":{"Line":17}},{"line":805,"address":[],"length":0,"stats":{"Line":17}},{"line":808,"address":[],"length":0,"stats":{"Line":17}},{"line":816,"address":[],"length":0,"stats":{"Line":0}},{"line":817,"address":[],"length":0,"stats":{"Line":0}},{"line":829,"address":[],"length":0,"stats":{"Line":2}},{"line":830,"address":[],"length":0,"stats":{"Line":2}},{"line":831,"address":[],"length":0,"stats":{"Line":2}},{"line":832,"address":[],"length":0,"stats":{"Line":2}},{"line":833,"address":[],"length":0,"stats":{"Line":2}},{"line":834,"address":[],"length":0,"stats":{"Line":2}},{"line":835,"address":[],"length":0,"stats":{"Line":2}},{"line":836,"address":[],"length":0,"stats":{"Line":2}},{"line":837,"address":[],"length":0,"stats":{"Line":2}},{"line":838,"address":[],"length":0,"stats":{"Line":2}},{"line":841,"address":[],"length":0,"stats":{"Line":0}},{"line":842,"address":[],"length":0,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":844,"address":[],"length":0,"stats":{"Line":0}},{"line":845,"address":[],"length":0,"stats":{"Line":0}},{"line":852,"address":[],"length":0,"stats":{"Line":1}},{"line":854,"address":[],"length":0,"stats":{"Line":1}},{"line":855,"address":[],"length":0,"stats":{"Line":1}},{"line":856,"address":[],"length":0,"stats":{"Line":1}},{"line":857,"address":[],"length":0,"stats":{"Line":1}},{"line":860,"address":[],"length":0,"stats":{"Line":1}},{"line":861,"address":[],"length":0,"stats":{"Line":1}},{"line":862,"address":[],"length":0,"stats":{"Line":1}},{"line":863,"address":[],"length":0,"stats":{"Line":1}},{"line":866,"address":[],"length":0,"stats":{"Line":1}},{"line":867,"address":[],"length":0,"stats":{"Line":2}},{"line":869,"address":[],"length":0,"stats":{"Line":1}},{"line":874,"address":[],"length":0,"stats":{"Line":16}},{"line":876,"address":[],"length":0,"stats":{"Line":16}},{"line":877,"address":[],"length":0,"stats":{"Line":16}},{"line":878,"address":[],"length":0,"stats":{"Line":16}},{"line":879,"address":[],"length":0,"stats":{"Line":16}},{"line":880,"address":[],"length":0,"stats":{"Line":16}},{"line":881,"address":[],"length":0,"stats":{"Line":16}},{"line":882,"address":[],"length":0,"stats":{"Line":16}},{"line":883,"address":[],"length":0,"stats":{"Line":16}},{"line":884,"address":[],"length":0,"stats":{"Line":16}},{"line":893,"address":[],"length":0,"stats":{"Line":50}},{"line":894,"address":[],"length":0,"stats":{"Line":25}},{"line":896,"address":[],"length":0,"stats":{"Line":100}},{"line":911,"address":[],"length":0,"stats":{"Line":25}},{"line":912,"address":[],"length":0,"stats":{"Line":25}},{"line":913,"address":[],"length":0,"stats":{"Line":25}},{"line":922,"address":[],"length":0,"stats":{"Line":25}},{"line":923,"address":[],"length":0,"stats":{"Line":25}},{"line":924,"address":[],"length":0,"stats":{"Line":25}},{"line":927,"address":[],"length":0,"stats":{"Line":25}},{"line":928,"address":[],"length":0,"stats":{"Line":25}},{"line":929,"address":[],"length":0,"stats":{"Line":25}},{"line":930,"address":[],"length":0,"stats":{"Line":25}},{"line":931,"address":[],"length":0,"stats":{"Line":25}},{"line":932,"address":[],"length":0,"stats":{"Line":25}},{"line":933,"address":[],"length":0,"stats":{"Line":25}},{"line":934,"address":[],"length":0,"stats":{"Line":25}},{"line":935,"address":[],"length":0,"stats":{"Line":25}},{"line":936,"address":[],"length":0,"stats":{"Line":25}},{"line":937,"address":[],"length":0,"stats":{"Line":25}},{"line":939,"address":[],"length":0,"stats":{"Line":50}},{"line":940,"address":[],"length":0,"stats":{"Line":25}},{"line":944,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":946,"address":[],"length":0,"stats":{"Line":0}},{"line":953,"address":[],"length":0,"stats":{"Line":2}},{"line":954,"address":[],"length":0,"stats":{"Line":1}},{"line":955,"address":[],"length":0,"stats":{"Line":1}},{"line":956,"address":[],"length":0,"stats":{"Line":1}},{"line":958,"address":[],"length":0,"stats":{"Line":2}},{"line":960,"address":[],"length":0,"stats":{"Line":1}},{"line":974,"address":[],"length":0,"stats":{"Line":0}},{"line":975,"address":[],"length":0,"stats":{"Line":0}},{"line":976,"address":[],"length":0,"stats":{"Line":0}},{"line":978,"address":[],"length":0,"stats":{"Line":0}},{"line":979,"address":[],"length":0,"stats":{"Line":0}},{"line":980,"address":[],"length":0,"stats":{"Line":0}},{"line":981,"address":[],"length":0,"stats":{"Line":0}},{"line":983,"address":[],"length":0,"stats":{"Line":0}},{"line":984,"address":[],"length":0,"stats":{"Line":0}},{"line":985,"address":[],"length":0,"stats":{"Line":0}},{"line":986,"address":[],"length":0,"stats":{"Line":0}},{"line":987,"address":[],"length":0,"stats":{"Line":0}},{"line":991,"address":[],"length":0,"stats":{"Line":0}},{"line":998,"address":[],"length":0,"stats":{"Line":0}},{"line":999,"address":[],"length":0,"stats":{"Line":0}},{"line":1002,"address":[],"length":0,"stats":{"Line":1105}},{"line":1005,"address":[],"length":0,"stats":{"Line":4324}},{"line":1006,"address":[],"length":0,"stats":{"Line":4402}},{"line":1007,"address":[],"length":0,"stats":{"Line":2164}},{"line":1008,"address":[],"length":0,"stats":{"Line":0}},{"line":1009,"address":[],"length":0,"stats":{"Line":0}},{"line":1010,"address":[],"length":0,"stats":{"Line":0}},{"line":1012,"address":[],"length":0,"stats":{"Line":1105}},{"line":1014,"address":[],"length":0,"stats":{"Line":1105}},{"line":1023,"address":[],"length":0,"stats":{"Line":1173}},{"line":1024,"address":[],"length":0,"stats":{"Line":1173}},{"line":1025,"address":[],"length":0,"stats":{"Line":20}},{"line":1026,"address":[],"length":0,"stats":{"Line":1153}},{"line":1038,"address":[],"length":0,"stats":{"Line":0}},{"line":1039,"address":[],"length":0,"stats":{"Line":0}},{"line":1040,"address":[],"length":0,"stats":{"Line":0}},{"line":1041,"address":[],"length":0,"stats":{"Line":0}},{"line":1042,"address":[],"length":0,"stats":{"Line":0}},{"line":1043,"address":[],"length":0,"stats":{"Line":1167}},{"line":1045,"address":[],"length":0,"stats":{"Line":1173}},{"line":1046,"address":[],"length":0,"stats":{"Line":1173}},{"line":1047,"address":[],"length":0,"stats":{"Line":1173}},{"line":1048,"address":[],"length":0,"stats":{"Line":1173}},{"line":1049,"address":[],"length":0,"stats":{"Line":1173}},{"line":1050,"address":[],"length":0,"stats":{"Line":1173}},{"line":1051,"address":[],"length":0,"stats":{"Line":1173}},{"line":1053,"address":[],"length":0,"stats":{"Line":1173}},{"line":1054,"address":[],"length":0,"stats":{"Line":0}},{"line":1055,"address":[],"length":0,"stats":{"Line":0}},{"line":1058,"address":[],"length":0,"stats":{"Line":2346}},{"line":1059,"address":[],"length":0,"stats":{"Line":0}},{"line":1066,"address":[],"length":0,"stats":{"Line":0}},{"line":1069,"address":[],"length":0,"stats":{"Line":1173}},{"line":1075,"address":[],"length":0,"stats":{"Line":2}},{"line":1076,"address":[],"length":0,"stats":{"Line":2}},{"line":1077,"address":[],"length":0,"stats":{"Line":2}},{"line":1078,"address":[],"length":0,"stats":{"Line":2}},{"line":1079,"address":[],"length":0,"stats":{"Line":2}},{"line":1080,"address":[],"length":0,"stats":{"Line":2}},{"line":1081,"address":[],"length":0,"stats":{"Line":2}},{"line":1087,"address":[],"length":0,"stats":{"Line":1171}},{"line":1088,"address":[],"length":0,"stats":{"Line":1171}},{"line":1089,"address":[],"length":0,"stats":{"Line":1171}},{"line":1090,"address":[],"length":0,"stats":{"Line":1171}},{"line":1091,"address":[],"length":0,"stats":{"Line":1171}},{"line":1092,"address":[],"length":0,"stats":{"Line":1171}},{"line":1098,"address":[],"length":0,"stats":{"Line":2335}},{"line":1102,"address":[],"length":0,"stats":{"Line":1173}},{"line":1110,"address":[],"length":0,"stats":{"Line":0}},{"line":1111,"address":[],"length":0,"stats":{"Line":0}},{"line":1118,"address":[],"length":0,"stats":{"Line":0}},{"line":1119,"address":[],"length":0,"stats":{"Line":0}},{"line":1121,"address":[],"length":0,"stats":{"Line":0}},{"line":1122,"address":[],"length":0,"stats":{"Line":0}},{"line":1123,"address":[],"length":0,"stats":{"Line":0}},{"line":1126,"address":[],"length":0,"stats":{"Line":1}},{"line":1127,"address":[],"length":0,"stats":{"Line":1}},{"line":1128,"address":[],"length":0,"stats":{"Line":1}},{"line":1129,"address":[],"length":0,"stats":{"Line":1}},{"line":1130,"address":[],"length":0,"stats":{"Line":1}},{"line":1131,"address":[],"length":0,"stats":{"Line":1}},{"line":1134,"address":[],"length":0,"stats":{"Line":0}},{"line":1138,"address":[],"length":0,"stats":{"Line":0}},{"line":1146,"address":[],"length":0,"stats":{"Line":21}},{"line":1147,"address":[],"length":0,"stats":{"Line":81}},{"line":1151,"address":[],"length":0,"stats":{"Line":21}},{"line":1152,"address":[],"length":0,"stats":{"Line":21}},{"line":1153,"address":[],"length":0,"stats":{"Line":21}},{"line":1155,"address":[],"length":0,"stats":{"Line":21}},{"line":1156,"address":[],"length":0,"stats":{"Line":21}},{"line":1157,"address":[],"length":0,"stats":{"Line":21}},{"line":1158,"address":[],"length":0,"stats":{"Line":21}},{"line":1159,"address":[],"length":0,"stats":{"Line":21}},{"line":1160,"address":[],"length":0,"stats":{"Line":21}},{"line":1161,"address":[],"length":0,"stats":{"Line":21}},{"line":1163,"address":[],"length":0,"stats":{"Line":21}},{"line":1164,"address":[],"length":0,"stats":{"Line":20}},{"line":1168,"address":[],"length":0,"stats":{"Line":21}},{"line":1178,"address":[],"length":0,"stats":{"Line":21}},{"line":1179,"address":[],"length":0,"stats":{"Line":21}},{"line":1181,"address":[],"length":0,"stats":{"Line":83}},{"line":1185,"address":[],"length":0,"stats":{"Line":0}},{"line":1186,"address":[],"length":0,"stats":{"Line":0}},{"line":1188,"address":[],"length":0,"stats":{"Line":0}},{"line":1189,"address":[],"length":0,"stats":{"Line":0}},{"line":1190,"address":[],"length":0,"stats":{"Line":0}},{"line":1191,"address":[],"length":0,"stats":{"Line":0}},{"line":1192,"address":[],"length":0,"stats":{"Line":0}},{"line":1194,"address":[],"length":0,"stats":{"Line":0}},{"line":1202,"address":[],"length":0,"stats":{"Line":0}},{"line":1203,"address":[],"length":0,"stats":{"Line":0}},{"line":1220,"address":[],"length":0,"stats":{"Line":0}},{"line":1221,"address":[],"length":0,"stats":{"Line":0}},{"line":1223,"address":[],"length":0,"stats":{"Line":0}},{"line":1224,"address":[],"length":0,"stats":{"Line":0}},{"line":1225,"address":[],"length":0,"stats":{"Line":0}},{"line":1226,"address":[],"length":0,"stats":{"Line":0}},{"line":1227,"address":[],"length":0,"stats":{"Line":0}},{"line":1228,"address":[],"length":0,"stats":{"Line":0}},{"line":1232,"address":[],"length":0,"stats":{"Line":3}},{"line":1233,"address":[],"length":0,"stats":{"Line":12}},{"line":1234,"address":[],"length":0,"stats":{"Line":9}},{"line":1235,"address":[],"length":0,"stats":{"Line":5}},{"line":1236,"address":[],"length":0,"stats":{"Line":3}},{"line":1244,"address":[],"length":0,"stats":{"Line":10}},{"line":1245,"address":[],"length":0,"stats":{"Line":5}},{"line":1246,"address":[],"length":0,"stats":{"Line":5}},{"line":1248,"address":[],"length":0,"stats":{"Line":5}},{"line":1249,"address":[],"length":0,"stats":{"Line":5}},{"line":1250,"address":[],"length":0,"stats":{"Line":5}},{"line":1251,"address":[],"length":0,"stats":{"Line":5}},{"line":1253,"address":[],"length":0,"stats":{"Line":5}},{"line":1255,"address":[],"length":0,"stats":{"Line":5}},{"line":1258,"address":[],"length":0,"stats":{"Line":5}},{"line":1266,"address":[],"length":0,"stats":{"Line":0}},{"line":1276,"address":[],"length":0,"stats":{"Line":0}},{"line":1281,"address":[],"length":0,"stats":{"Line":0}},{"line":1285,"address":[],"length":0,"stats":{"Line":0}},{"line":1289,"address":[],"length":0,"stats":{"Line":0}},{"line":1293,"address":[],"length":0,"stats":{"Line":4}},{"line":1294,"address":[],"length":0,"stats":{"Line":4}},{"line":1295,"address":[],"length":0,"stats":{"Line":4}},{"line":1296,"address":[],"length":0,"stats":{"Line":4}},{"line":1299,"address":[],"length":0,"stats":{"Line":4}},{"line":1310,"address":[],"length":0,"stats":{"Line":21}},{"line":1311,"address":[],"length":0,"stats":{"Line":21}},{"line":1312,"address":[],"length":0,"stats":{"Line":21}},{"line":1313,"address":[],"length":0,"stats":{"Line":21}},{"line":1315,"address":[],"length":0,"stats":{"Line":21}},{"line":1316,"address":[],"length":0,"stats":{"Line":21}},{"line":1317,"address":[],"length":0,"stats":{"Line":21}},{"line":1318,"address":[],"length":0,"stats":{"Line":21}},{"line":1319,"address":[],"length":0,"stats":{"Line":21}},{"line":1320,"address":[],"length":0,"stats":{"Line":21}},{"line":1321,"address":[],"length":0,"stats":{"Line":21}},{"line":1322,"address":[],"length":0,"stats":{"Line":21}},{"line":1323,"address":[],"length":0,"stats":{"Line":21}},{"line":1325,"address":[],"length":0,"stats":{"Line":65}},{"line":1326,"address":[],"length":0,"stats":{"Line":22}},{"line":1333,"address":[],"length":0,"stats":{"Line":41}},{"line":1334,"address":[],"length":0,"stats":{"Line":23}},{"line":1336,"address":[],"length":0,"stats":{"Line":21}},{"line":1339,"address":[],"length":0,"stats":{"Line":0}},{"line":1340,"address":[],"length":0,"stats":{"Line":0}},{"line":1342,"address":[],"length":0,"stats":{"Line":0}},{"line":1343,"address":[],"length":0,"stats":{"Line":0}},{"line":1344,"address":[],"length":0,"stats":{"Line":0}},{"line":1346,"address":[],"length":0,"stats":{"Line":0}},{"line":1347,"address":[],"length":0,"stats":{"Line":0}},{"line":1348,"address":[],"length":0,"stats":{"Line":0}},{"line":1350,"address":[],"length":0,"stats":{"Line":0}},{"line":1362,"address":[],"length":0,"stats":{"Line":0}},{"line":1363,"address":[],"length":0,"stats":{"Line":0}},{"line":1364,"address":[],"length":0,"stats":{"Line":0}},{"line":1366,"address":[],"length":0,"stats":{"Line":0}},{"line":1367,"address":[],"length":0,"stats":{"Line":0}},{"line":1368,"address":[],"length":0,"stats":{"Line":0}},{"line":1369,"address":[],"length":0,"stats":{"Line":0}},{"line":1370,"address":[],"length":0,"stats":{"Line":0}},{"line":1379,"address":[],"length":0,"stats":{"Line":0}},{"line":1380,"address":[],"length":0,"stats":{"Line":0}},{"line":1382,"address":[],"length":0,"stats":{"Line":0}},{"line":1383,"address":[],"length":0,"stats":{"Line":0}},{"line":1384,"address":[],"length":0,"stats":{"Line":0}},{"line":1386,"address":[],"length":0,"stats":{"Line":0}},{"line":1387,"address":[],"length":0,"stats":{"Line":0}},{"line":1388,"address":[],"length":0,"stats":{"Line":0}},{"line":1389,"address":[],"length":0,"stats":{"Line":0}},{"line":1390,"address":[],"length":0,"stats":{"Line":0}},{"line":1394,"address":[],"length":0,"stats":{"Line":12}},{"line":1395,"address":[],"length":0,"stats":{"Line":46}},{"line":1396,"address":[],"length":0,"stats":{"Line":37}},{"line":1397,"address":[],"length":0,"stats":{"Line":20}},{"line":1398,"address":[],"length":0,"stats":{"Line":11}},{"line":1411,"address":[],"length":0,"stats":{"Line":12}},{"line":1412,"address":[],"length":0,"stats":{"Line":12}},{"line":1413,"address":[],"length":0,"stats":{"Line":12}},{"line":1414,"address":[],"length":0,"stats":{"Line":12}},{"line":1415,"address":[],"length":0,"stats":{"Line":12}},{"line":1416,"address":[],"length":0,"stats":{"Line":12}},{"line":1417,"address":[],"length":0,"stats":{"Line":12}},{"line":1418,"address":[],"length":0,"stats":{"Line":12}},{"line":1419,"address":[],"length":0,"stats":{"Line":14}},{"line":1421,"address":[],"length":0,"stats":{"Line":11}},{"line":1424,"address":[],"length":0,"stats":{"Line":11}},{"line":1439,"address":[],"length":0,"stats":{"Line":0}},{"line":1440,"address":[],"length":0,"stats":{"Line":0}},{"line":1441,"address":[],"length":0,"stats":{"Line":0}},{"line":1442,"address":[],"length":0,"stats":{"Line":0}},{"line":1443,"address":[],"length":0,"stats":{"Line":0}},{"line":1444,"address":[],"length":0,"stats":{"Line":0}},{"line":1445,"address":[],"length":0,"stats":{"Line":0}},{"line":1446,"address":[],"length":0,"stats":{"Line":0}},{"line":1447,"address":[],"length":0,"stats":{"Line":0}},{"line":1448,"address":[],"length":0,"stats":{"Line":0}},{"line":1449,"address":[],"length":0,"stats":{"Line":0}},{"line":1450,"address":[],"length":0,"stats":{"Line":0}},{"line":1454,"address":[],"length":0,"stats":{"Line":0}},{"line":1459,"address":[],"length":0,"stats":{"Line":0}},{"line":1463,"address":[],"length":0,"stats":{"Line":0}},{"line":1467,"address":[],"length":0,"stats":{"Line":0}},{"line":1483,"address":[],"length":0,"stats":{"Line":0}},{"line":1487,"address":[],"length":0,"stats":{"Line":0}},{"line":1488,"address":[],"length":0,"stats":{"Line":0}},{"line":1489,"address":[],"length":0,"stats":{"Line":0}},{"line":1491,"address":[],"length":0,"stats":{"Line":0}},{"line":1492,"address":[],"length":0,"stats":{"Line":0}},{"line":1493,"address":[],"length":0,"stats":{"Line":0}},{"line":1494,"address":[],"length":0,"stats":{"Line":0}},{"line":1497,"address":[],"length":0,"stats":{"Line":6}},{"line":1498,"address":[],"length":0,"stats":{"Line":3}},{"line":1499,"address":[],"length":0,"stats":{"Line":3}},{"line":1500,"address":[],"length":0,"stats":{"Line":0}},{"line":1501,"address":[],"length":0,"stats":{"Line":0}},{"line":1502,"address":[],"length":0,"stats":{"Line":0}},{"line":1505,"address":[],"length":0,"stats":{"Line":3}},{"line":1506,"address":[],"length":0,"stats":{"Line":3}},{"line":1507,"address":[],"length":0,"stats":{"Line":3}},{"line":1509,"address":[],"length":0,"stats":{"Line":3}},{"line":1510,"address":[],"length":0,"stats":{"Line":6}},{"line":1511,"address":[],"length":0,"stats":{"Line":3}},{"line":1513,"address":[],"length":0,"stats":{"Line":3}},{"line":1514,"address":[],"length":0,"stats":{"Line":3}},{"line":1515,"address":[],"length":0,"stats":{"Line":0}},{"line":1516,"address":[],"length":0,"stats":{"Line":0}},{"line":1517,"address":[],"length":0,"stats":{"Line":0}},{"line":1519,"address":[],"length":0,"stats":{"Line":3}},{"line":1521,"address":[],"length":0,"stats":{"Line":0}},{"line":1522,"address":[],"length":0,"stats":{"Line":0}},{"line":1523,"address":[],"length":0,"stats":{"Line":0}},{"line":1526,"address":[],"length":0,"stats":{"Line":0}},{"line":1536,"address":[],"length":0,"stats":{"Line":21}},{"line":1537,"address":[],"length":0,"stats":{"Line":61}},{"line":1538,"address":[],"length":0,"stats":{"Line":21}},{"line":1540,"address":[],"length":0,"stats":{"Line":21}},{"line":1541,"address":[],"length":0,"stats":{"Line":21}},{"line":1542,"address":[],"length":0,"stats":{"Line":21}},{"line":1544,"address":[],"length":0,"stats":{"Line":21}},{"line":1545,"address":[],"length":0,"stats":{"Line":24}},{"line":1548,"address":[],"length":0,"stats":{"Line":21}},{"line":1549,"address":[],"length":0,"stats":{"Line":21}},{"line":1550,"address":[],"length":0,"stats":{"Line":21}},{"line":1552,"address":[],"length":0,"stats":{"Line":21}},{"line":1553,"address":[],"length":0,"stats":{"Line":21}},{"line":1554,"address":[],"length":0,"stats":{"Line":21}},{"line":1555,"address":[],"length":0,"stats":{"Line":21}},{"line":1556,"address":[],"length":0,"stats":{"Line":21}},{"line":1557,"address":[],"length":0,"stats":{"Line":21}},{"line":1558,"address":[],"length":0,"stats":{"Line":21}},{"line":1559,"address":[],"length":0,"stats":{"Line":21}},{"line":1560,"address":[],"length":0,"stats":{"Line":21}},{"line":1561,"address":[],"length":0,"stats":{"Line":21}},{"line":1563,"address":[],"length":0,"stats":{"Line":21}},{"line":1564,"address":[],"length":0,"stats":{"Line":22}},{"line":1567,"address":[],"length":0,"stats":{"Line":0}},{"line":1569,"address":[],"length":0,"stats":{"Line":0}},{"line":1570,"address":[],"length":0,"stats":{"Line":0}},{"line":1571,"address":[],"length":0,"stats":{"Line":0}},{"line":1573,"address":[],"length":0,"stats":{"Line":0}},{"line":1574,"address":[],"length":0,"stats":{"Line":0}},{"line":1575,"address":[],"length":0,"stats":{"Line":0}},{"line":1576,"address":[],"length":0,"stats":{"Line":0}},{"line":1577,"address":[],"length":0,"stats":{"Line":0}},{"line":1578,"address":[],"length":0,"stats":{"Line":0}},{"line":1579,"address":[],"length":0,"stats":{"Line":0}},{"line":1582,"address":[],"length":0,"stats":{"Line":0}},{"line":1583,"address":[],"length":0,"stats":{"Line":0}},{"line":1584,"address":[],"length":0,"stats":{"Line":0}},{"line":1585,"address":[],"length":0,"stats":{"Line":0}},{"line":1589,"address":[],"length":0,"stats":{"Line":0}},{"line":1590,"address":[],"length":0,"stats":{"Line":0}},{"line":1591,"address":[],"length":0,"stats":{"Line":0}},{"line":1592,"address":[],"length":0,"stats":{"Line":0}},{"line":1593,"address":[],"length":0,"stats":{"Line":0}},{"line":1595,"address":[],"length":0,"stats":{"Line":0}},{"line":1596,"address":[],"length":0,"stats":{"Line":0}},{"line":1598,"address":[],"length":0,"stats":{"Line":0}},{"line":1599,"address":[],"length":0,"stats":{"Line":0}},{"line":1601,"address":[],"length":0,"stats":{"Line":0}},{"line":1602,"address":[],"length":0,"stats":{"Line":0}},{"line":1603,"address":[],"length":0,"stats":{"Line":0}},{"line":1605,"address":[],"length":0,"stats":{"Line":0}},{"line":1606,"address":[],"length":0,"stats":{"Line":0}},{"line":1607,"address":[],"length":0,"stats":{"Line":0}},{"line":1611,"address":[],"length":0,"stats":{"Line":0}},{"line":1612,"address":[],"length":0,"stats":{"Line":0}},{"line":1613,"address":[],"length":0,"stats":{"Line":0}},{"line":1619,"address":[],"length":0,"stats":{"Line":0}},{"line":1620,"address":[],"length":0,"stats":{"Line":0}},{"line":1621,"address":[],"length":0,"stats":{"Line":0}},{"line":1622,"address":[],"length":0,"stats":{"Line":0}},{"line":1624,"address":[],"length":0,"stats":{"Line":0}},{"line":1625,"address":[],"length":0,"stats":{"Line":0}},{"line":1630,"address":[],"length":0,"stats":{"Line":21}},{"line":1631,"address":[],"length":0,"stats":{"Line":21}},{"line":1632,"address":[],"length":0,"stats":{"Line":20}},{"line":1634,"address":[],"length":0,"stats":{"Line":0}},{"line":1638,"address":[],"length":0,"stats":{"Line":21}},{"line":1639,"address":[],"length":0,"stats":{"Line":21}},{"line":1640,"address":[],"length":0,"stats":{"Line":21}},{"line":1641,"address":[],"length":0,"stats":{"Line":0}},{"line":1642,"address":[],"length":0,"stats":{"Line":0}},{"line":1646,"address":[],"length":0,"stats":{"Line":0}},{"line":1647,"address":[],"length":0,"stats":{"Line":0}},{"line":1652,"address":[],"length":0,"stats":{"Line":21}},{"line":1653,"address":[],"length":0,"stats":{"Line":21}},{"line":1654,"address":[],"length":0,"stats":{"Line":21}},{"line":1655,"address":[],"length":0,"stats":{"Line":21}},{"line":1656,"address":[],"length":0,"stats":{"Line":21}},{"line":1658,"address":[],"length":0,"stats":{"Line":21}},{"line":1659,"address":[],"length":0,"stats":{"Line":24}},{"line":1661,"address":[],"length":0,"stats":{"Line":21}},{"line":1665,"address":[],"length":0,"stats":{"Line":2}},{"line":1666,"address":[],"length":0,"stats":{"Line":3}},{"line":1667,"address":[],"length":0,"stats":{"Line":2}},{"line":1668,"address":[],"length":0,"stats":{"Line":2}},{"line":1669,"address":[],"length":0,"stats":{"Line":4}},{"line":1672,"address":[],"length":0,"stats":{"Line":1}},{"line":1695,"address":[],"length":0,"stats":{"Line":0}},{"line":1696,"address":[],"length":0,"stats":{"Line":0}},{"line":1697,"address":[],"length":0,"stats":{"Line":0}},{"line":1698,"address":[],"length":0,"stats":{"Line":0}},{"line":1699,"address":[],"length":0,"stats":{"Line":0}},{"line":1700,"address":[],"length":0,"stats":{"Line":0}},{"line":1702,"address":[],"length":0,"stats":{"Line":0}},{"line":1703,"address":[],"length":0,"stats":{"Line":0}},{"line":1704,"address":[],"length":0,"stats":{"Line":0}},{"line":1705,"address":[],"length":0,"stats":{"Line":0}},{"line":1706,"address":[],"length":0,"stats":{"Line":0}},{"line":1710,"address":[],"length":0,"stats":{"Line":0}},{"line":1714,"address":[],"length":0,"stats":{"Line":10}},{"line":1715,"address":[],"length":0,"stats":{"Line":38}},{"line":1716,"address":[],"length":0,"stats":{"Line":31}},{"line":1717,"address":[],"length":0,"stats":{"Line":16}},{"line":1718,"address":[],"length":0,"stats":{"Line":8}},{"line":1726,"address":[],"length":0,"stats":{"Line":27}},{"line":1727,"address":[],"length":0,"stats":{"Line":10}},{"line":1729,"address":[],"length":0,"stats":{"Line":18}},{"line":1730,"address":[],"length":0,"stats":{"Line":10}},{"line":1731,"address":[],"length":0,"stats":{"Line":10}},{"line":1733,"address":[],"length":0,"stats":{"Line":10}},{"line":1734,"address":[],"length":0,"stats":{"Line":10}},{"line":1735,"address":[],"length":0,"stats":{"Line":10}},{"line":1736,"address":[],"length":0,"stats":{"Line":10}},{"line":1737,"address":[],"length":0,"stats":{"Line":10}},{"line":1738,"address":[],"length":0,"stats":{"Line":10}},{"line":1739,"address":[],"length":0,"stats":{"Line":10}},{"line":1740,"address":[],"length":0,"stats":{"Line":10}},{"line":1741,"address":[],"length":0,"stats":{"Line":13}},{"line":1744,"address":[],"length":0,"stats":{"Line":8}},{"line":1748,"address":[],"length":0,"stats":{"Line":8}},{"line":1767,"address":[],"length":0,"stats":{"Line":0}},{"line":1768,"address":[],"length":0,"stats":{"Line":0}},{"line":1769,"address":[],"length":0,"stats":{"Line":0}},{"line":1770,"address":[],"length":0,"stats":{"Line":0}},{"line":1771,"address":[],"length":0,"stats":{"Line":0}},{"line":1774,"address":[],"length":0,"stats":{"Line":0}},{"line":1775,"address":[],"length":0,"stats":{"Line":0}},{"line":1776,"address":[],"length":0,"stats":{"Line":0}},{"line":1777,"address":[],"length":0,"stats":{"Line":0}},{"line":1778,"address":[],"length":0,"stats":{"Line":0}},{"line":1779,"address":[],"length":0,"stats":{"Line":0}},{"line":1782,"address":[],"length":0,"stats":{"Line":0}},{"line":1786,"address":[],"length":0,"stats":{"Line":0}},{"line":1792,"address":[],"length":0,"stats":{"Line":1}},{"line":1793,"address":[],"length":0,"stats":{"Line":1}},{"line":1794,"address":[],"length":0,"stats":{"Line":2}},{"line":1795,"address":[],"length":0,"stats":{"Line":0}},{"line":1796,"address":[],"length":0,"stats":{"Line":1}},{"line":1797,"address":[],"length":0,"stats":{"Line":2}},{"line":1805,"address":[],"length":0,"stats":{"Line":1}},{"line":1806,"address":[],"length":0,"stats":{"Line":1}},{"line":1808,"address":[],"length":0,"stats":{"Line":1}},{"line":1809,"address":[],"length":0,"stats":{"Line":1}},{"line":1810,"address":[],"length":0,"stats":{"Line":1}},{"line":1811,"address":[],"length":0,"stats":{"Line":1}},{"line":1812,"address":[],"length":0,"stats":{"Line":1}},{"line":1813,"address":[],"length":0,"stats":{"Line":1}},{"line":1814,"address":[],"length":0,"stats":{"Line":1}},{"line":1815,"address":[],"length":0,"stats":{"Line":1}},{"line":1821,"address":[],"length":0,"stats":{"Line":2}},{"line":1822,"address":[],"length":0,"stats":{"Line":1}},{"line":1823,"address":[],"length":0,"stats":{"Line":1}},{"line":1825,"address":[],"length":0,"stats":{"Line":3}},{"line":1827,"address":[],"length":0,"stats":{"Line":6}},{"line":1828,"address":[],"length":0,"stats":{"Line":0}},{"line":1830,"address":[],"length":0,"stats":{"Line":4}},{"line":1831,"address":[],"length":0,"stats":{"Line":0}},{"line":1832,"address":[],"length":0,"stats":{"Line":0}},{"line":1833,"address":[],"length":0,"stats":{"Line":1}},{"line":1839,"address":[],"length":0,"stats":{"Line":2}},{"line":1850,"address":[],"length":0,"stats":{"Line":2}},{"line":1851,"address":[],"length":0,"stats":{"Line":2}},{"line":1852,"address":[],"length":0,"stats":{"Line":2}},{"line":1853,"address":[],"length":0,"stats":{"Line":2}},{"line":1855,"address":[],"length":0,"stats":{"Line":2}},{"line":1857,"address":[],"length":0,"stats":{"Line":3}},{"line":1858,"address":[],"length":0,"stats":{"Line":1}},{"line":1859,"address":[],"length":0,"stats":{"Line":1}},{"line":1860,"address":[],"length":0,"stats":{"Line":1}},{"line":1863,"address":[],"length":0,"stats":{"Line":2}},{"line":1868,"address":[],"length":0,"stats":{"Line":0}},{"line":1869,"address":[],"length":0,"stats":{"Line":0}},{"line":1875,"address":[],"length":0,"stats":{"Line":1215}},{"line":1876,"address":[],"length":0,"stats":{"Line":1215}},{"line":1877,"address":[],"length":0,"stats":{"Line":1215}},{"line":1878,"address":[],"length":0,"stats":{"Line":1215}},{"line":1879,"address":[],"length":0,"stats":{"Line":1215}},{"line":1880,"address":[],"length":0,"stats":{"Line":1215}},{"line":1881,"address":[],"length":0,"stats":{"Line":1215}},{"line":1883,"address":[],"length":0,"stats":{"Line":1215}},{"line":1884,"address":[],"length":0,"stats":{"Line":0}},{"line":1887,"address":[],"length":0,"stats":{"Line":1215}},{"line":1888,"address":[],"length":0,"stats":{"Line":1215}},{"line":1889,"address":[],"length":0,"stats":{"Line":1215}},{"line":1890,"address":[],"length":0,"stats":{"Line":1215}},{"line":1891,"address":[],"length":0,"stats":{"Line":1215}},{"line":1892,"address":[],"length":0,"stats":{"Line":1215}},{"line":1893,"address":[],"length":0,"stats":{"Line":1215}},{"line":1894,"address":[],"length":0,"stats":{"Line":1215}},{"line":1899,"address":[],"length":0,"stats":{"Line":3}},{"line":1904,"address":[],"length":0,"stats":{"Line":6}},{"line":1905,"address":[],"length":0,"stats":{"Line":3}},{"line":1906,"address":[],"length":0,"stats":{"Line":3}},{"line":1908,"address":[],"length":0,"stats":{"Line":3}},{"line":1909,"address":[],"length":0,"stats":{"Line":3}},{"line":1910,"address":[],"length":0,"stats":{"Line":3}},{"line":1911,"address":[],"length":0,"stats":{"Line":3}},{"line":1913,"address":[],"length":0,"stats":{"Line":7}},{"line":1914,"address":[],"length":0,"stats":{"Line":3}}],"covered":506,"coverable":798},{"path":["/","Users","yaleman","Projects","goatns","src","db","test.rs"],"content":"use super::*;\n\nuse crate::enums::{RecordClass, RecordType};\nuse crate::error::GoatNsError;\nuse crate::zones::{FileZone, FileZoneRecord};\n\n#[tokio::test]\nasync fn create_user() -\u003e Result\u003c(), GoatNsError\u003e {\n    let pool = test_get_sqlite_memory().await;\n\n    start_db(\u0026pool).await?;\n\n    let mut user = User {\n        username: \"yaleman\".to_string(),\n        email: \"billy@hello.goat\".to_string(),\n        disabled: true,\n        ..User::default()\n    };\n\n    println!(\"Creating user the first time\");\n    user.save(\u0026pool).await?;\n\n    user.disabled = false;\n\n    println!(\"Creating user the second time\");\n    let res = user.save(\u0026pool).await;\n    assert!(res.is_err());\n\n    Ok(())\n}\n\n#[cfg(test)]\n/// create a zone example.com\npub async fn test_create_example_com_records(\n    pool: \u0026SqlitePool,\n    zoneid: i64,\n    num_records: usize,\n) -\u003e Result\u003c(), GoatNsError\u003e {\n    use rand::distributions::{Alphanumeric, DistString};\n\n    let mut name: String;\n    let mut rdata: String;\n    for i in 0..num_records {\n        name = Alphanumeric.sample_string(\u0026mut rand::thread_rng(), 16);\n        rdata = Alphanumeric.sample_string(\u0026mut rand::thread_rng(), 32);\n\n        FileZoneRecord {\n            zoneid: Some(zoneid),\n            name,\n            rrtype: RecordType::A.to_string(),\n            class: RecordClass::Internet,\n            rdata,\n            id: None,\n            ttl: i as u32,\n        }\n        .save(\u0026pool)\n        .await?;\n    }\n    println!(\"Completed creating records\");\n    Ok(())\n}\n\n#[tokio::test]\nasync fn test_get_zone_records() -\u003e Result\u003c(), GoatNsError\u003e {\n    let pool = test_get_sqlite_memory().await;\n    start_db(\u0026pool).await?;\n    test_create_example_com_zone(\u0026pool).await?;\n    let testzone = test_example_com_zone();\n\n    let mut txn = pool.begin().await?;\n    let zone = FileZone::get_by_name(\u0026mut txn, \u0026testzone.name)\n        .await?\n        .expect(\"Couldn't get zone\");\n\n    test_create_example_com_records(\u0026pool, zone.id.expect(\"Zone ID not found\"), 1000).await?;\n\n    let zone = FileZone::get_by_name(\u0026mut txn, \u0026testzone.name)\n        .await?\n        .expect(\"Failed to get zone\")\n        .with_zone_records(\u0026mut txn)\n        .await;\n\n    assert_eq!(zone.records.len(), 1000);\n    Ok(())\n}\n\n/// Checks that the table create process works and is idempotent\n#[tokio::test]\nasync fn test_db_create_table_zones() -\u003e Result\u003c(), GoatNsError\u003e {\n    let pool = test_get_sqlite_memory().await;\n    FileZone::create_table(\u0026pool).await?;\n    FileZone::create_table(\u0026pool).await?;\n    Ok(FileZone::create_table(\u0026pool).await?)\n}\n\n/// Checks that the table create process works and is idempotent\n#[tokio::test]\nasync fn test_db_create_table_records() -\u003e Result\u003c(), GoatNsError\u003e {\n    let pool = test_get_sqlite_memory().await;\n    println!(\"Creating Records Table\");\n    FileZoneRecord::create_table(\u0026pool).await?;\n    FileZoneRecord::create_table(\u0026pool).await?;\n    Ok(FileZoneRecord::create_table(\u0026pool).await?)\n}\n\n/// An example zone for testing\npub fn test_example_com_zone() -\u003e FileZone {\n    FileZone {\n        id: Some(1),\n        name: String::from(\"example.com\"),\n        rname: String::from(\"billy.example.com\"),\n        ..FileZone::default()\n    }\n}\n\n/// Get a sqlite pool with a memory-only database\npub async fn test_get_sqlite_memory() -\u003e SqlitePool {\n    SqlitePool::connect(\"sqlite::memory:\").await.unwrap()\n}\n\n/// A whole lotta tests\n#[tokio::test]\nasync fn test_db_create_records() -\u003e Result\u003c(), GoatNsError\u003e {\n    let pool = test_get_sqlite_memory().await;\n\n    start_db(\u0026pool).await?;\n\n    println!(\"Creating Zone\");\n    let zone = test_example_com_zone()\n        .save(\u0026pool)\n        .await\n        .expect(\"Failed to save the zone!\");\n\n    let mut txn = pool.begin().await?;\n    eprintln!(\n        \"Zone after create: {:?}\",\n        FileZone::get_by_name(\u0026mut txn, \u0026test_example_com_zone().name).await?\n    );\n\n    println!(\"Creating Record\");\n    let rrtype: \u0026str = RecordType::TXT.into();\n    let rec_to_create = FileZoneRecord {\n        name: \"foo\".to_string(),\n        zoneid: zone.id,\n        ttl: 123,\n        id: None,\n        rrtype: rrtype.into(),\n        class: RecordClass::Internet.into(),\n        rdata: \"test txt\".to_string(),\n    };\n    println!(\"rec to create: {rec_to_create:?}\");\n    if let Err(error) = rec_to_create.save(\u0026pool).await {\n        panic!(\"{error:?}\");\n    };\n\n    let res = get_records(\n        \u0026pool,\n        \"foo\".to_string(),\n        RecordType::TXT,\n        RecordClass::Internet,\n        false,\n    )\n    .await?;\n    println!(\"Record: {res:?}\");\n    Ok(())\n}\n\n/// test all the things\n#[tokio::test]\nasync fn test_all_db_things() -\u003e Result\u003c(), GoatNsError\u003e {\n    let pool = test_get_sqlite_memory().await;\n\n    println!(\"Creating Zones Table\");\n    FileZone::create_table(\u0026pool).await?;\n    println!(\"Creating Records Table\");\n    FileZoneRecord::create_table(\u0026pool).await?;\n    println!(\"Successfully created tables!\");\n\n    let zone = test_example_com_zone();\n\n    println!(\"Creating a zone\");\n    zone.clone().save(\u0026pool).await?;\n    println!(\"Getting a zone!\");\n    let mut txn = pool.begin().await?;\n    let zone_data = FileZone::get_by_name(\u0026mut txn, \"example.com\")\n        .await?\n        .expect(\"Failed to get zone\");\n    println!(\"Zone: {:?}\", zone_data);\n\n    assert_eq!(*zone_data, zone);\n    let zone_data = FileZone::get_by_name(\u0026mut txn, \"example.com\")\n        .await?\n        .expect(\"Failed to get zone\");\n    println!(\"{:?}\", zone_data);\n    assert_eq!(*zone_data, zone);\n\n    println!(\"Creating Record\");\n    let rrtype: \u0026str = RecordType::TXT.into();\n    let rec_to_create = FileZoneRecord {\n        name: \"foo\".to_string(),\n        ttl: 123,\n        zoneid: Some(1),\n        id: None,\n        rrtype: rrtype.into(),\n        class: RecordClass::Internet.into(),\n        rdata: \"test txt\".to_string(),\n    };\n    println!(\"rec to create: {rec_to_create:?}\");\n    if let Err(err) = rec_to_create.save(\u0026pool).await {\n        panic!(\"{err:?}\");\n    };\n    if let Err(err) = rec_to_create.save(\u0026pool).await {\n        panic!(\"{err:?}\");\n    };\n    // rec_to_create.save(\u0026pool).await?;\n    // rec_to_create.save(\u0026pool).await?;\n\n    println!(\"Looking for foo.example.com TXT IN\");\n    let result = get_records(\n        \u0026pool,\n        String::from(\"foo.example.com\"),\n        RecordType::TXT,\n        RecordClass::Internet,\n        false,\n    )\n    .await?;\n    println!(\"Result: {result:?}\");\n    assert!(!result.is_empty());\n    Ok(())\n}\n\n#[tokio::test]\nasync fn test_load_zone() -\u003e Result\u003c(), GoatNsError\u003e {\n    let mut zone = FileZone {\n        name: \"example.com\".to_string(),\n        rname: \"billy.example.com\".to_string(),\n        ..Default::default()\n    };\n\n    let pool = test_get_sqlite_memory().await;\n    start_db(\u0026pool).await?;\n\n    // first time\n    zone.save(\u0026pool).await?;\n\n    let zone_first = FileZone::get_by_name(\u0026mut *pool.begin().await?, \u0026zone.name)\n        .await?\n        .expect(\"Couldn't find zone!\");\n\n    zone.rname = \"foo.example.com\".to_string();\n    zone.save(\u0026pool).await?;\n\n    let zone_second = FileZone::get_by_name(\u0026mut *pool.begin().await?, \u0026zone.name)\n        .await?\n        .expect(\"Couldn't find zone!\");\n\n    assert_ne!(zone_first, zone_second);\n\n    // compare the record lists\n    println!(\"comparing the list of records in each zone\");\n    for record in zone_first.records.iter() {\n        assert!(zone_second.records.contains(\u0026record));\n    }\n    for record in zone_second.records.iter() {\n        assert!(zone_first.records.contains(\u0026record));\n    }\n\n    Ok(())\n}\n\n#[cfg(test)]\n/// create a zone example.com\nasync fn test_create_example_com_zone(pool: \u0026SqlitePool) -\u003e Result\u003c(), GoatNsError\u003e {\n    test_example_com_zone().save(\u0026pool).await?;\n    Ok(())\n}\n\n#[tokio::test]\nasync fn test_export_zone() -\u003e Result\u003c(), GoatNsError\u003e {\n    let pool = test_get_sqlite_memory().await;\n    eprintln!(\"Setting up DB\");\n    start_db(\u0026pool).await?;\n    eprintln!(\"Setting up example zone\");\n    test_create_example_com_zone(\u0026pool).await?;\n    let testzone = test_example_com_zone();\n\n    eprintln!(\"Getting example zone\");\n    let zone = FileZone::get_by_name(\u0026mut *pool.begin().await?, \u0026testzone.name)\n        .await?\n        .expect(\"Failed to get zone\");\n\n    let records_to_create = 100usize;\n    eprintln!(\"Creating records\");\n    if let Err(err) =\n        test_create_example_com_records(\u0026pool, zone.id.unwrap(), records_to_create).await\n    {\n        panic!(\"failed to create test records: {err:?}\");\n    }\n\n    eprintln!(\"Exporting zone {}\", zone.id.unwrap());\n    // let exported_zone = export_zone(pool.acquire().await?, zone.id.try_into().unwrap()).await?;\n    let exported_zone = FileZone::get(\u0026pool, zone.id.unwrap()).await?;\n    eprintln!(\"Done exporting zone\");\n\n    println!(\"found {} records\", exported_zone.records.len());\n    assert_eq!(exported_zone.records.len(), records_to_create);\n\n    let json_result = serde_json::to_string_pretty(\u0026exported_zone).unwrap();\n\n    println!(\"{json_result}\");\n\n    let export_json_result = match export_zone_json(\u0026pool, zone.id.unwrap()).await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e panic!(\"error exporting json: {err}\"),\n    };\n\n    println!(\"Checking that the result matches expectation\");\n    assert_eq!(json_result, export_json_result);\n\n    Ok(())\n}\n\n#[tokio::test]\nasync fn load_then_export() -\u003e Result\u003c(), GoatNsError\u003e {\n    use tokio::io::AsyncReadExt;\n    // set up the DB\n    let pool = test_get_sqlite_memory().await;\n    eprintln!(\"Setting up DB\");\n    start_db(\u0026pool).await?;\n\n    let example_zone_file = std::path::Path::new(\u0026\"./examples/test_config/single-zone.json\");\n\n    eprintln!(\"load_zone_from_file from {:?}\", example_zone_file);\n    let example_zone = crate::zones::load_zone_from_file(example_zone_file)\n        .inspect_err(|err| println!(\"Failed to load zone file! {:?}\", err))?;\n\n    eprint!(\"importing zone into db...\");\n    example_zone.save(\u0026pool).await?;\n    eprintln!(\"done!\");\n\n    let mut file = match tokio::fs::File::open(example_zone_file).await {\n        Ok(value) =\u003e value,\n        Err(error) =\u003e {\n            panic!(\"Failed to open zone file: {:?}\", error);\n        }\n    };\n    let mut buf: String = String::new();\n    file.read_to_string(\u0026mut buf).await.unwrap();\n\n    eprintln!(\"File contents: {:?}\", buf);\n\n    let json: FileZone = json5::from_str(\u0026buf).map_err(|e| panic!(\"{e:?}\")).unwrap();\n    eprintln!(\"loaded zone from file again: {json:?}\");\n    let _json: String = serde_json::to_string(\u0026json).unwrap();\n\n    eprintln!(\"Exporting zone\");\n    let zone_got = FileZone::get_by_name(\u0026mut *pool.begin().await?, \u0026example_zone.name).await?;\n    eprintln!(\"zone_got {zone_got:?}\");\n\n    if let Err(err) = export_zone_json(\u0026pool, 1).await {\n        panic!(\"Failed to export zone! {err}\");\n    }\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","enums.rs"],"content":"use crate::resourcerecord::InternalResourceRecord;\nuse enum_iterator::Sequence;\nuse packed_struct::prelude::*;\nuse serde::{de, Serialize, Serializer};\nuse std::fmt::Display;\nuse utoipa::ToSchema;\n\n#[derive(Clone, Debug, PartialEq, Eq)]\npub enum Agent {\n    Datastore,\n    API,\n    UDPServer,\n    TCPServer,\n}\n\n#[derive(Clone, Debug)]\npub enum AgentState {\n    Started { agent: Agent },\n    Stopped { agent: Agent },\n}\n\n#[derive(Debug, PartialEq, Eq)]\npub enum SystemState {\n    Import,\n    Export,\n    Server,\n    ShuttingDown,\n}\n\n#[derive(Debug, Eq, PartialEq, PrimitiveEnum_u8, Copy, Clone)]\n/// A four bit field that specifies kind of query in this message.\n/// This value is set by the originator of a query and copied into the response.\npub enum OpCode {\n    /// A standard query (QUERY)\n    Query = 0,\n    // IQuery = 1, an inverse query (IQUERY) - obsolete in https://www.rfc-editor.org/rfc/rfc3425\n    /// Server status request (STATUS)\n    Status = 2,\n    /// 3-15            reserved for future use\n    Reserved = 15,\n}\nimpl From\u003cu8\u003e for OpCode {\n    fn from(input: u8) -\u003e Self {\n        match input {\n            0 =\u003e Self::Query,\n            2 =\u003e Self::Status,\n            _ =\u003e Self::Reserved,\n        }\n    }\n}\n\nimpl From\u003cOpCode\u003e for i32 {\n    fn from(val: OpCode) -\u003e i32 {\n        match val {\n            OpCode::Query =\u003e 0b00,\n            OpCode::Status =\u003e 0b10,\n            //  Self::Reserved\n            _ =\u003e 0b11,\n        }\n    }\n}\n\n#[derive(PrimitiveEnum_u8, Clone, Copy, Debug, Eq, PartialEq)]\n/// Response code, things like NOERROR, FORMATERROR, SERVFAIL etc.\npub enum Rcode {\n    // No error condition\n    NoError = 0,\n    // Format error - The name server was unable to interpret the query.\n    FormatError = 1,\n    // Server failure - The name server was unable to process this query due to a problem with the name server.\n    ServFail = 2,\n    /// Name Error - Meaningful only for responses from an authoritative name server, this code signifies that the domain name referenced in the query does not exist.\n    NameError = 3,\n    /// Not Implemented - The name server does not support the requested kind of query.\n    NotImplemented = 4,\n    /// Refused - The name server refuses to perform the specified operation for policy reasons.  For example, a name server may not wish to provide the information to the particular requester, or a name server may not wish to perform a particular operation (e.g., zone transfers\n    Refused = 5,\n    // Reserved,\n    // 6..15 - Reserved for future use\n}\n\n#[allow(clippy::upper_case_acronyms)]\n#[derive(Clone, Copy, Debug, PartialEq, Eq, Sequence, sqlx::Type)]\n/// RRType, eg A, NS, MX, etc\n#[sqlx(type_name = \"INTEGER\")]\n#[repr(i64)]\npub enum RecordType {\n    /// A host address\n    A = 1,\n    /// Authoritative name server\n    NS = 2,\n    CNAME = 5,  // 5 the canonical name for an alias\n    SOA = 6,    // 6 marks the start of a zone of authority\n    MB = 7,     // 7 a mailbox domain name (EXPERIMENTAL)\n    MG = 8,     // 8 a mail group member (EXPERIMENTAL)\n    MR = 9,     // 9 a mail rename domain name (EXPERIMENTAL)\n    NULL = 10,  // 10 a null RR (EXPERIMENTAL)\n    WKS = 11,   // 11 a well known service description\n    PTR = 12,   // 12 a domain name pointer\n    HINFO = 13, // 13 host information\n    MINFO = 14, // 14 mailbox or mail list information\n    MX = 15,    // 15 mail exchange\n    /// Text strings\n    TXT = 16,\n    /// IPv6 Records \u003chttps://www.rfc-editor.org/rfc/rfc3596#section-2.1\u003e\n    AAAA = 28,\n    /// For when you want to know the physical location of a thing! \u003chttps://www.rfc-editor.org/rfc/rfc1876\u003e\n    LOC = 29,\n    /// NAPTR \u003chttps://www.rfc-editor.org/rfc/rfc2915\u003e\n    NAPTR = 35,\n    /// 252 A request for a transfer of an entire zone\n    AXFR = 252,\n    /// 253 A request for mailbox-related records (MB, MG or MR)\n    MAILB = 253,\n    URI = 256,\n    /// 255 A request for all records (*)\n    ANY = 255,\n    /// Certification Authority Restriction - \u003chttps://www.rfc-editor.org/rfc/rfc6844.txt\u003e\n    CAA = 257,\n    InvalidType,\n}\n\nimpl From\u003c\u0026u16\u003e for RecordType {\n    fn from(input: \u0026u16) -\u003e Self {\n        match input {\n            1 =\u003e Self::A,\n            2 =\u003e Self::NS,\n            5 =\u003e Self::CNAME,\n            6 =\u003e Self::SOA,\n            7 =\u003e Self::MB,\n            8 =\u003e Self::MG,\n            9 =\u003e Self::MR,\n            10 =\u003e Self::NULL,\n            11 =\u003e Self::WKS,\n            12 =\u003e Self::PTR,\n            13 =\u003e Self::HINFO,\n            14 =\u003e Self::MINFO,\n            15 =\u003e Self::MX,\n            16 =\u003e Self::TXT,\n            28 =\u003e Self::AAAA, // https://www.rfc-editor.org/rfc/rfc3596#section-2.1\n            29 =\u003e Self::LOC,\n            35 =\u003e Self::NAPTR, // https://www.rfc-editor.org/rfc/rfc3596#section-2.1\n            252 =\u003e Self::AXFR,\n            253 =\u003e Self::MAILB,\n            255 =\u003e Self::ANY,\n            256 =\u003e Self::URI,\n            257 =\u003e Self::CAA,\n            _ =\u003e Self::InvalidType,\n        }\n    }\n}\n\nimpl From\u003cString\u003e for RecordType {\n    fn from(input: String) -\u003e Self {\n        let input: RecordType = input.as_str().into();\n        input\n    }\n}\nimpl From\u003c\u0026str\u003e for RecordType {\n    fn from(input: \u0026str) -\u003e Self {\n        match input {\n            \"A\" =\u003e Self::A,\n            \"AAAA\" =\u003e Self::AAAA, // https://www.rfc-editor.org/rfc/rfc3596#section-2.1\n            \"ANY\" =\u003e Self::ANY,\n            \"AXFR\" =\u003e Self::AXFR,\n            \"CAA\" =\u003e Self::CAA,\n            \"CNAME\" =\u003e Self::CNAME,\n            \"HINFO\" =\u003e Self::HINFO,\n            \"LOC\" =\u003e Self::LOC,\n            \"MAILB\" =\u003e Self::MAILB,\n            \"MB\" =\u003e Self::MB,\n            \"MG\" =\u003e Self::MG,\n            \"MINFO\" =\u003e Self::MINFO,\n            \"MR\" =\u003e Self::MR,\n            \"MX\" =\u003e Self::MX,\n            \"NAPTR\" =\u003e Self::NAPTR,\n            \"NS\" =\u003e Self::NS,\n            \"NULL\" =\u003e Self::NULL,\n            \"PTR\" =\u003e Self::PTR,\n            \"SOA\" =\u003e Self::SOA,\n            \"TXT\" =\u003e Self::TXT,\n            \"URI\" =\u003e Self::URI,\n            \"WKS\" =\u003e Self::WKS,\n            _ =\u003e Self::InvalidType,\n        }\n    }\n}\n\nimpl From\u003cRecordType\u003e for \u0026'static str {\n    fn from(input: RecordType) -\u003e \u0026'static str {\n        match input {\n            RecordType::A =\u003e \"A\",\n            RecordType::AAAA =\u003e \"AAAA\",\n            RecordType::ANY =\u003e \"ANY\",\n            RecordType::AXFR =\u003e \"AXFR\",\n            RecordType::CAA =\u003e \"CAA\",\n            RecordType::CNAME =\u003e \"CNAME\",\n            RecordType::HINFO =\u003e \"HINFO\",\n            RecordType::LOC =\u003e \"LOC\",\n            RecordType::MAILB =\u003e \"MAILB\",\n            RecordType::MB =\u003e \"MB\",\n            RecordType::MG =\u003e \"MG\",\n            RecordType::MINFO =\u003e \"MINFO\",\n            RecordType::MR =\u003e \"MR\",\n            RecordType::MX =\u003e \"MX\",\n            RecordType::NAPTR =\u003e \"NAPTR\",\n            RecordType::NS =\u003e \"NS\",\n            RecordType::NULL =\u003e \"NULL\",\n            RecordType::PTR =\u003e \"PTR\",\n            RecordType::SOA =\u003e \"SOA\",\n            RecordType::TXT =\u003e \"TXT\",\n            RecordType::URI =\u003e \"URI\",\n            RecordType::WKS =\u003e \"WKS\",\n            RecordType::InvalidType =\u003e \"\",\n        }\n    }\n}\n\nimpl Display for RecordType {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        let res: \u0026'static str = self.to_owned().into();\n        f.write_fmt(format_args!(\"{res}\"))\n    }\n}\n\nimpl From\u003cInternalResourceRecord\u003e for RecordType {\n    fn from(input: InternalResourceRecord) -\u003e RecordType {\n        match input {\n            InternalResourceRecord::A { .. } =\u003e RecordType::A,\n            InternalResourceRecord::AAAA { .. } =\u003e RecordType::AAAA,\n            InternalResourceRecord::AXFR { .. } =\u003e RecordType::AXFR,\n            InternalResourceRecord::CAA { .. } =\u003e RecordType::CAA,\n            InternalResourceRecord::CNAME { .. } =\u003e RecordType::CNAME,\n            InternalResourceRecord::HINFO { .. } =\u003e RecordType::HINFO,\n            InternalResourceRecord::InvalidType =\u003e RecordType::InvalidType,\n            InternalResourceRecord::LOC { .. } =\u003e RecordType::LOC,\n            InternalResourceRecord::MX { .. } =\u003e RecordType::MX,\n            InternalResourceRecord::NAPTR { .. } =\u003e RecordType::NAPTR,\n            InternalResourceRecord::NS { .. } =\u003e RecordType::NS,\n            InternalResourceRecord::PTR { .. } =\u003e RecordType::PTR,\n            InternalResourceRecord::SOA { .. } =\u003e RecordType::SOA,\n            InternalResourceRecord::TXT { .. } =\u003e RecordType::TXT,\n            InternalResourceRecord::URI { .. } =\u003e RecordType::URI,\n        }\n    }\n}\n\nimpl RecordType {\n    pub fn supported(self: RecordType) -\u003e bool {\n        #[allow(clippy::match_like_matches_macro)]\n        match self {\n            RecordType::A\n            | RecordType::AAAA\n            | RecordType::ANY\n            | RecordType::CAA\n            | RecordType::CNAME\n            | RecordType::HINFO\n            | RecordType::LOC\n            | RecordType::MX\n            | RecordType::NS\n            | RecordType::PTR\n            | RecordType::SOA\n            | RecordType::TXT\n            | RecordType::URI =\u003e true,\n            _ =\u003e false,\n        }\n    }\n}\n\n#[derive(Clone, Copy, Debug, PartialEq, Eq, Sequence, sqlx::Type, ToSchema)]\n#[repr(i64)]\n/// CLASS fields appear in resource records, most entries should be IN, but CHAOS is typically used for management-layer things. Ref RFC1035 3.2.4.\npub enum RecordClass {\n    /// IN - Internet\n    Internet = 1,\n    /// CS - CSNET class (Obsolete - used only for examples in some obsolete RFCs)\n    CsNet = 2,\n    /// CH - Chaos\n    Chaos = 3,\n    /// Hesiod [Dyer 87]\n    Hesiod = 4,\n\n    InvalidType = 0,\n}\n\nimpl Display for RecordClass {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        f.write_fmt(format_args!(\n            \"{}\",\n            match self {\n                RecordClass::Internet =\u003e \"IN\",\n                RecordClass::CsNet =\u003e \"CS\",\n                RecordClass::Chaos =\u003e \"CHAOS\",\n                RecordClass::Hesiod =\u003e \"HESIOD\",\n                RecordClass::InvalidType =\u003e \"Invalid\",\n            }\n        ))\n    }\n}\n\nimpl\u003c'de\u003e de::Deserialize\u003c'de\u003e for RecordClass {\n    fn deserialize\u003cD\u003e(deserializer: D) -\u003e Result\u003cSelf, D::Error\u003e\n    where\n        D: de::Deserializer\u003c'de\u003e,\n    {\n        let s: String = de::Deserialize::deserialize(deserializer)?;\n        Ok(RecordClass::from(s.as_str()))\n    }\n}\nimpl From\u003c\u0026str\u003e for RecordClass {\n    fn from(value: \u0026str) -\u003e Self {\n        match value {\n            \"IN\" =\u003e RecordClass::Internet,\n            \"CS\" =\u003e RecordClass::CsNet,\n            \"CHAOS\" =\u003e RecordClass::Chaos,\n            \"HESIOD\" =\u003e RecordClass::Hesiod,\n            _ =\u003e RecordClass::InvalidType,\n        }\n    }\n}\n\nimpl Serialize for RecordClass {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        serializer.serialize_str(format!(\"{self}\").as_str())\n    }\n}\n\nimpl From\u003c\u0026u16\u003e for RecordClass {\n    fn from(input: \u0026u16) -\u003e Self {\n        match input {\n            1 =\u003e Self::Internet,\n            2 =\u003e Self::CsNet,\n            3 =\u003e Self::Chaos,\n            4 =\u003e Self::Hesiod,\n            _ =\u003e Self::InvalidType,\n        }\n    }\n}\n\n#[derive(Debug, PrimitiveEnum_u8, Clone, Copy, Eq, PartialEq)]\npub enum PacketType {\n    Query = 0,\n    Answer = 1,\n}\n\nimpl From\u003cbool\u003e for PacketType {\n    fn from(input: bool) -\u003e Self {\n        match input {\n            false =\u003e Self::Query,\n            true =\u003e Self::Answer,\n        }\n    }\n}\n\n#[derive(Debug, PartialEq, Eq, Clone)]\npub enum ContactDetails {\n    Mastodon { contact: String, server: String },\n    Email { contact: String },\n    Twitter { contact: String },\n    None,\n}\n\nimpl Default for ContactDetails {\n    fn default() -\u003e Self {\n        Self::None\n    }\n}\n\nimpl std::fmt::Display for ContactDetails {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            ContactDetails::Mastodon { server, contact } =\u003e f.write_fmt(format_args!(\n                r#\"\u003ca href=\"https://{}/@{}\"\u003e{}\u003c/a\u003e\"#,\n                server, contact, contact\n            )),\n            ContactDetails::Email { contact } =\u003e f.write_fmt(format_args!(\n                r#\"\u003ca href=\"mailto:{}\"\u003e{}\u003c/a\u003e\"#,\n                contact, contact\n            )),\n            ContactDetails::Twitter { contact } =\u003e f.write_fmt(format_args!(\n                r#\"\u003ca href=\"https://twitter.com/{}\"\u003e{}\u003c/a\u003e\"#,\n                contact, contact\n            )),\n            ContactDetails::None =\u003e f.write_str(\"\"),\n        }\n    }\n}\nimpl ContactDetails {\n    /// returns (username, url)\n    pub fn to_html_parts(\u0026self) -\u003e (String, String) {\n        match self {\n            ContactDetails::Mastodon { server, contact } =\u003e (\n                contact.to_owned(),\n                format!(\"https://{}/@{}\", server, contact),\n            ),\n            ContactDetails::Email { contact } =\u003e {\n                (contact.to_owned(), format!(\"mailto:{}\", contact))\n            }\n            ContactDetails::Twitter { contact } =\u003e (\n                contact.to_owned(),\n                format!(\"https://twitter.com/{}\", contact),\n            ),\n            ContactDetails::None =\u003e (\"\".to_string(), \"\".to_string()),\n        }\n    }\n}\n\n#[derive(Debug)]\n/// Errors returned from trying to turn a String into a [ContactDetails]\npub enum ContactDetailsDeserializerError {\n    InputLengthWrong { msg: \u0026'static str, len: usize },\n    InputFormatWrong { unexp: String, exp: \u0026'static str },\n    WrongContactType(String),\n}\n\nimpl TryFrom\u003cString\u003e for ContactDetails {\n    type Error = ContactDetailsDeserializerError;\n\n    fn try_from(value: String) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let mut split_value = value.split(':');\n        let contact_type = split_value.next();\n        let contact_value = split_value.next();\n\n        match (contact_type, contact_value) {\n            (Some(contact_type), Some(contact_value)) =\u003e {\n                // return Err(ContactDetailsDeserializerError::InputLengthWrong{\n                //     msg: \"Length of input is wrong please ensure it's in the format type:username@server (server for Mastodon)\",\n                //     len: split_value.count(),\n                // });\n\n                match contact_type {\n                    \"Mastodon\" =\u003e {\n                        let contact_value = match contact_value.starts_with('@') {\n                            false =\u003e contact_value,\n                            true =\u003e contact_value.trim_start_matches(\n                                '@'\n                            )\n                        };\n                        if !contact_value.contains('@') {\n                            Err(ContactDetailsDeserializerError::InputFormatWrong{unexp: contact_value.to_string(),exp: \"Input format is wrong please ensure it's in the format Mastodon:username@server for Mastodon\",\n                        })\n                        }\n\n                        else {\n                            let mut contact_split = contact_value.split('@');\n                            #[allow(clippy::expect_used)]\n                            Ok( Self::Mastodon {\n                                contact: contact_split.next().expect(\"THe length was checked and then we couldn't get \n                                it!\").to_string(),\n                                server: contact_split.next().expect(\"THe length was checked and then we couldn't get it!\").to_string(),\n                            })\n                        }\n\n                    },\n                    \"Email\" =\u003e {\n                        Ok(Self::Email { contact: contact_value.to_string() })\n\n                    },\n                    \"Twitter\" =\u003e {\n                        Ok(Self::Twitter { contact: contact_value.to_string() })\n\n                    },\n                    \u0026_ =\u003e {\n                        Err(ContactDetailsDeserializerError::WrongContactType(format!(\n                                \"Contact type ({}) wrong, please ensure it's in the format type:value where type is one of Email/Twitter/Mastodon\",\n                                contact_type\n                                ) ))\n                    }\n                }\n            }\n            _ =\u003e {\n                Err(ContactDetailsDeserializerError::InputLengthWrong{\n                    msg: \"Length/value of input is wrong. please ensure it's in the format type:username@server (server for Mastodon)\",\n                    len: split_value.count(),\n                })\n            }\n        }\n    }\n}\n","traces":[{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":1227}},{"line":125,"address":[],"length":0,"stats":{"Line":1227}},{"line":126,"address":[],"length":0,"stats":{"Line":1214}},{"line":127,"address":[],"length":0,"stats":{"Line":2}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":1}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":2}},{"line":139,"address":[],"length":0,"stats":{"Line":4}},{"line":140,"address":[],"length":0,"stats":{"Line":3}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":1}},{"line":154,"address":[],"length":0,"stats":{"Line":4719}},{"line":155,"address":[],"length":0,"stats":{"Line":4719}},{"line":156,"address":[],"length":0,"stats":{"Line":4719}},{"line":160,"address":[],"length":0,"stats":{"Line":4722}},{"line":161,"address":[],"length":0,"stats":{"Line":4722}},{"line":162,"address":[],"length":0,"stats":{"Line":9242}},{"line":163,"address":[],"length":0,"stats":{"Line":247}},{"line":164,"address":[],"length":0,"stats":{"Line":158}},{"line":165,"address":[],"length":0,"stats":{"Line":157}},{"line":166,"address":[],"length":0,"stats":{"Line":156}},{"line":167,"address":[],"length":0,"stats":{"Line":155}},{"line":168,"address":[],"length":0,"stats":{"Line":154}},{"line":169,"address":[],"length":0,"stats":{"Line":153}},{"line":170,"address":[],"length":0,"stats":{"Line":152}},{"line":171,"address":[],"length":0,"stats":{"Line":151}},{"line":172,"address":[],"length":0,"stats":{"Line":150}},{"line":173,"address":[],"length":0,"stats":{"Line":149}},{"line":174,"address":[],"length":0,"stats":{"Line":148}},{"line":175,"address":[],"length":0,"stats":{"Line":179}},{"line":176,"address":[],"length":0,"stats":{"Line":114}},{"line":177,"address":[],"length":0,"stats":{"Line":145}},{"line":178,"address":[],"length":0,"stats":{"Line":80}},{"line":179,"address":[],"length":0,"stats":{"Line":95}},{"line":180,"address":[],"length":0,"stats":{"Line":62}},{"line":181,"address":[],"length":0,"stats":{"Line":105}},{"line":182,"address":[],"length":0,"stats":{"Line":28}},{"line":183,"address":[],"length":0,"stats":{"Line":3}},{"line":184,"address":[],"length":0,"stats":{"Line":1}},{"line":190,"address":[],"length":0,"stats":{"Line":3525}},{"line":191,"address":[],"length":0,"stats":{"Line":3525}},{"line":192,"address":[],"length":0,"stats":{"Line":3444}},{"line":193,"address":[],"length":0,"stats":{"Line":15}},{"line":194,"address":[],"length":0,"stats":{"Line":1}},{"line":195,"address":[],"length":0,"stats":{"Line":1}},{"line":196,"address":[],"length":0,"stats":{"Line":1}},{"line":197,"address":[],"length":0,"stats":{"Line":1}},{"line":198,"address":[],"length":0,"stats":{"Line":1}},{"line":199,"address":[],"length":0,"stats":{"Line":1}},{"line":200,"address":[],"length":0,"stats":{"Line":1}},{"line":201,"address":[],"length":0,"stats":{"Line":1}},{"line":202,"address":[],"length":0,"stats":{"Line":1}},{"line":203,"address":[],"length":0,"stats":{"Line":1}},{"line":204,"address":[],"length":0,"stats":{"Line":1}},{"line":205,"address":[],"length":0,"stats":{"Line":11}},{"line":206,"address":[],"length":0,"stats":{"Line":1}},{"line":207,"address":[],"length":0,"stats":{"Line":11}},{"line":208,"address":[],"length":0,"stats":{"Line":1}},{"line":209,"address":[],"length":0,"stats":{"Line":6}},{"line":210,"address":[],"length":0,"stats":{"Line":1}},{"line":211,"address":[],"length":0,"stats":{"Line":19}},{"line":212,"address":[],"length":0,"stats":{"Line":4}},{"line":213,"address":[],"length":0,"stats":{"Line":1}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":3515}},{"line":221,"address":[],"length":0,"stats":{"Line":3515}},{"line":222,"address":[],"length":0,"stats":{"Line":3515}},{"line":227,"address":[],"length":0,"stats":{"Line":3}},{"line":228,"address":[],"length":0,"stats":{"Line":3}},{"line":229,"address":[],"length":0,"stats":{"Line":2}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":1}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":2}},{"line":250,"address":[],"length":0,"stats":{"Line":2}},{"line":251,"address":[],"length":0,"stats":{"Line":2}},{"line":264,"address":[],"length":0,"stats":{"Line":2}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":235}},{"line":288,"address":[],"length":0,"stats":{"Line":470}},{"line":289,"address":[],"length":0,"stats":{"Line":235}},{"line":290,"address":[],"length":0,"stats":{"Line":235}},{"line":291,"address":[],"length":0,"stats":{"Line":232}},{"line":292,"address":[],"length":0,"stats":{"Line":1}},{"line":293,"address":[],"length":0,"stats":{"Line":1}},{"line":294,"address":[],"length":0,"stats":{"Line":1}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":5}},{"line":306,"address":[],"length":0,"stats":{"Line":10}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":10}},{"line":312,"address":[],"length":0,"stats":{"Line":10}},{"line":313,"address":[],"length":0,"stats":{"Line":16}},{"line":314,"address":[],"length":0,"stats":{"Line":5}},{"line":315,"address":[],"length":0,"stats":{"Line":4}},{"line":316,"address":[],"length":0,"stats":{"Line":3}},{"line":317,"address":[],"length":0,"stats":{"Line":1}},{"line":323,"address":[],"length":0,"stats":{"Line":228}},{"line":327,"address":[],"length":0,"stats":{"Line":228}},{"line":332,"address":[],"length":0,"stats":{"Line":1226}},{"line":333,"address":[],"length":0,"stats":{"Line":1226}},{"line":334,"address":[],"length":0,"stats":{"Line":1225}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":1}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":288}},{"line":368,"address":[],"length":0,"stats":{"Line":288}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":9}},{"line":423,"address":[],"length":0,"stats":{"Line":9}},{"line":424,"address":[],"length":0,"stats":{"Line":9}},{"line":425,"address":[],"length":0,"stats":{"Line":9}},{"line":427,"address":[],"length":0,"stats":{"Line":9}},{"line":428,"address":[],"length":0,"stats":{"Line":7}},{"line":434,"address":[],"length":0,"stats":{"Line":7}},{"line":435,"address":[],"length":0,"stats":{"Line":7}},{"line":436,"address":[],"length":0,"stats":{"Line":6}},{"line":437,"address":[],"length":0,"stats":{"Line":2}},{"line":438,"address":[],"length":0,"stats":{"Line":1}},{"line":442,"address":[],"length":0,"stats":{"Line":3}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":3}},{"line":450,"address":[],"length":0,"stats":{"Line":3}},{"line":451,"address":[],"length":0,"stats":{"Line":3}},{"line":452,"address":[],"length":0,"stats":{"Line":3}},{"line":453,"address":[],"length":0,"stats":{"Line":3}},{"line":458,"address":[],"length":0,"stats":{"Line":4}},{"line":459,"address":[],"length":0,"stats":{"Line":1}},{"line":462,"address":[],"length":0,"stats":{"Line":3}},{"line":463,"address":[],"length":0,"stats":{"Line":1}},{"line":467,"address":[],"length":0,"stats":{"Line":2}},{"line":468,"address":[],"length":0,"stats":{"Line":2}},{"line":469,"address":[],"length":0,"stats":{"Line":2}},{"line":475,"address":[],"length":0,"stats":{"Line":2}},{"line":476,"address":[],"length":0,"stats":{"Line":2}},{"line":477,"address":[],"length":0,"stats":{"Line":2}}],"covered":124,"coverable":198},{"path":["/","Users","yaleman","Projects","goatns","src","error.rs"],"content":"use std::str::Utf8Error;\n\nuse packed_struct::PackingError;\n\n/// When things go awry\n#[derive(Debug)]\npub enum GoatNsError {\n    Csrf(String),\n    BytePackingError(String),\n    InvalidName,\n    IoError(std::io::Error),\n    /// Something failed in the start up of the platform\n    StartupError(String),\n    SqlxError(sqlx::Error),\n    SeaOrm(sea_orm::DbErr),\n    ReqwestError(reqwest::Error),\n    FileError(String),\n    EmptyFile,\n    /// Failed to send something across a tokio channel\n    SendError(String),\n    Utf8Error(Utf8Error),\n    DateParseError(String),\n    /// No ANY records for you!\n    RFC8482,\n    Generic(String),\n    Regex(String),\n    InvalidValue(String),\n}\n\nimpl From\u003cregex::Error\u003e for GoatNsError {\n    fn from(error: regex::Error) -\u003e Self {\n        GoatNsError::Regex(error.to_string())\n    }\n}\nimpl From\u003cstd::io::Error\u003e for GoatNsError {\n    fn from(error: std::io::Error) -\u003e Self {\n        GoatNsError::IoError(error)\n    }\n}\n\nimpl From\u003csqlx::Error\u003e for GoatNsError {\n    fn from(error: sqlx::Error) -\u003e Self {\n        GoatNsError::SqlxError(error)\n    }\n}\n\nimpl From\u003creqwest::Error\u003e for GoatNsError {\n    fn from(error: reqwest::Error) -\u003e Self {\n        GoatNsError::ReqwestError(error)\n    }\n}\n\nimpl From\u003cPackingError\u003e for GoatNsError {\n    fn from(error: PackingError) -\u003e Self {\n        GoatNsError::BytePackingError(error.to_string())\n    }\n}\n\nimpl From\u003cUtf8Error\u003e for GoatNsError {\n    fn from(error: Utf8Error) -\u003e Self {\n        GoatNsError::Utf8Error(error)\n    }\n}\n\nimpl From\u003cchrono::format::ParseError\u003e for GoatNsError {\n    fn from(error: chrono::format::ParseError) -\u003e Self {\n        GoatNsError::DateParseError(error.to_string())\n    }\n}\n\nimpl From\u003csea_orm::DbErr\u003e for GoatNsError {\n    fn from(error: sea_orm::DbErr) -\u003e Self {\n        GoatNsError::SeaOrm(error)\n    }\n}\n\nimpl From\u003cGoatNsError\u003e for std::io::Error {\n    fn from(error: GoatNsError) -\u003e Self {\n        match error {\n            GoatNsError::IoError(err) =\u003e err,\n            GoatNsError::StartupError(err) =\u003e std::io::Error::new(std::io::ErrorKind::Other, err),\n            GoatNsError::SqlxError(err) =\u003e std::io::Error::new(std::io::ErrorKind::Other, err),\n            GoatNsError::ReqwestError(err) =\u003e std::io::Error::new(std::io::ErrorKind::Other, err),\n            GoatNsError::FileError(err) =\u003e std::io::Error::new(std::io::ErrorKind::Other, err),\n            GoatNsError::EmptyFile =\u003e std::io::Error::new(std::io::ErrorKind::Other, \"Empty file\"),\n            GoatNsError::SendError(err) =\u003e std::io::Error::new(std::io::ErrorKind::Other, err),\n            _ =\u003e std::io::Error::new(std::io::ErrorKind::Other, format!(\"{:?}\", error)),\n        }\n    }\n}\n","traces":[{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":4}},{"line":43,"address":[],"length":0,"stats":{"Line":4}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}}],"covered":2,"coverable":26},{"path":["/","Users","yaleman","Projects","goatns","src","lib.rs"],"content":"//! Goats are cool, but they make for poor DNS record stores. So here's an authoritative DNS server INSPIRED by goats.\n\n#![allow(clippy::multiple_crate_versions)]\n#![deny(clippy::all)]\n#![deny(clippy::await_holding_lock)]\n#![deny(clippy::complexity)]\n#![deny(clippy::correctness)]\n#![deny(clippy::expect_used)]\n#![deny(clippy::needless_pass_by_value)]\n#![deny(clippy::panic)]\n#![deny(clippy::perf)]\n#![deny(clippy::trivially_copy_pass_by_ref)]\n#![deny(clippy::unreachable)]\n#![deny(clippy::unwrap_used)]\n#![deny(warnings)]\n#![forbid(unsafe_code)]\n// #![warn(missing_docs)]\n\n#[macro_use]\nextern crate lazy_static;\n\n// #[cfg(test)]\n// #[macro_use(defer)]\n// extern crate scopeguard;\n\nuse crate::enums::*;\nuse crate::utils::*;\nuse error::GoatNsError;\nuse log::trace;\nuse packed_struct::prelude::*;\nuse std::fmt::{Debug, Display};\nuse std::str::from_utf8;\n\npub mod cli;\n/// Configuration handling for the server\npub mod config;\n/// The data-storing backend for zone information and (eventually) caching.\npub mod datastore;\npub mod db;\npub mod enums;\npub mod error;\npub(crate) mod logging;\npub mod packet_dumper;\npub mod reply;\npub mod resourcerecord;\npub mod serializers;\npub mod servers;\n#[cfg(test)]\nmod tests;\npub mod utils;\n/// Configuration and management API\n#[macro_use]\npub mod web;\npub mod zones;\n\n/// Internal limit of in-flight requests\npub const MAX_IN_FLIGHT: usize = 512;\n/// The size of a DNS request header\npub const HEADER_BYTES: usize = 12;\n\n/// The default \"cancel a server response\" timeout\npub const REPLY_TIMEOUT_MS: u64 = 1000;\n/// The maximum size of a UDP packet \u003chttps://dnsflagday.net/2020/#dns-flag-day-2020\u003e\npub const UDP_BUFFER_SIZE: usize = 1232;\n\npub const COOKIE_NAME: \u0026str = \"goatns_session\";\n\n/// The header of a DNS transmission, either a Query or Reply. Ref [RFC1035](https://www.rfc-editor.org/rfc/rfc1035#section-4.1.1) section 4.1.1.\n#[derive(Debug, PackedStruct, PartialEq, Eq, Clone)]\n#[packed_struct(bit_numbering = \"msb0\", size_bytes = \"12\")]\n#[allow(clippy::struct_excessive_bools)]\npub struct Header {\n    /// The query ID\n    #[packed_field(bits = \"0..=15\", endian = \"msb\")]\n    id: u16,\n    // Is it a query or response\n    #[packed_field(bits = \"16\", ty = \"enum\")]\n    qr: PacketType, // bit 16\n    #[packed_field(bits = \"17..=20\", ty = \"enum\")]\n    opcode: OpCode, // 17-20 actually 4 bits\n    #[packed_field(bits = \"21\")]\n    authoritative: bool, // 21\n    #[packed_field(bits = \"22\")]\n    truncated: bool, // 22\n    // RD - Recursion Desired - this bit may be set in a query and is copied into the response.  If RD is set, it directs the name server to pursue the query recursively. Recursive query support is optional.\n    #[packed_field(bits = \"23\")]\n    recursion_desired: bool, // 23\n    #[packed_field(bits = \"24\")]\n    recursion_available: bool, // 24\n    /// reserved, must be all 0's\n    #[packed_field(bits = \"25\")]\n    z: bool, // 25-27 -\n    #[packed_field(bits = \"26\")]\n    ad: bool,\n    #[packed_field(bits = \"27\")]\n    cd: bool,\n    #[packed_field(bits = \"28..=31\", ty = \"enum\")]\n    rcode: Rcode, // bits 28-31\n    /// an unsigned 16 bit integer specifying the number of entries in the question section.\n    #[packed_field(bits = \"32..=47\", endian = \"msb\")]\n    qdcount: u16, // bits 32-47\n    /// an unsigned 16 bit integer specifying the number of entries in the answer section.\n    #[packed_field(bits = \"48..=63\", endian = \"msb\")]\n    ancount: u16, // 48-63\n    /// an unsigned 16 bit integer specifying the number of name server resource records in the authority records section.\n    #[packed_field(bits = \"64..=79\", endian = \"msb\")]\n    nscount: u16, // 64-79\n    /// an unsigned 16 bit integer specifying the number of resource records in the additional records section.\n    #[packed_field(bits = \"80..=95\", endian = \"msb\")]\n    arcount: u16, // 80-95\n}\n\nimpl Default for Header {\n    fn default() -\u003e Self {\n        Header {\n            id: 0,\n            qr: PacketType::Query,\n            opcode: OpCode::Query,\n            // we *are* an authoritative DNS server after all\n            authoritative: true,\n            truncated: false,\n            recursion_desired: false,\n            recursion_available: false,\n            z: false,\n            ad: false,\n            cd: false,\n            rcode: Rcode::NoError,\n            qdcount: 0,\n            ancount: 0,\n            nscount: 0,\n            arcount: 0,\n        }\n    }\n}\n\nimpl Header {\n    pub fn as_answer(self) -\u003e Header {\n        let mut response = self;\n        response.qr = PacketType::Answer;\n        response\n    }\n}\n\n/// The answer, authority, and additional sections all share the same\n/// format: a variable number of resource records, where the number of\n/// records is specified in the corresponding count field in the header.\n///\n/// Ref [RFC1035 Section 4.1.3](https://www.rfc-editor.org/rfc/rfc1035.html#section-4.1.3)\n#[derive(Clone, Debug)]\npub struct ResourceRecord {\n    /// A domain name to which this resource record pertains.\n    pub name: Vec\u003cu8\u003e,\n    /// Two octets containing one of the RR type codes. This field specifies the meaning of the data in the RDATA field. The official name is \"type\".\n    pub record_type: RecordType,\n    /// Two octets which specify the class of the data in the RDATA field.\n    pub class: RecordClass,\n    /// A 32 bit unsigned integer that specifies the time interval (in seconds) that the resource record may be cached before it should be discarded. Zero values are interpreted to mean that the RR can only be used for the transaction in progress, and should not be cached.\n    pub ttl: u32,\n    /// A variable length string of octets that describes the resource.\n    /// The format of this information varies according to the TYPE and CLASS of the resource record.\n    /// For example, the if the TYPE is A and the CLASS is IN, the RDATA field is a 4 octet ARPA Internet address.\n    pub rdata: Vec\u003cu8\u003e,\n}\nimpl ResourceRecord {}\n\nimpl TryFrom\u003cResourceRecord\u003e for Vec\u003cu8\u003e {\n    type Error = GoatNsError;\n    fn try_from(record: ResourceRecord) -\u003e Result\u003cSelf, Self::Error\u003e {\n        Vec::\u003cu8\u003e::try_from(\u0026record)\n    }\n}\n\nimpl TryFrom\u003c\u0026ResourceRecord\u003e for Vec\u003cu8\u003e {\n    type Error = GoatNsError;\n    fn try_from(record: \u0026ResourceRecord) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let mut retval: Vec\u003cu8\u003e = vec![];\n\n        trace!(\"{:?}\", record);\n\n        let record_name_bytes = name_as_bytes(\u0026record.name, Some(HEADER_BYTES as u16), None)?;\n        retval.extend(record_name_bytes);\n        // type\n        retval.extend((record.record_type as u16).to_be_bytes());\n        // class\n        retval.extend((record.class as u16).to_be_bytes());\n        // reply ttl\n        let ttl_bytes: [u8; 4] = record.ttl.to_be_bytes();\n        trace!(\"ttl_bytes: {:?}\", ttl_bytes);\n        retval.extend(ttl_bytes);\n        #[allow(clippy::cast_possible_truncation)]\n        // reply data length\n        retval.extend((record.rdata.len() as u16).to_be_bytes());\n        // rdata\n        retval.extend(record.rdata.clone());\n\n        Ok(retval)\n    }\n}\n\n#[derive(Clone, Debug, PartialEq, Eq)]\n/// A DNS Question section, from Ref [RFC1035](https://www.rfc-editor.org/rfc/rfc1035#section-4.1.2) section 4.1.2 \"Question section format\".\npub struct Question {\n    /// The name which is being queried\n    qname: Vec\u003cu8\u003e,\n    /// The Record type that is being requested, eg A, NS, MX, TXT etc.\n    qtype: RecordType,\n    /// The class, (typically IN for \"Internet\")\n    qclass: RecordClass,\n}\n\nimpl Display for Question {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        let qname = match from_utf8(\u0026self.qname) {\n            Ok(value) =\u003e value.to_string(),\n            Err(_) =\u003e {\n                format!(\"{:?}\", self.qname)\n            }\n        };\n        f.write_fmt(format_args!(\n            \"QNAME={} QTYPE={:?} QCLASS={}\",\n            qname, self.qtype, self.qclass,\n        ))\n    }\n}\n\n/// Returns a `Vec\u003cu8\u003e` representation of the name\n/// (ie, example.com = [101, 120, 97, 109, 112, 108, 101, 46, 99, 111, 109])\n///\n/// # Errors\n/// Will return Strings telling you what's gone wrong.\npub fn get_question_qname(input_val: \u0026[u8]) -\u003e Result\u003cVec\u003cu8\u003e, String\u003e {\n    trace!(\"got buf: {input_val:?}\");\n    if input_val.is_empty() {\n        return Err(\"zero-length buffer? That's bad.\".to_string());\n    }\n    // let's make a mut copy of the input so we can do things to do it\n    let mut buf = input_val.to_owned();\n\n    let mut result: Vec\u003cu8\u003e = vec![];\n    while !buf.is_empty() {\n        let label_len = buf[0] as usize;\n        if label_len == 0 {\n            // we got to the end\n            break;\n        } else if label_len \u003e 63 {\n            return Err(format!(\"Label length provided was {label_len}, needs to be \u003c=63 while parsing {input_val:?}\"));\n        }\n        if buf.len() \u003c label_len + 1 {\n            return Err(format!(\n                \"Label length was {label_len} but remaining size was too short: {} while parsing {input_val:?}\",\n                buf.len()\n            ));\n        }\n        #[cfg(test)]\n        eprintln!(\"Before extend: {result:?}\");\n        if buf.len() \u003c label_len {\n            return Err(format!(\n                \"Buffer was too sort to pull bytes from ({})\",\n                buf.len()\n            ));\n        }\n        result.extend(buf[1..=label_len].to_vec());\n        #[cfg(test)]\n        eprintln!(\"After extend:  {result:?}\");\n\n        // slice off the front part\n        #[cfg(test)]\n        eprintln!(\n            \"Before slicing buf: {buf:?}, about to grab {}..{}\",\n            label_len + 1,\n            buf.len()\n        );\n        buf = buf[label_len + 1..buf.len()].to_vec();\n        trace!(\"After slicing buf:  {buf:?}\");\n        if buf[0] != 0 {\n            result.push(46);\n        }\n        if result.len() \u003e 255 {\n            return Err(format!(\n                \"qname length over 255 while parsing question: {result:?}\"\n            ));\n        }\n    }\n    let result_string = match from_utf8(\u0026result) {\n        Ok(value) =\u003e value.to_owned().to_lowercase(),\n        Err(error) =\u003e return Err(format!(\"{error:?}\")),\n    };\n    #[cfg(test)]\n    eprintln!(\"Returning from get_question_qname {result_string:?}\");\n    Ok(result_string.as_bytes().to_vec())\n}\n\nimpl Question {\n    fn normalized_name(\u0026self) -\u003e Result\u003cString, String\u003e {\n        match from_utf8(\u0026self.qname) {\n            Ok(value) =\u003e Ok(value.to_lowercase()),\n            Err(error) =\u003e Err(format!(\n                \"Failed to normalize {:?}: {:?}\",\n                \u0026self.qname, error\n            )),\n        }\n    }\n\n    /// hand it the buffer and the things, and get back a [Question]\n    fn from_packets(buf: \u0026[u8]) -\u003e Result\u003cSelf, String\u003e {\n        let qname = get_question_qname(buf)?;\n\n        // skip past the end of the question\n        let read_pointer = qname.len() + 2;\n        if buf.len() \u003c= read_pointer + 1 {\n            return Err(format!(\n                \"Packet not long enough, looked for {read_pointer}, got {}\",\n                buf.len()\n            ));\n        }\n        let mut qtype_bytes: [u8; 2] = [0; 2];\n        if buf[read_pointer..read_pointer + 2].len() != 2 {\n            return Err(\n                \"Couldn't get two bytes when I asked for it from the header for the QTYPE\"\n                    .to_string(),\n            );\n        }\n        qtype_bytes.copy_from_slice(\u0026buf[read_pointer..read_pointer + 2]);\n        let qtype = RecordType::from(\u0026u16::from_be_bytes(qtype_bytes));\n        let mut qclass_bytes: [u8; 2] = [0; 2];\n        if buf.len() \u003c= read_pointer + 3 {\n            return Err(\"Buffer length too short to get two bytes when I asked for it from the header for the QCLASS\"\n            .to_string(),);\n        }\n        if buf[read_pointer + 2..read_pointer + 4].len() != 2 {\n            return Err(\n                \"Couldn't get two bytes when I asked for it from the header for the QCLASS\"\n                    .to_string(),\n            );\n        }\n        qclass_bytes.copy_from_slice(\u0026buf[read_pointer + 2..read_pointer + 4]);\n        let qclass: RecordClass = RecordClass::from(\u0026u16::from_be_bytes(qclass_bytes));\n\n        Ok(Question {\n            qname,\n            qtype,\n            qclass,\n        })\n    }\n\n    /// turn a question into a vec of bytes to send back to the user\n    fn try_to_bytes(\u0026self) -\u003e Result\u003cVec\u003cu8\u003e, GoatNsError\u003e {\n        let mut retval: Vec\u003cu8\u003e = vec![];\n\n        let name_bytes = name_as_bytes(\u0026self.qname, None, None)?;\n        retval.extend(name_bytes);\n        retval.extend((self.qtype as u16).to_be_bytes());\n        retval.extend((self.qclass as u16).to_be_bytes());\n        Ok(retval)\n    }\n}\n\nimpl TryFrom\u003cQuestion\u003e for Vec\u003cu8\u003e {\n    type Error = GoatNsError;\n    fn try_from(question: Question) -\u003e Result\u003cSelf, Self::Error\u003e {\n        question.try_to_bytes()\n    }\n}\n","traces":[{"line":114,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":1}},{"line":138,"address":[],"length":0,"stats":{"Line":1}},{"line":139,"address":[],"length":0,"stats":{"Line":1}},{"line":140,"address":[],"length":0,"stats":{"Line":1}},{"line":168,"address":[],"length":0,"stats":{"Line":3}},{"line":169,"address":[],"length":0,"stats":{"Line":3}},{"line":175,"address":[],"length":0,"stats":{"Line":3}},{"line":176,"address":[],"length":0,"stats":{"Line":3}},{"line":178,"address":[],"length":0,"stats":{"Line":3}},{"line":180,"address":[],"length":0,"stats":{"Line":6}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":3}},{"line":192,"address":[],"length":0,"stats":{"Line":3}},{"line":194,"address":[],"length":0,"stats":{"Line":3}},{"line":196,"address":[],"length":0,"stats":{"Line":3}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":7}},{"line":232,"address":[],"length":0,"stats":{"Line":7}},{"line":233,"address":[],"length":0,"stats":{"Line":7}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":7}},{"line":239,"address":[],"length":0,"stats":{"Line":7}},{"line":240,"address":[],"length":0,"stats":{"Line":19}},{"line":241,"address":[],"length":0,"stats":{"Line":19}},{"line":242,"address":[],"length":0,"stats":{"Line":19}},{"line":244,"address":[],"length":0,"stats":{"Line":6}},{"line":245,"address":[],"length":0,"stats":{"Line":13}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":13}},{"line":249,"address":[],"length":0,"stats":{"Line":1}},{"line":250,"address":[],"length":0,"stats":{"Line":1}},{"line":251,"address":[],"length":0,"stats":{"Line":1}},{"line":256,"address":[],"length":0,"stats":{"Line":12}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":12}},{"line":273,"address":[],"length":0,"stats":{"Line":12}},{"line":274,"address":[],"length":0,"stats":{"Line":12}},{"line":275,"address":[],"length":0,"stats":{"Line":18}},{"line":276,"address":[],"length":0,"stats":{"Line":6}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":12}},{"line":285,"address":[],"length":0,"stats":{"Line":6}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":6}},{"line":294,"address":[],"length":0,"stats":{"Line":2}},{"line":295,"address":[],"length":0,"stats":{"Line":2}},{"line":296,"address":[],"length":0,"stats":{"Line":2}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":5}},{"line":306,"address":[],"length":0,"stats":{"Line":10}},{"line":311,"address":[],"length":0,"stats":{"Line":2}},{"line":312,"address":[],"length":0,"stats":{"Line":2}},{"line":313,"address":[],"length":0,"stats":{"Line":2}},{"line":316,"address":[],"length":0,"stats":{"Line":3}},{"line":317,"address":[],"length":0,"stats":{"Line":3}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":3}},{"line":324,"address":[],"length":0,"stats":{"Line":3}},{"line":325,"address":[],"length":0,"stats":{"Line":3}},{"line":326,"address":[],"length":0,"stats":{"Line":3}},{"line":327,"address":[],"length":0,"stats":{"Line":1}},{"line":328,"address":[],"length":0,"stats":{"Line":1}},{"line":330,"address":[],"length":0,"stats":{"Line":2}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":2}},{"line":337,"address":[],"length":0,"stats":{"Line":2}},{"line":339,"address":[],"length":0,"stats":{"Line":2}},{"line":340,"address":[],"length":0,"stats":{"Line":2}},{"line":341,"address":[],"length":0,"stats":{"Line":2}},{"line":342,"address":[],"length":0,"stats":{"Line":2}},{"line":347,"address":[],"length":0,"stats":{"Line":7}},{"line":348,"address":[],"length":0,"stats":{"Line":7}},{"line":350,"address":[],"length":0,"stats":{"Line":14}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}}],"covered":64,"coverable":91},{"path":["/","Users","yaleman","Projects","goatns","src","logging.rs"],"content":"//! Logging and OTEL related thingies\n\nuse init_tracing_opentelemetry::tracing_subscriber_ext;\n\nuse tracing_subscriber::layer::SubscriberExt;\n\nuse tracing_subscriber::EnvFilter;\n\n#[allow(dead_code)]\npub(crate) fn build_loglevel_filter_layer() -\u003e EnvFilter {\n    // filter what is output on log (fmt)\n    // std::env::set_var(\"RUST_LOG\", \"warn,otel::tracing=info,otel=debug\");\n    std::env::set_var(\n        \"RUST_LOG\",\n        format!(\n            // `otel::tracing` should be a level info to emit opentelemetry trace \u0026 span\n            // `otel::setup` set to debug to log detected resources, configuration read and inferred\n            \"{},otel::tracing=debug,otel=debug,h2=error,hyper=warn,hyper_util=warn,tower=error,tonic=error\",\n            std::env::var(\"RUST_LOG\")\n                .or_else(|_| std::env::var(\"OTEL_LOG_LEVEL\"))\n                .unwrap_or_else(|_| \"info\".to_string())\n        ),\n    );\n    EnvFilter::from_default_env()\n}\n\n#[allow(dead_code)]\npub(crate) fn init_otel_subscribers() -\u003e Result\u003c(), String\u003e {\n    //setup a temporary subscriber to log output during setup\n    let subscriber = tracing_subscriber::registry()\n        .with(build_loglevel_filter_layer())\n        .with(tracing_subscriber_ext::build_logger_text());\n    let _guard = tracing::subscriber::set_default(subscriber);\n\n    let subscriber = tracing_subscriber::registry()\n        .with(tracing_subscriber_ext::build_otel_layer().map_err(|err| err.to_string())?)\n        .with(build_loglevel_filter_layer())\n        .with(tracing_subscriber_ext::build_logger_text());\n    tracing::subscriber::set_global_default(subscriber).map_err(|err| err.to_string())?;\n    Ok(())\n}\n","traces":[{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":16},{"path":["/","Users","yaleman","Projects","goatns","src","main.rs"],"content":"use goatns::enums::SystemState;\nuse goatns::error::GoatNsError;\nuse goatns::utils::start_channels;\nuse sqlx::SqlitePool;\nuse std::io;\nuse std::time::Duration;\n\nuse goatns::cli::clap_parser;\nuse goatns::config::{setup_logging, ConfigFile};\nuse goatns::datastore;\nuse goatns::db;\nuse goatns::servers;\nuse tokio::time::sleep;\n\nasync fn run() -\u003e Result\u003c(), GoatNsError\u003e {\n    let clap_results = clap_parser();\n\n    let config = ConfigFile::try_as_cowcell(clap_results.get_one::\u003cString\u003e(\"config\"))\n        .map_err(|err| GoatNsError::StartupError(format!(\"Config loading failed! {:?}\", err)))?;\n\n    let logger = setup_logging(config.read(), \u0026clap_results)\n        .await\n        .map_err(|err| GoatNsError::StartupError(format!(\"Log setup failed! {:?}\", err)))?;\n\n    let config_result = ConfigFile::check_config(config.write().await).await;\n\n    if clap_results.get_flag(\"configcheck\") {\n        log::info!(\n            \"{}\",\n            config\n                .read()\n                .as_json_pretty()\n                .expect(\"Failed to serialize config!\")\n        );\n        match config_result {\n            Ok(_) =\u003e log::info!(\"Checking config... [OK!]\"),\n            Err(_) =\u003e log::error!(\"Checking config... [ERR!]\"),\n        };\n    }\n\n    // sometimes you just have to print some errors\n    if let Err(errors) = config_result {\n        for error in errors {\n            log::error!(\"{error:}\")\n        }\n        log::error!(\"Shutting down due to error!\");\n        logger.shutdown();\n        return Err(GoatNsError::StartupError(\n            \"Config check failed!\".to_string(),\n        ));\n    };\n\n    if clap_results.get_flag(\"configcheck\") {\n        log::info!(\"Shutting down after config check.\");\n        logger.shutdown();\n        return config_result.map_err(|err| {\n            GoatNsError::StartupError(format!(\"Config check failed! Errors: {}\", err.join(\" \")))\n        });\n    };\n\n    log::info!(\"Configuration: {}\", *config.read());\n\n    let (agent_tx, datastore_sender, datastore_receiver) = start_channels();\n\n    // start up the DB\n    let connpool: SqlitePool = db::get_conn(config.read())\n        .await\n        .map_err(|err| GoatNsError::StartupError(format!(\"DB Setup failed: {:?}\", err)))?;\n\n    db::start_db(\u0026connpool).await?;\n\n    // start all the things!\n    let datastore_manager = tokio::spawn(datastore::manager(\n        datastore_receiver,\n        connpool.clone(),\n        Some(Duration::from_secs(config.read().sql_db_cleanup_seconds)),\n    ));\n\n    match goatns::cli::cli_commands(\n        datastore_sender.clone(),\n        \u0026clap_results,\n        \u0026config.read().zone_file,\n    )\n    .await\n    {\n        Ok(resp) =\u003e {\n            if resp == SystemState::Server {\n                let _ = rustls::crypto::aws_lc_rs::default_provider().install_default();\n                let udpserver = tokio::spawn(servers::udp_server(\n                    config.read(),\n                    datastore_sender.clone(),\n                    agent_tx.clone(),\n                ));\n                let tcpserver = tokio::spawn(servers::tcp_server(\n                    config.read(),\n                    datastore_sender.clone(),\n                    agent_tx.clone(),\n                ));\n\n                let apiserver =\n                    goatns::web::build(datastore_sender.clone(), config.read(), connpool.clone())\n                        .await?;\n\n                let servers = servers::Servers::build(agent_tx)\n                    .with_datastore(datastore_manager)\n                    .with_udpserver(udpserver)\n                    .with_tcpserver(tcpserver)\n                    .with_apiserver(apiserver);\n\n                loop {\n                    if servers.all_finished() {\n                        break;\n                    }\n                    sleep(std::time::Duration::from_micros(500)).await;\n                }\n            }\n        }\n        Err(error) =\u003e {\n            log::trace!(\"{error}\")\n        }\n    };\n    logger.flush();\n\n    logger.shutdown();\n    Ok(())\n}\n\nfn main() -\u003e Result\u003c(), io::Error\u003e {\n    tokio::runtime::Builder::new_current_thread()\n        .enable_all()\n        .build()\n        .expect(\"Failed to start main thread!\")\n        .block_on(async { run().await })\n        .map_err(|err| {\n            log::error!(\"{err:?}\");\n            err.into()\n        })\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":77},{"path":["/","Users","yaleman","Projects","goatns","src","packet_dumper.rs"],"content":"use chrono::{DateTime, Utc};\nuse tokio::fs::File;\nuse tokio::io::AsyncWriteExt;\nuse tracing::{debug, error};\n\npub enum DumpType {\n    ClientRequest,\n    // Header\n}\n\nimpl core::fmt::Display for DumpType {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match \u0026self {\n            DumpType::ClientRequest =\u003e f.write_str(\"client_request\"),\n        }\n    }\n}\n\n/// Dumps the bytes of a given vector to a templated packet\npub async fn dump_bytes(bytes: Vec\u003cu8\u003e, dump_type: DumpType) {\n    let now: DateTime\u003cUtc\u003e = Utc::now();\n\n    debug!(\"bytes: {:?}\", bytes);\n    let filename = format!(\n        \"./captures/{}-{}.cap\",\n        dump_type,\n        now.format(\"%Y-%m-%dT%H%M%SZ\")\n    );\n    let mut fh = match File::create(\u0026filename).await {\n        Ok(value) =\u003e value,\n        Err(error) =\u003e {\n            error!(\"couldn't open {} for writing: {:?}\", filename, error);\n            return;\n        }\n    };\n\n    match fh.write_all(\u0026bytes).await {\n        Ok(_) =\u003e debug!(\"Successfully wrote packet to {}\", \u0026filename),\n        Err(error) =\u003e debug!(\"Failed to write to {}: {:?}\", filename, error),\n    };\n}\n","traces":[{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":17},{"path":["/","Users","yaleman","Projects","goatns","src","reply.rs"],"content":"use crate::enums::{PacketType, Rcode};\nuse crate::error::GoatNsError;\nuse crate::resourcerecord::{DNSCharString, InternalResourceRecord};\nuse crate::{Header, Question};\nuse crate::{ResourceRecord, UDP_BUFFER_SIZE};\nuse log::error;\nuse packed_struct::prelude::*;\n\n#[derive(Debug, Clone)]\npub struct Reply {\n    pub header: Header,\n    pub question: Option\u003cQuestion\u003e,\n    pub answers: Vec\u003cInternalResourceRecord\u003e,\n    pub authorities: Vec\u003cResourceRecord\u003e,\n    pub additional: Vec\u003cResourceRecord\u003e,\n}\n\nimpl Reply {\n    /// This is used to turn into a series of bytes to yeet back to the client, needs to take a mutable self because the answers record length goes into the header\n    pub async fn as_bytes(\u0026self) -\u003e Result\u003cVec\u003cu8\u003e, GoatNsError\u003e {\n        let mut retval: Vec\u003cu8\u003e = vec![];\n\n        // so we can set the headers\n        let mut final_reply = self.clone();\n        final_reply.header.ancount = final_reply.answers.len() as u16;\n        // use the packed_struct to build the bytes\n        let reply_header = final_reply.header.pack()?;\n        retval.extend(reply_header);\n\n        // need to add the question in here\n        if let Some(question) = \u0026final_reply.question {\n            retval.extend(question.try_to_bytes()?);\n\n            for answer in \u0026final_reply.answers {\n                let ttl: \u0026u32 = match answer {\n                    InternalResourceRecord::A { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::AAAA { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::AXFR { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::CAA { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::CNAME { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::HINFO { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::InvalidType =\u003e \u00261u32,\n                    InternalResourceRecord::LOC { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::MX { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::NAPTR { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::NS { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::PTR { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::SOA { minimum, .. } =\u003e minimum,\n                    InternalResourceRecord::TXT { ttl, .. } =\u003e ttl,\n                    InternalResourceRecord::URI { ttl, .. } =\u003e ttl,\n                };\n\n                let answer_record = ResourceRecord {\n                    name: question.qname.clone(),\n                    record_type: answer.to_owned().into(),\n                    class: question.qclass,\n                    ttl: *ttl,\n                    rdata: answer.as_bytes(\u0026question.qname)?,\n                };\n                let reply_bytes: Vec\u003cu8\u003e = answer_record.try_into()?;\n                retval.extend(reply_bytes);\n            }\n        }\n\n        for authority in \u0026final_reply.authorities {\n            error!(\n                \"Should be handling authority rr's in reply: {:?}\",\n                authority\n            );\n        }\n\n        for additional in \u0026final_reply.additional {\n            error!(\n                \"Should be handling additional rr's in reply: {:?}\",\n                additional\n            );\n        }\n\n        Ok(retval)\n    }\n\n    /// because sometimes you need to trunc that junk\n    pub async fn as_bytes_udp(\u0026self) -\u003e Result\u003cVec\u003cu8\u003e, GoatNsError\u003e {\n        let mut result = self.as_bytes().await?;\n        if result.len() \u003e UDP_BUFFER_SIZE {\n            result.truncate(UDP_BUFFER_SIZE);\n        };\n        Ok(result)\n    }\n\n    /// checks to see if it's over the max length set in [UDP_BUFFER_SIZE] and set the truncated flag if it is\n    pub async fn check_set_truncated(\u0026self) -\u003e Reply {\n        if let Ok(ret_bytes) = self.as_bytes().await {\n            if ret_bytes.len() \u003e UDP_BUFFER_SIZE {\n                let mut header = self.header.clone();\n                header.truncated = true;\n                return Self {\n                    header,\n                    ..self.clone()\n                };\n            }\n        }\n        self.clone()\n    }\n}\n\n/// Want a generic empty reply with an ID and an RCODE? Here's your function.\npub fn reply_builder(id: u16, rcode: Rcode) -\u003e Result\u003cReply, String\u003e {\n    let header = Header {\n        id,\n        qr: PacketType::Answer,\n        rcode,\n        ..Default::default()\n    };\n    Ok(Reply {\n        header,\n        question: None,\n        answers: vec![],\n        authorities: vec![],\n        additional: vec![],\n    })\n}\n\n/// Build a NXDOMAIN response\npub fn reply_nxdomain(id: u16) -\u003e Result\u003cReply, String\u003e {\n    // RFC 2308  - 2.1 Name Error - \u003chttps://www.rfc-editor.org/rfc/rfc2308#section-2.1\u003e\n    reply_builder(id, Rcode::NameError)\n}\n\n/// Reply to an ANY request with a HINFO \"RFC8482\" \"\" response\npub fn reply_any(id: u16, question: \u0026Question) -\u003e Result\u003cReply, String\u003e {\n    Ok(Reply {\n        header: Header {\n            id,\n            qr: PacketType::Answer,\n            rcode: Rcode::NoError,\n            authoritative: true,\n            qdcount: 1,\n            ancount: 1,\n            ..Header::default()\n        },\n        question: Some(question.clone()),\n        answers: vec![InternalResourceRecord::HINFO {\n            cpu: Some(DNSCharString::from(\"RFC8482\")),\n            os: Some(DNSCharString::from(\"\")),\n            ttl: 3789,\n            rclass: question.qclass,\n        }],\n        authorities: vec![],\n        additional: vec![],\n    })\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":12}},{"line":21,"address":[],"length":0,"stats":{"Line":6}},{"line":24,"address":[],"length":0,"stats":{"Line":6}},{"line":25,"address":[],"length":0,"stats":{"Line":6}},{"line":27,"address":[],"length":0,"stats":{"Line":12}},{"line":31,"address":[],"length":0,"stats":{"Line":4}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":10}},{"line":35,"address":[],"length":0,"stats":{"Line":3}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":3}},{"line":61,"address":[],"length":0,"stats":{"Line":3}},{"line":65,"address":[],"length":0,"stats":{"Line":6}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":6}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":6}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":2}},{"line":115,"address":[],"length":0,"stats":{"Line":2}},{"line":116,"address":[],"length":0,"stats":{"Line":2}},{"line":117,"address":[],"length":0,"stats":{"Line":2}},{"line":118,"address":[],"length":0,"stats":{"Line":2}},{"line":119,"address":[],"length":0,"stats":{"Line":2}},{"line":120,"address":[],"length":0,"stats":{"Line":2}},{"line":125,"address":[],"length":0,"stats":{"Line":2}},{"line":127,"address":[],"length":0,"stats":{"Line":2}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}}],"covered":24,"coverable":73},{"path":["/","Users","yaleman","Projects","goatns","src","resourcerecord.rs"],"content":"use crate::enums::{RecordClass, RecordType};\nuse crate::error::GoatNsError;\nuse crate::utils::{dms_to_u32, hexdump, name_as_bytes};\nuse crate::zones::FileZoneRecord;\nuse crate::HEADER_BYTES;\nuse core::fmt::Debug;\nuse goat_lib::constants::{DEFAULT_LOC_HORIZ_PRE, DEFAULT_LOC_SIZE, DEFAULT_LOC_VERT_PRE};\nuse goat_lib::validators::{CAA_TAG_VALIDATOR, URI_RECORD};\nuse num_traits::Num;\nuse packed_struct::prelude::*;\nuse regex::Regex;\nuse serde::{Deserialize, Serialize, Serializer};\nuse std::env::consts;\nuse std::str::{from_utf8, FromStr};\nuse std::string::FromUtf8Error;\nuse tracing::error;\n\n#[derive(Clone, Debug, Eq, PartialEq, Serialize, Deserialize)]\npub struct DomainName {\n    pub name: String,\n}\n\nimpl DomainName {\n    /// Push the DomainName through the name_as_bytes function\n    pub fn as_bytes(\n        \u0026self,\n        compress_target: Option\u003cu16\u003e,\n        compress_reference: Option\u003c\u0026Vec\u003cu8\u003e\u003e,\n    ) -\u003e Result\u003cVec\u003cu8\u003e, GoatNsError\u003e {\n        name_as_bytes(\n            \u0026self.name.to_owned().into_bytes(),\n            compress_target,\n            compress_reference,\n        )\n    }\n}\n\nimpl From\u003c\u0026str\u003e for DomainName {\n    fn from(input: \u0026str) -\u003e Self {\n        let name = match input.contains('@') {\n            false =\u003e String::from(input),\n            true =\u003e input.replace('@', \".\"),\n        };\n        DomainName { name }\n    }\n}\n\nimpl From\u003cString\u003e for DomainName {\n    fn from(name: String) -\u003e Self {\n        DomainName { name }\n    }\n}\n\nimpl TryFrom\u003c\u0026Vec\u003cu8\u003e\u003e for DomainName {\n    fn try_from(input: \u0026Vec\u003cu8\u003e) -\u003e Result\u003cSelf, FromUtf8Error\u003e {\n        match String::from_utf8(input.to_owned()) {\n            Ok(value) =\u003e Ok(DomainName { name: value }),\n            Err(error) =\u003e Err(error),\n        }\n    }\n\n    type Error = FromUtf8Error;\n}\n\n/// Turn this into the domain-name value\nimpl TryFrom\u003c\u0026DomainName\u003e for Vec\u003cu8\u003e {\n    type Error = GoatNsError;\n    fn try_from(dn: \u0026DomainName) -\u003e Result\u003cSelf, Self::Error\u003e {\n        name_as_bytes(dn.name.as_bytes(), None, None)\n    }\n}\n\n#[derive(Debug, PackedStruct, PartialEq, Eq, Clone)]\n#[packed_struct(bit_numbering = \"msb0\", size_bytes = \"16\")]\npub struct LocRecord {\n    #[packed_field(bits = \"0..8\", endian = \"msb\")]\n    pub version: u8,\n    // #[packed_field(bits = \"9..13\", endian = \"msb\")]\n    // pub size_higher: u8,\n    // #[packed_field(bits = \"13..16\", endian = \"msb\")]\n    // pub size_lower: u8,\n    #[packed_field(bits = \"9..16\", endian = \"msb\")]\n    pub size: u8,\n    #[packed_field(bits = \"16..24\", endian = \"msb\")]\n    pub horiz_pre: u8,\n    #[packed_field(bits = \"24..32\", endian = \"msb\")]\n    pub vert_pre: u8,\n    #[packed_field(bits = \"32..64\", endian = \"msb\")]\n    pub latitude: u32,\n    #[packed_field(bits = \"64..96\", endian = \"msb\")]\n    pub longitude: u32,\n    #[packed_field(bits = \"96..128\", endian = \"msb\")]\n    pub altitude: i32,\n}\n\n/// `\u003ccharacter-string\u003e` is a single length octet followed by that number of characters.  `\u003ccharacter-string\u003e` is treated as binary information, and can be up to 256 characters in length (including the length octet).\n#[derive(Eq, PartialEq, Debug, Clone)]\npub struct DNSCharString {\n    pub data: Vec\u003cu8\u003e,\n}\n\nimpl Serialize for DNSCharString {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        #[allow(clippy::expect_used)]\n        let res = from_utf8(\u0026self.data).expect(\"This shouldn't ever fail\");\n        serializer.serialize_str(res)\n    }\n}\n\nimpl From\u003c\u0026str\u003e for DNSCharString {\n    fn from(input: \u0026str) -\u003e Self {\n        DNSCharString { data: input.into() }\n    }\n}\n\nimpl From\u003cDNSCharString\u003e for Vec\u003cu8\u003e {\n    fn from(input: DNSCharString) -\u003e Vec\u003cu8\u003e {\n        let mut data: Vec\u003cu8\u003e = vec![input.data.len() as u8];\n        data.extend(input.data);\n        data\n    }\n}\n\nimpl DNSCharString {\n    /// Returns the bytes for a packet, ie - the length and then the string\n    fn as_bytes(\u0026self) -\u003e Vec\u003cu8\u003e {\n        let mut res: Vec\u003cu8\u003e = self.data.to_vec();\n        // \u003ccharacter-string\u003e is a single length octet followed by that number of characters.  \u003ccharacter-string\u003e is treated as binary information, and can be up to 256 characters in length (including the length octet).\n        res.truncate(255);\n        res.insert(0, res.len() as u8);\n        res\n    }\n}\n\n#[allow(clippy::upper_case_acronyms)]\n#[derive(Debug, PartialEq, Eq, Clone, Serialize)]\n/// Internal representation of a resource record\npub enum InternalResourceRecord {\n    /// A single host address\n    A {\n        #[serde(serialize_with = \"crate::serializers::a_to_ip\")]\n        address: u32,\n        ttl: u32,\n        rclass: RecordClass,\n    },\n    AAAA {\n        #[serde(serialize_with = \"crate::serializers::aaaa_to_ip\")]\n        address: u128,\n        ttl: u32,\n        rclass: RecordClass,\n    }, // 28 https://www.rfc-editor.org/rfc/rfc3596#section-2.1\n    AXFR {\n        ttl: u32,\n        rclass: RecordClass,\n    }, // 252 A request for a transfer of an entire zone\n    // [RFC8659](https://www.rfc-editor.org/rfc/rfc8659) - CAA Record\n    CAA {\n        flag: u8,\n        /// Tags MAY contain ASCII characters \"a\" through \"z\", \"A\" through \"Z\", and the numbers 0 through 9. Tags MUST NOT contain any other characters. Matching of tags is case insensitive.\n        tag: DNSCharString,\n        /// A sequence of octets representing the Property Value. Property Values are encoded as binary values and MAY employ subformats.\n        value: Vec\u003cu8\u003e,\n        ttl: u32,\n        rclass: RecordClass,\n    },\n    CNAME {\n        cname: DomainName,\n        ttl: u32,\n        rclass: RecordClass,\n    }, // 5 the canonical name for an alias\n    LOC {\n        ttl: u32,\n        rclass: RecordClass,\n        /// Version number of the representation.  This must be zero. Implementations are required to check this field and make no assumptions about the format of unrecognized versions.\n        version: u8,\n        size: u8,\n        horiz_pre: u8,\n        vert_pre: u8,\n        latitude: u32,\n        longitude: u32,\n        altitude: i32,\n    },\n    NAPTR {\n        ttl: u32,\n        rclass: RecordClass,\n        ///     Domain - The domain name to which this resource record refers.  This is the 'key' for this entry in the rule database.  This value will either be the first well known key (`\u003csomething\u003e.uri.arpa` for example) or a new key that is the output of a replacement or regexp rewrite. Beyond this, it has the standard DNS requirements.\n        domain: DomainName,\n        // A 16-bit unsigned integer specifying the order in which the NAPTR records MUST be processed to ensure the correct ordering of rules.  Low numbers are processed before high numbers, and once a NAPTR is found whose rule \"matches\" the target, the client MUST NOT consider any NAPTRs with a higher value for order (except as noted below for the Flags field).\n        order: u16,\n\n        /* A 16-bit unsigned integer that specifies the order in which NAPTR\n        records with equal \"order\" values SHOULD be processed, low\n        numbers being processed before high numbers.  This is similar to\n        the preference field in an MX record, and is used so domain\n        administrators can direct clients towards more capable hosts or\n        lighter weight protocols.  A client MAY look at records with\n        higher preference values if it has a good reason to do so such as\n        not understanding the preferred protocol or service.\n\n        The important difference between Order and Preference is that\n        once a match is found the client MUST NOT consider records with a\n        different Order but they MAY process records with the same Order\n        but different Preferences.  I.e., Preference is used to give weight\n        to rules that are considered the same from an authority\n        standpoint but not from a simple load balancing standpoint.*/\n        preference: u16,\n\n        // A \u003ccharacter-string\u003e containing flags to control aspects of the\n        // rewriting and interpretation of the fields in the record.  Flags\n        // are single characters from the set [A-Z0-9].  The case of the\n        // alphabetic characters is not significant.\n\n        // At this time only four flags, \"S\", \"A\", \"U\", and \"P\", are\n        // defined.  The \"S\", \"A\" and \"U\" flags denote a terminal lookup.\n        // This means that this NAPTR record is the last one and that the\n        // flag determines what the next stage should be.  The \"S\" flag\n        // means that the next lookup should be for SRV records [4].  See\n        // Section 5 for additional information on how NAPTR uses the SRV\n        // record type.  \"A\" means that the next lookup should be for either\n        // an A, AAAA, or A6 record.  The \"U\" flag means that the next step\n        // is not a DNS lookup but that the output of the Regexp field is an\n        // URI that adheres to the 'absoluteURI' production found in the\n        // ABNF of RFC 2396 [9].  Since there may be applications that use\n        // NAPTR to also lookup aspects of URIs, implementers should be\n        // aware that this may cause loop conditions and should act\n        // accordingly.\n        flags: String,\n    },\n    NS {\n        nsdname: DomainName,\n        ttl: u32,\n        rclass: RecordClass,\n    }, // 2 an authoritative name server\n    SOA {\n        // The zone that this SOA record is for - eg hello.goat or example.com\n        zone: DomainName,\n        /// The `domain-name` of the name server that was the original or primary source of data for this zone.\n        mname: DomainName,\n        /// A `domain-name` which specifies the mailbox of the person responsible for this zone. eg: `dns.example.com` is actually `dns@example.com`\n        rname: DomainName,\n        serial: u32,\n        refresh: u32,\n        retry: u32,\n        expire: u32,\n        minimum: u32,\n        rclass: RecordClass,\n    }, // 6 marks the start of a zone of authority\n\n    PTR {\n        ptrdname: DomainName,\n        ttl: u32,\n        rclass: RecordClass,\n    }, // 12 a domain name pointer\n    /// RFC1035\n    HINFO {\n        cpu: Option\u003cDNSCharString\u003e,\n        os: Option\u003cDNSCharString\u003e,\n        ttl: u32,\n        rclass: RecordClass,\n    }, // 13 host information\n    MX {\n        preference: u16,\n        exchange: DomainName,\n        ttl: u32,\n        rclass: RecordClass,\n    }, // 15 mail exchange\n    TXT {\n        txtdata: DNSCharString,\n        ttl: u32,\n        class: RecordClass,\n    }, // 16 text strings\n    URI {\n        priority: u16,\n        weight: u16,\n        target: DNSCharString,\n        ttl: u32,\n        rclass: RecordClass,\n    },\n    InvalidType,\n}\n\nimpl TryFrom\u003cFileZoneRecord\u003e for InternalResourceRecord {\n    type Error = GoatNsError;\n    /// This is where we convert from the JSON blob in the file to an internal representation of the data.\n    fn try_from(record: FileZoneRecord) -\u003e Result\u003cSelf, Self::Error\u003e {\n        if check_long_labels(\u0026record.name) {\n            return Err(GoatNsError::Generic(format!(\"At least one label is of length over 63 in name {}! I'm refusing to serve this record.\", record.name)));\n        };\n\n        if record.name.len() \u003e 255 {\n            return Err(GoatNsError::Generic(format!(\"The length of name ({}) is over 255 octets! ({}) I'm refusing to serve this record.\", record.name,\n            record.name.len())));\n        };\n\n        match record.rrtype.as_str() {\n            \"A\" =\u003e {\n                let address: u32 = match std::net::Ipv4Addr::from_str(\u0026record.rdata) {\n                    Ok(value) =\u003e value.into(),\n                    Err(error) =\u003e {\n                        log::error!(\n                            \"Failed to parse {:?} into an IPv4 address: {:?}\",\n                            record.rdata,\n                            error\n                        );\n                        0u32\n                    }\n                };\n                Ok(InternalResourceRecord::A {\n                    address,\n                    ttl: record.ttl,\n                    rclass: record.class,\n                })\n            }\n            \"AAAA\" =\u003e {\n                let address: u128 = match std::net::Ipv6Addr::from_str(\u0026record.rdata) {\n                    Ok(value) =\u003e {\n                        let res: u128 = value.into();\n                        log::trace!(\"Encoding {:?} as {:?}\", value, res);\n                        res\n                    }\n                    Err(error) =\u003e {\n                        return Err(GoatNsError::Generic(format!(\n                            \"Failed to parse {:?} into an IPv6 address: {:?}\",\n                            record.rdata, error\n                        )));\n                    }\n                };\n\n                Ok(InternalResourceRecord::AAAA {\n                    address,\n                    ttl: record.ttl,\n                    rclass: record.class,\n                })\n            }\n            \"CNAME\" =\u003e Ok(InternalResourceRecord::CNAME {\n                cname: DomainName::from(record.rdata),\n                ttl: record.ttl,\n                rclass: record.class,\n            }),\n            \"PTR\" =\u003e Ok(InternalResourceRecord::PTR {\n                ptrdname: DomainName::from(record.rdata),\n                ttl: record.ttl,\n                rclass: record.class,\n            }),\n            \"TXT\" =\u003e Ok(InternalResourceRecord::TXT {\n                txtdata: DNSCharString {\n                    data: record.rdata.into_bytes(),\n                },\n                ttl: record.ttl,\n                class: record.class,\n            }),\n            \"MX\" =\u003e {\n                let split_bit: Vec\u003c\u0026str\u003e = record.rdata.split(' ').collect();\n                if split_bit.len() != 2 {\n                    return Err(GoatNsError::Generic(format!(\n                        \"While trying to parse MX record, got '{:?}' which is wrong.\",\n                        split_bit\n                    )));\n                };\n                let pref = match u16::from_str(split_bit[0]) {\n                    Ok(value) =\u003e value,\n                    Err(error) =\u003e {\n                        return Err(GoatNsError::Generic(format!(\n                            \"Failed to parse {} into number: {:?}\",\n                            split_bit[0], error\n                        )))\n                    }\n                };\n                log::trace!(\"got pref {}, now {pref}\", split_bit[0]);\n                Ok(InternalResourceRecord::MX {\n                    preference: pref,\n                    exchange: DomainName::from(split_bit[1]),\n                    ttl: record.ttl,\n                    rclass: record.class,\n                })\n            }\n            \"NS\" =\u003e Ok(InternalResourceRecord::NS {\n                nsdname: DomainName::from(record.rdata),\n                ttl: record.ttl,\n                rclass: record.class,\n            }),\n            \"CAA\" =\u003e {\n                let split_bit: Vec\u003c\u0026str\u003e = record.rdata.split(' ').collect();\n                if split_bit.len() \u003c 3 {\n                    return Err(GoatNsError::Generic(format!(\n                        \"While trying to parse CAA record, got '{:?}' which is wrong.\",\n                        split_bit\n                    )));\n                };\n                let flag = match u8::from_str(split_bit[0]) {\n                    Ok(value) =\u003e value,\n                    Err(error) =\u003e {\n                        return Err(GoatNsError::Generic(format!(\n                            \"Failed to parse {} into number: {:?}\",\n                            split_bit[0], error\n                        )))\n                    }\n                };\n                let tag = DNSCharString::from(split_bit[1]);\n                // validate that the tag is valid.\n                if !CAA_TAG_VALIDATOR.is_match(split_bit[1]) {\n                    return Err(GoatNsError::Generic(format!(\n                        \"Invalid tag value {:?} for {}\",\n                        split_bit[1], record.name\n                    )));\n                };\n                // take the rest of the data as the thing.\n                let value = split_bit[2..].to_vec().join(\" \").as_bytes().to_vec();\n                Ok(InternalResourceRecord::CAA {\n                    flag,\n                    tag,\n                    value,\n                    ttl: record.ttl,\n                    rclass: record.class,\n                })\n            }\n            \"LOC\" =\u003e {\n                // we do this here because the conversion process is *so* big.\n                let res: FileLocRecord = FileLocRecord::try_from(record.rdata.as_str())?;\n\n                Ok(InternalResourceRecord::LOC {\n                    ttl: record.ttl,\n                    rclass: record.class,\n                    version: 0,\n                    size: res.size,\n                    horiz_pre: res.horiz_pre,\n                    vert_pre: res.vert_pre,\n                    latitude: dms_to_u32(res.d1, res.m1, res.s1, res.lat_dir == *\"N\"),\n                    longitude: dms_to_u32(res.d2, res.m2, res.s2, res.lon_dir == *\"E\"),\n                    altitude: res.alt,\n                })\n                // Err(\"LOC not finished!\".to_string())\n            }\n            \"URI\" =\u003e {\n                let matches = match URI_RECORD.captures(\u0026record.rdata) {\n                    Some(value) =\u003e value,\n                    None =\u003e {\n                        return Err(GoatNsError::Generic(\n                            \"Failed to parse URL record!\".to_string(),\n                        ))\n                    }\n                };\n\n                let priority = match matches.name(\"priority\") {\n                    Some(value) =\u003e match value.as_str().parse::\u003cu16\u003e() {\n                        Ok(value) =\u003e value,\n                        Err(err) =\u003e {\n                            return Err(GoatNsError::Generic(format!(\n                                \"Failed to parse priority into u16: {err:?}\"\n                            )))\n                        }\n                    },\n                    None =\u003e {\n                        return Err(GoatNsError::Generic(\n                            \"No target found in record?\".to_string(),\n                        ))\n                    }\n                };\n                let weight = match matches.name(\"weight\") {\n                    Some(value) =\u003e match value.as_str().parse::\u003cu16\u003e() {\n                        Ok(value) =\u003e value,\n                        Err(err) =\u003e {\n                            return Err(GoatNsError::Generic(format!(\n                                \"Failed to parse weight into u16: {err:?}\"\n                            )))\n                        }\n                    },\n                    None =\u003e {\n                        return Err(GoatNsError::Generic(\n                            \"No target found in record?\".to_string(),\n                        ))\n                    }\n                };\n                let target = match matches.name(\"target\") {\n                    Some(value) =\u003e DNSCharString::from(value.as_str()),\n                    None =\u003e {\n                        return Err(GoatNsError::Generic(\n                            \"No target found in record?\".to_string(),\n                        ))\n                    }\n                };\n\n                Ok(InternalResourceRecord::URI {\n                    priority,\n                    weight,\n                    target,\n                    ttl: record.ttl,\n                    rclass: record.class,\n                })\n            }\n            _ =\u003e Err(GoatNsError::Generic(\"Invalid type specified!\".to_string())),\n        }\n    }\n}\n\nimpl PartialEq\u003cRecordClass\u003e for InternalResourceRecord {\n    fn eq(\u0026self, other: \u0026RecordClass) -\u003e bool {\n        match self {\n            InternalResourceRecord::TXT { class, .. } =\u003e class == other,\n            _ =\u003e other == \u0026RecordClass::Internet, // TODO: we only support IN records outside TXT records\n        }\n    }\n}\n\nimpl PartialEq\u003cRecordType\u003e for InternalResourceRecord {\n    fn eq(\u0026self, other: \u0026RecordType) -\u003e bool {\n        match self {\n            InternalResourceRecord::A { .. } =\u003e other == \u0026RecordType::A,\n            InternalResourceRecord::AAAA { .. } =\u003e other == \u0026RecordType::AAAA,\n            InternalResourceRecord::AXFR { .. } =\u003e other == \u0026RecordType::AXFR,\n            InternalResourceRecord::CAA { .. } =\u003e other == \u0026RecordType::CAA,\n            InternalResourceRecord::CNAME { .. } =\u003e other == \u0026RecordType::CNAME,\n            InternalResourceRecord::HINFO { .. } =\u003e other == \u0026RecordType::HINFO,\n            InternalResourceRecord::InvalidType =\u003e other == \u0026RecordType::InvalidType,\n            InternalResourceRecord::LOC { .. } =\u003e other == \u0026RecordType::LOC,\n            InternalResourceRecord::MX { .. } =\u003e other == \u0026RecordType::MX,\n            InternalResourceRecord::NAPTR { .. } =\u003e other == \u0026RecordType::NAPTR,\n            InternalResourceRecord::NS { .. } =\u003e other == \u0026RecordType::NS,\n            InternalResourceRecord::PTR { .. } =\u003e other == \u0026RecordType::PTR,\n            InternalResourceRecord::SOA { .. } =\u003e other == \u0026RecordType::SOA,\n            InternalResourceRecord::TXT { .. } =\u003e other == \u0026RecordType::TXT,\n            InternalResourceRecord::URI { .. } =\u003e other == \u0026RecordType::URI,\n        }\n    }\n}\n\nimpl InternalResourceRecord {\n    pub fn as_bytes(\n        self: \u0026InternalResourceRecord,\n        question: \u0026Vec\u003cu8\u003e,\n    ) -\u003e Result\u003cVec\u003cu8\u003e, GoatNsError\u003e {\n        match self {\n            InternalResourceRecord::A { address, .. } =\u003e Ok(address.to_be_bytes().to_vec()),\n            InternalResourceRecord::AAAA { address, .. } =\u003e Ok(address.to_be_bytes().to_vec()),\n\n            InternalResourceRecord::CNAME { cname, .. } =\u003e {\n                log::trace!(\"turning CNAME {cname:?} into bytes\");\n                cname.as_bytes(Some(HEADER_BYTES as u16), Some(question))\n            }\n            InternalResourceRecord::LOC {\n                ttl,\n                version,\n                size,\n                horiz_pre,\n                vert_pre,\n                latitude,\n                longitude,\n                altitude,\n                ..\n            } =\u003e {\n                log::error!(\"LOC {:?} - TTL={ttl}\", from_utf8(question));\n                Ok(LocRecord {\n                    version: *version,\n                    size: *size,\n                    horiz_pre: *horiz_pre,\n                    vert_pre: *vert_pre,\n                    latitude: *latitude,\n                    longitude: *longitude,\n                    altitude: *altitude,\n                }\n                .pack_to_vec()?)\n            }\n            InternalResourceRecord::NS { nsdname, .. } =\u003e {\n                nsdname.as_bytes(Some(HEADER_BYTES as u16), Some(question))\n            }\n            InternalResourceRecord::PTR { ptrdname, .. } =\u003e {\n                ptrdname.as_bytes(Some(HEADER_BYTES as u16), Some(question))\n            }\n            InternalResourceRecord::SOA {\n                zone,\n                mname,\n                rname,\n                serial,\n                refresh,\n                retry,\n                expire,\n                minimum,\n                ..\n            } =\u003e {\n                let zone_as_bytes = zone.name.as_bytes().to_vec();\n                let mut res: Vec\u003cu8\u003e =\n                    mname.as_bytes(Some(HEADER_BYTES as u16), Some(\u0026zone_as_bytes))?;\n                res.extend(rname.as_bytes(Some(HEADER_BYTES as u16), Some(\u0026zone_as_bytes))?);\n                res.extend(serial.to_be_bytes());\n                res.extend(refresh.to_be_bytes());\n                res.extend(retry.to_be_bytes());\n                res.extend(expire.to_be_bytes());\n                res.extend(minimum.to_be_bytes());\n                Ok(res)\n            }\n            InternalResourceRecord::TXT { txtdata, .. } =\u003e Ok(txtdata.as_bytes()),\n            InternalResourceRecord::URI {\n                priority,\n                weight,\n                target,\n                ..\n            } =\u003e {\n                let mut res = vec![];\n                res.extend(priority.to_be_bytes());\n                res.extend(weight.to_be_bytes());\n                res.extend(\u0026target.data);\n                Ok(res)\n            }\n            InternalResourceRecord::HINFO { cpu, os, .. } =\u003e {\n                let mut hinfo_bytes: Vec\u003cu8\u003e = vec![];\n                match cpu {\n                    Some(value) =\u003e {\n                        hinfo_bytes.extend(\u0026value.as_bytes());\n                    }\n                    None =\u003e {\n                        hinfo_bytes.extend([consts::ARCH.len() as u8]);\n                        hinfo_bytes.extend(consts::ARCH.as_bytes());\n                    }\n                };\n\n                match os {\n                    Some(value) =\u003e {\n                        hinfo_bytes.extend(\u0026value.as_bytes());\n                    }\n                    None =\u003e {\n                        hinfo_bytes.extend([consts::OS.len() as u8]);\n                        hinfo_bytes.extend(consts::OS.as_bytes());\n                    }\n                };\n                Ok(hinfo_bytes)\n            }\n            // InternalResourceRecord::MINFO { ttl, .. } =\u003e ttl(),\n            InternalResourceRecord::MX {\n                preference,\n                exchange,\n                ..\n            } =\u003e {\n                let mut mx_bytes: Vec\u003cu8\u003e = preference.to_be_bytes().into();\n                mx_bytes.extend(exchange.as_bytes(Some(HEADER_BYTES as u16), Some(question))?);\n                Ok(mx_bytes)\n            }\n            InternalResourceRecord::AXFR { .. } =\u003e unimplemented!(), // TODO: handle axfr records\n            InternalResourceRecord::InvalidType =\u003e {\n                error!(\"Somehow people are requesting InvalidType records as bytes!\");\n                Ok(vec![])\n            }\n            InternalResourceRecord::CAA {\n                flag, tag, value, ..\n            } =\u003e {\n                let mut result: Vec\u003cu8\u003e = vec![*flag];\n                // add the tag\n                result.extend(tag.as_bytes());\n                // add the value\n                result.extend(value);\n\n                Ok(result)\n            }\n            InternalResourceRecord::NAPTR { .. } =\u003e {\n                error!(\"Asked for an NAPTR as_bytes, returning null\");\n                Ok(Vec::new())\n            }\n        }\n    }\n\n    pub fn hexdump(self) {\n        if let Err(err) = hexdump(\n            \u0026self\n                .as_bytes(\u0026vec![])\n                .inspect_err(|err| error!(\"Failed to convert to bytes: {:?}\", err))\n                .unwrap_or_default(),\n        ) {\n            error!(\"Failed to decode bytes: {:?}\", err);\n        };\n    }\n\n    pub fn ttl(\u0026self) -\u003e \u0026u32 {\n        match self {\n            InternalResourceRecord::A { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::AAAA { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::AXFR { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::CAA { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::CNAME { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::LOC { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::NAPTR { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::NS { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::SOA { minimum, .. } =\u003e minimum,\n            InternalResourceRecord::PTR { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::HINFO { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::MX { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::TXT { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::URI { ttl, .. } =\u003e ttl,\n            InternalResourceRecord::InvalidType =\u003e \u00260,\n        }\n    }\n}\n\npub trait SetTTL {\n    fn set_ttl(self, ttl: u32) -\u003e Self;\n}\n\nimpl SetTTL for InternalResourceRecord {\n    fn set_ttl(self, ttl: u32) -\u003e Self {\n        match self {\n            Self::A {\n                address, rclass, ..\n            } =\u003e Self::A {\n                ttl,\n                address,\n                rclass,\n            },\n            Self::AAAA {\n                address, rclass, ..\n            } =\u003e Self::AAAA {\n                address,\n                rclass,\n                ttl,\n            },\n            Self::AXFR { rclass, .. } =\u003e Self::AXFR { ttl, rclass },\n            Self::CAA {\n                flag,\n                tag,\n                value,\n                rclass,\n                ..\n            } =\u003e Self::CAA {\n                flag,\n                tag,\n                value,\n                rclass,\n                ttl,\n            },\n            Self::CNAME { cname, rclass, .. } =\u003e Self::CNAME { cname, ttl, rclass },\n            Self::LOC {\n                rclass,\n                version,\n                size,\n                horiz_pre,\n                vert_pre,\n                latitude,\n                longitude,\n                altitude,\n                ..\n            } =\u003e Self::LOC {\n                ttl,\n                rclass,\n                version,\n                size,\n                horiz_pre,\n                vert_pre,\n                latitude,\n                longitude,\n                altitude,\n            },\n            Self::NAPTR {\n                rclass,\n                domain,\n                order,\n                preference,\n                flags,\n                ..\n            } =\u003e Self::NAPTR {\n                rclass,\n                domain,\n                order,\n                preference,\n                flags,\n                ttl,\n            },\n            Self::NS {\n                nsdname, rclass, ..\n            } =\u003e Self::NS {\n                nsdname,\n                ttl,\n                rclass,\n            },\n            Self::SOA {\n                zone,\n                mname,\n                rname,\n                serial,\n                refresh,\n                retry,\n                expire,\n                rclass,\n                ..\n            } =\u003e Self::SOA {\n                zone,\n                mname,\n                rname,\n                serial,\n                refresh,\n                retry,\n                expire,\n                minimum: ttl,\n                rclass,\n            },\n            Self::PTR {\n                ptrdname, rclass, ..\n            } =\u003e Self::PTR {\n                ptrdname,\n                ttl,\n                rclass,\n            },\n            Self::HINFO {\n                cpu,\n                os,\n                ttl,\n                rclass,\n                ..\n            } =\u003e Self::HINFO {\n                cpu,\n                os,\n                rclass,\n                ttl,\n            },\n            Self::MX {\n                preference,\n                exchange,\n                rclass,\n                ..\n            } =\u003e Self::MX {\n                preference,\n                exchange,\n                ttl,\n                rclass,\n            },\n            Self::TXT { txtdata, class, .. } =\u003e Self::TXT {\n                txtdata,\n                class,\n                ttl,\n            },\n            Self::URI {\n                priority,\n                weight,\n                target,\n                rclass,\n                ..\n            } =\u003e Self::URI {\n                priority,\n                weight,\n                target,\n                rclass,\n                ttl,\n            },\n            //  Self::InvalidType =\u003e \u00260,\n            _ =\u003e {\n                log::error!(\"Tried to set TTL on an invalid type! {:?}\", self);\n                self\n            }\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use std::net::Ipv6Addr;\n    use std::str::FromStr;\n\n    use log::debug;\n\n    use crate::enums::RecordType;\n    use crate::zones::FileZoneRecord;\n    use crate::RecordClass;\n\n    use super::{DNSCharString, InternalResourceRecord};\n    #[test]\n    fn eq_resourcerecord() {\n        assert_eq!(\n            InternalResourceRecord::A {\n                address: 12345,\n                ttl: 1,\n                rclass: RecordClass::Internet\n            },\n            RecordType::A\n        );\n        assert_eq!(\n            InternalResourceRecord::AAAA {\n                address: 12345,\n                ttl: 1,\n                rclass: RecordClass::Internet\n            },\n            RecordType::AAAA\n        );\n    }\n\n    #[test]\n    fn resourcerecord_from_ipv6_string() {\n        let fzr = FileZoneRecord {\n            name: \"test\".to_string(),\n            rrtype: \"AAAA\".to_string(),\n            rdata: String::from(\"1234:5678:cafe:beef:ca75:0:4b9:e94d\"),\n            ttl: 160u32,\n            class: RecordClass::Internet,\n            zoneid: Some(1),\n            id: None,\n        };\n        debug!(\"fzr: {fzr}\");\n        let converted = match Ipv6Addr::from_str(\u0026fzr.rdata) {\n            Ok(value) =\u003e value,\n            Err(err) =\u003e panic!(\"Failed to convert rdata to string: {err:?}\"),\n        };\n        debug!(\"conversion: {:?}\", converted);\n        let rr: InternalResourceRecord = match fzr.try_into() {\n            Ok(value) =\u003e value,\n            Err(error) =\u003e panic!(\"Failed to get resource record: {:?}\", error),\n        };\n\n        debug!(\"fzr-\u003err = {rr:?}\");\n        assert_eq!(rr, RecordType::AAAA);\n        assert_eq!(\n            rr.as_bytes(\u0026vec![]).expect(\"failed to convert to bytes\"),\n            [18, 52, 86, 120, 202, 254, 190, 239, 202, 117, 0, 0, 4, 185, 233, 77].to_vec()\n        );\n    }\n    #[test]\n    fn dnscharstring() {\n        let test: DNSCharString = \"hello world\".into();\n        let testbytes: Vec\u003cu8\u003e = test.into();\n        assert_eq!(testbytes[0], 11);\n    }\n\n    #[test]\n    fn resourcerecord_txt() {\n        let foo = InternalResourceRecord::TXT {\n            txtdata: DNSCharString::from(\"Hello world\"),\n            ttl: 1,\n            class: RecordClass::Internet,\n        };\n        if let InternalResourceRecord::TXT { txtdata, .. } = foo {\n            let foo_bytes: Vec\u003cu8\u003e = txtdata.into();\n            assert_eq!(foo_bytes[0], 11);\n        };\n    }\n}\n\n#[derive(PartialEq)]\n/// This represents a LOC record in a zone file\npub struct FileLocRecord {\n    pub d1: u8,\n    pub d2: u8,\n    pub m1: u8,\n    pub m2: u8,\n    pub s1: f32,\n    pub s2: f32,\n    pub lat_dir: String,\n    pub lon_dir: String,\n    pub alt: i32,\n    pub size: u8,\n    pub horiz_pre: u8,\n    pub vert_pre: u8,\n}\n\nimpl Default for FileLocRecord {\n    fn default() -\u003e Self {\n        Self {\n            d1: 0,\n            m1: 0,\n            s1: 0.0,\n            d2: 0,\n            m2: 0,\n            s2: 0.0,\n            lat_dir: Default::default(),\n            lon_dir: Default::default(),\n            alt: Default::default(),\n            size: 0x12,      // 1m (100cm)\n            horiz_pre: 0x16, // 10000m (1,000,000 cm)\n            vert_pre: 0x13,  // 10m (1,000cm)\n        }\n    }\n}\n\nimpl Debug for FileLocRecord {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        f.debug_struct(\"FileLocRecord\")\n            .field(\"d1\", \u0026self.d1)\n            .field(\"m1\", \u0026self.m1)\n            .field(\"s1\", \u0026self.s1)\n            .field(\"lat_dir\", \u0026self.lat_dir)\n            .field(\"d2\", \u0026self.d2)\n            .field(\"m2\", \u0026self.m2)\n            .field(\"s2\", \u0026self.s2)\n            .field(\"lon_dir\", \u0026self.lon_dir)\n            .field(\"alt\", \u0026self.alt)\n            .field(\"size\", \u0026format_args!(\"0x{:2x}\", \u0026self.size))\n            .field(\"horiz_pre\", \u0026format_args!(\"0x{:2x}\", \u0026self.horiz_pre))\n            .field(\"vert_pre\", \u0026format_args!(\"0x{:2x}\", \u0026self.vert_pre))\n            .finish()\n    }\n}\n\nimpl TryFrom\u003c\u0026str\u003e for FileLocRecord {\n    type Error = GoatNsError;\n\n    fn try_from(input_string: \u0026str) -\u003e Result\u003cFileLocRecord, Self::Error\u003e {\n        // Thanks to the folks from #regex on Liberachat\n        let loc_regex = Regex::new(\n            r\"^(?P\u003cd1\u003e\\d+)(?:[ ](?P\u003cm1\u003e\\d+)(?:[ ](?P\u003cs1\u003e\\d+(?:[.]\\d+)?))?)?[ ](?P\u003clat_dir\u003e[NS])[ ](?P\u003cd2\u003e\\d+)(?:[ ](?P\u003cm2\u003e\\d+)(?:[ ](?P\u003cs2\u003e\\d+(?:[.]\\d+)?))?)?[ ](?P\u003clon_dir\u003e[EW])[ ](?P\u003calt\u003e-?\\d+(?:[.]\\d+)?)m(?:[ ](?P\u003csize\u003e\\d+(?:[.]\\d+)?)m(?:[ ](?P\u003chp\u003e\\d+(?:[.]\\d+)?)m(?:[ ](?P\u003cvp\u003e\\d+(?:[.]\\d+)?)m)?)?)?\",\n        )?;\n\n        let result = match loc_regex.captures(input_string) {\n            Some(value) =\u003e value,\n            None =\u003e {\n                return Err(GoatNsError::Generic(\n                    \"Failed to match input to expected format!\".to_string(),\n                ));\n            }\n        };\n        log::trace!(\"{result:?}\");\n\n        let d1: u8 = match result.name(\"d1\") {\n            Some(value) =\u003e match value.as_str().parse::\u003cu8\u003e() {\n                Ok(value) =\u003e value,\n                Err(err) =\u003e {\n                    log::error!(\"Failed to parse d1: {err:?}\");\n                    0\n                }\n            },\n            None =\u003e 0,\n        };\n        let d2: u8 = match result.name(\"d2\") {\n            Some(value) =\u003e match value.as_str().parse::\u003cu8\u003e() {\n                Ok(value) =\u003e value,\n                Err(err) =\u003e {\n                    log::error!(\"Failed to parse d2: {err:?}\");\n                    0\n                }\n            },\n            None =\u003e 0,\n        };\n\n        let m1: u8 = match result.name(\"m1\") {\n            Some(value) =\u003e match value.as_str().parse::\u003cu8\u003e() {\n                Ok(value) =\u003e value,\n                Err(err) =\u003e {\n                    log::error!(\"Failed to parse m1: {err:?}\");\n                    FileLocRecord::default().m1\n                }\n            },\n            None =\u003e FileLocRecord::default().m1,\n        };\n        let m2: u8 = match result.name(\"m2\") {\n            Some(value) =\u003e match value.as_str().parse::\u003cu8\u003e() {\n                Ok(value) =\u003e value,\n                Err(err) =\u003e {\n                    log::error!(\"Failed to parse m2: {err:?}\");\n                    FileLocRecord::default().m2\n                }\n            },\n            None =\u003e FileLocRecord::default().m2,\n        };\n        let s1: f32 = match result.name(\"s1\") {\n            Some(value) =\u003e match f32::from_str_radix(value.as_str(), 10) {\n                Ok(value) =\u003e {\n                    log::trace!(\"Parsed s1 as {value} from string\");\n                    value\n                }\n                Err(err) =\u003e {\n                    log::error!(\"Failed to parse s1: {err:?}\");\n                    0.0\n                }\n            },\n            None =\u003e 0f32,\n        };\n        let s2: f32 = match result.name(\"s2\") {\n            Some(value) =\u003e match f32::from_str_radix(value.as_str(), 10) {\n                Ok(value) =\u003e value,\n                Err(err) =\u003e {\n                    log::error!(\"Failed to parse s2: {err:?}\");\n                    0.0\n                }\n            },\n            None =\u003e 0f32,\n        };\n        let lat_dir: String = match result.name(\"lat_dir\") {\n            Some(value) =\u003e value.as_str().into(),\n            None =\u003e {\n                return Err(GoatNsError::Generic(\n                    \"Couldn't match lat_dir in this string!\".to_string(),\n                ));\n            }\n        };\n\n        let lon_dir: String = match result.name(\"lon_dir\") {\n            Some(value) =\u003e value.as_str().into(),\n            None =\u003e {\n                return Err(GoatNsError::Generic(\n                    \"Couldn't match lon_dir in this string!\".to_string(),\n                ));\n            }\n        };\n\n        let alt: i32 = match result.name(\"alt\") {\n            Some(value) =\u003e match value.as_str().parse::\u003ci32\u003e() {\n                Ok(value) =\u003e value,\n                Err(err) =\u003e {\n                    return Err(GoatNsError::Generic(format!(\n                        \"Error parsing altitude: {err:?}\"\n                    )))\n                }\n            },\n            None =\u003e return Err(GoatNsError::Generic(\"Error finding altitude!\".to_string())),\n        };\n        // here we work out the final value for the altitude\n        // let altfrac = alt_num % 100;\n        // let altmeters = alt_num ;\n        let alt = 10000000 + (alt * 100);\n\n        let size: u32 = match result.name(\"size\") {\n            Some(value) =\u003e match value.as_str().parse::\u003cu32\u003e() {\n                Ok(value) =\u003e {\n                    log::trace!(\"Parsed size as {value} from string\");\n                    value\n                }\n                Err(err) =\u003e {\n                    return Err(GoatNsError::Generic(format!(\n                        \"Failed to parse size: {value:?}, {err:?}\"\n                    )))\n                }\n            },\n            None =\u003e {\n                log::trace!(\"defaulting to size of 1\");\n                DEFAULT_LOC_SIZE\n            }\n        };\n        let size = crate::utils::loc_size_to_u8(size as f32);\n\n        let horiz_pre: u32 = match result.name(\"hp\") {\n            Some(value) =\u003e match value.as_str().parse::\u003cu32\u003e() {\n                Ok(value) =\u003e value,\n                Err(_) =\u003e {\n                    log::warn!(\"Failed to parse {value:?} as horizontal precision, using default\");\n                    DEFAULT_LOC_HORIZ_PRE\n                }\n            },\n            None =\u003e {\n                log::trace!(\"Using horiz_pre default as it wasn't specified\");\n                DEFAULT_LOC_HORIZ_PRE\n            }\n        };\n        let horiz_pre = crate::utils::loc_size_to_u8(horiz_pre as f32);\n        let vert_pre: u32 = match result.name(\"vp\") {\n            Some(value) =\u003e match value.as_str().parse::\u003cu32\u003e() {\n                Ok(value) =\u003e value,\n                Err(_) =\u003e {\n                    log::warn!(\"Failed to parse {value:?} as vertical precision, using default\");\n                    DEFAULT_LOC_VERT_PRE\n                }\n            },\n\n            None =\u003e {\n                log::trace!(\"Using vert_pre default as it wasn't specified\");\n                DEFAULT_LOC_VERT_PRE\n            }\n        };\n        let vert_pre = crate::utils::loc_size_to_u8(vert_pre as f32);\n        Ok(FileLocRecord {\n            d1,\n            d2,\n            m1,\n            m2,\n            s1,\n            s2,\n            lat_dir,\n            lon_dir,\n            alt,\n            size,\n            horiz_pre,\n            vert_pre,\n        })\n    }\n}\n\n/// tests to ensure that no label in the name is longer than 63 octets (bytes)\npub fn check_long_labels(testval: \u0026str) -\u003e bool {\n    return testval.split('.').any(|x| x.len() \u003e 63);\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":2}},{"line":31,"address":[],"length":0,"stats":{"Line":2}},{"line":32,"address":[],"length":0,"stats":{"Line":2}},{"line":33,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":3}},{"line":40,"address":[],"length":0,"stats":{"Line":6}},{"line":41,"address":[],"length":0,"stats":{"Line":3}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":2}},{"line":115,"address":[],"length":0,"stats":{"Line":2}},{"line":120,"address":[],"length":0,"stats":{"Line":2}},{"line":121,"address":[],"length":0,"stats":{"Line":2}},{"line":122,"address":[],"length":0,"stats":{"Line":2}},{"line":123,"address":[],"length":0,"stats":{"Line":2}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":9}},{"line":289,"address":[],"length":0,"stats":{"Line":9}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":9}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":9}},{"line":299,"address":[],"length":0,"stats":{"Line":9}},{"line":300,"address":[],"length":0,"stats":{"Line":12}},{"line":301,"address":[],"length":0,"stats":{"Line":6}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":3}},{"line":318,"address":[],"length":0,"stats":{"Line":2}},{"line":319,"address":[],"length":0,"stats":{"Line":1}},{"line":320,"address":[],"length":0,"stats":{"Line":1}},{"line":321,"address":[],"length":0,"stats":{"Line":1}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":2}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":2}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":4}},{"line":349,"address":[],"length":0,"stats":{"Line":2}},{"line":350,"address":[],"length":0,"stats":{"Line":2}},{"line":352,"address":[],"length":0,"stats":{"Line":2}},{"line":353,"address":[],"length":0,"stats":{"Line":2}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":3}},{"line":510,"address":[],"length":0,"stats":{"Line":3}},{"line":511,"address":[],"length":0,"stats":{"Line":1}},{"line":512,"address":[],"length":0,"stats":{"Line":2}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":4}},{"line":535,"address":[],"length":0,"stats":{"Line":4}},{"line":536,"address":[],"length":0,"stats":{"Line":2}},{"line":537,"address":[],"length":0,"stats":{"Line":1}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":1}},{"line":574,"address":[],"length":0,"stats":{"Line":1}},{"line":575,"address":[],"length":0,"stats":{"Line":1}},{"line":576,"address":[],"length":0,"stats":{"Line":1}},{"line":577,"address":[],"length":0,"stats":{"Line":1}},{"line":578,"address":[],"length":0,"stats":{"Line":1}},{"line":579,"address":[],"length":0,"stats":{"Line":1}},{"line":580,"address":[],"length":0,"stats":{"Line":1}},{"line":581,"address":[],"length":0,"stats":{"Line":1}},{"line":582,"address":[],"length":0,"stats":{"Line":1}},{"line":583,"address":[],"length":0,"stats":{"Line":1}},{"line":584,"address":[],"length":0,"stats":{"Line":1}},{"line":585,"address":[],"length":0,"stats":{"Line":1}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":1}},{"line":588,"address":[],"length":0,"stats":{"Line":1}},{"line":589,"address":[],"length":0,"stats":{"Line":1}},{"line":590,"address":[],"length":0,"stats":{"Line":1}},{"line":591,"address":[],"length":0,"stats":{"Line":1}},{"line":592,"address":[],"length":0,"stats":{"Line":1}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":614,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":652,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":670,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":3}},{"line":675,"address":[],"length":0,"stats":{"Line":3}},{"line":676,"address":[],"length":0,"stats":{"Line":3}},{"line":677,"address":[],"length":0,"stats":{"Line":0}},{"line":678,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":681,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":685,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[],"length":0,"stats":{"Line":3}},{"line":701,"address":[],"length":0,"stats":{"Line":3}},{"line":703,"address":[],"length":0,"stats":{"Line":3}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[],"length":0,"stats":{"Line":0}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":722,"address":[],"length":0,"stats":{"Line":0}},{"line":732,"address":[],"length":0,"stats":{"Line":0}},{"line":733,"address":[],"length":0,"stats":{"Line":0}},{"line":734,"address":[],"length":0,"stats":{"Line":0}},{"line":735,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":737,"address":[],"length":0,"stats":{"Line":0}},{"line":738,"address":[],"length":0,"stats":{"Line":0}},{"line":739,"address":[],"length":0,"stats":{"Line":0}},{"line":740,"address":[],"length":0,"stats":{"Line":0}},{"line":753,"address":[],"length":0,"stats":{"Line":0}},{"line":754,"address":[],"length":0,"stats":{"Line":0}},{"line":755,"address":[],"length":0,"stats":{"Line":0}},{"line":756,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":758,"address":[],"length":0,"stats":{"Line":0}},{"line":768,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":778,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":780,"address":[],"length":0,"stats":{"Line":0}},{"line":781,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":803,"address":[],"length":0,"stats":{"Line":0}},{"line":804,"address":[],"length":0,"stats":{"Line":0}},{"line":805,"address":[],"length":0,"stats":{"Line":0}},{"line":806,"address":[],"length":0,"stats":{"Line":0}},{"line":807,"address":[],"length":0,"stats":{"Line":0}},{"line":815,"address":[],"length":0,"stats":{"Line":0}},{"line":816,"address":[],"length":0,"stats":{"Line":0}},{"line":817,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[],"length":0,"stats":{"Line":0}},{"line":831,"address":[],"length":0,"stats":{"Line":0}},{"line":832,"address":[],"length":0,"stats":{"Line":0}},{"line":833,"address":[],"length":0,"stats":{"Line":0}},{"line":834,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":845,"address":[],"length":0,"stats":{"Line":0}},{"line":846,"address":[],"length":0,"stats":{"Line":0}},{"line":952,"address":[],"length":0,"stats":{"Line":7}},{"line":960,"address":[],"length":0,"stats":{"Line":7}},{"line":961,"address":[],"length":0,"stats":{"Line":7}},{"line":962,"address":[],"length":0,"stats":{"Line":7}},{"line":971,"address":[],"length":0,"stats":{"Line":0}},{"line":972,"address":[],"length":0,"stats":{"Line":0}},{"line":973,"address":[],"length":0,"stats":{"Line":0}},{"line":974,"address":[],"length":0,"stats":{"Line":0}},{"line":975,"address":[],"length":0,"stats":{"Line":0}},{"line":976,"address":[],"length":0,"stats":{"Line":0}},{"line":977,"address":[],"length":0,"stats":{"Line":0}},{"line":978,"address":[],"length":0,"stats":{"Line":0}},{"line":979,"address":[],"length":0,"stats":{"Line":0}},{"line":980,"address":[],"length":0,"stats":{"Line":0}},{"line":981,"address":[],"length":0,"stats":{"Line":0}},{"line":982,"address":[],"length":0,"stats":{"Line":0}},{"line":983,"address":[],"length":0,"stats":{"Line":0}},{"line":984,"address":[],"length":0,"stats":{"Line":0}},{"line":992,"address":[],"length":0,"stats":{"Line":7}},{"line":998,"address":[],"length":0,"stats":{"Line":7}},{"line":1001,"address":[],"length":0,"stats":{"Line":0}},{"line":1002,"address":[],"length":0,"stats":{"Line":0}},{"line":1006,"address":[],"length":0,"stats":{"Line":0}},{"line":1008,"address":[],"length":0,"stats":{"Line":14}},{"line":1009,"address":[],"length":0,"stats":{"Line":7}},{"line":1010,"address":[],"length":0,"stats":{"Line":7}},{"line":1011,"address":[],"length":0,"stats":{"Line":0}},{"line":1012,"address":[],"length":0,"stats":{"Line":0}},{"line":1013,"address":[],"length":0,"stats":{"Line":0}},{"line":1016,"address":[],"length":0,"stats":{"Line":0}},{"line":1018,"address":[],"length":0,"stats":{"Line":7}},{"line":1019,"address":[],"length":0,"stats":{"Line":7}},{"line":1020,"address":[],"length":0,"stats":{"Line":7}},{"line":1021,"address":[],"length":0,"stats":{"Line":0}},{"line":1022,"address":[],"length":0,"stats":{"Line":0}},{"line":1023,"address":[],"length":0,"stats":{"Line":0}},{"line":1026,"address":[],"length":0,"stats":{"Line":0}},{"line":1029,"address":[],"length":0,"stats":{"Line":7}},{"line":1030,"address":[],"length":0,"stats":{"Line":6}},{"line":1031,"address":[],"length":0,"stats":{"Line":6}},{"line":1032,"address":[],"length":0,"stats":{"Line":0}},{"line":1033,"address":[],"length":0,"stats":{"Line":0}},{"line":1034,"address":[],"length":0,"stats":{"Line":0}},{"line":1037,"address":[],"length":0,"stats":{"Line":1}},{"line":1039,"address":[],"length":0,"stats":{"Line":7}},{"line":1040,"address":[],"length":0,"stats":{"Line":6}},{"line":1041,"address":[],"length":0,"stats":{"Line":6}},{"line":1042,"address":[],"length":0,"stats":{"Line":0}},{"line":1043,"address":[],"length":0,"stats":{"Line":0}},{"line":1044,"address":[],"length":0,"stats":{"Line":0}},{"line":1047,"address":[],"length":0,"stats":{"Line":1}},{"line":1049,"address":[],"length":0,"stats":{"Line":7}},{"line":1050,"address":[],"length":0,"stats":{"Line":6}},{"line":1051,"address":[],"length":0,"stats":{"Line":6}},{"line":1052,"address":[],"length":0,"stats":{"Line":6}},{"line":1053,"address":[],"length":0,"stats":{"Line":6}},{"line":1055,"address":[],"length":0,"stats":{"Line":0}},{"line":1056,"address":[],"length":0,"stats":{"Line":0}},{"line":1057,"address":[],"length":0,"stats":{"Line":0}},{"line":1060,"address":[],"length":0,"stats":{"Line":1}},{"line":1062,"address":[],"length":0,"stats":{"Line":7}},{"line":1063,"address":[],"length":0,"stats":{"Line":6}},{"line":1064,"address":[],"length":0,"stats":{"Line":6}},{"line":1065,"address":[],"length":0,"stats":{"Line":0}},{"line":1066,"address":[],"length":0,"stats":{"Line":0}},{"line":1067,"address":[],"length":0,"stats":{"Line":0}},{"line":1070,"address":[],"length":0,"stats":{"Line":1}},{"line":1072,"address":[],"length":0,"stats":{"Line":7}},{"line":1075,"address":[],"length":0,"stats":{"Line":0}},{"line":1076,"address":[],"length":0,"stats":{"Line":0}},{"line":1081,"address":[],"length":0,"stats":{"Line":7}},{"line":1084,"address":[],"length":0,"stats":{"Line":0}},{"line":1085,"address":[],"length":0,"stats":{"Line":0}},{"line":1090,"address":[],"length":0,"stats":{"Line":7}},{"line":1091,"address":[],"length":0,"stats":{"Line":7}},{"line":1093,"address":[],"length":0,"stats":{"Line":0}},{"line":1094,"address":[],"length":0,"stats":{"Line":0}},{"line":1095,"address":[],"length":0,"stats":{"Line":0}},{"line":1099,"address":[],"length":0,"stats":{"Line":0}},{"line":1106,"address":[],"length":0,"stats":{"Line":7}},{"line":1107,"address":[],"length":0,"stats":{"Line":4}},{"line":1108,"address":[],"length":0,"stats":{"Line":4}},{"line":1109,"address":[],"length":0,"stats":{"Line":4}},{"line":1110,"address":[],"length":0,"stats":{"Line":4}},{"line":1112,"address":[],"length":0,"stats":{"Line":0}},{"line":1113,"address":[],"length":0,"stats":{"Line":0}},{"line":1114,"address":[],"length":0,"stats":{"Line":0}},{"line":1119,"address":[],"length":0,"stats":{"Line":3}},{"line":1120,"address":[],"length":0,"stats":{"Line":3}},{"line":1125,"address":[],"length":0,"stats":{"Line":7}},{"line":1126,"address":[],"length":0,"stats":{"Line":2}},{"line":1127,"address":[],"length":0,"stats":{"Line":2}},{"line":1129,"address":[],"length":0,"stats":{"Line":0}},{"line":1130,"address":[],"length":0,"stats":{"Line":0}},{"line":1134,"address":[],"length":0,"stats":{"Line":5}},{"line":1135,"address":[],"length":0,"stats":{"Line":5}},{"line":1139,"address":[],"length":0,"stats":{"Line":7}},{"line":1140,"address":[],"length":0,"stats":{"Line":1}},{"line":1141,"address":[],"length":0,"stats":{"Line":1}},{"line":1143,"address":[],"length":0,"stats":{"Line":0}},{"line":1144,"address":[],"length":0,"stats":{"Line":0}},{"line":1149,"address":[],"length":0,"stats":{"Line":6}},{"line":1150,"address":[],"length":0,"stats":{"Line":6}},{"line":1172,"address":[],"length":0,"stats":{"Line":12}},{"line":1173,"address":[],"length":0,"stats":{"Line":55}}],"covered":118,"coverable":442},{"path":["/","Users","yaleman","Projects","goatns","src","serializers.rs"],"content":"use serde::{de, Serializer};\nuse tracing::error;\n\nuse std::net::{IpAddr, Ipv6Addr};\n\nuse crate::enums::ContactDetails;\n\n/// Convert a u32 to a string representation of an ipv4 address\npub fn a_to_ip\u003cS\u003e(address: \u0026u32, s: S) -\u003e Result\u003cS::Ok, S::Error\u003e\nwhere\n    S: Serializer,\n{\n    let addr_bytes = address.to_be_bytes();\n    let addr = IpAddr::from(addr_bytes);\n    s.serialize_str(\u0026addr.to_string())\n}\n\n/// Convert a u128 to a string representation of an ipv6 address\npub fn aaaa_to_ip\u003cS\u003e(address: \u0026u128, s: S) -\u003e Result\u003cS::Ok, S::Error\u003e\nwhere\n    S: Serializer,\n{\n    let addr_bytes = address.to_be_bytes();\n    let addr = Ipv6Addr::from(addr_bytes);\n    s.serialize_str(\u0026addr.to_string())\n}\n\n/// Used for parsing the config file into a ContactDetails Object\nimpl\u003c'de\u003e de::Deserialize\u003c'de\u003e for ContactDetails {\n    fn deserialize\u003cD\u003e(deserializer: D) -\u003e Result\u003cSelf, D::Error\u003e\n    where\n        D: de::Deserializer\u003c'de\u003e,\n    {\n        let s: String = de::Deserialize::deserialize(deserializer)?;\n        let res = ContactDetails::try_from(s.clone());\n        log::trace!(\"deser input='{}' result='{:?}'\", s, res);\n        match res {\n            Ok(val) =\u003e Ok(val),\n            Err(err) =\u003e match err {\n                crate::enums::ContactDetailsDeserializerError::InputLengthWrong { msg, len } =\u003e {\n                    Err(de::Error::invalid_length(len, \u0026msg))\n                }\n                crate::enums::ContactDetailsDeserializerError::InputFormatWrong { unexp, exp } =\u003e {\n                    Err(de::Error::invalid_value(de::Unexpected::Str(\u0026unexp), \u0026exp))\n                }\n                crate::enums::ContactDetailsDeserializerError::WrongContactType(msg) =\u003e {\n                    error!(\"WrongContactType: '{}'\", msg);\n                    Err(de::Error::invalid_value(\n                        de::Unexpected::Str(\u0026msg),\n                        \u0026\"Mastodon, Email, Twitter or None\",\n                    ))\n                }\n            },\n        }\n    }\n}\n\nimpl serde::Serialize for ContactDetails {\n    fn serialize\u003cS\u003e(\u0026self, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        let string_repr = match self {\n            ContactDetails::Mastodon { contact, server } =\u003e format!(\"Mastodon:{contact}@{server}\",),\n            ContactDetails::Email { contact } =\u003e format!(\"Email:{contact}\",),\n            ContactDetails::Twitter { contact } =\u003e format!(\"Twitter:{contact}\",),\n            ContactDetails::None =\u003e \"\".to_string(),\n        };\n        serializer.serialize_str(\u0026string_repr)\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":2}},{"line":34,"address":[],"length":0,"stats":{"Line":4}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":2}},{"line":38,"address":[],"length":0,"stats":{"Line":1}},{"line":39,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":1}},{"line":41,"address":[],"length":0,"stats":{"Line":1}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}}],"covered":7,"coverable":31},{"path":["/","Users","yaleman","Projects","goatns","src","servers.rs"],"content":"use concread::cowcell::asynch::CowCellReadTxn;\nuse packed_struct::prelude::*;\nuse std::io::Error;\nuse std::net::SocketAddr;\nuse std::str::from_utf8;\nuse std::time::Duration;\nuse tokio::io::{self, AsyncReadExt};\nuse tokio::net::{TcpListener, TcpStream, UdpSocket};\nuse tokio::sync::{broadcast, mpsc, oneshot};\nuse tokio::task::JoinHandle;\nuse tokio::time::timeout;\nuse tracing::{error, field, instrument};\n\nuse crate::config::ConfigFile;\nuse crate::datastore::Command;\nuse crate::enums::{Agent, AgentState, PacketType, Rcode, RecordClass, RecordType};\nuse crate::error::GoatNsError;\nuse crate::reply::{reply_any, reply_builder, reply_nxdomain, Reply};\nuse crate::resourcerecord::{DNSCharString, InternalResourceRecord};\nuse crate::zones::ZoneRecord;\nuse crate::{Header, OpCode, Question, HEADER_BYTES, REPLY_TIMEOUT_MS, UDP_BUFFER_SIZE};\n\npub(crate) enum ChaosResult {\n    Refused(Reply),\n    Shutdown(Reply),\n}\n\n/// this handles a shutdown CHAOS request\nasync fn check_for_shutdown(r: \u0026Reply, allowed_shutdown: bool) -\u003e Result\u003cChaosResult, GoatNsError\u003e {\n    // when you get a CHAOS from localhost with \"shutdown\" break dat loop\n    if let Some(q) = \u0026r.question {\n        if q.qclass == RecordClass::Chaos {\n            let qname = from_utf8(\u0026q.qname).inspect_err(|e| {\n                log::error!(\n                    \"Failed to parse qname from {:?}, this shouldn't be able to happen! {e:?}\",\n                    q.qname\n                );\n            })?;\n            // Just don't do this on UDP, because we can't really tell who it's coming from.\n            if qname == \"shutdown\" {\n                // when we get a request, we update the response to say if we're going to do it or not\n                match allowed_shutdown {\n                    true =\u003e {\n                        log::info!(\"Got CHAOS shutdown, shutting down\");\n                        let mut chaos_reply = r.clone();\n                        chaos_reply.answers.push(CHAOS_OK.clone());\n                        return Ok(ChaosResult::Shutdown(chaos_reply));\n                    }\n                    false =\u003e {\n                        // get lost!  \n                        log::warn!(\"Got CHAOS shutdown, ignoring!\");\n                        let mut chaos_reply = r.clone();\n                        chaos_reply.answers.push(CHAOS_NO.clone());\n                        chaos_reply.header.rcode = Rcode::Refused;\n                        return Ok(ChaosResult::Refused(chaos_reply));\n                    }\n                };\n            }\n        }\n    };\n\n    let mut chaos_reply = r.clone();\n    chaos_reply.answers.push(CHAOS_NO.clone());\n    chaos_reply.header.rcode = Rcode::Refused;\n    Ok(ChaosResult::Refused(chaos_reply))\n}\n\n/// this handles a version CHAOS request\n// async fn check_for_version(r: \u0026Reply, addr: \u0026SocketAddr, config: \u0026ConfigFile) -\u003e Result\u003c(), ()\u003e {\n//     // when you get a CHAOS from localhost with \"VERSION\" or \"VERSION.BIND\" we might respond\n//     if let Some(q) = \u0026r.question {\n//         if q.qclass == RecordClass::Chaos {\n//             if let Ok(qname) = from_utf8(\u0026q.qname) {\n//                 if VERSION_STRINGS.contains(\u0026qname.to_ascii_lowercase()) \u0026 (config.ip_allow_lists.shutdown.contains(\u0026addr.ip())) {\n//                     info!(\"Got CHAOS VERSION from {:?}, responding.\", addr.ip());\n//                     return Ok(());\n//                 } else {\n//                     warn!(\"Got CHAOS VERSION from {:?}, ignoring!\", addr.ip());\n//                 }\n//             } else {\n//                 error!(\"Failed to parse qname from {:?}, this shouldn't be able to happen!\", q.qname);\n//             }\n//         }\n//     };\n//     Err(())\n// }\n\npub async fn udp_server(\n    config: CowCellReadTxn\u003cConfigFile\u003e,\n    datastore_sender: mpsc::Sender\u003ccrate::datastore::Command\u003e,\n    _agent_tx: broadcast::Sender\u003cAgentState\u003e,\n) -\u003e io::Result\u003c()\u003e {\n    let udp_sock = match UdpSocket::bind(config.dns_listener_address().map_err(|_err| {\n        GoatNsError::StartupError(\"Failed to get DNS listener address on startup!\".to_string())\n    })?)\n    .await\n    {\n        Ok(value) =\u003e {\n            log::info!(\"Started UDP listener on {}:{}\", config.address, config.port);\n            value\n        }\n        Err(error) =\u003e {\n            log::error!(\"Failed to start UDP listener: {:?}\", error);\n            return Ok(());\n        }\n    };\n\n    // TODO: this needs to be bigger to handle edns0-negotiated queries\n    let mut udp_buffer = [0; UDP_BUFFER_SIZE];\n\n    loop {\n        let (len, addr) = match udp_sock.recv_from(\u0026mut udp_buffer).await {\n            Ok(value) =\u003e value,\n            Err(error) =\u003e {\n                log::error!(\"Error accepting connection via UDP: {:?}\", error);\n                continue;\n            }\n        };\n\n        log::debug!(\"{:?} bytes received from {:?}\", len, addr);\n\n        let udp_result = match timeout(\n            Duration::from_millis(REPLY_TIMEOUT_MS),\n            parse_query(\n                datastore_sender.clone(),\n                len,\n                \u0026udp_buffer,\n                config.capture_packets,\n                QueryProtocol::Udp,\n            ),\n        )\n        .await\n        {\n            Ok(reply) =\u003e reply,\n            Err(_) =\u003e {\n                log::error!(\"Did not receive response from parse_query within 10 ms\");\n                continue;\n            }\n        };\n\n        match udp_result {\n            Ok(mut r) =\u003e {\n                log::debug!(\"Result: {:?}\", r);\n\n                let reply_bytes: Vec\u003cu8\u003e = match r.as_bytes().await {\n                    Ok(value) =\u003e {\n                        // Check if it's too long and set truncate flag if so, it's safe to unwrap since we've already gone\n                        if value.len() \u003e UDP_BUFFER_SIZE {\n                            let mut response_bytes = value.to_vec();\n                            response_bytes.truncate(UDP_BUFFER_SIZE);\n                            r = r.check_set_truncated().await;\n                            let r = r.as_bytes_udp().await;\n                            r.unwrap_or(value)\n                        } else {\n                            value\n                        }\n                    }\n                    Err(error) =\u003e {\n                        log::error!(\"Failed to parse reply {:?} into bytes: {:?}\", r, error);\n                        continue;\n                    }\n                };\n\n                log::trace!(\"reply_bytes: {:?}\", reply_bytes);\n                let len = match udp_sock.send_to(\u0026reply_bytes as \u0026[u8], addr).await {\n                    Ok(value) =\u003e value,\n                    Err(err) =\u003e {\n                        log::error!(\"Failed to send data back to {:?}: {:?}\", addr, err);\n                        return Ok(());\n                    }\n                };\n                // let len = sock.send_to(r.answer.as_bytes(), addr).await?;\n                log::trace!(\"{:?} bytes sent\", len);\n            }\n            Err(error) =\u003e log::error!(\"Error: {}\", error),\n        }\n    }\n}\n\n#[instrument(level = \"info\", skip_all)]\npub async fn tcp_conn_handler(\n    stream: \u0026mut TcpStream,\n    addr: SocketAddr,\n    datastore_sender: mpsc::Sender\u003cCommand\u003e,\n    agent_tx: broadcast::Sender\u003cAgentState\u003e,\n    capture_packets: bool,\n    allowed_shutdown: bool,\n) -\u003e io::Result\u003c()\u003e {\n    let (mut reader, writer) = stream.split();\n    let msg_length: usize = reader.read_u16().await?.into();\n    log::debug!(\"msg_length={msg_length}\");\n    let mut buf: Vec\u003cu8\u003e = vec![];\n\n    while buf.len() \u003c msg_length {\n        let len = match reader.read_buf(\u0026mut buf).await {\n            Ok(size) =\u003e size,\n            Err(error) =\u003e {\n                log::error!(\"Failed to read from TCP Stream: {:?}\", error);\n                return Ok(());\n            }\n        };\n        if len \u003e 0 {\n            log::debug!(\"Read {:?} bytes from TCP stream\", len);\n        }\n    }\n    // TODO: why are we hexdumping this?\n    if let Err(err) = crate::utils::hexdump(\u0026buf) {\n        log::error!(\"Failed to hexdump buffer: {:?}\", err);\n    };\n    // the first two bytes of a tcp query is the message length\n    // ref \u003chttps://www.rfc-editor.org/rfc/rfc7766#section-8\u003e\n\n    // check the message is long enough\n    if buf.len() \u003c msg_length {\n        log::warn!(\n            \"Message length too short {}, wanted {}\",\n            buf.len(),\n            msg_length + 2\n        );\n    } else {\n        log::info!(\"TCP Message length ftw!\");\n    }\n\n    // skip the TCP length header because rad\n    let buf = \u0026buf[0..msg_length];\n    let result = match timeout(\n        Duration::from_millis(REPLY_TIMEOUT_MS),\n        parse_query(\n            datastore_sender.clone(),\n            msg_length,\n            buf,\n            capture_packets,\n            QueryProtocol::Tcp,\n        ),\n    )\n    .await\n    {\n        Ok(reply) =\u003e reply,\n        Err(_) =\u003e {\n            log::error!(\"Did not receive response from parse_query within {REPLY_TIMEOUT_MS} ms\");\n            return Ok(());\n        }\n    };\n\n    match result {\n        Ok(r) =\u003e {\n            log::debug!(\"TCP Result: {r:?}\");\n\n            // when you get a CHAOS from the allow-list with \"shutdown\" it's quitting time\n            let r = match check_for_shutdown(\u0026r, allowed_shutdown).await {\n                // no change here\n                Err(err) =\u003e {\n                    log::error!(\"Failed to check for shutdown: {:?}\", err);\n                    return Ok(());\n                }\n                Ok(reply) =\u003e match reply {\n                    ChaosResult::Refused(response) =\u003e response,\n                    ChaosResult::Shutdown(response) =\u003e {\n                        if let Err(error) = agent_tx.send(AgentState::Stopped {\n                            agent: Agent::TCPServer,\n                        }) {\n                            eprintln!(\"Failed to send UDPServer shutdown message: {error:?}\");\n                        };\n                        if let Err(error) = datastore_sender.send(Command::Shutdown).await {\n                            eprintln!(\"Failed to send shutdown command to datastore.. {error:?}\");\n                        };\n                        response\n                    }\n                },\n            };\n\n            let reply_bytes: Vec\u003cu8\u003e = match r.as_bytes().await {\n                Ok(value) =\u003e value,\n                Err(error) =\u003e {\n                    log::error!(\"Failed to parse reply {:?} into bytes: {:?}\", r, error);\n                    return Ok(());\n                }\n            };\n\n            log::trace!(\"reply_bytes: {:?}\", reply_bytes);\n\n            let reply_bytes = \u0026reply_bytes as \u0026[u8];\n            // send the outgoing message length\n            let response_length: u16 = reply_bytes.len() as u16;\n            let len = match writer.try_write(\u0026response_length.to_be_bytes()) {\n                Ok(value) =\u003e value,\n                Err(err) =\u003e {\n                    log::error!(\"Failed to send data back to {:?}: {:?}\", addr, err);\n                    return Ok(());\n                }\n            };\n            log::trace!(\"{:?} bytes sent\", len);\n\n            // send the data\n            let len = match writer.try_write(reply_bytes) {\n                Ok(value) =\u003e value,\n                Err(err) =\u003e {\n                    log::error!(\"Failed to send data back to {:?}: {:?}\", addr, err);\n                    return Ok(());\n                }\n            };\n            log::trace!(\"{:?} bytes sent\", len);\n        }\n        Err(error) =\u003e log::error!(\"Error: {}\", error),\n    }\n    Ok(())\n}\n\n/// main handler for the TCP side of things\n///\n/// Ref \u003chttps://www.rfc-editor.org/rfc/rfc7766\u003e\npub async fn tcp_server(\n    config: CowCellReadTxn\u003cConfigFile\u003e,\n    tx: mpsc::Sender\u003ccrate::datastore::Command\u003e,\n    agent_tx: broadcast::Sender\u003cAgentState\u003e,\n    // mut agent_rx: broadcast::Receiver\u003cAgentState\u003e,\n) -\u003e io::Result\u003c()\u003e {\n    let mut agent_rx = agent_tx.subscribe();\n    let tcpserver = match TcpListener::bind(config.dns_listener_address().map_err(|_err| {\n        GoatNsError::StartupError(\"Failed to get DNS listener address on startup!\".to_string())\n    })?)\n    .await\n    {\n        Ok(value) =\u003e {\n            log::info!(\n                \"Started TCP listener on {}\",\n                config\n                    .dns_listener_address()\n                    .map_err(|_err| GoatNsError::StartupError(\n                        \"Failed to get DNS listener address on startup!\".to_string()\n                    ))?\n            );\n            value\n        }\n        Err(error) =\u003e {\n            log::error!(\"Failed to start TCP Server: {:?}\", error);\n            return Ok(());\n        }\n    };\n\n    let tcp_client_timeout = config.tcp_client_timeout;\n    let shutdown_ip_address_list = config.ip_allow_lists.shutdown.to_vec();\n    let capture_packets = config.capture_packets;\n    loop {\n        let (mut stream, addr) = match tcpserver.accept().await {\n            Ok(value) =\u003e value,\n            Err(err) =\u003e {\n                error!(\"Couldn't get data from TcpStream: {:?}\", err);\n                continue;\n            }\n        };\n\n        let allowed_shutdown = shutdown_ip_address_list.contains(\u0026addr.ip());\n        log::debug!(\"TCP connection from {:?}\", addr);\n        let loop_tx = tx.clone();\n        let loop_agent_tx = agent_tx.clone();\n        tokio::spawn(async move {\n            if timeout(\n                Duration::from_secs(tcp_client_timeout),\n                tcp_conn_handler(\n                    \u0026mut stream,\n                    addr,\n                    loop_tx,\n                    loop_agent_tx,\n                    capture_packets,\n                    allowed_shutdown,\n                ),\n            )\n            .await\n            .is_err()\n            {\n                log::warn!(\n                    \"TCP Connection from {addr:?} terminated after {} seconds.\",\n                    tcp_client_timeout\n                );\n            }\n        })\n        .await?;\n\n        if let Ok(agent_state) = agent_rx.try_recv() {\n            log::info!(\"Got agent state: {:?}\", agent_state);\n        };\n    }\n}\n\npub(crate) enum QueryProtocol {\n    Udp,\n    Tcp,\n    DoH,\n}\n\nimpl std::fmt::Display for QueryProtocol {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            QueryProtocol::Udp =\u003e write!(f, \"UDP\"),\n            QueryProtocol::Tcp =\u003e write!(f, \"TCP\"),\n            QueryProtocol::DoH =\u003e write!(f, \"DoH\"),\n        }\n    }\n}\n\n/// Parses the rest of the packets once we have stripped the header off.\n#[instrument(level = \"info\", skip_all, fields(protocol=protocol.to_string()))]\npub async fn parse_query(\n    datastore: tokio::sync::mpsc::Sender\u003ccrate::datastore::Command\u003e,\n    len: usize,\n    buf: \u0026[u8],\n    capture_packets: bool,\n    protocol: QueryProtocol,\n) -\u003e Result\u003cReply, String\u003e {\n    if capture_packets {\n        crate::packet_dumper::dump_bytes(\n            buf[0..len].into(),\n            crate::packet_dumper::DumpType::ClientRequest,\n        )\n        .await;\n    }\n    // we only want the first 12 bytes for the header\n    let mut split_header: [u8; HEADER_BYTES] = [0; HEADER_BYTES];\n    split_header.copy_from_slice(\u0026buf[0..HEADER_BYTES]);\n    // unpack the header for great justice\n    let header = match crate::Header::unpack(\u0026split_header) {\n        Ok(value) =\u003e value,\n        Err(error) =\u003e {\n            // can't return a servfail if we can't unpack the header, they're probably doing something bad.\n            return Err(format!(\"Failed to parse header: {:?}\", error));\n        }\n    };\n    log::trace!(\"Buffer length: {}\", len);\n    log::trace!(\"Parsed header: {:?}\", header);\n    get_result(header, len, buf, datastore).await\n}\n\nlazy_static! {\n    static ref CHAOS_OK: InternalResourceRecord = InternalResourceRecord::TXT {\n        txtdata: DNSCharString::from(\"OK\"),\n        ttl: 0,\n        class: RecordClass::Chaos,\n    };\n    static ref CHAOS_NO: InternalResourceRecord = InternalResourceRecord::TXT {\n        txtdata: DNSCharString::from(\"NO\"),\n        ttl: 0,\n        class: RecordClass::Chaos,\n    };\n}\n\n/// The generic handler for the packets once they've been pulled out of their protocol handlers. TCP has a slightly different stream format to UDP, y'know?\n#[instrument(level=\"info\", skip_all, fields(qname=field::Empty, qtype=field::Empty))]\nasync fn get_result(\n    header: Header,\n    len: usize,\n    buf: \u0026[u8],\n    datastore: mpsc::Sender\u003ccrate::datastore::Command\u003e,\n) -\u003e Result\u003cReply, String\u003e {\n    log::trace!(\"called get_result(header={header}, len={len})\");\n\n    // if we get something other than a query, yeah nah.\n    if header.opcode != OpCode::Query {\n        return Err(format!(\"Invalid OPCODE, got {:?}\", header.opcode));\n    };\n\n    let question = match Question::from_packets(\u0026buf[HEADER_BYTES..len]) {\n        Ok(value) =\u003e {\n            log::trace!(\"Parsed question: {:?}\", value);\n\n            value\n        }\n        Err(error) =\u003e {\n            log::debug!(\"Failed to parse question: {} id={}\", error, header.id);\n            return reply_builder(header.id, Rcode::ServFail);\n        }\n    };\n\n    // record the details of the query\n    let span = tracing::Span::current();\n    if !span.is_disabled() {\n        let qname_string = from_utf8(\u0026question.qname).unwrap_or(\"\u003cunable to parse\u003e\");\n        span.record(\"qname\", qname_string);\n        span.record(\"qtype\", question.qtype.to_string());\n    }\n\n    // yeet them when we get a request we can't handle\n    if !question.qtype.supported() {\n        log::debug!(\n            \"Unsupported request: {} {:?}, returning NotImplemented\",\n            from_utf8(\u0026question.qname).unwrap_or(\"\u003cunable to parse\u003e\"),\n            question.qtype,\n        );\n        return reply_builder(header.id, Rcode::NotImplemented);\n    }\n\n    // Check for CHAOS commands\n    #[allow(clippy::collapsible_if)]\n    if question.qclass == RecordClass::Chaos {\n        if \u0026question.normalized_name()? == \"shutdown\" {\n            log::debug!(\"Got CHAOS shutdown!\");\n            return Ok(Reply {\n                header,\n                question: Some(question),\n                answers: vec![],\n                authorities: vec![],\n                additional: vec![],\n            });\n        }\n    }\n\n    if let RecordType::ANY {} = question.qtype {\n        // TODO this should check to see if we have a zone record, but that requires walking down the qname record recursively, which is its own thing. We just YOLO a HINFO back for any request now.\n        return reply_any(header.id, \u0026question);\n    };\n\n    // build the request to the datastore to make the query\n    let (tx_oneshot, rx_oneshot) = oneshot::channel();\n    let ds_req: Command = Command::GetRecord {\n        name: question.qname.clone(),\n        rrtype: question.qtype,\n        rclass: question.qclass,\n        resp: tx_oneshot,\n    };\n\n    // here we talk to the datastore to pull the result\n    match datastore.send(ds_req).await {\n        Ok(_) =\u003e log::trace!(\"Sent a request to the datastore!\"),\n        // TODO: handle errors sending to the DS properly\n        Err(error) =\u003e log::error!(\"Error sending to datastore: {:?}\", error),\n    };\n\n    let record: ZoneRecord = match rx_oneshot.await {\n        Ok(value) =\u003e match value {\n            Some(zr) =\u003e {\n                log::debug!(\"DS Response: {}\", zr);\n                zr\n            }\n            None =\u003e {\n                log::debug!(\"No response from datastore\");\n                return reply_nxdomain(header.id);\n            }\n        },\n        Err(error) =\u003e {\n            log::error!(\"Failed to get response from datastore: {:?}\", error);\n            return reply_builder(header.id, Rcode::ServFail);\n        }\n    };\n\n    // this is our reply - static until that bit's done\n    Ok(Reply {\n        header: Header {\n            id: header.id,\n            qr: PacketType::Answer,\n            opcode: header.opcode,\n            authoritative: true,\n            truncated: false, // TODO: work out if it's truncated (ie, UDP)\n            recursion_desired: header.recursion_desired,\n            recursion_available: header.recursion_available, // TODO: work this out\n            z: false,\n            ad: true, // TODO: decide how the ad flag should be set -  \"authentic data\" - This requests the server to return whether all of the answer and\n            // authority sections have all been validated as secure according to the security policy of the server. AD=1 indicates that all\n            // records have been validated as secure and the answer is not from a OPT-OUT range. AD=0 indicate that some part of the answer\n            // was insecure or not validated. This bit is set by default.\n            cd: false, // TODO: figure this out -  CD (checking disabled) bit in the query. This requests the server to not perform DNSSEC validation of responses.\n            rcode: Rcode::NoError,\n            qdcount: 1,\n            ancount: record.typerecords.len() as u16,\n            nscount: 0,\n            arcount: 0,\n        },\n        question: Some(question),\n        answers: record.typerecords,\n        authorities: vec![], // TODO: we're authoritative, we should respond with our records!\n        additional: vec![],\n    })\n}\n\n#[derive(Debug)]\npub struct Servers {\n    pub datastore: Option\u003cJoinHandle\u003cResult\u003c(), String\u003e\u003e\u003e,\n    pub udpserver: Option\u003cJoinHandle\u003cResult\u003c(), Error\u003e\u003e\u003e,\n    pub tcpserver: Option\u003cJoinHandle\u003cResult\u003c(), Error\u003e\u003e\u003e,\n    pub apiserver: Option\u003cJoinHandle\u003cResult\u003c(), Error\u003e\u003e\u003e,\n    pub agent_tx: broadcast::Sender\u003cAgentState\u003e,\n}\n\nimpl Default for Servers {\n    fn default() -\u003e Self {\n        let (agent_tx, _) = broadcast::channel(10000);\n        Self {\n            datastore: None,\n            udpserver: None,\n            tcpserver: None,\n            apiserver: None,\n            agent_tx,\n        }\n    }\n}\n\nimpl Servers {\n    pub fn build(agent_tx: broadcast::Sender\u003cAgentState\u003e) -\u003e Self {\n        Self {\n            agent_tx,\n            ..Default::default()\n        }\n    }\n    pub fn with_apiserver(self, apiserver: JoinHandle\u003cResult\u003c(), Error\u003e\u003e) -\u003e Self {\n        Self {\n            apiserver: Some(apiserver),\n            ..self\n        }\n    }\n    pub fn with_datastore(self, datastore: JoinHandle\u003cResult\u003c(), String\u003e\u003e) -\u003e Self {\n        Self {\n            datastore: Some(datastore),\n            ..self\n        }\n    }\n    pub fn with_tcpserver(self, tcpserver: JoinHandle\u003cResult\u003c(), Error\u003e\u003e) -\u003e Self {\n        Self {\n            tcpserver: Some(tcpserver),\n            ..self\n        }\n    }\n    pub fn with_udpserver(self, udpserver: JoinHandle\u003cResult\u003c(), Error\u003e\u003e) -\u003e Self {\n        Self {\n            udpserver: Some(udpserver),\n            ..self\n        }\n    }\n\n    fn send_shutdown(\u0026self, agent: Agent) {\n        log::info!(\"{agent:?} shut down\");\n        if let Err(error) = self.agent_tx.send(AgentState::Stopped { agent }) {\n            eprintln!(\"Failed to send agent shutdown message: {error:?}\");\n        };\n    }\n\n    pub fn all_finished(\u0026self) -\u003e bool {\n        let mut results = vec![];\n        if let Some(server) = \u0026self.apiserver {\n            if server.is_finished() {\n                println!(\"Sending API Shutdown\");\n                self.send_shutdown(Agent::API);\n            }\n            results.push(server.is_finished())\n        }\n        if let Some(server) = \u0026self.datastore {\n            if server.is_finished() {\n                println!(\"Sending Datastore Shutdown\");\n                self.send_shutdown(Agent::Datastore);\n            }\n            results.push(server.is_finished())\n        }\n        if let Some(server) = \u0026self.tcpserver {\n            if server.is_finished() {\n                println!(\"Sending TCP Server Shutdown\");\n                self.send_shutdown(Agent::TCPServer);\n            }\n            results.push(server.is_finished())\n        }\n        if let Some(server) = \u0026self.udpserver {\n            if server.is_finished() {\n                println!(\"Sending UDP Server Shutdown\");\n                self.send_shutdown(Agent::UDPServer);\n            }\n            results.push(server.is_finished())\n        }\n        results.iter().any(|\u0026r| r)\n    }\n}\n","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":10}},{"line":93,"address":[],"length":0,"stats":{"Line":20}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":10}},{"line":99,"address":[],"length":0,"stats":{"Line":10}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":16}},{"line":113,"address":[],"length":0,"stats":{"Line":2}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":2}},{"line":122,"address":[],"length":0,"stats":{"Line":4}},{"line":123,"address":[],"length":0,"stats":{"Line":2}},{"line":124,"address":[],"length":0,"stats":{"Line":2}},{"line":125,"address":[],"length":0,"stats":{"Line":2}},{"line":126,"address":[],"length":0,"stats":{"Line":2}},{"line":127,"address":[],"length":0,"stats":{"Line":2}},{"line":128,"address":[],"length":0,"stats":{"Line":2}},{"line":129,"address":[],"length":0,"stats":{"Line":2}},{"line":132,"address":[],"length":0,"stats":{"Line":2}},{"line":134,"address":[],"length":0,"stats":{"Line":2}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":2}},{"line":142,"address":[],"length":0,"stats":{"Line":2}},{"line":143,"address":[],"length":0,"stats":{"Line":2}},{"line":145,"address":[],"length":0,"stats":{"Line":4}},{"line":146,"address":[],"length":0,"stats":{"Line":2}},{"line":148,"address":[],"length":0,"stats":{"Line":2}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":2}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":4}},{"line":166,"address":[],"length":0,"stats":{"Line":2}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":2}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":9}},{"line":318,"address":[],"length":0,"stats":{"Line":9}},{"line":319,"address":[],"length":0,"stats":{"Line":18}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":9}},{"line":325,"address":[],"length":0,"stats":{"Line":9}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":9}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":2}},{"line":394,"address":[],"length":0,"stats":{"Line":2}},{"line":395,"address":[],"length":0,"stats":{"Line":2}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":10}},{"line":585,"address":[],"length":0,"stats":{"Line":10}},{"line":597,"address":[],"length":0,"stats":{"Line":10}},{"line":603,"address":[],"length":0,"stats":{"Line":10}},{"line":605,"address":[],"length":0,"stats":{"Line":10}},{"line":609,"address":[],"length":0,"stats":{"Line":10}},{"line":611,"address":[],"length":0,"stats":{"Line":10}},{"line":615,"address":[],"length":0,"stats":{"Line":9}},{"line":617,"address":[],"length":0,"stats":{"Line":9}},{"line":621,"address":[],"length":0,"stats":{"Line":10}},{"line":623,"address":[],"length":0,"stats":{"Line":10}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":652,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}}],"covered":47,"coverable":157},{"path":["/","Users","yaleman","Projects","goatns","src","tests","config.rs"],"content":"\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","tests","db.rs"],"content":"use chrono::{TimeDelta, Utc};\n\nuse crate::db::test::test_get_sqlite_memory;\nuse crate::db::{cron_db_cleanup, get_zones_with_txn, start_db, DBEntity, ZoneOwnership};\nuse crate::error::GoatNsError;\nuse crate::tests::test_harness;\n\n#[test]\nfn zoneownership_serde() {\n    let test_str = r#\"{\"id\":1,\"userid\":1,\"zoneid\":1}\"#;\n\n    let zo: ZoneOwnership = serde_json::from_str(test_str).expect(\"failed to serde\");\n    assert_eq!(zo.id, Some(1));\n\n    let test_str = r#\"{\"userid\":1,\"zoneid\":1}\"#;\n    let zo: ZoneOwnership = serde_json::from_str(test_str).expect(\"failed to serde\");\n    assert_eq!(zo.id, None);\n\n    let res = serde_json::to_string(\u0026zo).expect(\"failed to serde\");\n\n    assert_eq!(res, test_str);\n}\n#[tokio::test]\nasync fn userauthtoken_saves() -\u003e Result\u003c(), GoatNsError\u003e {\n    use crate::db::UserAuthToken;\n\n    let pool = test_get_sqlite_memory().await;\n\n    println!(\"Starting DB\");\n    start_db(\u0026pool).await?;\n\n    test_harness::create_test_user(\u0026pool).await?;\n\n    println!(\"Creating UAT Object\");\n\n    let uat = UserAuthToken {\n        name: \"Test Token\".to_string(),\n        id: None,\n        issued: Utc::now(),\n        expiry: None,\n        userid: 1,\n        tokenkey: \"tokenkey\".to_string(),\n        tokenhash: \"hello world\".to_string(),\n    };\n    println!(\"Saving UAT Object to DB: {uat:?}\");\n\n    uat.save(\u0026pool).await?;\n\n    println!(\"Saving duplicate UAT Object to DB: {uat:?}\");\n    uat.save(\u0026pool)\n        .await\n        .expect_err(\"Creating a duplicate token value should fail!\");\n    println!(\"Saving duplicate UAT Object to DB: {uat:?}\");\n    uat.save(\u0026pool)\n        .await\n        .expect_err(\"Creating a duplicate token value should fail!\");\n\n    println!(\"Done!\");\n\n    Ok(())\n}\n#[tokio::test]\nasync fn userauthtoken_expiry() -\u003e Result\u003c(), GoatNsError\u003e {\n    use crate::db::UserAuthToken;\n\n    let pool = test_get_sqlite_memory().await;\n\n    println!(\"Starting DB\");\n    start_db(\u0026pool).await?;\n\n    test_harness::create_test_user(\u0026pool).await?;\n\n    println!(\"Creating UAT Objects\");\n    let tokenhash = \"hello world\".to_string();\n    #[allow(clippy::expect_used)]\n    let expiry = Utc::now() - TimeDelta::try_hours(60).expect(\"how did this fail?\");\n    let uat = UserAuthToken {\n        id: None,\n        name: \"Test Token\".to_string(),\n        issued: Utc::now(),\n        expiry: Some(expiry),\n        userid: 1,\n        tokenkey: \"hello world\".to_string(),\n        tokenhash,\n    };\n    println!(\"Saving UAT Object 1 to DB: {uat:?}\");\n\n    uat.save(\u0026pool).await?;\n    let tokenhash = \"hello world this should exist\".to_string();\n    #[allow(clippy::expect_used)]\n    let expiry = Utc::now() + TimeDelta::try_hours(60).expect(\"how did this fail?\");\n    let uat = UserAuthToken {\n        id: None,\n        name: \"Test Token\".to_string(),\n        issued: Utc::now(),\n        expiry: Some(expiry),\n        userid: 1,\n        tokenkey: \"hello world\".to_string(),\n        tokenhash,\n    };\n    println!(\"Saving UAT Object 2 to DB: {uat:?}\");\n    let res = uat.save(\u0026pool).await;\n    println!(\"result: {res:?}\");\n\n    print!(\"Starting DB Cleanup... \");\n    UserAuthToken::cleanup(\u0026pool).await?;\n    println!(\"Done!\");\n\n    match UserAuthToken::get(\u0026pool, 1).await {\n        Ok(uat) =\u003e panic!(\"We shouldn't find this! {uat:?}\"),\n        Err(err) =\u003e println!(\"Didn't find the UserAuthToken after cleanup, is good. Got {err:?}\"),\n    };\n\n    assert!(UserAuthToken::get(\u0026pool, 2).await.is_ok());\n\n    println!(\"Done!\");\n\n    Ok(())\n}\n\n#[tokio::test]\nasync fn test_cron_db_cleanup() -\u003e Result\u003c(), GoatNsError\u003e {\n    let pool = test_get_sqlite_memory().await;\n\n    println!(\"Starting DB\");\n    start_db(\u0026pool).await?;\n\n    test_harness::create_test_user(\u0026pool).await?;\n    println!(\"doing cleanup\");\n    cron_db_cleanup(pool, core::time::Duration::from_micros(100), Some(2)).await;\n    println!(\"done with cleanup cycle\");\n\n    Ok(())\n}\n\n#[tokio::test]\nasync fn testget_zones_with_txn() -\u003e Result\u003c(), GoatNsError\u003e {\n    let pool = test_get_sqlite_memory().await;\n\n    println!(\"Starting DB\");\n    start_db(\u0026pool).await?;\n\n    test_harness::create_test_user(\u0026pool).await?;\n\n    let mut txn = pool.begin().await?;\n    let zones = get_zones_with_txn(\u0026mut txn, 0, 10).await?;\n    drop(txn);\n\n    assert!(zones.is_empty());\n\n    test_harness::import_test_zone_file(\u0026pool).await?;\n\n    let mut txn = pool.begin().await?;\n    let zones = get_zones_with_txn(\u0026mut txn, 100, 0).await?;\n\n    assert!(!zones.is_empty());\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","tests","doh.rs"],"content":"use axum::http::header::ACCEPT;\n\nuse crate::db::test::test_example_com_zone;\nuse crate::db::DBEntity;\nuse crate::enums::RecordClass;\nuse crate::tests::test_api::insert_test_user;\nuse crate::tests::test_api::start_test_server;\nuse crate::zones::FileZoneRecord;\n\n#[tokio::test]\nasync fn test_doh_get_json() -\u003e Result\u003c(), ()\u003e {\n    // here we stand up the servers\n    let (pool, _servers, config) = start_test_server().await;\n\n    let api_port = config.read().api_port;\n\n    let _user = insert_test_user(\u0026pool).await;\n    test_example_com_zone()\n        .save(\u0026pool)\n        .await\n        .expect(\"Failed to save test zone\");\n\n    let fzr = FileZoneRecord {\n        zoneid: Some(1),\n        name: \"test\".to_string(),\n        rrtype: \"A\".to_string(),\n        id: None,\n        class: RecordClass::Internet,\n        rdata: \"1.2.3.4\".to_string(),\n        ttl: 1,\n    }\n    .save(\u0026pool)\n    .await\n    .expect(\"Failed to save test record\");\n\n    eprintln!(\"FZR result: {fzr:?}\");\n\n    let mut headers = reqwest::header::HeaderMap::new();\n    headers.insert(\n        ACCEPT,\n        \"application/dns-json\"\n            .parse()\n            .expect(\"Failed to parse hard-coded header\"),\n    );\n\n    let client = reqwest::ClientBuilder::new()\n        .danger_accept_invalid_certs(true)\n        // .cookie_store(true)\n        .default_headers(headers)\n        .timeout(std::time::Duration::from_secs(5))\n        .build()\n        .expect(\"Failed to build client\");\n\n    let res = client\n        .get(\u0026format!(\n            \"https://localhost:{api_port}/dns-query?name=test.example.com\u0026type=A\"\n        ))\n        .timeout(std::time::Duration::from_secs(5))\n        .send()\n        .await\n        .unwrap();\n    assert_eq!(res.status(), reqwest::StatusCode::from_u16(200).unwrap());\n    eprintln!(\"{:?}\", res);\n    eprintln!(\"{:?}\", res.bytes().await);\n\n    // TODO: finish this\n    Ok(())\n}\n\n#[tokio::test]\nasync fn test_doh_ask_raw_accept() -\u003e Result\u003c(), ()\u003e {\n    let (_pool, _servers, config) = start_test_server().await;\n\n    let api_port = config.read().api_port;\n    let mut headers = reqwest::header::HeaderMap::new();\n    headers.insert(\"Accept\", \"application/dns-message\".parse().unwrap());\n\n    let client = reqwest::ClientBuilder::new()\n        .danger_accept_invalid_certs(true)\n        // .cookie_store(true)\n        .default_headers(headers)\n        .timeout(std::time::Duration::from_secs(5))\n        .build()\n        .unwrap();\n\n    let res = client\n        .get(\u0026format!(\n            \"https://localhost:{api_port}/dns-query?name=test.example.com\u0026type=A\"\n        ))\n        .timeout(std::time::Duration::from_secs(5))\n        .send()\n        .await\n        .unwrap();\n    eprintln!(\"{res:?}\");\n    assert_eq!(res.status(), reqwest::StatusCode::from_u16(200).unwrap());\n    Ok(())\n}\n\n#[tokio::test]\nasync fn test_doh_ask_json_accept() -\u003e Result\u003c(), ()\u003e {\n    let (_pool, _servers, config) = start_test_server().await;\n\n    let api_port = config.read().api_port;\n    let mut headers = reqwest::header::HeaderMap::new();\n    headers.insert(\"Accept\", \"application/dns-json\".parse().unwrap());\n\n    let client = reqwest::ClientBuilder::new()\n        .danger_accept_invalid_certs(true)\n        // .cookie_store(true)\n        .default_headers(headers)\n        .timeout(std::time::Duration::from_secs(5))\n        .build()\n        .unwrap();\n\n    let res = client\n        .get(\u0026format!(\n            \"https://localhost:{api_port}/dns-query?name=test.example.com\u0026type=A\"\n        ))\n        .timeout(std::time::Duration::from_secs(5))\n        .send()\n        .await\n        .unwrap();\n    eprintln!(\"{res:?}\");\n    assert_eq!(res.status(), reqwest::StatusCode::from_u16(200).unwrap());\n    Ok(())\n}\n\n#[tokio::test]\nasync fn test_doh_ask_wrong_accept() -\u003e Result\u003c(), ()\u003e {\n    let (_pool, _servers, config) = start_test_server().await;\n\n    let api_port = config.read().api_port;\n    let mut headers = reqwest::header::HeaderMap::new();\n    headers.insert(\"Accept\", \"application/cheese\".parse().unwrap());\n\n    let client = reqwest::ClientBuilder::new()\n        .danger_accept_invalid_certs(true)\n        // .cookie_store(true)\n        .default_headers(headers)\n        .timeout(std::time::Duration::from_secs(5))\n        .build()\n        .unwrap();\n\n    let res = client\n        .get(\u0026format!(\n            \"https://localhost:{api_port}/dns-query?name=test.example.com\u0026type=A\"\n        ))\n        .timeout(std::time::Duration::from_secs(5))\n        .send()\n        .await\n        .unwrap();\n    eprintln!(\"{res:?}\");\n    assert_eq!(res.status(), reqwest::StatusCode::from_u16(406).unwrap());\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","tests","e2e_test.rs"],"content":"#[cfg(test)]\nmod tests {\n\n    use std::env;\n    use std::net::*;\n    use trust_dns_resolver::config::*;\n    use trust_dns_resolver::AsyncResolver;\n\n    use crate::servers::udp_server;\n    use crate::tests::utils::wait_for_server;\n\n    fn in_github_actions() -\u003e bool {\n        env::var(\"GITHUB_ACTIONS\").is_ok()\n    }\n\n    #[tokio::test]\n    async fn test_full_run() -\u003e Result\u003c(), std::io::Error\u003e {\n        if in_github_actions() {\n            eprintln!(\"Skipping this test because it won't work in GHA\");\n            return Ok(());\n        }\n\n        let config = crate::config::ConfigFile::try_as_cowcell(Some(\n            \u0026\"./examples/test_config/goatns-test.json\".to_string(),\n        ))?;\n\n        println!(\"Config as loaded\");\n\n        println!(\"{:?}\", config.read());\n\n        println!(\"Starting channels\");\n        let (agent_sender, datastore_tx, datastore_rx) = crate::utils::start_channels();\n\n        println!(\"Starting UDP server\");\n        let udpserver = tokio::spawn(udp_server(\n            config.read(),\n            datastore_tx.clone(),\n            agent_sender.clone(),\n        ));\n\n        println!(\"Starting database connection pool\");\n        let connpool = crate::db::get_conn(config.read()).await.unwrap();\n\n        println!(\"Starting datastore\");\n\n        // start all the things!\n        let datastore_manager = tokio::spawn(crate::datastore::manager(\n            datastore_rx,\n            connpool.clone(),\n            None,\n        ));\n\n        println!(\"Starting API Server\");\n        let apiserver = crate::web::build(datastore_tx.clone(), config.read(), connpool.clone())\n            .await\n            .expect(\"Failed to build API server\");\n\n        println!(\"Building server struct\");\n        let _ = crate::servers::Servers::build(agent_sender)\n            .with_datastore(datastore_manager)\n            .with_udpserver(udpserver)\n            .with_apiserver(apiserver);\n\n        let status_url = config.read().status_url();\n        wait_for_server(status_url).await;\n\n        // Construct a new Resolver pointing at localhost\n        let localhost: std::net::IpAddr =\n            \"127.0.0.1\".parse().expect(\"Failed to parse localhost IP\");\n        let mut resolver_config = ResolverConfig::new();\n        resolver_config.add_name_server(NameServerConfig::new(\n            SocketAddr::new(localhost, 15353),\n            Protocol::Udp,\n        ));\n        let resolver = AsyncResolver::tokio(resolver_config, ResolverOpts::default());\n\n        // Lookup the IP addresses associated with a name.\n\n        println!(\"Querying hello.goat A\");\n        let response = match resolver.lookup_ip(\"hello.goat\").await {\n            Ok(value) =\u003e Some(value),\n            Err(error) =\u003e {\n                eprintln!(\"Error resolving hello.goat A {error:?}\");\n                None\n            }\n        };\n\n        println!(\"Checking for response\");\n        if response.is_none() {\n            return Ok(());\n        }\n\n        // There can be many addresses associated with the name,\n        //  this can return IPv4 and/or IPv6 addresses\n        let address = response\n            .expect(\"Failed to get response\")\n            .iter()\n            .next()\n            .expect(\"no addresses returned!\");\n        if address.is_ipv4() {\n            assert_eq!(address, IpAddr::V4(Ipv4Addr::new(6, 6, 6, 6)));\n        } else {\n            assert_eq!(\n                address,\n                IpAddr::V6(Ipv6Addr::new(\n                    0x2606, 0x2800, 0x220, 0x1, 0x248, 0x1893, 0x25c8, 0x1946\n                ))\n            );\n        }\n        println!(\"Successfully got hello.goat A: {:?}\", address);\n\n        println!(\"Querying _mqtt._http.hello.goat URI\");\n        let response = match resolver\n            .lookup(\n                \"_mqtt._http.hello.goat\",\n                trust_dns_resolver::proto::rr::RecordType::Unknown(\n                    crate::enums::RecordType::URI as u16,\n                ),\n            )\n            .await\n        {\n            Ok(value) =\u003e value,\n            Err(error) =\u003e panic!(\"{error:?}\"),\n        };\n        assert!(!response.records().is_empty());\n        eprintln!(\"URL response: {response:?}\");\n\n        Ok(())\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","tests","enums.rs"],"content":"use std::str::FromStr;\n\nuse crate::enums::ContactDetails;\n\n#[test]\nfn test_contactdetails() {\n    let good_mastodon = ContactDetails::try_from(\"Mastodon:yaleman@mastodon.social\".to_string());\n    println!(\"{good_mastodon:?}\");\n    assert!(good_mastodon.is_ok());\n    let expected_mastodon = ContactDetails::Mastodon {\n        contact: \"yaleman\".to_string(),\n        server: \"mastodon.social\".to_string(),\n    };\n    assert_eq!(good_mastodon.unwrap(), expected_mastodon);\n\n    let good_mastodon = ContactDetails::try_from(\"Mastodon:@yaleman@mastodon.social\".to_string());\n    println!(\"{good_mastodon:?}\");\n    assert!(good_mastodon.is_ok());\n    let expected_mastodon = ContactDetails::Mastodon {\n        contact: \"yaleman\".to_string(),\n        server: \"mastodon.social\".to_string(),\n    };\n    assert_eq!(good_mastodon.unwrap(), expected_mastodon);\n\n    let good_twitter = ContactDetails::try_from(\"Twitter:@yaleman43381258\".to_string());\n    assert!(good_twitter.is_ok());\n    let good_email = ContactDetails::try_from(\"Email:billy@dotgoat.net\".to_string());\n    assert!(good_email.is_ok());\n\n    assert!(ContactDetails::try_from(\"asdfasdf\".to_string()).is_err());\n    assert!(ContactDetails::try_from(\"foo:asdfasdf\".to_string()).is_err());\n    assert!(ContactDetails::try_from(\"foo:asdfasdf:asdfasdfd\".to_string()).is_err());\n}\n\n#[test]\nfn test_contactdetails_deser() {\n    use crate::config::ConfigFile;\n\n    let configfile = r#\"{\n\t\"admin_contact\" : \"asdfadsf\"\n}\n\"#;\n    print!(\"Parsing config file...\");\n    let configfile = ConfigFile::from_str(configfile).unwrap();\n    println!(\"OK\");\n\n    println!(\n        \"Checking that {:?} = {:?}\",\n        configfile.admin_contact,\n        ContactDetails::None\n    );\n    assert_eq!(configfile.admin_contact, ContactDetails::None);\n\n    let configfile = r#\"{\n\t\"admin_contact\" : \"Mastodon:yaleman@mastodon.social\"\n}\n\"#;\n    print!(\"Parsing config file...\");\n    let configfile = ConfigFile::from_str(configfile).unwrap();\n    println!(\"OK\");\n\n    let expected_result: ContactDetails = ContactDetails::Mastodon {\n        contact: \"yaleman\".to_string(),\n        server: \"mastodon.social\".to_string(),\n    };\n\n    println!(\n        \"Checking that {:?} = {expected_result:?}\",\n        configfile.admin_contact\n    );\n    assert_eq!(configfile.admin_contact, expected_result);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","tests","mod.rs"],"content":"mod config;\nmod db;\nmod doh;\nmod e2e_test;\nmod enums;\nmod resourcerecord;\nmod test_api;\npub mod test_harness;\nmod utils;\n\nuse crate::db::test::test_get_sqlite_memory;\nuse crate::db::*;\nuse crate::enums::{RecordClass, RecordType};\nuse crate::resourcerecord::{InternalResourceRecord, LocRecord};\nuse crate::tests::test_harness::*;\nuse crate::utils::name_as_bytes;\nuse crate::{get_question_qname, PacketType, Question};\nuse ipnet::IpNet;\nuse log::debug;\nuse packed_struct::prelude::*;\nuse std::net::IpAddr;\nuse std::str::FromStr;\n\n#[test]\n/// test my assumptions about ipnet things\nfn test_ip_in_ipnet() {\n    let net = IpNet::from_str(\"10.0.0.0/24\").unwrap();\n\n    let addr: IpAddr = \"10.0.0.69\".parse().unwrap();\n    let noaddr: IpAddr = \"69.0.0.69\".parse().unwrap();\n\n    assert!(net.contains(\u0026addr));\n    assert!(!net.contains(\u0026noaddr));\n}\n\n#[test]\nfn test_resourcerecord_name_to_bytes() {\n    let rdata = \"cheese.world\".as_bytes();\n    assert_eq!(\n        name_as_bytes(rdata, None, None).expect(\"Failed to parse name\"),\n        [6, 99, 104, 101, 101, 115, 101, 5, 119, 111, 114, 108, 100, 0]\n    );\n}\n#[test]\nfn test_resourcerecord_short_name_to_bytes() {\n    let rdata = \"cheese\".as_bytes();\n    assert_eq!(\n        name_as_bytes(rdata, None, None).expect(\"Failed to parse name\"),\n        [6, 99, 104, 101, 101, 115, 101, 0]\n    );\n}\n#[test]\nfn test_name_as_bytes() {\n    let rdata = \"cheese.hello.world\".as_bytes();\n    let compress_ref = \"zing.hello.world\".as_bytes().to_vec();\n    assert_eq!(\n        name_as_bytes(rdata, Some(12u16), Some(\u0026compress_ref)).expect(\"Failed to parse\"),\n        [6, 99, 104, 101, 101, 115, 101, 192, 17]\n    );\n}\n\n#[tokio::test]\nasync fn test_build_iana_org_a_reply() {\n    use crate::reply::Reply;\n    use crate::resourcerecord::InternalResourceRecord;\n    use crate::Header;\n\n    let header = Header {\n        id: 41840,\n        qr: PacketType::Answer,\n        opcode: crate::OpCode::Query,\n        authoritative: false,\n        truncated: false,\n        recursion_desired: true,\n        recursion_available: true,\n        z: false,\n        ad: false,\n        cd: false,\n        rcode: crate::Rcode::NoError,\n        qdcount: 1,\n        ancount: 1,\n        arcount: 0,\n        nscount: 0,\n    };\n    let qname = \"iana.org\".as_bytes().to_vec();\n    let question = Question {\n        qname: qname.clone(),\n        qtype: crate::RecordType::A,\n        qclass: crate::RecordClass::Internet,\n    };\n    let question_length = question\n        .try_to_bytes()\n        .expect(\"Failed to convert question to bytes\")\n        .len();\n    debug!(\"question byte length: {}\", question_length);\n    let address = std::net::Ipv4Addr::from_str(\"192.0.43.8\").unwrap();\n    let answers = vec![InternalResourceRecord::A {\n        ttl: 350,\n        address: address.into(),\n        rclass: crate::RecordClass::Internet,\n    }];\n    let reply = Reply {\n        header,\n        question: Some(question),\n        answers,\n        authorities: vec![],\n        additional: vec![],\n    };\n    let reply_bytes: Vec\u003cu8\u003e = reply\n        .as_bytes()\n        .await\n        .expect(\"Failed to convert reply to bytes\");\n    debug!(\"{:?}\", reply_bytes);\n    let expected_bytes = [\n        /* header - 12 bytes */\n        0xa3, 0x70, 0x81, 0x80, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,\n        /* question - 14 bytes */\n        0x04, 0x69, 0x61, 0x6e, 0x61, 0x03, 0x6f, 0x72, 0x67, 0x00, 0x00, 0x01, 0x00, 0x01,\n        /* answer - 16 bytes */\n        0xc0, 0x0c, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01, 0x5e, 0x00, 0x04, 0xc0, 0x00, 0x2b,\n        0x08,\n    ];\n    let mut current_block: \u0026str;\n    for (index, byte) in reply_bytes.iter().enumerate() {\n        if index \u003c 12 {\n            current_block = \"Header \";\n        } else if index \u003c 26 {\n            current_block = \"Question \";\n        } else {\n            current_block = \"Answer   \";\n        }\n\n        let expected_byte = expected_bytes.get(index).expect(\"Our reply is longer!\");\n        debug!(\n            \"{} \\t {} us: {} ex: {} {}\",\n            current_block,\n            index,\n            byte,\n            expected_byte,\n            (byte == expected_byte)\n        );\n        assert_eq!(byte, \u0026expected_bytes[index]);\n    }\n    assert_eq!([reply_bytes[0], reply_bytes[1]], [0xA3, 0x70])\n}\n#[tokio::test]\nasync fn test_cloudflare_soa_reply() {\n    use crate::reply::Reply;\n    use crate::resourcerecord::DomainName;\n    use crate::{Header, HEADER_BYTES};\n    //     /*\n    //     from: \u003chttps://raw.githubusercontent.com/paulc/dnslib/master/dnslib/test/cloudflare.com-SOA\u003e\n\n    //     ;; Sending:\n    //     ;; QUERY: 8928010000010000000000000a636c6f7564666c61726503636f6d0000060001\n    //     ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 35112\n    //     ;; flags: rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0\n    //     ;; QUESTION SECTION:\n    //     ;cloudflare.com.                IN      SOA\n\n    //     ;; Got answer:\n    //     ;; RESPONSE: 8928818000010001000000000a636c6f7564666c61726503636f6d0000060001c00c00060001000000ad0020036e7333c00c03646e73c00c7906ce18000027100000096000093a800000012c\n    //     ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 35112\n    //     ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n    //     ;; QUESTION SECTION:\n    //     ;cloudflare.com.                IN      SOA\n    //     ;; ANSWER SECTION:\n    //     cloudflare.com.         173     IN      SOA     ns3.cloudflare.com. dns.cloudflare.com. 2030489112 10000 2400 604800 300\n\n    //     */\n    let original_question: [u8; 32] = [\n        0x89, 0x28, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x63, 0x6c,\n        0x6f, 0x75, 0x64, 0x66, 0x6c, 0x61, 0x72, 0x65, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x06,\n        0x00, 0x01,\n    ];\n\n    let expected_bytes = [\n        /* header - 12 bytes */\n        0x89, 0x28, 0x81, 0x80, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,\n        /* question - 14 bytes */\n        0x0a, 0x63, 0x6c, 0x6f, 0x75, 0x64, 0x66, 0x6c, 0x61, /* answer - 16 bytes */\n        0x72, 0x65, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x06, 0x00, 0x01, 0xc0, 0x0c, 0x00, 0x06,\n        0x00, 0x01, 0x00, 0x00, 0x00, 0xad, 0x00, 0x20, 0x03, 0x6e, 0x73, 0x33, 0xc0, 0x0c, 0x03,\n        0x64, 0x6e, 0x73, 0xc0, 0x0c, 0x79, 0x06, 0xce, 0x18, 0x00, 0x00, 0x27, 0x10, 0x00, 0x00,\n        0x09, 0x60, 0x00, 0x09, 0x3a, 0x80, 0x00, 0x00, 0x01, 0x2c,\n    ];\n\n    let header = Header {\n        id: 35112,\n        qr: PacketType::Answer,\n        opcode: crate::OpCode::Query,\n        authoritative: false,\n        truncated: false,\n        recursion_desired: true,\n        recursion_available: false,\n        z: false,\n        ad: false,\n        cd: false,\n        rcode: crate::Rcode::NoError,\n        qdcount: 1,\n        ancount: 1,\n        arcount: 0,\n        nscount: 0,\n    };\n    let qname = \"cloudflare.com\".as_bytes().to_vec();\n    let question = Question {\n        qname: qname.clone(),\n        qtype: crate::RecordType::SOA,\n        qclass: crate::RecordClass::Internet,\n    };\n    let question_length = question\n        .try_to_bytes()\n        .expect(\"Failed to convert question to bytes\")\n        .len();\n    debug!(\"question byte length: {}\", question_length);\n\n    // YOLO the  string conversions because it's a test\n    let rdata = InternalResourceRecord::SOA {\n        zone: DomainName::from(\"cloudflare.com\"),\n        mname: DomainName::from(\"ns3.cloudflare.com\"),\n        rname: DomainName::from(\"dns.cloudflare.com\"),\n        serial: 2030489112,\n        refresh: 10000,\n        retry: 2400,\n        expire: 604800,\n        minimum: 300,\n        rclass: crate::RecordClass::Internet,\n    };\n\n    // let rdata = rdata.as_bytes();\n    let answers = vec![rdata];\n\n    let mut reply = Reply {\n        header: header.clone(),\n        question: Some(question),\n        answers,\n        authorities: vec![],\n        additional: vec![],\n    };\n    reply.header.recursion_available = true;\n    debug!(\"{:?}\", reply);\n    let reply_bytes: Vec\u003cu8\u003e = reply.as_bytes().await.unwrap();\n    debug!(\"{:?}\", reply_bytes);\n\n    // testing if I was parsing it right...\n    let mut their_header = Header::unpack_from_slice(\u0026original_question[0..HEADER_BYTES]).unwrap();\n    their_header.ancount = 1;\n    assert_eq!(header, their_header.as_answer());\n    log::trace!(\"Parsed header matched!\");\n\n    let mut current_block: \u0026str;\n    for (index, byte) in reply_bytes.iter().enumerate() {\n        if index \u003c HEADER_BYTES {\n            current_block = \"Header \";\n        } else if index \u003c HEADER_BYTES + 9 {\n            current_block = \"Question \";\n        } else {\n            current_block = \"Answer   \";\n        }\n\n        let b = [byte.clone()];\n        let ascii_byte_us = match byte.is_ascii_alphanumeric() {\n            true =\u003e std::str::from_utf8(\u0026b).unwrap_or(\"-\"),\n            false =\u003e \" \",\n        };\n\n        match expected_bytes.get(index) {\n            Some(expected_byte) =\u003e {\n                let eb: u8 = expected_byte.clone();\n                let ascii_byte_them = match eb.is_ascii_alphanumeric() {\n                    true =\u003e std::str::from_utf8(\u0026b).unwrap_or(\"-\"),\n                    false =\u003e \" \",\n                };\n                log::trace!(\n                    \"{current_block} \\t {index} us: {}\\t{:#010b}\\tex: {expected_byte}\\t{expected_byte:#010b} \\tchars: {} {}\\t matched: {}\",\n                    byte.clone(),\n                    byte.clone(),\n                    ascii_byte_us,\n                    ascii_byte_them,\n                    (byte == expected_byte)\n                )\n            }\n            None =\u003e {\n                panic!(\"Our reply is longer!\");\n                // break;\n            }\n        }\n        // assert_eq!(byte, \u0026expected_bytes[index]);\n    }\n    // assert_eq!([reply_bytes[0], reply_bytes[1]], [0xA3, 0x70])\n}\n\n#[tokio::test]\nasync fn build_ackcdn_allzeros() {\n    use crate::reply::Reply;\n    use crate::Header;\n\n    let header = Header {\n        id: 0x3DE1,\n        qr: PacketType::Answer,\n        opcode: crate::OpCode::Query,\n        authoritative: true,\n        truncated: false,\n        recursion_desired: true,\n        recursion_available: true,\n        z: false,\n        ad: false,\n        cd: false,\n        rcode: crate::Rcode::NoError,\n        qdcount: 1,\n        ancount: 1,\n        arcount: 0,\n        nscount: 0,\n    };\n    let qname = \"ackcdn.com\".as_bytes().to_vec();\n    let question = Question {\n        qname: qname.clone(),\n        qtype: crate::RecordType::A,\n        qclass: crate::RecordClass::Internet,\n    };\n    let question_length = question\n        .try_to_bytes()\n        .expect(\"Failed to convert question to bytes\")\n        .len();\n    debug!(\"question byte length: {}\", question_length);\n\n    // let rdata = IpAddr::try_from(\"0.0.0.0\");\n    // let rdata: Ipv4Addr = \"0.0.0.0\".parse().unwrap();\n    // let rdata: u32 = rdata.into();\n    // let rdata = rdata.octets();\n    // let rdlength: u16 = rdata.len() as u16;\n\n    let answers = vec![crate::resourcerecord::InternalResourceRecord::A {\n        // name: vec![0xc0, 0x0c],\n        // name: \"ackcdn.com\".as_bytes().to_vec(),\n        // record_type: crate::RecordType::A,\n        // class: crate::RecordClass::Internet,\n        ttl: 2u32,\n        address: 0u32,\n\n        rclass: crate::RecordClass::Internet,\n        // rdlength,\n        // rdata: rdata.into(),\n        // compression: true,\n    }];\n\n    let reply = Reply {\n        header,\n        question: Some(question),\n        answers,\n        authorities: vec![],\n        additional: vec![],\n    };\n    let reply_bytes: Vec\u003cu8\u003e = reply.as_bytes().await.unwrap();\n    debug!(\"{} bytes: {:?}\", reply_bytes.len(), reply_bytes);\n\n    let expected_bytes = [\n        /* header - 12 bytes */\n        0x3d, 0xe1, 0x85, 0x80, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,\n        /* question - 16 bytes */\n        0x06, 0x61, 0x63, 0x6b, 0x63, 0x64, 0x6e, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x01, 0x00,\n        0x01, /* answer - 16 bytes  */\n        0xC0, 0x0c, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x04, 0x00, 0x00, 0x00,\n        0x00,\n    ];\n\n    log::trace!(\"Our length: {}\", reply_bytes.len());\n    log::trace!(\"Exp length: {}\", expected_bytes.len());\n\n    let mut current_block: \u0026str;\n    for (index, byte) in reply_bytes.iter().enumerate() {\n        if index \u003c 12 {\n            current_block = \"Header \";\n        } else if index \u003c 28 {\n            current_block = \"Question \";\n        } else {\n            current_block = \"Answer   \";\n        }\n        match expected_bytes.get(index) {\n            Some(expected_byte) =\u003e log::error!(\n                \"{} \\t {} us: {} ex: {} {}\",\n                current_block,\n                index,\n                byte,\n                expected_byte,\n                (byte == expected_byte)\n            ),\n            None =\u003e {\n                panic!(\"Our reply is longer!\");\n                // break;\n            }\n        }\n        assert_eq!(byte, \u0026expected_bytes[index]);\n    }\n    assert_eq!([reply_bytes[0], reply_bytes[1]], [0x3D, 0xE1]);\n}\n\n/// turns a degrees-minutes-seconds input into a signed 32-bit integer.\n/// when positive = true, you're North or West\n#[test]\nfn test_dms_to_i32() {\n    use crate::utils::dms_to_u32;\n\n    let equator: u32 = 2u32.pow(31);\n    assert_eq!(dms_to_u32(0, 0, 0.0, true), equator);\n\n    assert_eq!(dms_to_u32(1, 2, 3.0, true), 2151206648);\n}\n\n#[test]\n/// this is based on a record in a pcap in the examples directory -\nfn test_loc_as_bytes() {\n    // pizza.yaleman.org.\t69\tIN\tLOC\t1 2 3.000 N 1 2 3.000 E 10.00m 10m 10m 10m\n    // compression header c00c\n    // LOC: 001d\n    // IN: 0001\n    // TTL: 00000045 (69)\n    // Length: 0010 (16)\n    let expected_bytes: [u8; 16] = [\n        0x00, // Version: 0\n        0x13, // size 19 (10m)\n        0x13, // hor 19 (10m)\n        0x13, // ver 19 (10m)\n        0x80, 0x38, 0xce, 0xf8, // Latitude: 2151206648 (1 deg 2 min 3.000 sec N)\n        0x80, 0x38, 0xce, 0xf8, // Longitude: 2151206648 (1 deg 2 min 3.000 sec E)\n        0x00, 0x98, 0x9a, 0x68, // Altitude: 10001000 (10 m)\n    ];\n\n    let test_record = LocRecord {\n        version: 0,\n        size: 0x13,\n        horiz_pre: 0x13,\n        vert_pre: 0x13,\n        latitude: 2151206648,\n        longitude: 2151206648,\n        altitude: 10001000,\n    };\n    let test_result = test_record.pack().unwrap();\n    assert_eq!(expected_bytes, test_result);\n}\n\n#[test]\nfn test_loc_record_parser() {\n    use crate::resourcerecord::FileLocRecord;\n\n    let sample_data: Vec\u003c(\u0026str, FileLocRecord)\u003e = vec![\n        (\n            \"42 21 43.952 N 71 5 6.344 W -24m 1m 200m 15m\",\n            FileLocRecord {\n                d1: 42,\n                m1: 21,\n                s1: 43.952,\n                d2: 71,\n                m2: 5,\n                s2: 6.344,\n                lat_dir: \"N\".to_string(),\n                lon_dir: \"W\".to_string(),\n                alt: (10000000 + (-24 * 100)),\n                size: 0x12,\n                horiz_pre: 0x24,\n                vert_pre: 0x23,\n            },\n        ),\n        (\n            \"42 21 43.952 N 71 5 6.344 W -24m 1m 200m\",\n            FileLocRecord {\n                d1: 42,\n                m1: 21,\n                s1: 43.952,\n                lat_dir: \"N\".to_string(),\n                d2: 71,\n                m2: 5,\n                s2: 6.344,\n                lon_dir: \"W\".to_string(),\n                alt: 10000000 + (-24 * 100),\n                size: 0x12,\n                horiz_pre: 0x24,\n                vert_pre: 0x13,\n            },\n        ),\n        (\n            \"32 S 116 E 10m\",\n            FileLocRecord {\n                d1: 32,\n                lat_dir: \"S\".to_string(),\n                d2: 116,\n                lon_dir: \"E\".to_string(),\n                alt: 10000000 + (10 * 100),\n                ..Default::default()\n            },\n        ),\n        (\n            \"32 7 19 S 116 2 25 E 10m\",\n            FileLocRecord {\n                d1: 32,\n                m1: 7,\n                s1: 19.0,\n                lat_dir: \"S\".to_string(),\n                d2: 116,\n                m2: 2,\n                s2: 25.0,\n                lon_dir: \"E\".to_string(),\n                alt: 10000000 + (10 * 100),\n                ..FileLocRecord::default()\n            },\n        ),\n        (\n            \"42 21 54 N 71 06 18 W -24m 30m\",\n            FileLocRecord {\n                d1: 42,\n                m1: 21,\n                s1: 54.0,\n                lat_dir: \"N\".to_string(),\n                d2: 71,\n                m2: 6,\n                s2: 18.0,\n                lon_dir: \"W\".to_string(),\n                alt: (-24 * 100) + 10000000,\n                size: 0x33,\n                ..FileLocRecord::default()\n            },\n        ),\n        (\n            \"52 14 05 N 00 08 50 E 10m\",\n            FileLocRecord {\n                d1: 52,\n                m1: 14,\n                s1: 5.0,\n                lat_dir: \"N\".to_string(),\n                m2: 8,\n                s2: 50.0,\n                lon_dir: \"E\".to_string(),\n                alt: (10 * 100) + 10000000,\n                ..FileLocRecord::default()\n            },\n        ),\n        (\n            \"42 21 28.764 N 71 00 51.617 W -44m 2000m\",\n            FileLocRecord {\n                d1: 42,\n                m1: 21,\n                s1: 28.764,\n                lat_dir: \"N\".to_string(),\n                d2: 71,\n                m2: 0,\n                s2: 51.617,\n                lon_dir: \"W\".to_string(),\n                alt: (-44 * 100) + 10000000,\n                size: 0x25,\n                ..FileLocRecord::default()\n            },\n        ),\n    ];\n    for (input, output) in sample_data {\n        eprintln!(\"Testing {input}\");\n        let record = FileLocRecord::try_from(input);\n        assert!(record.is_ok());\n        assert_eq!(record.unwrap(), output);\n    }\n}\n\n#[test]\nfn test_all_record_type_conversions() {\n    for record_type in enum_iterator::all::\u003cRecordType\u003e().collect::\u003cVec\u003c_\u003e\u003e() {\n        eprintln!(\"Testing {record_type:?}\");\n        if record_type != RecordType::InvalidType {\n            let string_version = record_type.to_string();\n            assert_ne!(string_version, \"\".to_string());\n\n            let from_string_version = RecordType::from(string_version);\n\n            assert_eq!(record_type, from_string_version);\n            let _: u16 = record_type as u16;\n        } else {\n            let garbled = String::from(\"asdfasdfasdflq23423l4kj23h4l23jk4\");\n            assert_eq!(record_type, RecordType::from(garbled));\n            assert_eq!(record_type, RecordType::from(\u002612345u16));\n        }\n    }\n}\n#[test]\nfn test_all_record_class_conversions() {\n    for record_class in enum_iterator::all::\u003cRecordClass\u003e().collect::\u003cVec\u003c_\u003e\u003e() {\n        eprintln!(\"Testing {record_class:?}\");\n        let fail_string: \u0026'static str = \"\";\n        if record_class != RecordClass::InvalidType {\n            let string_version = record_class.to_owned().to_string();\n            assert_ne!(string_version, fail_string);\n\n            let str_version = string_version.as_str();\n\n            let from_string_version = RecordClass::from(str_version);\n\n            assert_eq!(record_class, from_string_version);\n            let _: u16 = record_class as u16;\n        } else {\n            let garbled = \"asdfasdfasdflq23423l4kj23h4l23jk4\";\n            assert_eq!(record_class, RecordClass::from(garbled));\n            assert_eq!(record_class, RecordClass::from(\u002612345u16));\n        }\n    }\n}\n\n#[test]\nfn test_normalize_name() {\n    let q = Question {\n        qname: String::from(\"HellO.world\").into_bytes(),\n        qtype: crate::enums::RecordType::A,\n        qclass: crate::enums::RecordClass::Internet,\n    };\n    assert_eq!(q.normalized_name().unwrap(), String::from(\"hello.world\"));\n    let q = Question {\n        qname: String::from(\"hello.world\").into_bytes(),\n        qtype: crate::enums::RecordType::A,\n        qclass: crate::enums::RecordClass::Internet,\n    };\n    assert_eq!(q.normalized_name().unwrap(), String::from(\"hello.world\"));\n}\n\n#[test]\nfn test_get_question_qname() {\n    assert!(get_question_qname(\u0026[23, 0]).is_err());\n\n    let sample_data = vec![7, 101, 120, 97, 109, 112, 108, 101, 3, 99, 111, 109, 0];\n    eprintln!(\"{:?}\", sample_data);\n    let result = get_question_qname(\u0026sample_data);\n    assert_eq!(\n        result,\n        Ok(vec![101, 120, 97, 109, 112, 108, 101, 46, 99, 111, 109])\n    );\n}\n\n#[tokio::test]\n///tries to test when input buffers are weird\nasync fn test_question_from_bytes() {\n    let ok_question = vec![\n        /* question - 14 bytes */\n        0x04, 0x69, 0x61, 0x6e, 0x61, 0x03, 0x6f, 0x72, 0x67, 0x00, 0x00, 0x01, //0x00, 0x01,\n    ];\n    let input_bufs: Vec\u003cVec\u003cu8\u003e\u003e = vec![\n        /* header - 12 bytes */\n        // 0xa3, 0x70, 0x81, 0x80, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,\n        ok_question[0..10].to_vec(),\n        ok_question[0..11].to_vec(),\n        ok_question[0..12].to_vec(),\n    ];\n\n    for buf in input_bufs {\n        assert!(Question::from_packets(\u0026buf).is_err());\n    }\n}\n\n#[tokio::test]\n/// this test checks that all TTLs in the record are the same when we set normalise_ttls = true\nasync fn test_normalize_ttls() {\n    // use crate::zones::FileZoneRecord;\n    let pool = test_get_sqlite_memory().await;\n\n    start_db(\u0026pool).await.expect(\"failed to start DB\");\n    import_test_zone_file(\u0026pool)\n        .await\n        .expect(\"failed to import test zone file\");\n\n    let response = get_records(\n        \u0026pool,\n        \"ttltest.hello.goat\".to_string(),\n        RecordType::A,\n        RecordClass::Internet,\n        true,\n    )\n    .await\n    .expect(\"Failed to query records\");\n\n    print!(\"Checking that we got three records...\");\n    println!(\"Response:\");\n    for re in response.iter() {\n        println!(\"{re:?}\");\n    }\n    assert_eq!(response.iter().len(), 3);\n    println!(\" OK\");\n\n    // first we just check we got three records from the db\n    let mut found_records: Vec\u003cu32\u003e = vec![];\n    for record in response {\n        println!(\"found record {record:?}\");\n        if let InternalResourceRecord::A { ttl, .. } = record {\n            if !found_records.contains(\u0026ttl) {\n                found_records.push(ttl);\n            }\n        } else {\n            println!(\"We found a record that wasn't an A record, that's cool I guess?\")\n        }\n    }\n    print!(\"Checking that we found a single ttl...\");\n    assert!(found_records.len() == 1);\n    println!(\" OK\");\n}\n\n#[tokio::test]\n/// this test checks that all TTLs in the record are the same when we set normalise_ttls = true\nasync fn test_dont_normalize_ttls() {\n    // use crate::zones::FileZoneRecord;\n    let pool = test_get_sqlite_memory().await;\n\n    start_db(\u0026pool).await.expect(\"Failed to start DB\");\n    import_test_zone_file(\u0026pool)\n        .await\n        .expect(\"Failed to import zone file\");\n\n    let response = get_records(\n        \u0026pool,\n        \"ttltest.hello.goat\".to_string(),\n        RecordType::A,\n        RecordClass::Internet,\n        false,\n    )\n    .await\n    .unwrap();\n\n    print!(\"Checking that we got three records...\");\n    assert!(response.iter().len() == 3);\n    println!(\" OK\");\n\n    // first we just check we got three records from the db\n    let mut found_records: Vec\u003cu32\u003e = vec![];\n    for record in response {\n        println!(\"found record {record:?}\");\n        if let InternalResourceRecord::A { ttl, .. } = record {\n            if !found_records.contains(\u0026ttl) {\n                found_records.push(ttl);\n            }\n        } else {\n            println!(\"We found a record that wasn't an A record, that's cool I guess?\")\n        }\n    }\n    print!(\"Checking that we found three different ttls...\");\n    assert!(found_records.len() == 3);\n    println!(\" OK\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","tests","resourcerecord.rs"],"content":"use crate::resourcerecord::check_long_labels;\n\n#[test]\nfn test_check_long_labels() {\n    assert_eq!(false, check_long_labels(\u0026\"hello.\".to_string()));\n    assert_eq!(false, check_long_labels(\u0026\"hello.world\".to_string()));\n    assert_eq!(\n        true,\n        check_long_labels(\n            \u0026\"foo.12345678901234567890123456789012345678901234567890123456789012345678901234567890\"\n                .to_string()\n        )\n    );\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","tests","test_api.rs"],"content":"use crate::config::ConfigFile;\nuse crate::db::test::test_get_sqlite_memory;\nuse crate::db::{start_db, DBEntity, User, UserAuthToken, ZoneOwnership};\nuse crate::enums::RecordType;\nuse crate::error::GoatNsError;\nuse crate::servers::{self, Servers};\nuse crate::web::api::auth::AuthPayload;\nuse crate::web::utils::{create_api_token, ApiToken};\nuse crate::zones::{FileZone, FileZoneRecord};\nuse concread::cowcell::asynch::CowCell;\nuse sqlx::SqlitePool;\nuse tokio::net::TcpStream;\n\npub async fn is_free_port(port: u16) -\u003e bool {\n    TcpStream::connect((\"127.0.0.1\", port)).await.is_err()\n}\n\npub async fn start_test_server() -\u003e (SqlitePool, Servers, CowCell\u003cConfigFile\u003e) {\n    let _ = rustls::crypto::aws_lc_rs::default_provider().install_default();\n    let pool = test_get_sqlite_memory().await;\n\n    start_db(\u0026pool).await.expect(\"failed to start DB\");\n\n    let config = crate::config::ConfigFile::try_as_cowcell(Some(\n        \u0026\"./examples/test_config/goatns-test.json\".to_string(),\n    ))\n    .expect(\"failed to parse test config\");\n\n    use rand::thread_rng;\n    use rand::Rng;\n    let mut rng = thread_rng();\n    let mut port: u16 = rng.gen_range(2000..=65000);\n    loop {\n        if is_free_port(port).await {\n            break;\n        }\n        port = rng.gen_range(2000..=65000);\n    }\n\n    let mut config_tx = config.write().await;\n    config_tx.api_port = port;\n    config_tx.commit();\n\n    // println!(\"Starting channels\");\n    let (agent_sender, datastore_tx, datastore_rx) = crate::utils::start_channels();\n\n    let udpserver = tokio::spawn(servers::udp_server(\n        config.read(),\n        datastore_tx.clone(),\n        agent_sender.clone(),\n    ));\n    let tcpserver = tokio::spawn(servers::tcp_server(\n        config.read(),\n        datastore_tx.clone(),\n        agent_sender.clone(),\n    ));\n    // start all the things!\n    let datastore_manager =\n        tokio::spawn(crate::datastore::manager(datastore_rx, pool.clone(), None));\n\n    println!(\"Starting API Server on port {port}\");\n    let apiserver = crate::web::build(datastore_tx.clone(), config.read(), pool.clone())\n        .await\n        .expect(\"Failed to start API server\");\n\n    println!(\"Building server struct\");\n    (\n        pool,\n        crate::servers::Servers::build(agent_sender)\n            .with_datastore(datastore_manager)\n            .with_apiserver(apiserver)\n            .with_udpserver(udpserver)\n            .with_tcpserver(tcpserver),\n        config,\n    )\n}\n\npub async fn insert_test_user(pool: \u0026SqlitePool) -\u003e Box\u003cUser\u003e {\n    User {\n        id: Some(5),\n        displayname: \"Example user\".to_string(),\n        username: \"example\".to_string(),\n        email: \"example@hello.goat\".to_string(),\n        disabled: false,\n        authref: Some(\"zooooom\".to_string()),\n        admin: true,\n    }\n    .save(\u0026pool)\n    .await\n    .unwrap()\n}\n\n/// Shoves an API token into the DB for a user\nasync fn insert_test_user_api_token(pool: \u0026SqlitePool, userid: i64) -\u003e Result\u003cApiToken, ()\u003e {\n    println!(\"creating test token for user {userid:?}\");\n    let token = create_api_token(\"lols\".as_bytes(), 900, userid);\n\n    UserAuthToken {\n        id: None,\n        name: \"test token\".to_string(),\n        issued: token.issued,\n        expiry: token.expiry,\n        tokenkey: token.token_key.to_owned(),\n        tokenhash: token.token_hash.to_owned(),\n        userid,\n    }\n    .save(\u0026pool)\n    .await\n    .unwrap();\n\n    Ok(token)\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn api_zone_create() -\u003e Result\u003c(), GoatNsError\u003e {\n    // here we stand up the servers\n    let (pool, _servers, config) = start_test_server().await;\n\n    let api_port = config.read().api_port;\n    // let apiserver = servers.apiserver.unwrap();\n\n    let user = insert_test_user(\u0026pool).await;\n    println!(\"api_zone_create Created user... {user:?}\");\n\n    println!(\"api_zone_create Creating token for user\");\n    let token = insert_test_user_api_token(\u0026pool, user.id.expect(\"no user id found\"))\n        .await\n        .unwrap();\n    println!(\"api_zone_create Created token... {token:?}\");\n\n    let client = reqwest::ClientBuilder::new()\n        .danger_accept_invalid_certs(true)\n        .cookie_store(true)\n        .timeout(std::time::Duration::from_secs(5))\n        .build()\n        .unwrap();\n\n    println!(\"api_zone_create Logging in with the token...\");\n    let res = client\n        .post(\u0026format!(\"https://localhost:{api_port}/api/login\"))\n        .timeout(std::time::Duration::from_secs(5))\n        .json(\u0026AuthPayload {\n            token_key: token.token_key,\n            token_secret: token.token_secret.to_owned(),\n        })\n        .send()\n        .await\n        .unwrap();\n    println!(\"{:?}\", res);\n    assert_eq!(res.status(), 200);\n    println!(\"api_zone_create =\u003e Token login success!\");\n\n    let newzone = FileZone {\n        id: Some(1234),\n        name: \"example.goat\".to_string(),\n        rname: \"bob@example.goat\".to_string(),\n        serial: 12345,\n        expire: 30,\n        minimum: 1235,\n        ..Default::default()\n    };\n\n    println!(\"api_zone_create Sending zone create\");\n    let res = client\n        .post(\u0026format!(\"https://localhost:{api_port}/api/zone\"))\n        .header(\"Authorization\", format!(\"Bearer {}\", token.token_secret))\n        .json(\u0026newzone)\n        .send()\n        .await\n        .unwrap();\n    assert_eq!(res.status(), 200);\n\n    let response_zone: FileZone = res\n        .json()\n        .await\n        .inspect_err(|err| println!(\"Failed to parse response content: {err:?}\"))?;\n\n    assert_eq!(response_zone.name, \"example.goat\");\n    assert_eq!(response_zone.serial, 12345);\n    assert_ne!(response_zone.serial, 123456);\n    drop(pool);\n    Ok(())\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn api_zone_create_delete() -\u003e Result\u003c(), sqlx::Error\u003e {\n    // here we stand up the servers\n    let (pool, _servers, config) = start_test_server().await;\n\n    let api_port = config.read().api_port;\n    // let apiserver = servers.apiserver.unwrap();\n\n    let user = insert_test_user(\u0026pool).await;\n    println!(\"Created user... {user:?}\");\n\n    println!(\"Creating token for user\");\n    let token = insert_test_user_api_token(\u0026pool, user.id.expect(\"no user id found\"))\n        .await\n        .unwrap();\n    println!(\"Created token... {token:?}\");\n\n    let client = reqwest::ClientBuilder::new()\n        .danger_accept_invalid_certs(true)\n        .cookie_store(true)\n        .timeout(std::time::Duration::from_secs(5))\n        .build()\n        .unwrap();\n\n    println!(\"Logging in with the token...\");\n    let res = client\n        .post(\u0026format!(\"https://localhost:{api_port}/api/login\"))\n        .timeout(std::time::Duration::from_secs(5))\n        .json(\u0026AuthPayload {\n            token_key: token.token_key,\n            token_secret: token.token_secret.to_owned(),\n        })\n        .send()\n        .await\n        .unwrap();\n    println!(\"{:?}\", res);\n    assert_eq!(res.status(), 200);\n    println!(\"=\u003e Token login success!\");\n\n    let newzone = FileZone {\n        id: Some(1234),\n        name: \"example.goat\".to_string(),\n        rname: \"bob@example.goat\".to_string(),\n        serial: 12345,\n        expire: 30,\n        minimum: 1235,\n        ..Default::default()\n    };\n\n    println!(\"Sending zone create\");\n    let res = client\n        .post(\u0026format!(\"https://localhost:{api_port}/api/zone\"))\n        .json(\u0026newzone)\n        .send()\n        .await\n        .unwrap();\n\n    assert_eq!(res.status(), 200);\n    let res_content = res.bytes().await;\n    println!(\"content from create: {res_content:?}\");\n\n    println!(\"Sending zone delete\");\n    let res = client\n        .delete(\u0026format!(\"https://localhost:{api_port}/api/zone/1234\"))\n        .send()\n        .await\n        .unwrap();\n\n    assert_eq!(res.status(), 200);\n    let res_content = res.bytes().await;\n    println!(\"content from delete: {res_content:?}\");\n\n    drop(pool);\n    Ok(())\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn api_zone_create_update() -\u003e Result\u003c(), GoatNsError\u003e {\n    // here we stand up the servers\n    let (pool, _servers, config) = start_test_server().await;\n\n    let api_port = config.read().api_port;\n    // let apiserver = servers.apiserver.unwrap();\n\n    let user = insert_test_user(\u0026pool).await;\n    println!(\"Created user... {user:?}\");\n\n    println!(\"Creating token for user\");\n    let token = insert_test_user_api_token(\u0026pool, user.id.expect(\"no user id found\"))\n        .await\n        .unwrap();\n    println!(\"Created token... {token:?}\");\n\n    let client = reqwest::ClientBuilder::new()\n        .danger_accept_invalid_certs(true)\n        .cookie_store(true)\n        .timeout(std::time::Duration::from_secs(5))\n        .build()\n        .unwrap();\n\n    println!(\"Logging in with the token...\");\n    let res = client\n        .post(\u0026format!(\"https://localhost:{api_port}/api/login\"))\n        .timeout(std::time::Duration::from_secs(5))\n        .json(\u0026AuthPayload {\n            token_key: token.token_key,\n            token_secret: token.token_secret.to_owned(),\n        })\n        .send()\n        .await\n        .unwrap();\n    println!(\"{:?}\", res);\n    assert_eq!(res.status(), 200);\n    println!(\"=\u003e Token login success!\");\n\n    let newzone = FileZone {\n        id: Some(1234),\n        name: \"example.goat\".to_string(),\n        rname: \"bob@example.goat\".to_string(),\n        serial: 12345,\n        expire: 30,\n        minimum: 1235,\n        ..Default::default()\n    };\n    println!(\"Saving zone\");\n    newzone.save(\u0026pool).await?;\n    println!(\"Saving zone ownership\");\n    ZoneOwnership {\n        id: None,\n        userid: user.id.expect(\"No user id\"),\n        zoneid: newzone.id.expect(\"No zone id\"),\n    }\n    .save(\u0026pool)\n    .await?;\n\n    println!(\"updating zone rname to steve@example.goat\");\n    let newzone = FileZone {\n        rname: \"steve@example.goat\".to_string(),\n        ..newzone\n    };\n\n    println!(\"Sending zone update\");\n    let res = client\n        .put(\u0026format!(\"https://localhost:{api_port}/api/zone\",))\n        .json(\u0026newzone)\n        .send()\n        .await\n        .unwrap();\n\n    assert_eq!(res.status(), 200);\n    let res_content = res.bytes().await;\n    println!(\"content from patch: {res_content:?}\");\n\n    drop(pool);\n    Ok(())\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn api_record_create() -\u003e Result\u003c(), GoatNsError\u003e {\n    // here we stand up the servers\n    let (pool, _servers, config) = start_test_server().await;\n    let api_port = config.read().api_port;\n    let user = insert_test_user(\u0026pool).await;\n    println!(\"Created user... {user:?}\");\n    println!(\"Creating token for user\");\n    let token = insert_test_user_api_token(\u0026pool, user.id.expect(\"no user id found\"))\n        .await\n        .unwrap();\n    println!(\"Created token... {token:?}\");\n\n    let client = reqwest::ClientBuilder::new()\n        .danger_accept_invalid_certs(true)\n        .cookie_store(true)\n        .timeout(std::time::Duration::from_secs(5))\n        .build()\n        .unwrap();\n\n    println!(\"Logging in with the token...\");\n    let res = client\n        .post(\u0026format!(\"https://localhost:{api_port}/api/login\"))\n        .timeout(std::time::Duration::from_secs(5))\n        .json(\u0026AuthPayload {\n            token_key: token.token_key,\n            token_secret: token.token_secret.to_owned(),\n        })\n        .send()\n        .await\n        .unwrap();\n    println!(\"{:?}\", res);\n    assert_eq!(res.status(), 200);\n    println!(\"=\u003e Token login success!\");\n\n    let zone = FileZone {\n        id: Some(333),\n        name: \"example.goat\".to_string(),\n        rname: \"bob@example.goat\".to_string(),\n        serial: 12345,\n        expire: 30,\n        minimum: 1235,\n        ..Default::default()\n    }\n    .save(\u0026pool)\n    .await\n    .unwrap();\n\n    let zo = ZoneOwnership {\n        id: None,\n        userid: user.id.expect(\"no user id found\"),\n        zoneid: zone.id.unwrap(),\n    };\n    println!(\"ZO: {zo:?}\");\n    zo.save(\u0026pool).await.unwrap();\n\n    println!(\"building fzr object\");\n    let fzr = FileZoneRecord {\n        id: Some(3),\n        class: crate::enums::RecordClass::Internet,\n        name: \"doggo\".to_string(),\n        zoneid: Some(333),\n        rrtype: RecordType::A.to_string(),\n        ttl: 33,\n        rdata: \"1.2.3.4\".to_string(),\n    };\n    println!(\"Sending record create\");\n    let res = client\n        .post(\u0026format!(\"https://localhost:{api_port}/api/record\"))\n        .header(\"Authorization\", format!(\"Bearer {}\", token.token_secret))\n        .json(\u0026fzr)\n        .send()\n        .await\n        .unwrap();\n\n    assert_eq!(res.status(), 200);\n    let response_record: FileZoneRecord = res\n        .json()\n        .await\n        .inspect_err(|err| eprintln!(\"Failed to get response content: {err:?}\"))?;\n    assert_eq!(response_record.name, \"doggo\");\n    drop(pool);\n    Ok(())\n}\n\n#[tokio::test(flavor = \"multi_thread\", worker_threads = 4)]\nasync fn api_record_delete() -\u003e Result\u003c(), GoatNsError\u003e {\n    // here we stand up the servers\n    let (pool, _servers, config) = start_test_server().await;\n    let api_port = config.read().api_port;\n    let user = insert_test_user(\u0026pool).await;\n    println!(\"Created user... {user:?}\");\n    println!(\"Creating token for user\");\n    let token = insert_test_user_api_token(\u0026pool, user.id.expect(\"no user id found\"))\n        .await\n        .unwrap();\n    println!(\"Created token... {token:?}\");\n\n    let client = reqwest::ClientBuilder::new()\n        .danger_accept_invalid_certs(true)\n        .cookie_store(true)\n        .timeout(std::time::Duration::from_secs(5))\n        .build()\n        .unwrap();\n\n    println!(\"Logging in with the token...\");\n    let res = match client\n        .post(\u0026format!(\"https://localhost:{api_port}/api/login\"))\n        .timeout(std::time::Duration::from_secs(5))\n        .timeout(std::time::Duration::from_secs(5))\n        .json(\u0026AuthPayload {\n            token_key: token.token_key,\n            token_secret: token.token_secret.to_owned(),\n        })\n        .send()\n        .await\n    {\n        Ok(value) =\u003e value,\n        Err(err) =\u003e {\n            eprintln!(\"Failed to send login request: {err:?}\");\n            return Err(GoatNsError::StartupError(\n                \"Failed to send login request\".to_string(),\n            ));\n        }\n    };\n    println!(\"{:?}\", res);\n    assert_eq!(res.status(), 200);\n    println!(\"=\u003e Token login success!\");\n\n    let zone = FileZone {\n        id: Some(333),\n        name: \"example.goat\".to_string(),\n        rname: \"bob@example.goat\".to_string(),\n        serial: 12345,\n        expire: 30,\n        minimum: 1235,\n        ..Default::default()\n    }\n    .save(\u0026pool)\n    .await\n    .unwrap();\n\n    let zo = ZoneOwnership {\n        id: None,\n        userid: user.id.expect(\"no user id found\"),\n        zoneid: zone.id.unwrap(),\n    };\n    println!(\"ZO: {zo:?}\");\n    zo.save(\u0026pool).await.unwrap();\n\n    println!(\"creating fzr object in the database\");\n    let fzr = FileZoneRecord {\n        id: Some(3),\n        class: crate::enums::RecordClass::Internet,\n        name: \"doggo\".to_string(),\n        zoneid: Some(333),\n        rrtype: RecordType::A.to_string(),\n        ttl: 33,\n        rdata: \"1.2.3.4\".to_string(),\n    }\n    .save(\u0026pool)\n    .await?;\n\n    println!(\"{fzr:?}\");\n\n    println!(\"Sending record delete\");\n    let res = client\n        .delete(\u0026format!(\"https://localhost:{api_port}/api/record/3\"))\n        .header(\"Authorization\", format!(\"Bearer {}\", token.token_secret))\n        .send()\n        .await\n        .expect(\"Failed to send delete request\");\n\n    let status = res.status();\n    println!(\"Response content: {:?}\", res.text().await);\n\n    assert_eq!(status, 200);\n\n    drop(pool);\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","tests","test_harness.rs"],"content":"use sqlx::{Pool, Sqlite};\n\nuse crate::datastore::handle_import_file;\nuse crate::db::{DBEntity, User};\nuse crate::error::GoatNsError;\n\npub async fn import_test_zone_file(pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003c(), GoatNsError\u003e {\n    println!(\"#####################################################################\");\n    println!(\"importing test zone ./examples/test_config/zones.json\");\n    println!(\"#####################################################################\");\n    handle_import_file(\n        \u0026pool,\n        \"./examples/test_config/zones.json\".to_string(),\n        Some(\"hello.goat\".to_string()),\n    )\n    .await\n    .map_err(|e| GoatNsError::Generic(format!(\"Failed to import test zones.json: {e:?}\")))?;\n    println!(\"#####################################################################\");\n    println!(\"finished importing test zone ./examples/test_config/zones.json\");\n    println!(\"#####################################################################\");\n    Ok(())\n}\n\npub async fn create_test_user(pool: \u0026Pool\u003cSqlite\u003e) -\u003e Result\u003cBox\u003cUser\u003e, GoatNsError\u003e {\n    println!(\"Creating User\");\n    Ok(User {\n        id: None,\n        displayname: \"Testuser\".to_string(),\n        username: \"testuser\".to_string(),\n        email: \"billy@dotgoat.net\".to_string(),\n        disabled: false,\n        authref: None,\n        admin: false,\n    }\n    .save(\u0026pool)\n    .await?)\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","tests","utils.rs"],"content":"use std::str::from_utf8;\n\nuse url::Url;\n\nuse crate::utils::{check_valid_tld, find_tail_match, loc_size_to_u8, name_as_bytes};\nuse std::thread::sleep;\nuse std::time::Duration;\n\n/// Test function to keep checking the server for startup\n#[cfg(test)]\npub async fn wait_for_server(status_url: Url) {\n    let client = reqwest::ClientBuilder::new()\n        .danger_accept_invalid_certs(true)\n        .read_timeout(std::time::Duration::from_secs(1))\n        .timeout(std::time::Duration::from_secs(1))\n        .build()\n        .unwrap();\n    for i in 0..10 {\n        match client\n            .get(status_url.clone())\n            .timeout(std::time::Duration::from_secs(1))\n            .send()\n            .await\n        {\n            Ok(value) =\u003e {\n                eprintln!(\"OK: {value:?}\");\n                if let Ok(text) = value.text().await {\n                    eprintln!(\"Server response: {text}\");\n                    if text == crate::web::STATUS_OK.to_string() {\n                        println!(\"API is up!\");\n                        break;\n                    }\n                }\n            }\n            Err(err) =\u003e eprintln!(\"ERR: {err:?}\"),\n        }\n        sleep(Duration::from_secs(1));\n        assert!(i \u003c 10, \"Couldn't connect to test server after 10 seconds!\");\n    }\n}\n\n#[test]\nfn test_loc_size_to_u8() {\n    assert_eq!(loc_size_to_u8(10.0), 0x13);\n    assert_eq!(loc_size_to_u8(100.0), 0x14);\n    eprintln!(\"testing 90000000.0 = 0x99\");\n    assert_eq!(loc_size_to_u8(90000000.0), 0x99);\n    eprintln!(\"{:3x}\", loc_size_to_u8(20000000.0));\n}\n\n#[test]\npub fn test_find_tail_match() {\n    let name = \"foo.example.com\".as_bytes().to_vec();\n    let target = \"zot.example.com\".as_bytes().to_vec();\n    let result = find_tail_match(\u0026name, \u0026target);\n\n    assert_eq!(result, 3);\n    let name = \"foo.yeanah.xyz\".as_bytes().to_vec();\n    let target = \"zot.example.com\".as_bytes().to_vec();\n    let result = find_tail_match(\u0026name, \u0026target);\n\n    assert_eq!(result, 0)\n}\n\n#[test]\npub fn test_name_bytes_simple_compress() {\n    let expected_result: Vec\u003cu8\u003e = vec![192, 12];\n\n    let test_result =\n        name_as_bytes(\"example.com\".as_bytes(), Some(12), None).expect(\"Failed to parse name\");\n    assert_eq!(expected_result, test_result);\n}\n#[test]\npub fn test_name_bytes_no_compress() {\n    let expected_result: Vec\u003cu8\u003e = vec![7, 101, 120, 97, 109, 112, 108, 101, 3, 99, 111, 109, 0];\n\n    let test_result =\n        name_as_bytes(\"example.com\".as_bytes(), None, None).expect(\"Failed to parse name\");\n    assert_eq!(expected_result, test_result);\n}\n\n#[test]\npub fn test_name_bytes_with_compression() {\n    let example_com = \"example.com\".as_bytes().to_vec();\n    let test_input = \"lol.example.com\".as_bytes();\n\n    let expected_result: Vec\u003cu8\u003e = vec![3, 108, 111, 108, 192, 12];\n\n    println!(\"{:?}\", from_utf8(\u0026example_com));\n    println!(\"{:?}\", from_utf8(\u0026test_input));\n\n    let result =\n        name_as_bytes(test_input, Some(12), Some(\u0026example_com)).expect(\"Failed to parse name\");\n\n    assert_eq!(result, expected_result);\n}\n\n#[test]\npub fn test_name_bytes_with_tail_compression() {\n    let example_com = \"ns1.example.com\".as_bytes().to_vec();\n    let test_input = \"lol.example.com\".as_bytes();\n\n    let expected_result: Vec\u003cu8\u003e = vec![3, 108, 111, 108, 192, 16];\n\n    println!(\"{:?}\", from_utf8(\u0026example_com));\n    println!(\"{:?}\", from_utf8(\u0026test_input));\n\n    let result =\n        name_as_bytes(test_input, Some(12), Some(\u0026example_com)).expect(\"Failed to parse name\");\n\n    assert_eq!(result, expected_result);\n}\n\n#[test]\nfn test_test_valid_tld() {\n    // empty list\n    let valid_tlds = vec![];\n    let zone_name = \"hello.example.goat\";\n    assert_eq!(check_valid_tld(\u0026zone_name, \u0026valid_tlds), true);\n\n    let valid_tlds = vec![\"goat\".to_string()];\n    let zone_name = \"hello.example.goat\";\n    assert_eq!(check_valid_tld(\u0026zone_name, \u0026valid_tlds), true);\n\n    let valid_tlds = vec![\"cheese\".to_string()];\n    let zone_name = \"hello.example.goat\";\n    assert_eq!(check_valid_tld(\u0026zone_name, \u0026valid_tlds), false);\n\n    let valid_tlds = vec![\"goat\".to_string()];\n    let zone_name = \"hello.example.happygoat\";\n    assert_eq!(check_valid_tld(\u0026zone_name, \u0026valid_tlds), false);\n\n    let valid_tlds = vec![\"goat\".to_string()];\n    let zone_name = \"hello.example.goat.cheese\";\n    assert_eq!(check_valid_tld(\u0026zone_name, \u0026valid_tlds), false);\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","utils.rs"],"content":"use crate::datastore::Command;\nuse crate::enums::AgentState;\nuse crate::error::GoatNsError;\nuse crate::HEADER_BYTES;\nuse log::{debug, trace};\nuse std::str::from_utf8;\nuse tokio::sync::{broadcast, mpsc};\n\npub fn vec_find(item: u8, search: \u0026[u8]) -\u003e Option\u003cusize\u003e {\n    for (index, curr_byte) in search.iter().enumerate() {\n        if \u0026(item) == curr_byte {\n            return Some(index);\n        }\n    }\n    None\n}\n\n/// does the conversion from \"example.com\" to \"7example3com\" BUT DOES NOT DO THE TRAILING NULL BECAUSE REASONS\nfn seven_dot_three_conversion(name: \u0026[u8]) -\u003e Vec\u003cu8\u003e {\n    trace!(\"7.3 conversion for {name:?} {:?}\", from_utf8(name));\n    let mut result: Vec\u003cu8\u003e = vec![];\n\n    // TODO: reimplement this with slices and stuff\n    let mut next_dot: usize = match vec_find(46, name) {\n        Some(value) =\u003e value,\n        None =\u003e {\n            // if there's no dots, then just push a length on the front and include the data. then bail\n            result.push(name.len() as u8);\n            result.extend(name);\n            return result;\n        }\n    };\n    let mut name_bytes: Vec\u003cu8\u003e = name.to_vec();\n    let mut keep_looping = true;\n    let mut current_position: usize = 0;\n    // add the first segment length\n    result.push(next_dot as u8);\n\n    while keep_looping {\n        if next_dot == current_position {\n            name_bytes = name_bytes.to_vec()[current_position + 1..].into();\n            next_dot = match vec_find(46, \u0026name_bytes) {\n                Some(value) =\u003e value,\n                None =\u003e name_bytes.len(),\n            };\n            current_position = 0;\n            // this should be the\n            // debug!(\". - {:?} ({:?})\", next_dot, name_bytes);\n            if next_dot != 0 {\n                result.push(next_dot as u8);\n                trace!(\"pushing next_dot {}\", next_dot as u8);\n            }\n        } else {\n            // we are processing bytes\n            trace!(\"pushing {}\", name_bytes[current_position]);\n            result.push(name_bytes[current_position]);\n            // debug!(\"{:?} {:?}\", current_position, name_bytes.as_bytes()[current_position]);\n            current_position += 1;\n        }\n        if current_position == name_bytes.len() {\n            keep_looping = false;\n        }\n    }\n    result\n}\n\n/// If you have a `name` and a `target` and want to see if you can find a chunk of the `target` that the `name` ends with, this is your function!\npub fn find_tail_match(name: \u0026[u8], target: \u0026Vec\u003cu8\u003e) -\u003e usize {\n    // #[cfg(debug)]\n    // {\n    let name_str = format!(\"{name:?}\");\n    let target_str = format!(\"{target:?}\");\n    let longest = match name_str.len() \u003e target_str.len() {\n        true =\u003e name_str.len(),\n        false =\u003e target_str.len(),\n    };\n    trace!(\"find_tail_match(\\n  name={name_str:\u003elongest$}, \\ntarget={target_str:\u003elongest$}\\n)\",);\n    // }\n    let mut tail_index: usize = 0;\n    for (i, _) in target.iter().enumerate() {\n        trace!(\"Tail index={i}\");\n        let tail = \u0026target[i..];\n        if name.ends_with(tail) {\n            trace!(\"Found a tail at index {i}\");\n            tail_index = i;\n            break;\n        } else {\n            trace!(\"Didn't match: name / target \\n{name:?}\\n{:?}\", \u0026target[i..]);\n        }\n    }\n    tail_index\n}\n\n/*\nturn the NAME field into the bytes for a response\n\nso example.com turns into\n\n(7)example(3)com(0)\n\ncompress_target is the index of the octet in the response to point the response at\nwhich should typically be the qname in the question bytes\n\ncompress_reference is the vec of bytes of the compression target, ie this is the kind of terrible thing you should do\nname_as_bytes(\n    \"lol.example.com\".as_bytes().to_vec(),\n    Some(12),\n    Some(\"example.com\".as_bytes().to_vec())\n)\n*/\npub fn name_as_bytes(\n    name: \u0026[u8],\n    compress_target: Option\u003cu16\u003e,\n    compress_reference: Option\u003c\u0026Vec\u003cu8\u003e\u003e,\n) -\u003e Result\u003cVec\u003cu8\u003e, GoatNsError\u003e {\n    trace!(\"################################\");\n    match from_utf8(name) {\n        Ok(nstr) =\u003e trace!(\"name_as_bytes name={nstr:?} compress_target={compress_target:?} compress_reference={compress_reference:?}\"),\n        Err(_) =\u003e  trace!(\"failed to utf-8 name name_as_bytes name={name:?} compress_target={compress_target:?} compress_reference={compress_reference:?}\"),\n    };\n\n    // if we're given a compression target and no reference just compress it and return\n    if let (Some(target), None) = (compress_target, compress_reference) {\n        trace!(\"we got a compress target ({target}) but no reference we're just going to compress\");\n        // we need the first two bits to be 1, to mark it as compressed\n        // 4.1.4 RFC1035 - https://www.rfc-editor.org/rfc/rfc1035.html#section-4.1.4\n        let result: Vec\u003cu8\u003e = (0b1100000000000000 | target).to_be_bytes().into();\n        trace!(\"result of name_as_bytes {result:?}\");\n        return Ok(result);\n    };\n\n    let mut result: Vec\u003cu8\u003e = vec![];\n    // if somehow it's a weird bare domain then we don't have to do much it\n    if !name.contains(\u002646) {\n        result.push(name.len() as u8);\n        result.extend(name);\n        result.push(0); // null pad the name\n        return Ok(result);\n    }\n    result = seven_dot_three_conversion(name);\n\n    if compress_target.is_none() {\n        trace!(\"no compression target, adding the trailing null and returning!\");\n        result.push(0);\n        return Ok(result);\n    };\n\n    if let Some(ct) = compress_reference {\n        trace!(\"you gave me {ct:?} as a compression reference\");\n\n        if name == ct {\n            trace!(\"The thing we're converting is the same as the compression reference!\");\n            // return a pointer to the target_byte (probably the name in the header)\n            if let Some(target) = compress_target {\n                let result: u16 = 0b1100000000000000 | target;\n                return Ok(result.to_be_bytes().to_vec());\n            } else {\n                return Err(GoatNsError::InvalidName);\n            }\n        }\n        if name.ends_with(ct) {\n            trace!(\"the name ends with the target! woo!\");\n            // Ok, we've gotten this far. We need to slice off the \"front\" of the string and return that.\n            result.clone_from(\u0026name.to_vec());\n            result.truncate(name.len() - ct.len());\n            trace!(\"The result is trimmed and now {:?}\", from_utf8(\u0026result));\n\n            // do the 7.3 conversion\n            result = seven_dot_three_conversion(\u0026result);\n            trace!(\"7.3converted: {:?}\", from_utf8(\u0026result));\n\n            // then we need to return the pointer to the tail\n            if let Some(target) = compress_target {\n                let pointer_bytes: u16 = 0b1100000000000000 | target;\n                result.extend(pointer_bytes.to_be_bytes());\n            } else {\n                return Err(GoatNsError::BytePackingError(\n                    \"No compression target and we totally could have compressed this.\".to_string(),\n                ));\n            }\n\n            trace!(\"The result is trimmed and now {:?}\", result);\n        } else {\n            // dropped into tail-finding mode where we're looking for a sub-string of the parent to target a compression pointer\n            trace!(\"trying to find a sub-part of {ct:?} in {name:?}\");\n\n            let tail_index = find_tail_match(name, ct);\n            trace!(\"tail_index: {tail_index}\");\n            // if we get to here and the tail_index is 0 then we haven't set it - because we'd have caught the whole thing in the ends_with matcher earlier.\n            if tail_index != 0 {\n                trace!(\"Found a tail-match: {tail_index}\");\n                // slice the tail off the name\n                let mut name_copy = name.to_vec();\n                // the amount of the tail that matched to the name, ie abc, bc = 2, aab, bbb = 1\n                let matched_length = ct.len() - tail_index;\n                name_copy.truncate(name.len() - matched_length);\n                trace!(\"sliced name down to {name_copy:?}\");\n                // put the pointer on there\n                result = seven_dot_three_conversion(\u0026name_copy);\n                trace!(\"converted result to {result:?}\");\n                let pointer: u16 = 0b1100000000000000 | (HEADER_BYTES + tail_index + 1) as u16;\n                result.extend(pointer.to_be_bytes());\n            }\n        }\n    }\n    trace!(\"Final result {result:?}\");\n    Ok(result)\n}\n\n// lazy_static!{\n//     static ref GOATNS_VERSION: DNSCharString = DNSCharString::from(format!(\"GoatNS {}\", env!(\"CARGO_PKG_VERSION\")).as_str());\n// }\n\n// lazy_static!{\n//     static ref VERSION_RESPONSE: Vec\u003cInternalResourceRecord\u003e = vec![InternalResourceRecord::TXT {\n//         class: RecordClass::Chaos,\n//         ttl: 1,\n//         txtdata: GOATNS_VERSION.to_owned(),\n//     }];\n// }\n\n// pub fn reply_version(id: \u0026u16, question: \u0026Option\u003ccrate::Question\u003e) -\u003e Result\u003cReply, String\u003e {\n//     let mut reply = reply_builder(id.to_owned(), Rcode::NoError)?;\n//     reply.question = question.to_owned();\n//     reply.answers = VERSION_RESPONSE.clone();\n//     reply.header.ancount = 1;\n//     debug!(\"Version: {reply:?}\");\n//     debug!(\"Goatns version: {:?}\", GOATNS_VERSION.to_owned());\n//     Ok(reply)\n// }\n\n/// dumps the bytes out as if you were using some kind of fancy packet-dumper\npub fn hexdump(bytes: \u0026[u8]) -\u003e Result\u003c(), GoatNsError\u003e {\n    for byte in bytes.chunks(2) {\n        let byte0_alpha = match byte[0].is_ascii_alphanumeric() {\n            true =\u003e from_utf8(byte[0..1].into())?,\n            false =\u003e \" \",\n        };\n        match byte.len() {\n            2 =\u003e {\n                let byte1_alpha = match byte[1].is_ascii_alphanumeric() {\n                    true =\u003e from_utf8(byte[1..2].into())?,\n                    false =\u003e \" \",\n                };\n\n                debug!(\n                    \"{:02x} {:02x} {:#010b} {:#010b} {:3} {:3} {byte0_alpha} {byte1_alpha}\",\n                    byte[0], byte[1], byte[0], byte[1], byte[0], byte[1],\n                );\n            }\n            _ =\u003e {\n                debug!(\n                    \"{:02x}    {:#010b}    {:3} {byte0_alpha}\",\n                    byte[0], byte[0], byte[0],\n                );\n            }\n        }\n    }\n    Ok(())\n}\n\n/// turn a degrees/minutes/seconds format into unsigned 32-bit integer matching the format\n/// required for a DNS LOC record\n///\n/// when positive = true, you're North or West\npub fn dms_to_u32(deg: u8, min: u8, sec: f32, positive: bool) -\u003e u32 {\n    let secsfrac = sec % 1f32;\n\n    let dms_multiplied: u32 = (((((deg as u32 * 60) + min as u32) * 60) + sec as u32) * 1000)\n        + (secsfrac * 1000.0) as u32;\n\n    match positive {\n        true =\u003e 2u32.pow(31) + dms_multiplied,\n        false =\u003e 2u32.pow(31) - dms_multiplied,\n    }\n}\n\n/// converts size/precision X * 10**Y(cm) to 0xXY\n/// This code is ported from the C code in RFC1876 (Appendix A, precsize_aton)\n#[allow(dead_code)]\npub fn loc_size_to_u8(input: f32) -\u003e u8 {\n    let mut mantissa: u8;\n\n    let cmval = input * 100.0;\n\n    let mut exponent = 0;\n    for i in 0..10 {\n        if (cmval as f64) \u003c (10u64.pow(i + 1) as f64) {\n            exponent = i;\n            // eprintln!(\"CMVAL: {cmval} Exponent #{i} {}\", (poweroften[i+1] as u64));\n            break;\n        }\n    }\n    // eprintln!(\"{:?}\", ((cmval as f64) / (poweroften[exponent] as f64) ).ceil());\n    mantissa = ((cmval as f64) / (10u64.pow(exponent) as f64)).ceil() as u8;\n    if mantissa \u003e 9u8 {\n        mantissa = 9u8;\n    }\n    // eprintln!(\"mantissa: {mantissa}, exponent: {exponent}\");\n    // turn it into the magic ugly numbers\n    let retval: u8 = (mantissa \u003c\u003c 4) | (exponent as u8);\n    retval\n}\n\n/// Get all the widgets for agent signalling\npub fn start_channels() -\u003e (\n    broadcast::Sender\u003cAgentState\u003e,\n    mpsc::Sender\u003cCommand\u003e,\n    mpsc::Receiver\u003cCommand\u003e,\n) {\n    let (agent_tx, _) = broadcast::channel(32);\n    let datastore_sender: mpsc::Sender\u003cCommand\u003e;\n    let datastore_receiver: mpsc::Receiver\u003cCommand\u003e;\n    (datastore_sender, datastore_receiver) = mpsc::channel(crate::MAX_IN_FLIGHT);\n    (agent_tx, datastore_sender, datastore_receiver)\n}\n\n/// Compares the TLD to the list of valid TLDs - usually from `allowed_tlds` in [crate::config::ConfigFile]\n///```\n/// use goatns::utils::check_valid_tld;\n///\n/// let valid_tlds = vec![];\n/// let zone_name = \"hello.example.goat\";\n/// assert_eq!(check_valid_tld(\u0026zone_name, \u0026valid_tlds), true);\n///\n/// let valid_tlds = vec![\"goat\".to_string()];\n/// let zone_name = \"hello.example.goat\";\n/// assert_eq!(check_valid_tld(\u0026zone_name, \u0026valid_tlds), true);\n///\n/// let valid_tlds = vec![\"cheese\".to_string()];\n/// let zone_name = \"hello.example.goat\";\n/// assert_eq!(check_valid_tld(\u0026zone_name, \u0026valid_tlds), false);\n/// ```\npub fn check_valid_tld(zone_name: \u0026str, allowed_tlds: \u0026[String]) -\u003e bool {\n    if allowed_tlds.is_empty() {\n        return true;\n    }\n    for tld in allowed_tlds.iter() {\n        if zone_name.ends_with(\u0026format!(\".{tld}\")) {\n            return true;\n        }\n    }\n    false\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":42}},{"line":10,"address":[],"length":0,"stats":{"Line":250}},{"line":11,"address":[],"length":0,"stats":{"Line":208}},{"line":12,"address":[],"length":0,"stats":{"Line":23}},{"line":15,"address":[],"length":0,"stats":{"Line":19}},{"line":19,"address":[],"length":0,"stats":{"Line":19}},{"line":20,"address":[],"length":0,"stats":{"Line":19}},{"line":21,"address":[],"length":0,"stats":{"Line":19}},{"line":24,"address":[],"length":0,"stats":{"Line":17}},{"line":25,"address":[],"length":0,"stats":{"Line":17}},{"line":28,"address":[],"length":0,"stats":{"Line":2}},{"line":29,"address":[],"length":0,"stats":{"Line":2}},{"line":30,"address":[],"length":0,"stats":{"Line":2}},{"line":33,"address":[],"length":0,"stats":{"Line":17}},{"line":34,"address":[],"length":0,"stats":{"Line":17}},{"line":35,"address":[],"length":0,"stats":{"Line":17}},{"line":37,"address":[],"length":0,"stats":{"Line":17}},{"line":39,"address":[],"length":0,"stats":{"Line":216}},{"line":40,"address":[],"length":0,"stats":{"Line":199}},{"line":41,"address":[],"length":0,"stats":{"Line":23}},{"line":42,"address":[],"length":0,"stats":{"Line":23}},{"line":43,"address":[],"length":0,"stats":{"Line":6}},{"line":44,"address":[],"length":0,"stats":{"Line":17}},{"line":46,"address":[],"length":0,"stats":{"Line":23}},{"line":49,"address":[],"length":0,"stats":{"Line":23}},{"line":50,"address":[],"length":0,"stats":{"Line":20}},{"line":51,"address":[],"length":0,"stats":{"Line":20}},{"line":55,"address":[],"length":0,"stats":{"Line":176}},{"line":56,"address":[],"length":0,"stats":{"Line":176}},{"line":58,"address":[],"length":0,"stats":{"Line":176}},{"line":60,"address":[],"length":0,"stats":{"Line":216}},{"line":61,"address":[],"length":0,"stats":{"Line":17}},{"line":64,"address":[],"length":0,"stats":{"Line":17}},{"line":68,"address":[],"length":0,"stats":{"Line":4}},{"line":71,"address":[],"length":0,"stats":{"Line":4}},{"line":72,"address":[],"length":0,"stats":{"Line":4}},{"line":73,"address":[],"length":0,"stats":{"Line":8}},{"line":74,"address":[],"length":0,"stats":{"Line":2}},{"line":75,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":4}},{"line":79,"address":[],"length":0,"stats":{"Line":4}},{"line":80,"address":[],"length":0,"stats":{"Line":28}},{"line":81,"address":[],"length":0,"stats":{"Line":28}},{"line":82,"address":[],"length":0,"stats":{"Line":28}},{"line":83,"address":[],"length":0,"stats":{"Line":28}},{"line":84,"address":[],"length":0,"stats":{"Line":3}},{"line":85,"address":[],"length":0,"stats":{"Line":3}},{"line":86,"address":[],"length":0,"stats":{"Line":3}},{"line":88,"address":[],"length":0,"stats":{"Line":25}},{"line":91,"address":[],"length":0,"stats":{"Line":4}},{"line":111,"address":[],"length":0,"stats":{"Line":19}},{"line":116,"address":[],"length":0,"stats":{"Line":19}},{"line":117,"address":[],"length":0,"stats":{"Line":19}},{"line":118,"address":[],"length":0,"stats":{"Line":19}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":23}},{"line":124,"address":[],"length":0,"stats":{"Line":4}},{"line":127,"address":[],"length":0,"stats":{"Line":4}},{"line":128,"address":[],"length":0,"stats":{"Line":4}},{"line":129,"address":[],"length":0,"stats":{"Line":4}},{"line":132,"address":[],"length":0,"stats":{"Line":15}},{"line":134,"address":[],"length":0,"stats":{"Line":15}},{"line":135,"address":[],"length":0,"stats":{"Line":1}},{"line":136,"address":[],"length":0,"stats":{"Line":1}},{"line":137,"address":[],"length":0,"stats":{"Line":1}},{"line":138,"address":[],"length":0,"stats":{"Line":1}},{"line":140,"address":[],"length":0,"stats":{"Line":14}},{"line":142,"address":[],"length":0,"stats":{"Line":14}},{"line":143,"address":[],"length":0,"stats":{"Line":9}},{"line":144,"address":[],"length":0,"stats":{"Line":9}},{"line":145,"address":[],"length":0,"stats":{"Line":9}},{"line":148,"address":[],"length":0,"stats":{"Line":5}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":5}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":5}},{"line":162,"address":[],"length":0,"stats":{"Line":3}},{"line":164,"address":[],"length":0,"stats":{"Line":3}},{"line":165,"address":[],"length":0,"stats":{"Line":3}},{"line":166,"address":[],"length":0,"stats":{"Line":3}},{"line":169,"address":[],"length":0,"stats":{"Line":3}},{"line":170,"address":[],"length":0,"stats":{"Line":3}},{"line":173,"address":[],"length":0,"stats":{"Line":6}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":2}},{"line":187,"address":[],"length":0,"stats":{"Line":2}},{"line":188,"address":[],"length":0,"stats":{"Line":2}},{"line":190,"address":[],"length":0,"stats":{"Line":2}},{"line":191,"address":[],"length":0,"stats":{"Line":2}},{"line":193,"address":[],"length":0,"stats":{"Line":2}},{"line":195,"address":[],"length":0,"stats":{"Line":2}},{"line":196,"address":[],"length":0,"stats":{"Line":2}},{"line":197,"address":[],"length":0,"stats":{"Line":2}},{"line":199,"address":[],"length":0,"stats":{"Line":2}},{"line":200,"address":[],"length":0,"stats":{"Line":2}},{"line":201,"address":[],"length":0,"stats":{"Line":2}},{"line":202,"address":[],"length":0,"stats":{"Line":2}},{"line":206,"address":[],"length":0,"stats":{"Line":5}},{"line":207,"address":[],"length":0,"stats":{"Line":5}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":2}},{"line":267,"address":[],"length":0,"stats":{"Line":2}},{"line":269,"address":[],"length":0,"stats":{"Line":2}},{"line":270,"address":[],"length":0,"stats":{"Line":2}},{"line":272,"address":[],"length":0,"stats":{"Line":2}},{"line":273,"address":[],"length":0,"stats":{"Line":2}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":25}},{"line":282,"address":[],"length":0,"stats":{"Line":25}},{"line":284,"address":[],"length":0,"stats":{"Line":25}},{"line":286,"address":[],"length":0,"stats":{"Line":25}},{"line":287,"address":[],"length":0,"stats":{"Line":254}},{"line":289,"address":[],"length":0,"stats":{"Line":25}},{"line":291,"address":[],"length":0,"stats":{"Line":25}},{"line":295,"address":[],"length":0,"stats":{"Line":25}},{"line":296,"address":[],"length":0,"stats":{"Line":25}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":10}},{"line":311,"address":[],"length":0,"stats":{"Line":10}},{"line":312,"address":[],"length":0,"stats":{"Line":10}},{"line":313,"address":[],"length":0,"stats":{"Line":10}},{"line":314,"address":[],"length":0,"stats":{"Line":10}},{"line":315,"address":[],"length":0,"stats":{"Line":10}},{"line":334,"address":[],"length":0,"stats":{"Line":8}},{"line":335,"address":[],"length":0,"stats":{"Line":8}},{"line":336,"address":[],"length":0,"stats":{"Line":4}},{"line":338,"address":[],"length":0,"stats":{"Line":4}},{"line":339,"address":[],"length":0,"stats":{"Line":4}},{"line":340,"address":[],"length":0,"stats":{"Line":1}},{"line":343,"address":[],"length":0,"stats":{"Line":3}}],"covered":123,"coverable":149},{"path":["/","Users","yaleman","Projects","goatns","src","web","api","auth.rs"],"content":"use axum::http::StatusCode;\nuse axum::{extract::State, Json};\nuse serde::{Deserialize, Serialize};\nuse tower_sessions::Session;\nuse tracing::error;\nuse utoipa::ToSchema;\n\nuse crate::db::User;\nuse crate::web::utils::validate_api_token;\nuse crate::web::GoatState;\n\n#[derive(Debug, Serialize, Deserialize, Clone, ToSchema)]\npub struct AuthPayload {\n    pub token_key: String,\n    pub token_secret: String,\n}\n\n#[derive(Debug, Deserialize, Serialize, Clone, ToSchema)]\npub struct AuthResponse {\n    pub message: String,\n}\n\nimpl From\u003cString\u003e for AuthResponse {\n    fn from(message: String) -\u003e Self {\n        AuthResponse { message }\n    }\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/login\",\n    operation_id = \"login\",\n    request_body = AuthPayload,\n    responses(\n        (status = 200, description = \"Login Successful\"),\n        (status = 403, description = \"Auth failed\"),\n        (status = 500, description = \"Something broke!\"),\n    ),\n    tag = \"Authentication\",\n)]\npub async fn login(\n    State(state): State\u003cGoatState\u003e,\n    session: Session,\n    payload: Json\u003cAuthPayload\u003e,\n) -\u003e Result\u003c(StatusCode, Json\u003cAuthResponse\u003e), (StatusCode, Json\u003cAuthResponse\u003e)\u003e {\n    #[cfg(test)]\n    println!(\"Got login payload: {payload:?}\");\n    #[cfg(not(test))]\n    log::debug!(\"Got login payload: {payload:?}\");\n    let mut pool = state.read().await.connpool.clone();\n    let token = match User::get_token(\u0026mut pool, \u0026payload.token_key).await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            log::info!(\n                \"action=api_login tokenkey={} result=failure reason=\\\"no token found\\\"\",\n                payload.token_key\n            );\n            log::debug!(\"Error: {err:?}\");\n            session.flush().await.map_err(|err| {\n                error!(\"Failed to flush session: {err:?}\");\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    Json(AuthResponse::from(\"Failed to flush session!\".to_string())),\n                )\n            })?;\n            let resp = AuthResponse {\n                message: \"token not found\".to_string(),\n            };\n            return Err((StatusCode::UNAUTHORIZED, Json(resp)));\n        }\n    };\n\n    match validate_api_token(\u0026token, \u0026payload.token_secret) {\n        Ok(_) =\u003e {\n            println!(\"Successfully validated token on login\");\n            let session_user = session.insert(\"user\", \u0026token.user).await;\n            let session_authref = session.insert(\"authref\", token.user.authref).await;\n            let session_signin = session.insert(\"signed_in\", true).await;\n\n            if session_authref.is_err() | session_user.is_err() | session_signin.is_err() {\n                session.flush().await.map_err(|err| {\n                    error!(\"Failed to flush session: {err:?}\");\n                    (\n                        StatusCode::INTERNAL_SERVER_ERROR,\n                        Json(AuthResponse::from(\"Failed to flush session!\".to_string())),\n                    )\n                })?;\n                log::info!(\"action=api_login tokenkey={} result=failure reason=\\\"failed to store session for user\\\"\", payload.token_key);\n                return Err((\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    Json(AuthResponse {\n                        message: \"system failure, please contact an admin\".to_string(),\n                    }),\n                ));\n            };\n            log::info!(\"action=api_login user={} result=success\", payload.token_key);\n            Ok((\n                StatusCode::OK,\n                Json(AuthResponse {\n                    message: \"success\".to_string(),\n                }),\n            ))\n        }\n        Err(err) =\u003e {\n            session.flush().await.map_err(|err| {\n                error!(\"Failed to flush session: {err:?}\");\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    Json(AuthResponse::from(\"Failed to flush session!\".to_string())),\n                )\n            })?;\n            #[cfg(test)]\n            println!(\"Failed to validate token! {err:?}\");\n            log::error!(\n        \"action=api_login username={} userid={} tokenkey=\\\"{:?}\\\" result=failure reason=\\\"failed to match token: {err:?}\\\"\",\n        token.user.username,\n        token.user.id.map(|id| id.to_string()).unwrap_or(\"\u003cunknown user id\u003e\".to_string()),\n        payload.token_key,\n        );\n            Err((\n                StatusCode::INTERNAL_SERVER_ERROR,\n                Json(AuthResponse {\n                    message: \"system failure, please contact an admin\".to_string(),\n                }),\n            ))\n        }\n    }\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":5}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":15}},{"line":51,"address":[],"length":0,"stats":{"Line":27}},{"line":52,"address":[],"length":0,"stats":{"Line":5}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":5}},{"line":75,"address":[],"length":0,"stats":{"Line":5}},{"line":76,"address":[],"length":0,"stats":{"Line":5}},{"line":77,"address":[],"length":0,"stats":{"Line":10}},{"line":78,"address":[],"length":0,"stats":{"Line":10}},{"line":80,"address":[],"length":0,"stats":{"Line":5}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":5}},{"line":97,"address":[],"length":0,"stats":{"Line":5}},{"line":98,"address":[],"length":0,"stats":{"Line":5}},{"line":99,"address":[],"length":0,"stats":{"Line":5}},{"line":100,"address":[],"length":0,"stats":{"Line":5}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}}],"covered":15,"coverable":51},{"path":["/","Users","yaleman","Projects","goatns","src","web","api","docs.rs"],"content":"use utoipa::{Modify, OpenApi};\n\nuse crate::zones::FileZoneRecord;\nuse crate::RecordClass;\n\n#[derive(OpenApi)]\n#[openapi(\n    paths(\n        super::auth::login,\n        super::filezonerecord::api_create,\n    ),\n    components(\n        schemas(\n            super::auth::AuthPayload,\n            super::auth::AuthResponse,\n            FileZoneRecord,\n            RecordClass,\n        )\n    ),\n    modifiers(\u0026SecurityAddon),\n    tags(\n        (name = \"Authentication\", description = \"Authentication-related tasks\"),\n        (name = \"Records\", description = \"DNS Record operations\"),\n        (name = \"Zones\", description = \"DNS Zone operations\"),\n    )\n)]\npub(crate) struct ApiDoc;\n\npub(crate) struct SecurityAddon;\n\nimpl Modify for SecurityAddon {\n    fn modify(\u0026self, _openapi: \u0026mut utoipa::openapi::OpenApi) {\n        // if let Some(components) = openapi.components.as_mut() {\n        //     components.add_security_scheme(\n        //         \"api_key\",\n        //         SecurityScheme::ApiKey(ApiKey::Header(ApiKeyValue::new(\"todo_apikey\"))),\n        //     )\n        // }\n    }\n}\n","traces":[{"line":32,"address":[],"length":0,"stats":{"Line":10}}],"covered":1,"coverable":1},{"path":["/","Users","yaleman","Projects","goatns","src","web","api","filezone.rs"],"content":"use super::*;\nuse crate::db::DBEntity;\n\nuse crate::db::User;\nuse crate::db::ZoneOwnership;\nuse crate::error_result_json;\nuse crate::utils::check_valid_tld;\nuse crate::zones::FileZone;\nuse axum::extract::Path;\nuse axum::Json;\nuse goatns_macros::check_api_auth;\nuse serde::Deserialize;\nuse serde::Serialize;\nuse tower_sessions::Session;\n\n#[derive(Deserialize, Serialize, Debug, Clone)]\npub struct FileZoneResponse {\n    pub message: String,\n    pub zone: Option\u003cFileZone\u003e,\n    pub id: Option\u003ci64\u003e,\n}\n\npub(crate) async fn api_create(\n    State(state): State\u003cGoatState\u003e,\n    session: Session,\n    Json(zone): Json\u003cFileZone\u003e,\n) -\u003e Result\u003cJson\u003cBox\u003cFileZone\u003e\u003e, (StatusCode, Json\u003cErrorResult\u003e)\u003e {\n    check_api_auth!();\n\n    if !check_valid_tld(\u0026zone.name, \u0026state.read().await.config.allowed_tlds) {\n        return error_result_json!(\"Invalid TLD for this system\", StatusCode::BAD_REQUEST);\n    }\n\n    // check to see if the zone exists\n    let mut txn = match state.connpool().await.begin().await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            log::error!(\"failed to get connection to the database: {err:?}\");\n            return error_result_json!(\n                \"Failed to get a connection to the database!\",\n                StatusCode::INTERNAL_SERVER_ERROR\n            );\n        }\n    };\n\n    match FileZone::get_by_name(\u0026mut txn, \u0026zone.name).await {\n        Ok(Some(_)) =\u003e {\n            log::debug!(\"Zone {} already exists, user sent POST\", zone.name);\n            return error_result_json!(\"Zone already exists!\", StatusCode::BAD_REQUEST);\n        }\n        Ok(None) =\u003e {}\n        Err(err) =\u003e {\n            log::debug!(\n                \"Couldn't get zone  {}, something went wrong: {err:?}\",\n                zone.name\n            );\n            return error_result_json!(\n                \"Server error querying zone!\",\n                StatusCode::INTERNAL_SERVER_ERROR\n            );\n        }\n    };\n\n    // if they got here there were no issues with querying the DB and it doesn't exist already!\n\n    if let Err(err) = zone.save_with_txn(\u0026mut txn).await {\n        log::debug!(\n            \"Couldn't create zone  {}, something went wrong during save: {err:?}\",\n            zone.name\n        );\n        return error_result_json!(\n            \"Server error creating zone!\",\n            StatusCode::INTERNAL_SERVER_ERROR\n        );\n    }\n\n    if let Err(err) = txn.commit().await {\n        log::debug!(\n            \"Couldn't create zone {}, something went wrong committing transaction: {err:?}\",\n            zone.name\n        );\n        return error_result_json!(\n            \"Server error creating zone!\",\n            StatusCode::INTERNAL_SERVER_ERROR\n        );\n    }\n    // start a new transaction!\n    let mut txn = match state.connpool().await.begin().await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            log::error!(\"failed to get connection to the database: {err:?}\");\n            return error_result_json!(\n                \"Failed to get a connection to the database!\",\n                StatusCode::INTERNAL_SERVER_ERROR\n            );\n        }\n    };\n\n    let zone = match FileZone::get_by_name(\u0026mut txn, \u0026zone.name).await {\n        Ok(val) =\u003e match val {\n            Some(val) =\u003e *val,\n            None =\u003e {\n                return error_result_json!(\"Couldn't find Zone!\", StatusCode::NOT_FOUND);\n            }\n        },\n        Err(err) =\u003e {\n            log::debug!(\n                \"Couldn't get zone  {}, something went wrong: {err:?}\",\n                zone.name\n            );\n            return error_result_json!(\n                \"Server error querying zone!\",\n                StatusCode::INTERNAL_SERVER_ERROR\n            );\n        }\n    };\n\n    let userid = match user.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            log::debug!(\"User id not found in session, something went wrong\");\n            return error_result_json!(\n                \"Server error creating zone, contact the admins!\",\n                StatusCode::INTERNAL_SERVER_ERROR\n            );\n        }\n    };\n\n    let zoneid = match zone.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            log::debug!(\"Zone id not found in session, something went wrong\");\n            return error_result_json!(\n                \"Server error creating zone, contact the admins!\",\n                StatusCode::INTERNAL_SERVER_ERROR\n            );\n        }\n    };\n\n    let ownership = ZoneOwnership {\n        id: None,\n        userid,\n        zoneid,\n    };\n\n    if let Err(err) = ownership.save_with_txn(\u0026mut txn).await {\n        log::debug!(\"Couldn't store zone ownership {ownership:?}, something went wrong: {err:?}\");\n        return error_result_json!(\n            \"Server error creating zone ownership, contact the admins!\",\n            StatusCode::INTERNAL_SERVER_ERROR\n        );\n    };\n\n    if let Err(err) = txn.commit().await {\n        log::debug!(\n            \"Couldn't create zone {}, something went wrong committing transaction: {err:?}\",\n            zone.name\n        );\n        return error_result_json!(\n            \"Server error creating zone, contact the admins!\",\n            StatusCode::INTERNAL_SERVER_ERROR\n        );\n    }\n    log::debug!(\"Zone created by user={:?} zone={:?}\", user.id, zone);\n\n    Ok(Json(Box::new(zone)))\n}\n\npub(crate) async fn api_update(\n    State(state): State\u003cGoatState\u003e,\n    session: Session,\n    Json(zone): Json\u003cFileZone\u003e,\n) -\u003e Result\u003cJson\u003cString\u003e, (StatusCode, Json\u003cErrorResult\u003e)\u003e {\n    check_api_auth!();\n\n    let zone_id = match zone.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            return error_result_json!(\"No zone ID specified\", StatusCode::BAD_REQUEST);\n        }\n    };\n    if !check_valid_tld(\u0026zone.name, \u0026state.read().await.config.allowed_tlds) {\n        return error_result_json!(\"Invalid TLD for this system\", StatusCode::BAD_REQUEST);\n    }\n\n    // get a db transaction\n    let connpool = state.connpool().await.clone();\n    // TODO getting a transaction might fail\n    let mut txn = match connpool.begin().await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            log::error!(\"failed to get connection to the database: {err:?}\");\n            return error_result_json!(\n                \"Failed to get a connection to the database!\",\n                StatusCode::INTERNAL_SERVER_ERROR\n            );\n        }\n    };\n\n    let user_id = match user.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            log::error!(\"User id not found in session, something went wrong\");\n            return error_result_json!(\"Internal server error\", StatusCode::INTERNAL_SERVER_ERROR);\n        }\n    };\n\n    // check the user owns the zone\n    if let Err(err) = ZoneOwnership::get_ownership_by_userid(\u0026mut txn, \u0026user_id, \u0026zone_id).await {\n        // TODO: make this a better log\n        println!(\"Failed to validate user owns zone: {err:?}\");\n        return Err((\n            StatusCode::UNAUTHORIZED,\n            Json(ErrorResult {\n                message: \"\".to_string(),\n            }),\n        ));\n    };\n    println!(\"looks like user owns zone\");\n\n    // save the zone data\n\n    if let Err(err) = zone.save_with_txn(\u0026mut txn).await {\n        // TODO: make this a better log\n        println!(\"Failed to save zone: {err:?}\");\n        return Err((\n            StatusCode::INTERNAL_SERVER_ERROR,\n            Json(ErrorResult {\n                message: \"failed to save zone\".to_string(),\n            }),\n        ));\n    };\n    if let Err(err) = txn.commit().await {\n        // TODO: make this a better log\n        println!(\"Failed to commit transaction while saving zone: {err:?}\");\n        return Err((\n            StatusCode::INTERNAL_SERVER_ERROR,\n            Json(ErrorResult {\n                message: \"failed to save zone\".to_string(),\n            }),\n        ));\n    };\n    Ok(Json(\"success\".to_string()))\n}\n\npub(crate) async fn api_delete(\n    State(state): State\u003cGoatState\u003e,\n    session: Session,\n    Path(id): Path\u003ci64\u003e,\n) -\u003e Result\u003cStatusCode, (StatusCode, Json\u003cErrorResult\u003e)\u003e {\n    // let id = id;\n\n    check_api_auth!();\n\n    let mut txn = match state.connpool().await.begin().await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            log::error!(\"Error getting txn: {err:?}\");\n            return error_result_json!(\"Internal server error\", StatusCode::INTERNAL_SERVER_ERROR);\n        }\n    };\n    // get the zoneownership\n    let userid = match user.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            log::error!(\"User id not found in session, something went wrong\");\n            return error_result_json!(\"Internal server error\", StatusCode::INTERNAL_SERVER_ERROR);\n        }\n    };\n\n    match ZoneOwnership::get_ownership_by_userid(\u0026mut txn, \u0026userid, \u0026id).await {\n        Ok(None) =\u003e {\n            return error_result_json!(\n                format!(\"Zone ID {} not found\", id).as_str(),\n                StatusCode::NOT_FOUND\n            )\n        }\n        Ok(Some(val)) =\u003e val,\n        Err(err) =\u003e {\n            error!(\n                \"Failed to get zone ownership for zoneid={}: error: {:?}\",\n                id, err\n            );\n            return error_result_json!(\"Internal server error\", StatusCode::INTERNAL_SERVER_ERROR);\n        }\n    };\n\n    // get the zone\n    let zone = match FileZone::get_with_txn(\u0026mut txn, \u0026id).await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            log::error!(\n                \"Failed to get Zone during api_delete zoneid={} error=\\\"{err:?}\\\"\",\n                id\n            );\n            return error_result_json!(\"Internal server error\", StatusCode::INTERNAL_SERVER_ERROR);\n        }\n    };\n\n    let res = match zone.delete_with_txn(\u0026mut txn).await {\n        Ok(_) =\u003e Ok(StatusCode::OK),\n        Err(err) =\u003e {\n            log::error!(\n                \"Failed to delete Zone during api_delete zoneid={} error=\\\"{err:?}\\\"\",\n                id\n            );\n            return error_result_json!(\"Internal server error\", StatusCode::INTERNAL_SERVER_ERROR);\n        }\n    };\n\n    if let Err(err) = txn.commit().await {\n        log::error!(\n            \"Failed to commit txn for zone.delete during api_delete zoneid={} error=\\\"{err:?}\\\"\",\n            id\n        );\n        return error_result_json!(\"Internal server error\", StatusCode::INTERNAL_SERVER_ERROR);\n    };\n    res\n}\n\npub(crate) async fn api_get(\n    State(state): State\u003cGoatState\u003e,\n    session: Session,\n    Path(id): Path\u003ci64\u003e,\n) -\u003e Result\u003cJson\u003cBox\u003cFileZone\u003e\u003e, (StatusCode, Json\u003cErrorResult\u003e)\u003e {\n    check_api_auth!();\n\n    let mut txn = match state.connpool().await.begin().await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            log::error!(\"failed to get connection to the database: {err:?}\");\n            return error_result_json!(\n                \"Failed to get a connection to the database!\",\n                StatusCode::INTERNAL_SERVER_ERROR\n            );\n        }\n    };\n\n    let user_id = match user.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            log::error!(\"User id not found in session, something went wrong\");\n            return error_result_json!(\"Internal server error\", StatusCode::INTERNAL_SERVER_ERROR);\n        }\n    };\n\n    if ZoneOwnership::get_ownership_by_userid(\u0026mut txn, \u0026user_id, \u0026id)\n        .await\n        .is_err()\n    {\n        log::error!(\"User {:?} not authorized for zoneid={}\", \u0026user_id, id);\n        return error_result_json!(\"\", StatusCode::UNAUTHORIZED);\n    };\n\n    log::debug!(\"Searching for zone id {id:?}\");\n    let zone = match FileZone::get(\u0026state.connpool().await, id).await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            error!(\"Couldn't get zone id {}: error: {:?}\", id, err);\n            return error_result_json!(\n                format!(\"Couldn't get zone id {}\", id).as_ref(),\n                StatusCode::INTERNAL_SERVER_ERROR\n            );\n        }\n    };\n\n    Ok(Json::from(zone))\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":2}},{"line":28,"address":[],"length":0,"stats":{"Line":2}},{"line":30,"address":[],"length":0,"stats":{"Line":2}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":10}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":4}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":2}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":12}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":4}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":10}},{"line":89,"address":[],"length":0,"stats":{"Line":2}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":6}},{"line":100,"address":[],"length":0,"stats":{"Line":2}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":2}},{"line":119,"address":[],"length":0,"stats":{"Line":2}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":4}},{"line":130,"address":[],"length":0,"stats":{"Line":2}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":4}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":4}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":2}},{"line":166,"address":[],"length":0,"stats":{"Line":2}},{"line":169,"address":[],"length":0,"stats":{"Line":1}},{"line":174,"address":[],"length":0,"stats":{"Line":1}},{"line":176,"address":[],"length":0,"stats":{"Line":2}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":3}},{"line":189,"address":[],"length":0,"stats":{"Line":4}},{"line":190,"address":[],"length":0,"stats":{"Line":1}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":2}},{"line":201,"address":[],"length":0,"stats":{"Line":1}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":2}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":1}},{"line":223,"address":[],"length":0,"stats":{"Line":7}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":2}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":1}},{"line":246,"address":[],"length":0,"stats":{"Line":1}},{"line":253,"address":[],"length":0,"stats":{"Line":1}},{"line":255,"address":[],"length":0,"stats":{"Line":5}},{"line":256,"address":[],"length":0,"stats":{"Line":1}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":2}},{"line":264,"address":[],"length":0,"stats":{"Line":1}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":2}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":1}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":4}},{"line":290,"address":[],"length":0,"stats":{"Line":1}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":5}},{"line":301,"address":[],"length":0,"stats":{"Line":1}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":2}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":1}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}}],"covered":48,"coverable":175},{"path":["/","Users","yaleman","Projects","goatns","src","web","api","filezonerecord.rs"],"content":"use crate::db::{DBEntity, User, ZoneOwnership};\nuse crate::error_result_json;\nuse crate::zones::FileZoneRecord;\nuse goatns_macros::check_api_auth;\nuse tower_sessions::Session;\nuse tracing::debug;\n\nuse super::*;\n\n/// Save the entity to the database\n#[utoipa::path(\n    post,\n    path = \"/api/record\",\n    operation_id = \"record_create\",\n    request_body = FileZoneRecord,\n    responses(\n        (status = 200, description = \"Successful\"),\n        (status = 403, description = \"Auth failed\"),\n        (status = 500, description = \"Something broke!\"),\n    ),\n    tag = \"Records\",\n)]\npub(crate) async fn api_create(\n    State(state): State\u003cGoatState\u003e,\n    session: Session,\n    Json(record): Json\u003cFileZoneRecord\u003e,\n) -\u003e Result\u003cJson\u003cBox\u003cFileZoneRecord\u003e\u003e, (StatusCode, Json\u003cErrorResult\u003e)\u003e {\n    check_api_auth!();\n\n    let user_id = match user.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            debug!(\"No user id found in session\");\n            return error_result_json!(\"No user id found in session\", StatusCode::UNAUTHORIZED);\n        }\n    };\n\n    let zone_id = match record.zoneid {\n        Some(val) =\u003e val,\n        None =\u003e {\n            debug!(\"No zone id found in record\");\n            return error_result_json!(\"No zone id found in record\", StatusCode::BAD_REQUEST);\n        }\n    };\n\n    let mut txn = state.connpool().await.begin().await.map_err(|_| {\n        (\n            StatusCode::INTERNAL_SERVER_ERROR,\n            Json::from(ErrorResult::from(\"Database error\")),\n        )\n    })?;\n    debug!(\"looking for ZO for user: {} zoneid: {}\", user_id, zone_id);\n    if let Err(err) = ZoneOwnership::get_ownership_by_userid(\u0026mut txn, \u0026user_id, \u0026zone_id).await {\n        eprintln!(\"Error getting ownership: {err:?}\");\n        return error_result_json!(\"\", StatusCode::UNAUTHORIZED);\n    };\n\n    match record.save_with_txn(\u0026mut txn).await {\n        Err(err) =\u003e {\n            eprintln!(\"Error saving record: {err:?}\");\n            // TODO: this needs to handle index conflicts\n            error_result_json!(\"Error saving record\", StatusCode::BAD_REQUEST)\n        }\n        Ok(val) =\u003e {\n            if let Err(err) = txn.commit().await {\n                // TODO: This error message needs improving\n                eprintln!(\"error committing transaction! {err:?}\");\n                return error_result_json!(\n                    \"Error saving record, see the admins\",\n                    StatusCode::INTERNAL_SERVER_ERROR\n                );\n            }\n            Ok(Json(val))\n        }\n    }\n}\n/// HTTP Put \u003chttps://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/PUT\u003e\npub(crate) async fn api_update(\n    State(state): State\u003cGoatState\u003e,\n    session: Session,\n    Json(payload): Json\u003cserde_json::Value\u003e,\n) -\u003e Result\u003cJson\u003cString\u003e, (StatusCode, Json\u003cErrorResult\u003e)\u003e {\n    check_api_auth!();\n\n    let record: FileZoneRecord = match serde_json::from_value(payload) {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            eprintln!(\"Failed to parse object: {err:?}\");\n            return error_result_json!(\"Failed to parse object\", StatusCode::BAD_REQUEST);\n        }\n    };\n    let mut txn = state.connpool().await.begin().await.map_err(|_| {\n        (\n            StatusCode::INTERNAL_SERVER_ERROR,\n            Json::from(ErrorResult::from(\"Database error\")),\n        )\n    })?;\n\n    let res = match record.update_with_txn(\u0026mut txn).await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            // TODO: this should handle missing OR failures\n            eprintln!(\"Error getting record: {err:?}\");\n            return error_result_json!(\"\", StatusCode::NOT_FOUND);\n        }\n    };\n\n    let user_id = match user.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            debug!(\"No user id found in session\");\n            return error_result_json!(\"No user id found in session\", StatusCode::UNAUTHORIZED);\n        }\n    };\n\n    let zone_id = match record.zoneid {\n        Some(val) =\u003e val,\n        None =\u003e {\n            debug!(\"No zone id found in record\");\n            return error_result_json!(\"No zone id found in record\", StatusCode::BAD_REQUEST);\n        }\n    };\n\n    if let Err(err) = ZoneOwnership::get_ownership_by_userid(\u0026mut txn, \u0026user_id, \u0026zone_id).await {\n        eprintln!(\"Error getting ownership: {err:?}\");\n        return error_result_json!(\"\", StatusCode::UNAUTHORIZED);\n    };\n\n    let res = match serde_json::to_string(\u0026res) {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            eprintln!(\"Failed to parse object: {err:?}\");\n            return error_result_json!(\"Failed to parse object\", StatusCode::BAD_REQUEST);\n        }\n    };\n\n    Ok(Json(res))\n}\npub(crate) async fn api_get(\n    State(state): State\u003cGoatState\u003e,\n    session: Session,\n    Path(id): Path\u003ci64\u003e,\n) -\u003e Result\u003cJson\u003cBox\u003cFileZoneRecord\u003e\u003e, (StatusCode, Json\u003cErrorResult\u003e)\u003e {\n    check_api_auth!();\n\n    let pool = state.connpool().await;\n    let res = match FileZoneRecord::get(\u0026pool, id).await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            // TODO: this should handle missing OR failures\n            eprintln!(\"Error getting record: {err:?}\");\n            return error_result_json!(\"\", StatusCode::NOT_FOUND);\n        }\n    };\n    Ok(Json(res))\n}\n\n/// Delete an object\n/// \u003chttps://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/DELETE\u003e\npub(crate) async fn api_delete(\n    State(state): State\u003cGoatState\u003e,\n    session: Session,\n    Path(id): Path\u003ci64\u003e,\n) -\u003e Result\u003c(), (StatusCode, Json\u003cErrorResult\u003e)\u003e {\n    check_api_auth!();\n\n    let mut txn = state.connpool().await.begin().await.map_err(|_| {\n        (\n            StatusCode::INTERNAL_SERVER_ERROR,\n            Json::from(ErrorResult::from(\"Database error\")),\n        )\n    })?;\n\n    let record = match FileZoneRecord::get_with_txn(\u0026mut txn, \u0026id).await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            let resmsg = format!(\"error getting record: {err:?}\");\n            return error_result_json!(resmsg.as_str(), StatusCode::UNAUTHORIZED);\n        }\n    };\n    let user_id = match user.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            debug!(\"No user id found in session\");\n            return error_result_json!(\"No user id found in session\", StatusCode::UNAUTHORIZED);\n        }\n    };\n\n    let zone_id = match record.zoneid {\n        Some(val) =\u003e val,\n        None =\u003e {\n            debug!(\"No zone id found in record\");\n            return error_result_json!(\"No zone id found in record\", StatusCode::BAD_REQUEST);\n        }\n    };\n    if let Err(err) = ZoneOwnership::get_ownership_by_userid(\u0026mut txn, \u0026user_id, \u0026zone_id).await {\n        eprintln!(\"Error getting ownership: {err:?}\");\n        return error_result_json!(\"no zone ownership found\", StatusCode::UNAUTHORIZED);\n    };\n\n    if let Err(err) = record.delete_with_txn(\u0026mut txn).await {\n        // TODO: This error message needs improving\n        eprintln!(\"error committing transaction! {err:?}\");\n        return error_result_json!(\n            \"Error deleting record, see the admins\",\n            StatusCode::INTERNAL_SERVER_ERROR\n        );\n    }\n    if let Err(err) = txn.commit().await {\n        // TODO: This error message needs improving\n        eprintln!(\"error committing transaction! {err:?}\");\n        return error_result_json!(\n            \"Error deleting record, see the admins\",\n            StatusCode::INTERNAL_SERVER_ERROR\n        );\n    };\n\n    Ok(())\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":1}},{"line":28,"address":[],"length":0,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":2}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":2}},{"line":39,"address":[],"length":0,"stats":{"Line":1}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":6}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":2}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":3}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":2}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":1}},{"line":165,"address":[],"length":0,"stats":{"Line":1}},{"line":167,"address":[],"length":0,"stats":{"Line":4}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":2}},{"line":175,"address":[],"length":0,"stats":{"Line":1}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":2}},{"line":182,"address":[],"length":0,"stats":{"Line":1}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":2}},{"line":190,"address":[],"length":0,"stats":{"Line":1}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":2}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":2}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":2}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":1}}],"covered":25,"coverable":100},{"path":["/","Users","yaleman","Projects","goatns","src","web","api","mod.rs"],"content":"use super::*;\nuse crate::zones::FileZone;\nuse axum::extract::Path;\nuse axum::extract::State;\nuse axum::routing::{delete, post, put};\nuse axum::Json;\nuse serde::Deserialize;\nuse serde::Serialize;\n\npub mod auth;\npub(crate) mod docs;\npub mod filezone;\npub mod filezonerecord;\n\n#[macro_export]\n/// message, status\nmacro_rules! error_result_json {\n    ($msg:expr, $status:expr) =\u003e {\n        Err(($status, Json(ErrorResult::from($msg))))\n    };\n}\n\n#[derive(Serialize)]\npub struct NotImplemented {\n    response: String,\n}\n\nimpl Default for NotImplemented {\n    fn default() -\u003e Self {\n        Self {\n            response: \"This endpoint is not yet implemented\".to_string(),\n        }\n    }\n}\n\n#[derive(Debug, Serialize, Deserialize, Clone)]\n#[allow(dead_code)]\npub struct ErrorResult {\n    #[allow(dead_code)]\n    pub message: String,\n}\n\nimpl From\u003c\u0026str\u003e for ErrorResult {\n    fn from(input: \u0026str) -\u003e Self {\n        ErrorResult {\n            message: input.to_string(),\n        }\n    }\n}\n\n/// This gets applied to DBEntities\n// #[async_trait]\n// trait APIEntity {\n//     /// Save the entity to the database\n//     async fn api_create(\n//         State(state): State\u003cGoatState\u003e,\n//         session: Session,\n//         Json(payload): Json\u003cserde_json::Value\u003e,\n//     ) -\u003e Result\u003cJson\u003cBox\u003cSelf\u003e\u003e, (StatusCode, Json\u003cErrorResult\u003e)\u003e;\n//     /// HTTP Put \u003chttps://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/PUT\u003e\n//     async fn api_update(\n//         State(state): State\u003cGoatState\u003e,\n//         session: Session,\n//         Json(payload): Json\u003cserde_json::Value\u003e,\n//     ) -\u003e Result\u003cJson\u003cString\u003e, (StatusCode, Json\u003cErrorResult\u003e)\u003e;\n//     async fn api_get(\n//         State(state): State\u003cGoatState\u003e,\n//         session: Session,\n//         Path(id): Path\u003ci64\u003e,\n//     ) -\u003e Result\u003cJson\u003cBox\u003cSelf\u003e\u003e, (StatusCode, Json\u003cErrorResult\u003e)\u003e;\n\n//     /// Delete an object\n//     /// \u003chttps://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/DELETE\u003e\n//     async fn api_delete(\n//         State(state): State\u003cGoatState\u003e,\n//         session: Session,\n//         Path(id): Path\u003ci64\u003e,\n//     ) -\u003e Result\u003cStatusCode, (StatusCode, Json\u003cErrorResult\u003e)\u003e;\n// }\n\n#[derive(Deserialize, Serialize, Debug, Clone)]\npub struct FileZoneResponse {\n    pub message: String,\n    pub zone: Option\u003cFileZone\u003e,\n    pub id: Option\u003ci64\u003e,\n}\n\n#[derive(Serialize)]\npub struct GoatNSVersion {\n    version: String,\n}\nimpl Default for GoatNSVersion {\n    fn default() -\u003e Self {\n        Self {\n            version: format!(\"GoatNS {}\", env!(\"CARGO_PKG_VERSION\")),\n        }\n    }\n}\n\npub async fn version_get() -\u003e Json\u003cGoatNSVersion\u003e {\n    Json::from(GoatNSVersion::default())\n}\n\npub fn new() -\u003e Router\u003cGoatState\u003e {\n    Router::new()\n        .route(\"/zone\", post(filezone::api_create))\n        .route(\"/zone\", put(filezone::api_update))\n        .route(\"/zone/:id\", get(filezone::api_get))\n        .route(\"/zone/:id\", delete(filezone::api_delete))\n        .route(\"/record\", post(filezonerecord::api_create))\n        .route(\"/record\", put(filezonerecord::api_update))\n        .route(\"/record/:id\", get(filezonerecord::api_get))\n        .route(\"/record/:id\", delete(filezonerecord::api_delete))\n        .route(\"/login\", post(auth::login))\n}\n","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":10}},{"line":105,"address":[],"length":0,"stats":{"Line":10}},{"line":106,"address":[],"length":0,"stats":{"Line":10}},{"line":107,"address":[],"length":0,"stats":{"Line":10}},{"line":108,"address":[],"length":0,"stats":{"Line":10}},{"line":109,"address":[],"length":0,"stats":{"Line":10}},{"line":110,"address":[],"length":0,"stats":{"Line":10}},{"line":111,"address":[],"length":0,"stats":{"Line":10}},{"line":112,"address":[],"length":0,"stats":{"Line":10}},{"line":113,"address":[],"length":0,"stats":{"Line":10}},{"line":114,"address":[],"length":0,"stats":{"Line":10}}],"covered":11,"coverable":19},{"path":["/","Users","yaleman","Projects","goatns","src","web","auth","mod.rs"],"content":"use super::GoatState;\nuse crate::config::ConfigFile;\nuse crate::db::{DBEntity, User};\nuse crate::error::GoatNsError;\nuse crate::web::utils::Urls;\nuse crate::web::GoatStateTrait;\nuse crate::COOKIE_NAME;\nuse askama::Template;\nuse axum::extract::{Query, State};\nuse axum::http::StatusCode;\nuse axum::response::{IntoResponse, Redirect, Response};\nuse axum::routing::{get, post};\nuse axum::{Form, Router};\nuse chrono::{DateTime, Utc};\nuse concread::cowcell::asynch::CowCellReadTxn;\nuse oauth2::{PkceCodeChallenge, PkceCodeVerifier, RedirectUrl};\nuse openidconnect::reqwest::async_http_client;\nuse openidconnect::EmptyAdditionalProviderMetadata;\nuse openidconnect::{\n    core::*, ClaimsVerificationError, EmptyAdditionalClaims, IdTokenClaims, TokenResponse,\n};\nuse openidconnect::{\n    AuthenticationFlow, AuthorizationCode, CsrfToken, IssuerUrl, Nonce, ProviderMetadata, Scope,\n};\nuse serde::Deserialize;\nuse tower_sessions::cookie::time::Duration;\nuse tower_sessions::{session_store::ExpiredDeletion, sqlx::SqlitePool, SqliteStore};\n\n// pub(crate) mod sessionstore;\npub mod traits;\nuse tower_sessions::{Expiry, Session, SessionManagerLayer};\nuse tracing::error;\nuse traits::*;\n\n#[derive(Deserialize)]\n/// Parser for path bits\npub struct QueryForLogin {\n    /// OAuth2 CSRF token\n    pub state: Option\u003cString\u003e,\n    /// OAuth2 code\n    pub code: Option\u003cString\u003e,\n    /// Where we'll redirect users to after successful login\n    pub redirect: Option\u003cString\u003e,\n}\n\n/// Used in the parsing of the OIDC Provider metadata\npub type CustomProviderMetadata = ProviderMetadata\u003c\n    EmptyAdditionalProviderMetadata,\n    CoreAuthDisplay,\n    CoreClientAuthMethod,\n    CoreClaimName,\n    CoreClaimType,\n    CoreGrantType,\n    CoreJweContentEncryptionAlgorithm,\n    CoreJweKeyManagementAlgorithm,\n    CoreJwsSigningAlgorithm,\n    CoreJsonWebKeyType,\n    CoreJsonWebKeyUse,\n    CoreJsonWebKey,\n    CoreResponseMode,\n    CoreResponseType,\n    CoreSubjectIdentifierType,\n\u003e;\ntype CustomClaimType = IdTokenClaims\u003cEmptyAdditionalClaims, CoreGenderClaim\u003e;\n\n#[derive(Template)]\n#[template(path = \"auth_login.html.j2\")]\n#[allow(dead_code)]\nstruct AuthLoginTemplate {\n    errors: Vec\u003cString\u003e,\n    redirect_url: String,\n    pub user_is_admin: bool,\n}\n\n#[derive(Template)]\n#[template(path = \"auth_new_user.html\")]\nstruct AuthNewUserTemplate {\n    state: String,\n    code: String,\n    email: String,\n    displayname: String,\n    redirect_url: String,\n    errors: Vec\u003cString\u003e,\n    pub user_is_admin: bool,\n}\n\n#[derive(Template)]\n#[template(path = \"auth_logout.html\")]\n#[allow(dead_code)]\nstruct AuthLogoutTemplate {\n    pub user_is_admin: bool,\n}\n\n#[derive(Template)]\n#[template(path = \"auth_provisioning_disabled.html\")]\n/// This renders a page telling the user that auto-provisioning is disabled and to tell the admin which username to add\nstruct AuthProvisioningDisabledTemplate {\n    username: String,\n    authref: String,\n\n    admin_contact_name: String,\n    admin_contact_url: String,\n    pub user_is_admin: bool,\n}\n\npub enum ParserError {\n    Redirect { content: Redirect },\n    ErrorMessage { content: String },\n    ClaimsVerificationError { content: ClaimsVerificationError },\n}\n\n/// Pull the OIDC Discovery details\npub async fn oauth_get_discover(state: \u0026mut GoatState) -\u003e Result\u003cCustomProviderMetadata, String\u003e {\n    log::debug!(\"Getting discovery data\");\n    let issuer_url = IssuerUrl::new(state.read().await.config.oauth2_config_url.clone())\n        .map_err(|err| format!(\"Failed to parse issuer URL: {:?}\", err))?;\n    match CoreProviderMetadata::discover_async(issuer_url, async_http_client).await {\n        Err(e) =\u003e Err(format!(\"{e:?}\")),\n        Ok(val) =\u003e {\n            state.oidc_update(val.clone()).await;\n            Ok(val)\n        }\n    }\n}\n\npub async fn oauth_start(state: \u0026mut GoatState) -\u003e Result\u003curl::Url, String\u003e {\n    let last_updated: DateTime\u003cUtc\u003e = state.read().await.oidc_config_updated;\n    let now: DateTime\u003cUtc\u003e = Utc::now();\n\n    let delta = now - last_updated;\n    let discovery = oauth_get_discover(state).await?;\n\n    let provider_metadata: CustomProviderMetadata = match delta.num_minutes() \u003e 5 {\n        true =\u003e discovery,\n        false =\u003e {\n            log::debug!(\"Using cached OIDC discovery data\");\n            let config = state.read().await.oidc_config.clone();\n            let meta = config.unwrap_or(discovery);\n            state.oidc_update(meta.clone()).await;\n            meta\n        }\n    };\n    log::trace!(\"provider metadata: {provider_metadata:?}\");\n\n    // Generate a PKCE challenge.\n    let (pkce_challenge, pkce_verifier) = PkceCodeChallenge::new_random_sha256();\n    let client = CoreClient::from_provider_metadata(\n        provider_metadata,\n        state.oauth2_client_id().await,\n        state.oauth2_secret().await,\n    )\n    // This example will be running its own server at localhost:8080.\n    // See below for the server implementation.\n    .set_redirect_uri(RedirectUrl::from_url(\n        state.read().await.config.oauth2_redirect_url.clone(),\n    ));\n\n    // Generate the authorization URL to which we'll redirect the user.\n    let (authorize_url, csrf_state, nonce) = client\n        .authorize_url(\n            AuthenticationFlow::\u003cCoreResponseType\u003e::AuthorizationCode,\n            CsrfToken::new_random,\n            Nonce::new_random,\n        )\n        // This example is requesting access to the the user's profile including email.\n        .add_scope(Scope::new(\"email\".to_string()))\n        .add_scope(Scope::new(\"profile\".to_string()))\n        .set_pkce_challenge(pkce_challenge)\n        .url();\n    state\n        .push_verifier(\n            csrf_state.secret().to_owned(),\n            (pkce_verifier.secret().to_owned(), nonce),\n        )\n        .await;\n    Ok(authorize_url)\n}\n\npub async fn parse_state_code(\n    shared_state: \u0026GoatState,\n    query_code: String,\n    pkce_verifier: PkceCodeVerifier,\n    nonce: Nonce,\n) -\u003e Result\u003cCustomClaimType, ParserError\u003e {\n    let auth_code = AuthorizationCode::new(query_code);\n    let reader = shared_state.read().await;\n    let provider_metadata = match \u0026reader.oidc_config {\n        Some(value) =\u003e value,\n        None =\u003e {\n            return Err(ParserError::ErrorMessage {\n                content: \"Failed to pull provider metadata!\".to_string(),\n            });\n        }\n    };\n\n    let client = CoreClient::from_provider_metadata(\n        provider_metadata.to_owned(),\n        shared_state.oauth2_client_id().await,\n        shared_state.oauth2_secret().await,\n    )\n    .set_redirect_uri(RedirectUrl::from_url(\n        shared_state.read().await.config.oauth2_redirect_url.clone(),\n    ));\n    let verifier_copy = PkceCodeVerifier::new(pkce_verifier.secret().clone());\n    assert_eq!(verifier_copy.secret(), pkce_verifier.secret());\n    // Now you can exchange it for an access token and ID token.\n    let token_response = client\n        .exchange_code(auth_code)\n        // Set the PKCE code verifier.\n        .set_pkce_verifier(pkce_verifier)\n        .request_async(async_http_client)\n        .await\n        .map_err(|e| ParserError::ErrorMessage {\n            content: format!(\"{e:?}\"),\n        })?;\n\n    // Extract the ID token claims after verifying its authenticity and nonce.\n    let id_token = match token_response.id_token() {\n        Some(token) =\u003e token,\n        None =\u003e {\n            return Err(ParserError::ErrorMessage {\n                content: \"couldn't parse token\".to_string(),\n            })\n        }\n    };\n    log::trace!(\"id_token: {id_token:?}\");\n    let allowed_algs = vec![\n        CoreJwsSigningAlgorithm::EcdsaP256Sha256,\n        CoreJwsSigningAlgorithm::RsaSsaPkcs1V15Sha256,\n        CoreJwsSigningAlgorithm::RsaSsaPkcs1V15Sha384,\n        CoreJwsSigningAlgorithm::RsaSsaPkcs1V15Sha512,\n    ];\n    let verifier = \u0026client.id_token_verifier().set_allowed_algs(allowed_algs);\n    // if verifier.is_none() {\n    // return Err(ParserError::ErrorMessage{content: \"Couldn't find a known session!\"});\n    // }\n    id_token\n        .claims(verifier, \u0026nonce)\n        .map_err(|e| ParserError::ClaimsVerificationError { content: e })\n        .cloned()\n}\n\npub async fn login(\n    Query(query): Query\u003cQueryForLogin\u003e,\n    session: Session,\n    axum::extract::State(mut state): axum::extract::State\u003cGoatState\u003e,\n) -\u003e Result\u003cimpl IntoResponse, impl IntoResponse\u003e {\n    // check if we've got an existing, valid session\n    if let Some(signed_in) = session.get(\"signed_in\").await.unwrap_or(Some(false)) {\n        if signed_in {\n            return Ok(Urls::Dashboard.redirect().into_response());\n        }\n    }\n\n    let (query_state, query_code) = match (query.state, query.code) {\n        (Some(state), Some(code)) =\u003e (state, code),\n        _ =\u003e {\n            let auth_url = \u0026oauth_start(\u0026mut state)\n                .await\n                .map_err(|err| {\n                    error!(\"Failed to do OIDC Discovery: {err:?}\");\n                    (StatusCode::INTERNAL_SERVER_ERROR, \"OIDC Discovery Error\").into_response()\n                })?\n                .to_string();\n            return Ok(Redirect::to(auth_url).into_response());\n        }\n    };\n\n    // if we get the state and code back then we can go back to the server for a token\n    // ref \u003chttps://github.com/kanidm/kanidm/blob/master/kanidmd/testkit/tests/oauth2_test.rs#L276\u003e\n\n    let verifier = state.pop_verifier(query_state.clone()).await;\n\n    let (pkce_verifier_secret, nonce) = match verifier {\n        Some((p, n)) =\u003e (p, n),\n        None =\u003e {\n            log::error!(\"Couldn't find a session, redirecting...\");\n            return Err(Urls::Login.redirect().into_response());\n        }\n    };\n    let verifier_copy = PkceCodeVerifier::new(pkce_verifier_secret.clone());\n\n    let claims = parse_state_code(\n        \u0026state,\n        query_code.clone(),\n        PkceCodeVerifier::new(pkce_verifier_secret),\n        nonce.clone(),\n    )\n    .await;\n    match claims {\n        Ok(claims) =\u003e {\n            // check if they're in the database\n\n            let email = claims.get_email().map_err(|err| err.into_response())?;\n\n            let mut dbuser = match User::get_by_subject(\u0026state.connpool().await, claims.subject())\n                .await\n            {\n                Ok(Some(user)) =\u003e user,\n                Ok(None) =\u003e {\n                    if !state.read().await.config.user_auto_provisioning {\n                        // TODO: show a \"sorry\" page when auto-provisioning's not enabled\n                        // log::warn!(\"User attempted login when auto-provisioning is not enabled, yeeting them to the home page.\");\n                        let (admin_contact_name, admin_contact_url) =\n                            state.read().await.config.admin_contact.to_html_parts();\n\n                        return Ok(AuthProvisioningDisabledTemplate {\n                            username: claims.get_username(),\n                            authref: claims.subject().to_string(),\n                            admin_contact_name,\n                            admin_contact_url,\n                            user_is_admin: false, // TODO: ... probably not an admin but we can check\n                        }\n                        .into_response());\n                    }\n                    // push it back into the stack for signup\n\n                    state\n                        .push_verifier(\n                            query_state.clone(),\n                            (verifier_copy.secret().to_owned(), nonce),\n                        )\n                        .await;\n\n                    return Ok(AuthNewUserTemplate {\n                        state: query_state,\n                        code: query_code,\n                        email,\n                        displayname: claims.get_displayname(),\n                        redirect_url: \"\".to_string(),\n                        errors: vec![],\n                        user_is_admin: false, // TODO: ... probably not an admin but we can check\n                    }\n                    .into_response());\n                }\n                Err(error) =\u003e {\n                    log::error!(\"Database error finding user {:?}: {error:?}\", email.clone());\n                    let redirect: Option\u003cString\u003e = session.remove(\"redirect\").await.unwrap_or(None);\n                    return match redirect {\n                        Some(destination) =\u003e Err(Redirect::to(\u0026destination).into_response()),\n                        None =\u003e Err(Urls::Home.redirect().into_response()),\n                    };\n                }\n            };\n            log::debug!(\"Found user in database: {dbuser:?}\");\n\n            if dbuser.disabled {\n                session.flush().await.map_err(|err| {\n                    error!(\"Failed to flush session: {err:?}\");\n                    (\n                        axum::http::StatusCode::INTERNAL_SERVER_ERROR,\n                        \"Failed to flush session store!\",\n                    )\n                        .into_response()\n                })?;\n                log::info!(\"Disabled user attempted to log in: {dbuser:?}\");\n                return Err(Urls::Home.redirect().into_response());\n            }\n\n            if let Some(claims_email) = claims.email() {\n                let claims_email = claims_email.to_string();\n                if claims_email != dbuser.email {\n                    log::debug!(\n                        \"Email doesn't match on login: {} != {}\",\n                        claims_email,\n                        dbuser.email\n                    );\n\n                    dbuser.email = claims_email;\n                    let mut db_txn = match state.connpool().await.begin().await {\n                        Ok(val) =\u003e val,\n                        Err(err) =\u003e {\n                            log::error!(\"Failed to start transaction to store user: {err:?}\");\n                            return Err(Urls::Home.redirect().into_response());\n                            // TODO: this probably... should be handled as a better error?\n                        }\n                    };\n                    if let Err(err) = dbuser.update_with_txn(\u0026mut db_txn).await {\n                        log::error!(\"Failed to update user email: {err:?}\");\n                        return Err(Urls::Home.redirect().into_response());\n                        // TODO: this probably... should be handled as a better error?\n                    }\n                    if let Err(err) = db_txn.commit().await {\n                        log::error!(\"Failed to commit user email update: {err:?}\");\n                        return Err(Urls::Home.redirect().into_response());\n                    };\n                }\n            }\n\n            if session\n                .insert(\"authref\", claims.subject().to_string())\n                .await\n                .is_err()\n            {\n                return Err((\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Failed to store session details\",\n                )\n                    .into_response());\n            };\n            if session.insert(\"user\", dbuser).await.is_err() {\n                return Err((\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Failed to store session details\",\n                )\n                    .into_response());\n            };\n            if session.insert(\"signed_in\", true).await.is_err() {\n                return Err((\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Failed to store session details\",\n                )\n                    .into_response());\n            };\n\n            Ok(Urls::Dashboard.redirect().into_response())\n        }\n        Err(error) =\u003e match error {\n            ParserError::Redirect { content } =\u003e Ok(content.into_response()),\n            ParserError::ErrorMessage { content } =\u003e {\n                log::debug!(\"Failed to parse state: {content}\");\n                Err(Urls::Home.redirect().into_response())\n            }\n            ParserError::ClaimsVerificationError { content } =\u003e {\n                log::error!(\"Failed to verify claim token: {content:?}\");\n                Err(Urls::Home.redirect().into_response())\n            }\n        },\n    }\n}\n\npub async fn logout(session: Session) -\u003e Result\u003cRedirect, (axum::http::StatusCode, \u0026'static str)\u003e {\n    session.flush().await.map_err(|err| {\n        error!(\"Failed to flush session: {err:?}\");\n        (\n            axum::http::StatusCode::INTERNAL_SERVER_ERROR,\n            \"Failed to flush session store!\",\n        )\n    })?;\n    Ok(Urls::Home.redirect())\n}\n\npub async fn build_auth_stores(\n    config: CowCellReadTxn\u003cConfigFile\u003e,\n    connpool: SqlitePool,\n) -\u003e Result\u003cSessionManagerLayer\u003cSqliteStore\u003e, GoatNsError\u003e {\n    let session_store = SqliteStore::new(connpool)\n        .with_table_name(\"sessions\")\n        .map_err(|err| {\n            GoatNsError::StartupError(format!(\"Failed to initialize session store: {}\", err))\n        })?;\n\n    session_store.migrate().await?;\n\n    let _deletion_task = tokio::task::spawn(\n        session_store\n            .clone()\n            .continuously_delete_expired(tokio::time::Duration::from_secs(60)),\n    );\n\n    Ok(SessionManagerLayer::new(session_store)\n        .with_expiry(Expiry::OnInactivity(Duration::minutes(5)))\n        .with_name(COOKIE_NAME)\n        .with_secure(true)\n        // If the cookies start being weird it's because they were appending a \".\" on the start...\n        .with_domain(config.hostname.clone()))\n}\n\n#[derive(Deserialize, Debug)]\n/// This handles the POST from \"would you like to create your user\"\npub struct SignupForm {\n    pub state: String,\n    pub code: String,\n}\n\n/// /auth/signup\npub async fn signup(\n    State(mut state): State\u003cGoatState\u003e,\n    Form(form): Form\u003cSignupForm\u003e,\n) -\u003e Result\u003cResponse, Redirect\u003e {\n    log::debug!(\"Dumping form: {form:?}\");\n\n    let query_state = form.state;\n\n    let verifier = state.pop_verifier(query_state).await;\n\n    let (pkce_verifier, nonce) = match verifier {\n        Some((p, n)) =\u003e (p, n),\n        None =\u003e {\n            log::error!(\"Couldn't find a signup session, redirecting user...\");\n            return Ok(Urls::Login.redirect().into_response());\n        }\n    };\n    let claims = parse_state_code(\n        \u0026state,\n        form.code,\n        PkceCodeVerifier::new(pkce_verifier),\n        nonce.clone(),\n    )\n    .await;\n    match claims {\n        Err(error) =\u003e match error {\n            ParserError::Redirect { content } =\u003e Ok(content.into_response()),\n            ParserError::ErrorMessage { content } =\u003e {\n                log::error!(\"Failed to parse claim: {}\", content);\n                Ok(Urls::Home.redirect().into_response())\n            }\n            ParserError::ClaimsVerificationError { content } =\u003e {\n                log::error!(\"Failed to verify claim token: {content:?}\");\n                Ok(Urls::Home.redirect().into_response())\n            }\n        },\n        Ok(claims) =\u003e {\n            log::debug!(\"Verified claims in signup form: {claims:?}\");\n            let user = User {\n                id: None,\n                displayname: claims.get_displayname(),\n                username: claims.get_username(),\n                email: claims.get_email()?,\n                disabled: false,\n                authref: Some(claims.subject().to_string()),\n                admin: false,\n            };\n            match user.save(\u0026state.connpool().await).await {\n                Ok(_) =\u003e Ok(Urls::Dashboard.redirect().into_response()),\n                Err(error) =\u003e {\n                    log::debug!(\"Failed to save new user signup... oh no! {error:?}\");\n                    // TODO: throw an error page on this one\n                    Ok(Urls::Home.redirect().into_response())\n                }\n            }\n        }\n    }\n}\n\npub fn new() -\u003e Router\u003cGoatState\u003e {\n    Router::new()\n        .route(\"/login\", get(login))\n        .route(\"/logout\", get(logout))\n        .route(\"/signup\", post(signup))\n}\n","traces":[{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":10}},{"line":447,"address":[],"length":0,"stats":{"Line":20}},{"line":449,"address":[],"length":0,"stats":{"Line":10}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":20}},{"line":456,"address":[],"length":0,"stats":{"Line":10}},{"line":457,"address":[],"length":0,"stats":{"Line":10}},{"line":458,"address":[],"length":0,"stats":{"Line":10}},{"line":461,"address":[],"length":0,"stats":{"Line":10}},{"line":462,"address":[],"length":0,"stats":{"Line":10}},{"line":463,"address":[],"length":0,"stats":{"Line":10}},{"line":464,"address":[],"length":0,"stats":{"Line":10}},{"line":466,"address":[],"length":0,"stats":{"Line":10}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":10}},{"line":537,"address":[],"length":0,"stats":{"Line":10}},{"line":538,"address":[],"length":0,"stats":{"Line":10}},{"line":539,"address":[],"length":0,"stats":{"Line":10}},{"line":540,"address":[],"length":0,"stats":{"Line":10}}],"covered":17,"coverable":235},{"path":["/","Users","yaleman","Projects","goatns","src","web","auth","traits.rs"],"content":"use axum::response::Redirect;\nuse openidconnect::EndUserUsername;\n\nuse crate::web::utils::Urls;\n\nuse super::CustomClaimType;\n\npub trait CustomClaimTypeThings {\n    fn get_displayname(\u0026self) -\u003e String;\n    fn get_email(\u0026self) -\u003e Result\u003cString, Redirect\u003e;\n    fn get_username(\u0026self) -\u003e String;\n}\n\nimpl CustomClaimTypeThings for CustomClaimType {\n    fn get_email(\u0026self) -\u003e Result\u003cString, Redirect\u003e {\n        let email: String;\n        if let Some(user_email) = self.email() {\n            email = user_email.to_string();\n        } else if let Some(user_email) = self.preferred_username() {\n            email = user_email.to_string();\n        } else {\n            log::error!(\"Couldn't extract email address from claim: {self:?}\");\n            return Err(Urls::Home.redirect());\n        }\n        Ok(email)\n    }\n    fn get_displayname(\u0026self) -\u003e String {\n        let mut displayname: String = \"Anonymous Kid\".to_string();\n        if let Some(name) = self.name() {\n            if let Some(username) = name.iter().next() {\n                displayname = username.1.to_string();\n            }\n        }\n        displayname\n    }\n    fn get_username(\u0026self) -\u003e String {\n        let default = EndUserUsername::new(\"\".to_string());\n        self.preferred_username().unwrap_or(\u0026default).to_string()\n    }\n}\n\n#[test]\nfn custom_claim_type_things() {\n    use url::Url;\n\n    use openidconnect::{\n        EmptyAdditionalClaims, EndUserEmail, IssuerUrl, StandardClaims, SubjectIdentifier,\n    };\n    let cct = CustomClaimType::new(\n        IssuerUrl::from_url(Url::parse(\"https://example.com\").unwrap()),\n        vec![],\n        chrono::Utc::now(),\n        chrono::Utc::now(),\n        StandardClaims::new(SubjectIdentifier::new(\"example_identifier\".to_string()))\n            .set_email(Some(EndUserEmail::new(\"billy@goat.net\".to_string()))),\n        EmptyAdditionalClaims::default(),\n    );\n\n    assert_eq!(cct.get_displayname(), \"Anonymous Kid\".to_string());\n\n    assert_eq!(\"\".to_string(), cct.get_username());\n\n    assert_eq!(\"billy@goat.net\".to_string(), cct.get_email().unwrap());\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":1}},{"line":17,"address":[],"length":0,"stats":{"Line":2}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":1}},{"line":27,"address":[],"length":0,"stats":{"Line":1}},{"line":28,"address":[],"length":0,"stats":{"Line":1}},{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":36,"address":[],"length":0,"stats":{"Line":1}},{"line":37,"address":[],"length":0,"stats":{"Line":1}},{"line":38,"address":[],"length":0,"stats":{"Line":1}}],"covered":10,"coverable":16},{"path":["/","Users","yaleman","Projects","goatns","src","web","doh","mod.rs"],"content":"use askama_axum::IntoResponse;\nuse axum::body::{Body, Bytes};\nuse axum::extract::{Query, State};\nuse axum::http::{HeaderMap, StatusCode};\nuse axum::response::Response;\nuse axum::routing::{get, post};\nuse axum::Router;\nuse base64::{engine::general_purpose, Engine as _};\nuse packed_struct::PackedStruct;\nuse serde::{Deserialize, Serialize};\nuse std::str::from_utf8;\n\nuse crate::db::get_all_fzr_by_name;\nuse crate::enums::{Rcode, RecordClass, RecordType};\nuse crate::reply::Reply;\nuse crate::resourcerecord::InternalResourceRecord;\nuse crate::servers::{parse_query, QueryProtocol};\nuse crate::web::GoatState;\nuse crate::{Header, Question, HEADER_BYTES};\n\n// TODO: when responding to requests and have an empty response, if we can find the root zone, include the SOA minimum\n\n#[derive(Debug, Serialize)]\npub struct JSONQuestion {\n    name: String,\n    #[serde(rename = \"type\")]\n    qtype: u16,\n}\n\n#[derive(Debug, Serialize)]\npub struct JSONRecord {\n    name: String,\n    #[serde(rename = \"type\")]\n    qtype: u16,\n    #[serde(rename = \"TTL\")]\n    ttl: u32,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    data: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Default, Serialize)]\npub struct JSONResponse {\n    status: u32,\n    /// Response was truncated\n    #[serde(rename = \"tc\")]\n    truncated: bool,\n    /// Recursive desired was set\n    #[serde(rename = \"rd\")]\n    recursive_desired: bool,\n    #[serde(rename = \"ra\")]\n    /// If true, it means the Recursion Available bit was set.\n    recursion_available: bool,\n    ///If true, it means that every record in the answer was verified with DNSSEC.\n    ad: bool,\n    #[serde(rename = \"cd\")]\n    /// If true, the client asked to disable DNSSEC validation.\n    client_dnssec_disable: bool,\n    #[serde(rename = \"Question\")]\n    question: Vec\u003cJSONQuestion\u003e,\n    #[serde(rename = \"Answer\")]\n    answer: Vec\u003cJSONRecord\u003e,\n    #[serde(rename = \"Comment\", skip_serializing_if = \"Option::is_none\")]\n    comment: Option\u003cString\u003e,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    error: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\n#[allow(dead_code)]\npub struct GetQueryString {\n    /// Base64-encoded raw question bytes\n    dns: Option\u003cString\u003e,\n    /// QNAME field\n    name: Option\u003cString\u003e,\n    /// Query type, defaults to A\n    #[serde(alias = \"type\", default)]\n    rrtype: Option\u003cString\u003e,\n    /// DO bit - whether the client wants DNSSEC data (either empty or one of 0, false, 1, or true).\n    #[serde(alias = \"do\", default)]\n    dnssec: bool,\n    /// CD bit - disable validation (either empty or one of 0, false, 1, or true).\n    #[serde(default)]\n    cd: bool,\n    /// id of the request, should normally be 0 for caching, but sometimes...\n    #[serde(default)]\n    id: u16,\n}\n\nimpl Default for GetQueryString {\n    fn default() -\u003e Self {\n        Self {\n            dns: None,\n            name: None,\n            rrtype: Some(\"A\".to_string()),\n            dnssec: false,\n            cd: false,\n            id: 0,\n        }\n    }\n}\n\n#[derive(Debug)]\nenum ResponseType {\n    Json,\n    Raw,\n    Invalid,\n}\n\nasync fn parse_raw_http(bytes: Vec\u003cu8\u003e) -\u003e Result\u003cGetQueryString, String\u003e {\n    let mut split_header: [u8; HEADER_BYTES] = [0; HEADER_BYTES];\n    split_header.copy_from_slice(\u0026bytes[0..HEADER_BYTES]);\n    // unpack the header for great justice\n    let header = match crate::Header::unpack(\u0026split_header) {\n        Ok(value) =\u003e value,\n        Err(error) =\u003e {\n            // can't return a servfail if we can't unpack the header, they're probably doing something bad.\n            return Err(format!(\"Failed to parse header: {:?}\", error));\n        }\n    };\n\n    let question = Question::from_packets(\u0026bytes[HEADER_BYTES..])?;\n    log::debug!(\"Question: {question:?}\");\n\n    let name = match from_utf8(\u0026question.qname) {\n        Ok(value) =\u003e value.to_string(),\n        Err(_) =\u003e {\n            format!(\"{:?}\", question.qname)\n        }\n    };\n\n    Ok(GetQueryString {\n        dns: None,\n        name: Some(name),\n        rrtype: Some(question.qtype.to_string()),\n        id: header.id,\n        cd: header.cd,\n        ..Default::default()\n    })\n}\n\nfn get_response_type_from_headers(headers: \u0026HeaderMap) -\u003e ResponseType {\n    match headers.get(\"accept\") {\n        Some(value) =\u003e match value.to_str().unwrap_or(\"\") {\n            \"application/dns-json\" =\u003e ResponseType::Json,\n            \"application/dns-message\" =\u003e ResponseType::Raw,\n            _ =\u003e ResponseType::Invalid,\n        },\n        None =\u003e ResponseType::Invalid,\n    }\n}\n\npub(crate) fn response_406() -\u003e Response {\n    (\n        StatusCode::NOT_ACCEPTABLE,\n        [(axum::http::header::CACHE_CONTROL, \"max-age=3600\")],\n        \"\",\n    )\n        .into_response()\n}\npub(crate) fn response_500() -\u003e Response {\n    (\n        StatusCode::INTERNAL_SERVER_ERROR,\n        [(axum::http::header::CACHE_CONTROL, \"max-age=1\")],\n        \"\",\n    )\n        .into_response()\n}\n\npub async fn handle_get(\n    State(state): State\u003cGoatState\u003e,\n    headers: HeaderMap,\n    Query(query): Query\u003cGetQueryString\u003e,\n) -\u003e Result\u003cResponse, Response\u003e {\n    // TODO: accept header filtering probably should be a middleware since it applies to the whole /doh route but those things are annoying as heck\n    let response_type: ResponseType = get_response_type_from_headers(\u0026headers);\n    if let ResponseType::Invalid = response_type {\n        return Err(response_406());\n    }\n\n    let mut qname: String = query.name.unwrap_or(String::new());\n    let mut rrtype: String = query.rrtype.unwrap_or(\"A\".to_string());\n    let mut id: u16 = 0;\n\n    if let Some(dns) = query.dns {\n        let bytes = match general_purpose::STANDARD.decode(dns) {\n            Ok(val) =\u003e val,\n            Err(err) =\u003e {\n                log::debug!(\"Failed to parse DoH GET RAW: {err:?}\");\n                return Err(response_500()); // TODO: this could probably be a SERVFAIL?\n            }\n        };\n\n        let query = parse_raw_http(bytes).await.map_err(|err| {\n            log::error!(\"Failed to parse DoH GET RAW: {err:?}\");\n            response_500() // TODO: should this be a SERVFAIL?\n        })?;\n        if let Some(name) = query.name {\n            qname = name;\n        }\n        rrtype = query.rrtype.unwrap_or(\"A\".to_string());\n        id = query.id;\n    }\n\n    let mut read_txn = state.read().await.connpool.begin().await.map_err(|err| {\n        log::error!(\"Failed to get DB connection: {err:?}\");\n        response_500()\n    })?;\n\n    let records = match get_all_fzr_by_name(\n        \u0026mut read_txn,\n        \u0026qname,\n        RecordType::from(rrtype.as_str()) as u16,\n    )\n    .await\n    {\n        Ok(value) =\u003e value,\n        Err(error) =\u003e {\n            log::error!(\"Failed to query {qname}/{}: {error:?}\", rrtype);\n            return Err(response_500()); // TODO: This should probably be a SERVFAIL\n        }\n    };\n\n    log::trace!(\"Completed record request...\");\n\n    let ttl = records.iter().map(|r| r.ttl).min();\n    let ttl = match ttl {\n        Some(val) =\u003e val.to_owned(),\n        None =\u003e {\n            log::trace!(\"Failed to get minimum TTL from query, using 1\");\n            1\n        }\n    };\n\n    log::trace!(\"Returned records: {records:?}\");\n\n    match response_type {\n        ResponseType::Invalid =\u003e Err(response_500()),\n        ResponseType::Json =\u003e {\n            let answer = records\n                .iter()\n                .map(|rec| JSONRecord {\n                    name: rec.name.clone(),\n                    qtype: RecordType::from(rec.rrtype.clone()) as u16,\n                    ttl: rec.ttl.to_owned(),\n                    data: Some(rec.rdata.clone()),\n                })\n                .collect();\n\n            let reply = JSONResponse {\n                answer,\n                status: Rcode::NoError as u32,\n                truncated: false,\n                recursive_desired: false,\n                recursion_available: false,\n                ad: false,\n                client_dnssec_disable: false,\n                question: vec![JSONQuestion {\n                    name: qname,\n                    qtype: RecordType::from(rrtype) as u16,\n                }],\n                ..Default::default()\n            };\n\n            let response = serde_json::to_string(\u0026reply).map_err(|err| {\n                log::error!(\"Failed to parse DoH GET request into JSON: {err:?}\");\n                response_500()\n            })?;\n\n            let response_builder = axum::response::Response::builder()\n                .status(StatusCode::OK)\n                .header(\"Content-type\", \"application/dns-json\")\n                .header(\"Cache-Control\", format!(\"max-age={ttl}\"));\n            // TODO: add handler for DNSSEC responses\n            response_builder.body(Body::from(response)).map_err(|err| {\n                log::error!(\"Failed to turn DoH GET request into JSON: {err:?}\");\n                response_500()\n            })\n        }\n        ResponseType::Raw =\u003e {\n            let answers: Vec\u003cInternalResourceRecord\u003e = records\n                .iter()\n                .filter_map(|r| {\n                    let rec: Option\u003cInternalResourceRecord\u003e = match r.to_owned().try_into() {\n                        Ok(val) =\u003e Some(val),\n                        Err(_) =\u003e None,\n                    };\n                    rec\n                })\n                .collect();\n\n            let reply = Reply {\n                header: Header {\n                    id,\n                    qr: crate::enums::PacketType::Answer,\n                    opcode: crate::enums::OpCode::Query,\n                    authoritative: true, // we're always authoritative\n                    truncated: false,\n                    recursion_desired: false,\n                    recursion_available: false,\n                    z: false,\n                    ad: false, // TODO: ad handling\n                    cd: false, // TODO: cd handling\n                    rcode: crate::enums::Rcode::NoError,\n                    qdcount: 1,\n                    ancount: records.len() as u16,\n                    nscount: 0,\n                    arcount: 0,\n                },\n                question: Some(Question {\n                    qname: qname.into(),\n                    qtype: RecordType::from(rrtype),\n                    qclass: RecordClass::Internet,\n                }),\n                answers,\n                authorities: vec![], // TODO: authorities in handle_get raw response\n                additional: vec![],  // TODO: additional fields in handle_get raw response\n            };\n\n            match reply.as_bytes().await {\n                Ok(value) =\u003e axum::response::Response::builder()\n                    .status(StatusCode::OK)\n                    .header(\"Content-type\", \"application/dns-message\")\n                    .header(\"Cache-Control\", format!(\"max-age={ttl}\"))\n                    .body(Body::from(value))\n                    .map_err(|err| {\n                        log::error!(\"Failed to turn DoH GET request into bytes: {err:?}\");\n                        response_500()\n                    }),\n                Err(err) =\u003e {\n                    log::error!(\"Failed to turn DoH GET request into bytes: {err:?}\");\n                    Err(response_500())\n                }\n            }\n        }\n    }\n}\n\npub async fn handle_post(\n    State(state): State\u003cGoatState\u003e,\n    headers: HeaderMap,\n    body: Bytes,\n) -\u003e Result\u003cResponse, Response\u003e {\n    // TODO: accept header filtering probably should be a middleware since it applies to the whole /doh route but those things are annoying as heck\n    let response_type: ResponseType = get_response_type_from_headers(\u0026headers);\n    if let ResponseType::Invalid = response_type {\n        return Err(response_406());\n    };\n    if let ResponseType::Json = response_type {\n        // TODO: maybe support JSON responses to DoH POST requests\n        return Err(response_406());\n    };\n\n    let state_reader = state.read().await;\n    let datastore = state_reader.tx.clone();\n\n    let res = parse_query(\n        datastore,\n        body.len(),\n        \u0026body,\n        state_reader.config.capture_packets,\n        QueryProtocol::DoH,\n    )\n    .await;\n\n    match res {\n        Ok(mut reply) =\u003e {\n            let bytes = match reply.as_bytes().await {\n                Ok(value) =\u003e {\n                    // we need to truncate the response\n                    if value.len() \u003e 65535 {\n                        reply.header.truncated = true;\n                        let mut bytes: Vec\u003cu8\u003e = reply.as_bytes().await.map_err(|err| {\n                            log::error!(\"Failed to turn DoH POST response into bytes: {err:?}\");\n                            response_500()\n                        })?;\n                        bytes.resize(65535, 0);\n                        bytes\n                    } else {\n                        value\n                    }\n                }\n                Err(error) =\u003e {\n                    log::error!(\"Failed to turn DoH POST response into bytes! {error:?}\");\n                    return Err(response_500());\n                }\n            };\n\n            let ttl = reply.answers.iter().map(|a| a.ttl()).min();\n            let ttl = match ttl {\n                Some(ttl) =\u003e ttl.to_owned(),\n                None =\u003e 1,\n            };\n\n            axum::response::Response::builder()\n                .status(StatusCode::OK)\n                .header(\"Content-type\", \"application/dns-message\")\n                .header(\"Cache-Control\", format!(\"max-age={ttl}\"))\n                .body(Body::from(bytes))\n                .map_err(|err| {\n                    log::error!(\"Failed to turn DoH POST response into bytes: {err:?}\");\n                    response_500()\n                })\n        }\n        Err(err) =\u003e {\n            log::error!(\"Failed to parse DoH POST query: {err:?}\");\n            Err(response_500())\n        }\n    }\n}\n\npub fn new() -\u003e Router\u003cGoatState\u003e {\n    Router::new()\n        // just zone things\n        .route(\"/\", get(handle_get))\n        .route(\"/\", post(handle_post))\n}\n","traces":[{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":4}},{"line":142,"address":[],"length":0,"stats":{"Line":4}},{"line":143,"address":[],"length":0,"stats":{"Line":4}},{"line":144,"address":[],"length":0,"stats":{"Line":6}},{"line":145,"address":[],"length":0,"stats":{"Line":3}},{"line":146,"address":[],"length":0,"stats":{"Line":1}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":1}},{"line":154,"address":[],"length":0,"stats":{"Line":1}},{"line":155,"address":[],"length":0,"stats":{"Line":1}},{"line":156,"address":[],"length":0,"stats":{"Line":1}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":4}},{"line":175,"address":[],"length":0,"stats":{"Line":4}},{"line":176,"address":[],"length":0,"stats":{"Line":4}},{"line":177,"address":[],"length":0,"stats":{"Line":1}},{"line":180,"address":[],"length":0,"stats":{"Line":3}},{"line":181,"address":[],"length":0,"stats":{"Line":3}},{"line":182,"address":[],"length":0,"stats":{"Line":3}},{"line":184,"address":[],"length":0,"stats":{"Line":3}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":18}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":3}},{"line":214,"address":[],"length":0,"stats":{"Line":3}},{"line":216,"address":[],"length":0,"stats":{"Line":3}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":3}},{"line":225,"address":[],"length":0,"stats":{"Line":4}},{"line":226,"address":[],"length":0,"stats":{"Line":3}},{"line":227,"address":[],"length":0,"stats":{"Line":1}},{"line":229,"address":[],"length":0,"stats":{"Line":2}},{"line":230,"address":[],"length":0,"stats":{"Line":2}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":3}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":2}},{"line":241,"address":[],"length":0,"stats":{"Line":3}},{"line":242,"address":[],"length":0,"stats":{"Line":1}},{"line":243,"address":[],"length":0,"stats":{"Line":1}},{"line":244,"address":[],"length":0,"stats":{"Line":1}},{"line":245,"address":[],"length":0,"stats":{"Line":1}},{"line":264,"address":[],"length":0,"stats":{"Line":2}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":2}},{"line":270,"address":[],"length":0,"stats":{"Line":2}},{"line":272,"address":[],"length":0,"stats":{"Line":2}},{"line":274,"address":[],"length":0,"stats":{"Line":2}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":1}},{"line":282,"address":[],"length":0,"stats":{"Line":1}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":1}},{"line":309,"address":[],"length":0,"stats":{"Line":1}},{"line":315,"address":[],"length":0,"stats":{"Line":1}},{"line":316,"address":[],"length":0,"stats":{"Line":1}},{"line":319,"address":[],"length":0,"stats":{"Line":1}},{"line":320,"address":[],"length":0,"stats":{"Line":1}},{"line":321,"address":[],"length":0,"stats":{"Line":1}},{"line":323,"address":[],"length":0,"stats":{"Line":1}},{"line":324,"address":[],"length":0,"stats":{"Line":1}},{"line":325,"address":[],"length":0,"stats":{"Line":1}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":10}},{"line":412,"address":[],"length":0,"stats":{"Line":10}},{"line":414,"address":[],"length":0,"stats":{"Line":10}},{"line":415,"address":[],"length":0,"stats":{"Line":10}}],"covered":56,"coverable":142},{"path":["/","Users","yaleman","Projects","goatns","src","web","generic.rs"],"content":"use super::*;\nuse crate::enums::ContactDetails;\nuse askama::Template;\nuse axum::extract::Query;\nuse serde::Deserialize;\n\npub async fn status() -\u003e String {\n    STATUS_OK.to_string()\n}\n\n#[derive(Template)]\n#[template(path = \"index.html\")]\npub(crate) struct IndexTemplate {\n    admin_contact: String,\n    error: Option\u003cString\u003e,\n    message: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\n/// If you want to be able to catch error or messages from the query string\npub(crate) struct QueryErrorOrMessage {\n    pub(crate) error: Option\u003cString\u003e,\n    pub(crate) message: Option\u003cString\u003e,\n}\n\npub(crate) async fn index(\n    axum::extract::State(state): axum::extract::State\u003cGoatState\u003e,\n    Query(query): Query\u003cQueryErrorOrMessage\u003e,\n) -\u003e Result\u003cIndexTemplate, ()\u003e {\n    let admin_contact = match state.read().await.config.admin_contact {\n        ContactDetails::None =\u003e \"\".to_string(),\n        _ =\u003e {\n            format!(\n                \"- instance cared for by {}\",\n                state.read().await.config.admin_contact\n            )\n        }\n    };\n    Ok(IndexTemplate {\n        admin_contact,\n        error: query.error,\n        message: query.message,\n    })\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":2}},{"line":8,"address":[],"length":0,"stats":{"Line":1}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}}],"covered":2,"coverable":11},{"path":["/","Users","yaleman","Projects","goatns","src","web","macros.rs"],"content":"\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","web","middleware","csp.rs"],"content":"use axum::{extract::State, http::HeaderValue, middleware::Next, response::Response};\nuse axum_csp::*;\n\nuse crate::web::GoatState;\n\npub async fn cspheaders(\n    State(state): State\u003cGoatState\u003e,\n    req: axum::extract::Request,\n    next: Next,\n) -\u003e Response {\n    let uri: String = req.uri().path().to_string();\n    let url_matcher: Option\u003cCspUrlMatcher\u003e = state.read().await.csp_matchers.iter().find_map(|c| {\n        if c.matcher.is_match(\u0026uri) {\n            Some(c.to_owned())\n        } else {\n            None\n        }\n    });\n\n    // wait for the middleware to come back\n    let mut response = next.run(req).await;\n\n    // if we found one, woot\n    if let Some(rule) = url_matcher {\n        let headers = response.headers_mut();\n        if rule.matcher.is_match(\u0026uri) {\n            let header: HeaderValue = rule.into();\n            headers.insert(\"Content-Security-Policy\", header);\n        }\n    } else {\n        log::debug!(\"didn't match uri\");\n    }\n\n    response\n}\n","traces":[{"line":6,"address":[],"length":0,"stats":{"Line":15}},{"line":11,"address":[],"length":0,"stats":{"Line":15}},{"line":12,"address":[],"length":0,"stats":{"Line":60}},{"line":13,"address":[],"length":0,"stats":{"Line":15}},{"line":14,"address":[],"length":0,"stats":{"Line":15}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":127}},{"line":24,"address":[],"length":0,"stats":{"Line":30}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":15}},{"line":27,"address":[],"length":0,"stats":{"Line":15}},{"line":28,"address":[],"length":0,"stats":{"Line":15}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":15}}],"covered":11,"coverable":14},{"path":["/","Users","yaleman","Projects","goatns","src","web","middleware","gunk.rs"],"content":"\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","web","middleware","mod.rs"],"content":"pub mod csp;\npub mod gunk;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","yaleman","Projects","goatns","src","web","mod.rs"],"content":"//! # Web things\n//!\n//! Uses axum/tower for protocol, askama for templating, confusion for the rest.\n//!\n\n#![allow(clippy::clone_on_copy)]\n// ^ this is because the datetime in the goatchildState is a jerk\nuse crate::config::ConfigFile;\nuse crate::datastore;\nuse crate::error::GoatNsError;\n\n#[cfg(not(test))]\nuse crate::logging::init_otel_subscribers;\nuse crate::web::api::docs::ApiDoc;\nuse crate::web::middleware::csp;\nuse async_trait::async_trait;\nuse axum::extract::FromRef;\nuse axum::http::StatusCode;\nuse axum::middleware::from_fn_with_state;\nuse axum::routing::get;\nuse axum::Router;\nuse axum_csp::CspUrlMatcher;\n#[cfg(not(test))]\nuse axum_tracing_opentelemetry::middleware::OtelAxumLayer;\nuse chrono::{DateTime, NaiveDateTime, TimeDelta, Utc};\nuse concread::cowcell::asynch::CowCellReadTxn;\nuse log::error;\nuse oauth2::{ClientId, ClientSecret};\nuse openidconnect::Nonce;\nuse regex::RegexSet;\nuse sqlx::{Pool, Sqlite, SqlitePool};\nuse std::collections::HashMap;\nuse std::path::PathBuf;\nuse std::sync::Arc;\nuse tokio::sync::mpsc::Sender;\nuse tokio::sync::RwLock;\nuse tokio::task::JoinHandle;\nuse tower::ServiceBuilder;\nuse tower_http::compression::CompressionLayer;\nuse tower_http::services::ServeDir;\nuse utils::{handler_404, Urls};\nuse utoipa::OpenApi;\n\nuse self::auth::CustomProviderMetadata;\n\n#[macro_use]\npub mod macros;\n\npub mod api;\npub mod auth;\npub mod doh;\npub mod generic;\npub mod middleware;\npub mod ui;\npub mod utils;\n\npub const STATUS_OK: \u0026str = \"Ok\";\n\n// TODO: look at the ServiceBuilder layers bits here: https://github.com/tokio-rs/axum/blob/dea36db400f27c025b646e5720b9a6784ea4db6e/examples/key-value-store/src/main.rs\n\n// type GoatState = Arc\u003cRwLock\u003cState\u003e\u003e;\n\n#[async_trait]\npub trait GoatStateTrait {\n    async fn connpool(\u0026self) -\u003e Pool\u003cSqlite\u003e;\n    async fn oidc_update\u003c'life0\u003e(\u0026'life0 mut self, response: CustomProviderMetadata);\n    async fn pop_verifier\u003c'life0\u003e(\u0026'life0 mut self, csrftoken: String) -\u003e Option\u003c(String, Nonce)\u003e;\n    async fn oauth2_client_id(\u0026self) -\u003e ClientId;\n    async fn oauth2_secret(\u0026self) -\u003e Option\u003cClientSecret\u003e;\n    async fn push_verifier(\u0026mut self, csrftoken: String, verifier: (String, Nonce));\n}\n\n#[async_trait]\nimpl GoatStateTrait for GoatState {\n    /// Get an sqlite connection pool\n    async fn connpool(\u0026self) -\u003e Pool\u003cSqlite\u003e {\n        self.read().await.connpool.clone()\n    }\n    async fn oidc_update\u003c'life0\u003e(\u0026'life0 mut self, response: CustomProviderMetadata) {\n        log::debug!(\"Storing OIDC config!\");\n        let mut writer = self.write().await;\n        writer.oidc_config = Some(response.clone());\n        writer.oidc_config_updated =\n            chrono::TimeZone::from_utc_datetime(\u0026Utc, \u0026NaiveDateTime::default());\n        drop(writer);\n    }\n\n    async fn pop_verifier\u003c'life0\u003e(\u0026'life0 mut self, csrftoken: String) -\u003e Option\u003c(String, Nonce)\u003e {\n        let mut writer = self.write().await;\n        writer.oidc_verifier.remove(\u0026csrftoken)\n    }\n    async fn oauth2_client_id(\u0026self) -\u003e ClientId {\n        let client_id = self.read().await.config.oauth2_client_id.clone();\n        ClientId::new(client_id)\n    }\n\n    async fn oauth2_secret(\u0026self) -\u003e Option\u003cClientSecret\u003e {\n        let client_secret = self.read().await.config.oauth2_secret.clone();\n        Some(ClientSecret::new(client_secret))\n    }\n\n    /// Store the PKCE verifier details server-side for when the user comes back with their auth token\n    async fn push_verifier(\u0026mut self, csrftoken: String, verifier: (String, Nonce)) {\n        let mut writer = self.write().await;\n        log::trace!(\"Pushing CSRF token into shared state: token={csrftoken}\");\n        writer.oidc_verifier.insert(csrftoken, verifier);\n    }\n}\n\ntype GoatState = Arc\u003cRwLock\u003cGoatChildState\u003e\u003e;\n\n#[derive(Clone, FromRef)]\n/// Internal State handler for the datastore object within the API\npub struct GoatChildState {\n    pub tx: Sender\u003cdatastore::Command\u003e,\n    pub connpool: SqlitePool,\n    pub config: ConfigFile,\n    pub oidc_config_updated: DateTime\u003cUtc\u003e,\n    pub oidc_config: Option\u003cauth::CustomProviderMetadata\u003e,\n    pub oidc_verifier: std::collections::HashMap\u003cString, (String, Nonce)\u003e,\n    pub csp_matchers: Vec\u003cCspUrlMatcher\u003e,\n}\n\nfn check_static_dir_exists(static_dir: \u0026PathBuf, config: \u0026ConfigFile) -\u003e bool {\n    match static_dir.try_exists() {\n        Ok(res) =\u003e match res {\n            true =\u003e {\n                log::info!(\"Found static resources dir ({static_dir:#?}) for web API.\");\n                return true;\n            }\n            false =\u003e {\n                log::error!(\"Couldn't find static resources dir ({static_dir:#?}) for web API!\")\n            }\n        },\n        Err(err) =\u003e match err.kind() {\n            std::io::ErrorKind::PermissionDenied =\u003e {\n                log::error!(\n                    \"Permission denied accssing static resources dir ({:?}) for web API: {}\",\n                    \u0026config.api_static_dir,\n                    err.to_string()\n                )\n            }\n            std::io::ErrorKind::NotFound =\u003e {\n                log::error!(\n                    \"Static resources dir ({:?}) not found for web API: {}\",\n                    \u0026config.api_static_dir,\n                    err.to_string()\n                )\n            }\n            _ =\u003e log::error!(\n                \"Error accessing static resources dir ({:?}) for web API: {}\",\n                \u0026config.api_static_dir,\n                err.to_string()\n            ),\n        },\n    }\n    false\n}\n\npub async fn build(\n    tx: Sender\u003cdatastore::Command\u003e,\n    config: CowCellReadTxn\u003cConfigFile\u003e,\n    connpool: SqlitePool,\n) -\u003e Result\u003cJoinHandle\u003cResult\u003c(), std::io::Error\u003e\u003e, GoatNsError\u003e {\n    let static_dir: PathBuf = shellexpand::tilde(\u0026config.api_static_dir)\n        .to_string()\n        .into();\n\n    #[cfg(not(test))]\n    init_otel_subscribers().map_err(|err| {\n        GoatNsError::StartupError(format!(\"Failed to initialize OpenTelemetry tracing: {err}\"))\n    })?;\n\n    let session_layer = auth::build_auth_stores(config.clone(), connpool.clone()).await?;\n\n    let csp_matchers = vec![CspUrlMatcher::default_self(\n        RegexSet::new([r\"^(/|/ui)\"]).map_err(|err| {\n            GoatNsError::StartupError(format!(\"Failed to generate CSP matchers regex: {err}\"))\n        })?,\n    )];\n\n    // we set this to an hour ago so it forces update on startup\n    #[allow(clippy::expect_used)]\n    let oidc_config_updated = Utc::now() - TimeDelta::try_hours(1).expect(\"how did this fail?\");\n    // let config_clone: ConfigFile = ConfigFile::from(\u0026config);\n    let state = Arc::new(RwLock::new(GoatChildState {\n        tx,\n        connpool,\n        config: (*config).clone(),\n        oidc_config_updated,\n        oidc_config: None,\n        oidc_verifier: HashMap::new(),\n        csp_matchers,\n    }));\n\n    let service_layer = ServiceBuilder::new()\n        .layer(session_layer)\n        .layer(from_fn_with_state(state.clone(), csp::cspheaders));\n\n    let router = Router::new()\n        .route(Urls::Home.as_ref(), get(generic::index))\n        .nest(\"/ui\", ui::new())\n        .nest(\"/api\", api::new())\n        .merge(\n            utoipa_swagger_ui::SwaggerUi::new(\"/api/docs\")\n                .url(\"/api/openapi.json\", ApiDoc::openapi()),\n        )\n        .nest(\"/auth\", auth::new())\n        .nest(\"/dns-query\", doh::new())\n        .with_state(state)\n        .layer(service_layer);\n\n    // here we add the tracing layer\n    #[cfg(not(test))]\n    let router = router.layer(OtelAxumLayer::default());\n\n    let router = router.route(\"/status\", get(generic::status));\n\n    let router = match check_static_dir_exists(\u0026static_dir, \u0026config) {\n        true =\u003e router.nest_service(\"/static\", ServeDir::new(\u0026static_dir)),\n        false =\u003e router,\n    };\n    let router = router.layer(CompressionLayer::new()).fallback(handler_404);\n\n    let tls_config = config\n        .get_tls_config()\n        .await\n        .map_err(GoatNsError::StartupError)?;\n\n    let res: JoinHandle\u003cResult\u003c(), std::io::Error\u003e\u003e = tokio::spawn(\n        axum_server::bind_rustls(config.api_listener_address()?, tls_config)\n            .serve(router.into_make_service()),\n    );\n    let startup_message = format!(\n        \"Started Web server on https://{} / https://{}:{}\",\n        config.api_listener_address()?,\n        config.hostname,\n        config.api_port\n    );\n\n    #[cfg(test)]\n    println!(\"{}\", startup_message);\n    log::info!(\"{}\", startup_message);\n    Ok(res)\n}\n","traces":[{"line":76,"address":[],"length":0,"stats":{"Line":8}},{"line":77,"address":[],"length":0,"stats":{"Line":16}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":10}},{"line":125,"address":[],"length":0,"stats":{"Line":10}},{"line":126,"address":[],"length":0,"stats":{"Line":10}},{"line":128,"address":[],"length":0,"stats":{"Line":10}},{"line":129,"address":[],"length":0,"stats":{"Line":10}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":10}},{"line":165,"address":[],"length":0,"stats":{"Line":10}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":40}},{"line":176,"address":[],"length":0,"stats":{"Line":20}},{"line":177,"address":[],"length":0,"stats":{"Line":10}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":10}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":10}},{"line":227,"address":[],"length":0,"stats":{"Line":20}},{"line":228,"address":[],"length":0,"stats":{"Line":10}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":10}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":10}}],"covered":18,"coverable":87},{"path":["/","Users","yaleman","Projects","goatns","src","web","ui","admin_ui.rs"],"content":"use crate::db::{DBEntity, User, ZoneOwnership};\nuse crate::web::utils::Urls;\nuse crate::web::GoatState;\nuse crate::zones::FileZone;\nuse askama::Template;\nuse axum::extract::{Path, State};\nuse axum::http::Uri;\nuse axum::response::Redirect;\nuse axum::routing::get;\nuse axum::{Form, Router};\nuse serde::Deserialize;\nuse sqlx::Row;\nuse tower_sessions::Session;\nuse tracing::debug;\n\nuse super::check_logged_in;\n\n#[derive(Template)]\n#[template(path = \"admin_ui.html\")]\npub(crate) struct AdminUITemplate /*\u003c'a\u003e*/ {\n    // name: \u0026'a str,\n    pub user_is_admin: bool,\n}\n\n#[derive(Template)]\n#[template(path = \"admin_report_unowned_records.html\")]\npub(crate) struct AdminReportUnownedRecords /*\u003c'a\u003e*/ {\n    // name: \u0026'a str,\n    pub user_is_admin: bool,\n    pub records: Vec\u003cZoneRecord\u003e,\n\n    pub zones: Vec\u003cFileZone\u003e,\n}\n\n#[allow(dead_code)] // because this is only used in a template\n/// Template struct for showing a zone record\npub(crate) struct ZoneRecord {\n    id: u32,\n    name: String,\n    zoneid: u32,\n}\n\npub(crate) async fn dashboard(mut session: Session) -\u003e Result\u003cAdminUITemplate, Redirect\u003e {\n    let user = check_logged_in(\u0026mut session, Uri::from_static(Urls::Home.as_ref())).await?;\n\n    Ok(AdminUITemplate {\n        user_is_admin: user.admin,\n    })\n}\n\npub(crate) async fn report_unowned_records(\n    mut session: Session,\n    axum::extract::State(state): axum::extract::State\u003cGoatState\u003e,\n) -\u003e Result\u003cAdminReportUnownedRecords, Redirect\u003e {\n    let user = check_logged_in(\u0026mut session, Uri::from_static(Urls::Home.as_ref())).await?;\n\n    let mut pool = state.read().await.connpool.acquire().await.map_err(|err| {\n        log::error!(\"Failed to get DB connection: {err:?}\");\n        Redirect::to(Urls::Dashboard.as_ref())\n    })?;\n\n    let rows = match sqlx::query(\n        \"select records_merged.record_id as id, records_merged.* from records_merged\n        left join ownership\n        ON records_merged.record_id = ownership.id\n        where ownership.id is NULL\",\n    )\n    .fetch_all(\u0026mut *pool)\n    .await\n    {\n        Ok(val) =\u003e {\n            log::debug!(\"Got the rows!\");\n            val\n        }\n        Err(err) =\u003e {\n            log::error!(\"Failed to query records from DB: {err:?}\");\n            vec![]\n        }\n    };\n\n    log::debug!(\"starting to do the rows!\");\n\n    let records: Vec\u003cZoneRecord\u003e = rows\n        .iter()\n        .map(|r| ZoneRecord {\n            id: r.get(\"id\"),\n            name: r.get(\"name\"),\n            zoneid: r.get(\"zoneid\"),\n        })\n        .collect();\n\n    Ok(AdminReportUnownedRecords {\n        user_is_admin: user.admin,\n        records,\n        zones: FileZone::get_unowned(\u0026mut pool).await.map_err(|err| {\n            log::error!(\"Failed to get unowned zones: {err:?}\");\n            Redirect::to(Urls::Admin.as_ref())\n        })?,\n    })\n}\n\n#[derive(Template)]\n#[template(path = \"admin_ownership_template.html\")]\npub(crate) struct AssignOwnershipTemplate {\n    user_is_admin: bool,\n    zone: Box\u003cFileZone\u003e,\n    user: Option\u003cString\u003e,\n}\n\n#[derive(Deserialize)]\npub(crate) struct AssignOwnershipForm {\n    // userid: Option\u003ci64\u003e,\n    username: Option\u003cString\u003e,\n}\n\npub(crate) async fn assign_zone_ownership(\n    mut session: Session,\n    State(state): State\u003cGoatState\u003e,\n    Path(id): Path\u003ci64\u003e,\n    Form(form): Form\u003cAssignOwnershipForm\u003e,\n) -\u003e Result\u003cAssignOwnershipTemplate, Redirect\u003e {\n    let user = check_logged_in(\u0026mut session, Uri::from_static(Urls::Home.as_ref())).await?;\n\n    let mut txn = state.read().await.connpool.begin().await.map_err(|err| {\n        log::error!(\"Failed to start transaction: {err:?}\");\n        Redirect::to(Urls::Admin.as_ref())\n    })?;\n\n    let zone = FileZone::get(\u0026state.read().await.connpool, id)\n        .await\n        .map_err(|err| {\n            log::error!(\"Failed to get zone by ID: {err:?}\");\n            Redirect::to(Urls::Admin.as_ref())\n        })?;\n\n    if let Some(username) = form.username.as_ref() {\n        debug!(\"Got a username in the form!\");\n        let user = User::get_by_name(\u0026mut txn, username.as_str())\n            .await\n            .map_err(|err| {\n                log::error!(\"Failed to get user by name: {err:?}\");\n                Redirect::to(Urls::Admin.as_ref())\n            })?;\n        drop(txn);\n        if let Some(user) = user {\n            if let (Some(userid), Some(zoneid)) = (user.id, zone.id) {\n                // woo we found a valid user!\n                ZoneOwnership {\n                    id: None,\n                    zoneid,\n                    userid,\n                }\n                .save(\u0026state.read().await.connpool)\n                .await\n                .map_err(|err| {\n                    log::error!(\"Failed to insert zone ownership: {err:?}\");\n                    Redirect::to(Urls::Admin.as_ref())\n                })?;\n                return Err(Redirect::to(Urls::Admin.as_ref()));\n            }\n        }\n    }\n\n    Ok(AssignOwnershipTemplate {\n        user_is_admin: user.admin,\n        zone,\n        user: form.username,\n    })\n}\n\n/// Build the router for user settings\npub fn router() -\u003e Router\u003cGoatState\u003e {\n    Router::new()\n        .route(\"/\", get(dashboard))\n        .route(\"/reports/unowned_records\", get(report_unowned_records))\n        .route(\n            \"/zones/assign_ownership/:id\",\n            get(assign_zone_ownership).post(assign_zone_ownership),\n        )\n}\n","traces":[{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":10}},{"line":173,"address":[],"length":0,"stats":{"Line":10}},{"line":174,"address":[],"length":0,"stats":{"Line":10}},{"line":175,"address":[],"length":0,"stats":{"Line":10}},{"line":178,"address":[],"length":0,"stats":{"Line":10}}],"covered":5,"coverable":60},{"path":["/","Users","yaleman","Projects","goatns","src","web","ui","mod.rs"],"content":"use std::collections::HashMap;\n\nuse crate::datastore::Command;\nuse crate::db::User;\nuse crate::web::utils::Urls;\nuse crate::zones::FileZone;\nuse askama::Template;\nuse axum::extract::{OriginalUri, Path, Query, State};\nuse axum::http::{StatusCode, Uri};\nuse axum::response::{IntoResponse, Redirect};\nuse axum::routing::{get, post};\nuse axum::Router;\nuse serde::Deserialize;\nuse tower_sessions::Session;\nuse tracing::error;\n\nuse super::GoatState;\n\nmod admin_ui;\nmod profile;\nmod user_settings;\nmod zones;\n\n#[derive(Template)]\n#[template(path = \"view_zones.html\")]\npub(crate) struct TemplateViewZones {\n    zones: Vec\u003cFileZone\u003e,\n    pub user_is_admin: bool,\n    message: Option\u003cString\u003e,\n    error: Option\u003cString\u003e,\n}\n\n#[derive(Template)]\n#[template(path = \"view_zone.html\")]\npub(crate) struct TemplateViewZone {\n    zone: FileZone,\n    pub user_is_admin: bool,\n}\n\n#[derive(Deserialize)]\npub(crate) struct ViewZonesQueryString {\n    message: Option\u003cString\u003e,\n    error: Option\u003cString\u003e,\n}\n\npub(crate) async fn zones_list(\n    State(state): State\u003cGoatState\u003e,\n    mut session: Session,\n    OriginalUri(path): OriginalUri,\n    Query(query): Query\u003cViewZonesQueryString\u003e,\n) -\u003e Result\u003cTemplateViewZones, impl IntoResponse\u003e {\n    let user = check_logged_in(\u0026mut session, path)\n        .await\n        .map_err(|err| err.into_response())?;\n    let (os_tx, os_rx) = tokio::sync::oneshot::channel();\n\n    let offset = 0;\n    let limit = 20;\n\n    log::trace!(\"Sending request for zones\");\n    if let Err(err) = state\n        .read()\n        .await\n        .tx\n        .send(Command::GetZoneNames {\n            resp: os_tx,\n            user: user.clone(),\n            offset,\n            limit,\n        })\n        .await\n    {\n        eprintln!(\"failed to send GetZoneNames command to datastore: {err:?}\");\n        log::error!(\"failed to send GetZoneNames command to datastore: {err:?}\");\n        return Err(Urls::Dashboard.redirect().into_response());\n    };\n\n    let zones = os_rx.await.map_err(|err| {\n        error!(\"Failed to get zones for user={:?} error={:?}\", user.id, err);\n        (\n            StatusCode::INTERNAL_SERVER_ERROR,\n            format!(\"Error getting zones: {err:?}\"),\n        )\n            .into_response()\n    })?;\n\n    Ok(TemplateViewZones {\n        zones,\n        user_is_admin: user.admin,\n        message: query.message,\n        error: query.error,\n    })\n}\n\npub(crate) async fn zone_view(\n    OriginalUri(path): OriginalUri,\n    Path(name_or_id): Path\u003ci64\u003e,\n    State(state): State\u003cGoatState\u003e,\n    mut session: Session,\n) -\u003e Result\u003cTemplateViewZone, impl IntoResponse\u003e {\n    let user = check_logged_in(\u0026mut session, path)\n        .await\n        .map_err(|err| err.into_response())?;\n\n    let (os_tx, os_rx) = tokio::sync::oneshot::channel();\n    let cmd = Command::GetZone {\n        resp: os_tx,\n        id: Some(name_or_id),\n        name: None,\n    };\n    log::debug!(\"{cmd:?}\");\n    if let Err(err) = state.read().await.tx.send(cmd).await {\n        eprintln!(\"failed to send GetZone command to datastore: {err:?}\");\n        log::error!(\"failed to send GetZone command to datastore: {err:?}\");\n        return Err(Urls::ZonesList.redirect().into_response());\n    };\n\n    let zone = match os_rx.await {\n        Ok(zone) =\u003e match zone {\n            Some(value) =\u003e value,\n            None =\u003e {\n                return Err((\n                    axum::http::StatusCode::NOT_FOUND,\n                    format!(\"Zone '{}' not found\", name_or_id),\n                )\n                    .into_response())\n            }\n        },\n        Err(err) =\u003e {\n            log::error!(\"failed to get response from datastore: {err:?}\");\n            return Err(Urls::ZonesList.redirect().into_response());\n        }\n    };\n\n    log::trace!(\"Returning zone: {zone:?}\");\n    Ok(TemplateViewZone {\n        zone,\n        user_is_admin: user.admin,\n    })\n}\n\npub async fn check_logged_in(session: \u0026mut Session, path: Uri) -\u003e Result\u003cUser, Redirect\u003e {\n    let authref: Option\u003cString\u003e = session\n        .get(\"authref\")\n        .await\n        .map_err(|_e| Urls::Login.redirect())?;\n\n    let redirect_path = Some(\n        path.path_and_query()\n            .map(|v| v.to_string())\n            .unwrap_or(\"/\".to_string()),\n    );\n    if authref.is_none() {\n        session.clear().await;\n\n        session\n            .insert(\"redirect\", redirect_path)\n            .await\n            .map_err(|e| {\n                log::debug!(\"Couldn't store redirect for user: {e:?}\");\n                Urls::Home.redirect_with_query(HashMap::from([(\n                    \"error\",\n                    \"An error storing your session occurred!\",\n                )]))\n            })?;\n        log::debug!(\"Not-logged-in-user tried to log in, how rude!\");\n        // TODO: this should redirect to the current page\n        return Err(Urls::Login.redirect());\n    }\n    log::debug!(\"session ok!\");\n\n    let user = match session.get(\"user\").await.unwrap_or(None) {\n        Some(val) =\u003e val,\n        None =\u003e return Err(Urls::Login.redirect()),\n    };\n\n    // TODO: check the database to make sure they're actually legit and not disabled and blah\n    Ok(user)\n}\n\n#[derive(Template)]\n#[template(path = \"dashboard.html\")]\npub(crate) struct DashboardTemplate /*\u003c'a\u003e*/ {\n    // name: \u0026'a str,\n    pub user_is_admin: bool,\n}\n\npub(crate) async fn dashboard(\n    mut session: Session,\n    OriginalUri(path): OriginalUri,\n) -\u003e Result\u003cDashboardTemplate, Redirect\u003e {\n    let user = check_logged_in(\u0026mut session, path).await?;\n\n    Ok(DashboardTemplate {\n        user_is_admin: user.admin,\n    })\n}\n\npub fn new() -\u003e Router\u003cGoatState\u003e {\n    Router::new()\n        .route(\"/\", get(dashboard))\n        .route(\"/zones/:id\", get(zone_view))\n        .route(\"/zones/list\", get(zones_list))\n        .route(\"/zones/new\", post(zones::zones_new_post))\n        .route(\"/profile\", get(profile::user_profile_get))\n        .nest(\"/settings\", user_settings::router())\n        .nest(\"/admin\", admin_ui::router())\n}\n","traces":[{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":10}},{"line":200,"address":[],"length":0,"stats":{"Line":10}},{"line":201,"address":[],"length":0,"stats":{"Line":10}},{"line":202,"address":[],"length":0,"stats":{"Line":10}},{"line":203,"address":[],"length":0,"stats":{"Line":10}},{"line":204,"address":[],"length":0,"stats":{"Line":10}},{"line":205,"address":[],"length":0,"stats":{"Line":10}},{"line":206,"address":[],"length":0,"stats":{"Line":10}},{"line":207,"address":[],"length":0,"stats":{"Line":10}}],"covered":9,"coverable":83},{"path":["/","Users","yaleman","Projects","goatns","src","web","ui","profile.rs"],"content":"//! User profile things\n//!\n\nuse askama::Template;\nuse axum::extract::{OriginalUri, State};\nuse axum::response::Redirect;\nuse tower_sessions::Session;\n\nuse crate::db::User;\nuse crate::web::ui::check_logged_in;\n\nuse crate::web::GoatState;\n\n#[derive(Template)]\n#[template(path = \"view_profile.html\")]\npub(crate) struct UserProfilePage {\n    pub user: User,\n    pub user_is_admin: bool,\n}\n\npub(crate) async fn user_profile_get(\n    State(_state): State\u003cGoatState\u003e,\n    mut session: Session,\n    OriginalUri(path): OriginalUri,\n) -\u003e Result\u003cUserProfilePage, Redirect\u003e {\n    // check_logged_in!(state, session, path);\n\n    let user: User = check_logged_in(\u0026mut session, path).await?;\n    Ok(UserProfilePage {\n        user_is_admin: user.admin,\n        user,\n    })\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":5},{"path":["/","Users","yaleman","Projects","goatns","src","web","ui","user_settings.rs"],"content":"use crate::db::{DBEntity, User};\nuse crate::error::GoatNsError;\nuse crate::web::ui::check_logged_in;\nuse crate::web::utils::{create_api_token, Urls};\nuse std::collections::HashMap;\nuse std::fmt::Display;\nuse std::str::FromStr;\nuse std::sync::Arc;\n\nuse askama::Template;\nuse axum::extract::{OriginalUri, Path, State};\nuse axum::response::{Html, IntoResponse, Redirect};\nuse axum::routing::get;\nuse axum::routing::post;\nuse axum::{Form, Router};\n\nuse axum::http::Uri;\nuse chrono::{DateTime, TimeDelta, Utc};\nuse enum_iterator::Sequence;\nuse oauth2::CsrfToken;\nuse serde::{Deserialize, Serialize};\nuse tower_sessions::Session;\nuse tracing::{error, info};\n\nuse crate::db::UserAuthToken;\nuse crate::web::GoatState;\n\nstatic SESSION_CSRFTOKEN_FIELD: \u0026str = \"api_token_csrf_token\";\n\n#[derive(Template)]\n#[template(path = \"user_settings.html\")]\npub(crate) struct Settings {\n    pub user_is_admin: bool,\n}\n\n/// The user settings page at /ui/settings\npub(crate) async fn settings(State(_state): State\u003cGoatState\u003e) -\u003e Settings {\n    Settings {\n        user_is_admin: true,\n    }\n}\n\n#[derive(Template)]\n#[template(path = \"user_api_tokens.html\")]\npub(crate) struct ApiTokensGetPage {\n    csrftoken: String,\n    tokens: Vec\u003cArc\u003cUserAuthToken\u003e\u003e,\n    tokenkey: Option\u003cString\u003e,\n    token_value: Option\u003cString\u003e,\n    pub user_is_admin: bool,\n}\n\npub async fn validate_csrf_expiry(user_input: \u0026str, session: \u0026mut Session) -\u003e bool {\n    let session_token: String = match session.get(SESSION_CSRFTOKEN_FIELD).await.unwrap_or(None) {\n        None =\u003e {\n            let _ = session\n                .remove_value(SESSION_CSRFTOKEN_FIELD)\n                .await\n                .inspect_err(|err| {\n                    error!(\"Failed to remove CSRF token from session: {err:?}\");\n                });\n            log::debug!(\"Couldn't get session token from storage\");\n            return false;\n        }\n        Some(value) =\u003e value,\n    };\n\n    let mut split = session_token.split('|');\n    let csrf_token = match split.next() {\n        None =\u003e {\n            log::debug!(\"Didn't get split token\");\n            return false;\n        }\n        Some(value) =\u003e value,\n    };\n\n    if user_input != csrf_token {\n        log::debug!(\"Session and form CSRF token failed to match! user={user_input} \u003c\u003e session={csrf_token}\");\n        return false;\n    }\n\n    let expiry = match split.next() {\n        None =\u003e {\n            log::debug!(\"Couldn't get timestamp from stored CSRF Token\");\n            let _ = session\n                .remove_value(SESSION_CSRFTOKEN_FIELD)\n                .await\n                .inspect_err(|err| {\n                    error!(\"Failed to remove CSRF token from session: {err:?}\");\n                });\n            return false;\n        }\n        Some(value) =\u003e value,\n    };\n\n    let expiry: DateTime\u003cUtc\u003e = match DateTime::parse_from_rfc3339(expiry) {\n        Err(error) =\u003e {\n            log::debug!(\"Failed to parse {expiry:?} into datetime: {error:?}\");\n            let _ = session\n                .remove_value(SESSION_CSRFTOKEN_FIELD)\n                .await\n                .inspect_err(|err| {\n                    error!(\"Failed to remove CSRF token from session: {err:?}\");\n                });\n            return false;\n        }\n        Ok(value) =\u003e value.into(),\n    };\n    let now = Utc::now();\n\n    if expiry \u003c now {\n        log::debug!(\"Token has expired at {expiry:?}, time is now {now:?}\");\n        let _ = session\n            .remove_value(SESSION_CSRFTOKEN_FIELD)\n            .await\n            .inspect_err(|err| {\n                error!(\"Failed to remove CSRF token from session: {err:?}\");\n            });\n        return false;\n    }\n    log::debug!(\"CSRF Token was valid!\");\n    true\n}\n\n/// Store a CSRF token with an expiry in the session store\n///\n/// Expiry defaults to 5 (minutes)\nasync fn store_api_csrf_token(\n    session: \u0026mut Session,\n    expiry_plus_seconds: Option\u003ci64\u003e,\n) -\u003e Result\u003cString, GoatNsError\u003e {\n    let csrftoken = CsrfToken::new_random();\n    let csrftoken = csrftoken.secret().to_string();\n\n    let delta_time = match TimeDelta::try_seconds(expiry_plus_seconds.unwrap_or(300)) {\n        Some(val) =\u003e val,\n        None =\u003e {\n            return Err(GoatNsError::Csrf(\n                \"Failed to calculate CSRF expiry!\".to_string(),\n            ))\n        }\n    };\n    let csrf_expiry: DateTime\u003cUtc\u003e = Utc::now() + delta_time;\n\n    let stored_csrf = format!(\"{csrftoken}|{}\", csrf_expiry.to_rfc3339());\n\n    // store it in the session storage\n    session\n        .insert(SESSION_CSRFTOKEN_FIELD, stored_csrf)\n        .await\n        .map_err(|err| {\n            // TODO: nice errors are nice but secure errors are better\n            GoatNsError::Csrf(format!(\"Failed to store CSRF Token for user: {err:?}\"))\n        })?;\n    Ok(csrftoken)\n}\n\n/// The user settings page at /ui/settings/api_tokens\npub async fn api_tokens_get(\n    State(state): State\u003cGoatState\u003e,\n    mut session: Session,\n) -\u003e Result\u003cApiTokensGetPage, Redirect\u003e {\n    let user = check_logged_in(\n        \u0026mut session,\n        Uri::from_static(Urls::SettingsApiTokens.as_ref()),\n    )\n    .await?;\n\n    let csrftoken = match store_api_csrf_token(\u0026mut session, None).await {\n        Ok(value) =\u003e value,\n        Err(error) =\u003e {\n            log::error!(\"Failed to store csrf token in DB: {error:?}\");\n            return Err(Urls::Home.redirect());\n        }\n    };\n\n    // pull token from the session store new_api_token\n    let token_value: Option\u003cString\u003e = match session.remove(\"new_api_token\").await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            log::error!(\"Failed to get new_api_token from session store: {err:?}\");\n            return Err(Urls::Dashboard.redirect());\n        }\n    };\n    let tokenkey: Option\u003cString\u003e = match session.remove(\"new_api_tokenkey\").await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            log::error!(\"Failed to get new_api_tokenkey from session store: {err:?}\");\n            return Err(Urls::Dashboard.redirect());\n        }\n    };\n\n    let user_id = match user.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            log::debug!(\"Couldn't get user id from session store\");\n            return Err(Urls::Dashboard.redirect());\n        }\n    };\n\n    let tokens = match UserAuthToken::get_all_user(\u0026state.read().await.connpool, user_id).await {\n        Err(error) =\u003e {\n            log::error!(\"Failed to pull tokens for user {:#?}: {error:?}\", user_id);\n            vec![]\n        }\n        Ok(val) =\u003e val,\n    };\n\n    Ok(ApiTokensGetPage {\n        csrftoken,\n        tokens,\n        tokenkey,\n        token_value,\n        user_is_admin: user.admin,\n    })\n}\n\n#[derive(Debug, Deserialize, Serialize, Eq, PartialEq, Sequence)]\npub enum ApiTokenLifetime {\n    EightHours,\n    TwentyFourHours,\n    ThirtyDays,\n    Forever,\n}\n\nimpl From\u003cApiTokenLifetime\u003e for i32 {\n    fn from(input: ApiTokenLifetime) -\u003e Self {\n        match input {\n            ApiTokenLifetime::EightHours =\u003e 8 * 60 * 60,\n            ApiTokenLifetime::TwentyFourHours =\u003e 24 * 60 * 60,\n            ApiTokenLifetime::ThirtyDays =\u003e 30 * 86400,\n            ApiTokenLifetime::Forever =\u003e -1,\n        }\n    }\n}\n\nimpl Display for ApiTokenLifetime {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        f.write_str(match self {\n            ApiTokenLifetime::EightHours =\u003e \"Eight Hours (8h)\",\n            ApiTokenLifetime::TwentyFourHours =\u003e \"Twenty-Four Hours (24h)\",\n            ApiTokenLifetime::ThirtyDays =\u003e \"Thirty Days (30d)\",\n            ApiTokenLifetime::Forever =\u003e \"No Expiry\",\n        })\n    }\n}\n\nimpl ApiTokenLifetime {\n    fn variant_str(\u0026self) -\u003e String {\n        match self {\n            ApiTokenLifetime::EightHours =\u003e \"EightHours\".to_string(),\n            ApiTokenLifetime::TwentyFourHours =\u003e \"TwentyFourHours\".to_string(),\n            ApiTokenLifetime::ThirtyDays =\u003e \"ThirtyDays\".to_string(),\n            ApiTokenLifetime::Forever =\u003e \"Forever\".to_string(),\n        }\n    }\n}\n\n/// WHere are they in their token-creation-lifecycle?\n#[derive(Debug, Deserialize, Serialize, Eq, PartialEq)]\npub enum ApiTokenCreatePageState {\n    Start,\n    Generating,\n    Finished,\n    Error,\n}\n\nimpl Display for ApiTokenCreatePageState {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            ApiTokenCreatePageState::Start =\u003e f.write_fmt(format_args!(\"Start\")),\n            ApiTokenCreatePageState::Generating =\u003e f.write_fmt(format_args!(\"Generating\")),\n            ApiTokenCreatePageState::Finished =\u003e f.write_fmt(format_args!(\"Finished\")),\n            ApiTokenCreatePageState::Error =\u003e f.write_fmt(format_args!(\"Error\")),\n        }\n    }\n}\n\nimpl Default for ApiTokenCreatePageState {\n    fn default() -\u003e Self {\n        Self::Start\n    }\n}\n\nimpl ApiTokenCreatePageState {\n    pub fn next(\u0026self) -\u003e Self {\n        match \u0026self {\n            ApiTokenCreatePageState::Start =\u003e Self::Generating,\n            ApiTokenCreatePageState::Generating =\u003e Self::Finished,\n            ApiTokenCreatePageState::Finished =\u003e Self::Error,\n            ApiTokenCreatePageState::Error =\u003e Self::Start,\n        }\n    }\n}\n\n/// Form handler for the api tokens post endpoint\n#[derive(Debug, Deserialize, Serialize, Eq, PartialEq, Default)]\npub struct ApiTokenForm {\n    pub token_name: Option\u003cString\u003e,\n    pub tokenkey: Option\u003cString\u003e,\n    /// For when we want show the token\n    pub token_value: Option\u003cString\u003e,\n    pub csrftoken: String,\n    pub state: ApiTokenCreatePageState,\n    /// When the user selects the lifetime in the creation form\n    pub lifetime: Option\u003cApiTokenLifetime\u003e,\n}\n/// Form handler for the api tokens post endpoint\n#[derive(Debug, Deserialize, Serialize, Eq, PartialEq, Template, Default)]\n#[template(path = \"user_api_token_form.html\")]\npub struct ApiTokenPage {\n    pub token_name: Option\u003cString\u003e,\n    pub tokenkey: Option\u003cString\u003e,\n    /// For when we want show the token\n    pub token_value: Option\u003cString\u003e,\n    pub csrftoken: String,\n    pub state: ApiTokenCreatePageState,\n    /// When the user selects the lifetime in the creation form\n    pub lifetime: Option\u003cApiTokenLifetime\u003e,\n    /// Used to show the possible lifetimes in the creation form\n    pub lifetimes: Option\u003cVec\u003c(String, String)\u003e\u003e,\n    pub user_is_admin: bool,\n}\n\n/// The user settings page at /ui/settings\n// #[debug_handler]\npub async fn api_tokens_post(\n    mut session: Session,\n    State(state): State\u003cGoatState\u003e,\n    Form(form): Form\u003cApiTokenForm\u003e,\n) -\u003e Result\u003cimpl IntoResponse, Redirect\u003e {\n    eprintln!(\"Got form: {form:?}\");\n\n    let user = check_logged_in(\n        \u0026mut session,\n        Uri::from_static(Urls::SettingsApiTokens.as_ref()),\n    )\n    .await?;\n\n    if !validate_csrf_expiry(\u0026form.csrftoken, \u0026mut session).await {\n        // TODO: redirect to the start\n        log::debug!(\"Failed to validate csrf expiry\");\n        return Err(Urls::Settings.redirect());\n    }\n\n    let context = match form.state {\n        // Present the \"select a lifetime\" page\n        ApiTokenCreatePageState::Start =\u003e {\n            // present the user with the lifetime form\n            let lifetimes: Vec\u003c(String, String)\u003e = enum_iterator::all::\u003cApiTokenLifetime\u003e()\n                .map(|l| (l.to_string(), l.variant_str()))\n                .collect();\n            eprintln!(\"Lifetimes: {lifetimes:?}\");\n\n            let csrftoken = match store_api_csrf_token(\u0026mut session, None).await {\n                Ok(val) =\u003e val,\n                Err(err) =\u003e {\n                    log::error!(\"Failed to store CSRF token in the session store: {err:?}\");\n                    return Err(Urls::SettingsApiTokens.redirect());\n                }\n            };\n\n            ApiTokenPage {\n                csrftoken,\n                state: ApiTokenCreatePageState::Start,\n                token_name: None,\n                lifetimes: Some(lifetimes),\n                lifetime: None,\n                tokenkey: None,\n                token_value: None,\n                user_is_admin: user.admin,\n            }\n            .into_response()\n        }\n        // The user has set a lifetime and we're generating a token\n        ApiTokenCreatePageState::Generating =\u003e {\n            log::debug!(\"In the 'Generating' state\");\n\n            // generate the credential\n\n            let state_reader = state.read().await;\n            let api_cookie_secret = state_reader.config.api_cookie_secret();\n            let lifetime: i32 = form.lifetime.unwrap_or(ApiTokenLifetime::EightHours).into();\n            // get the user id from the session store, we should be able to safely unwrap here because we checked they were logged in up higher\n\n            let userid: i64 = match user.id {\n                Some(val) =\u003e val,\n                None =\u003e {\n                    log::error!(\"Failed to get user id from session store\");\n                    return Err(Urls::SettingsApiTokens.redirect());\n                }\n            };\n\n            let api_token = create_api_token(api_cookie_secret, lifetime, userid);\n\n            let name = match form.token_name {\n                Some(val) =\u003e val,\n                None =\u003e {\n                    log::error!(\"Failed to get token name from form\");\n                    return Err(Urls::SettingsApiTokens.redirect_with_query(HashMap::from([(\n                        \"error\",\n                        \"Token name needs to be set!\",\n                    )])));\n                }\n            };\n            let uat = UserAuthToken {\n                id: None,\n                name,\n                issued: api_token.issued,\n                expiry: api_token.expiry,\n                userid,\n                tokenkey: api_token.token_key.to_owned(),\n                tokenhash: api_token.token_hash,\n            };\n            log::trace!(\"Starting to store token in the DB, grabbing transaction...\");\n\n            let mut txn = match state_reader.connpool.begin().await {\n                Ok(val) =\u003e val,\n                Err(error) =\u003e {\n                    error!(\"Failed to pick up a txn for api token storage: {error:?}\");\n                    return Err(Urls::SettingsApiTokens.redirect());\n                }\n            };\n\n            log::trace!(\"Starting to store token in the DB, saving...\");\n            match uat.save_with_txn(\u0026mut txn).await {\n                Err(error) =\u003e {\n                    error!(\"Failed to save api_token for user {:?}\", error);\n                    return Err(Urls::SettingsApiTokens.redirect());\n                }\n                Ok(_) =\u003e {\n                    // store the api token in the session store\n                    if let Err(error) = session\n                        .insert(\"new_api_token\", \u0026api_token.token_secret)\n                        .await\n                    {\n                        log::error!(\n                            \"Failed to store new API token in the session, ruh roh? {error:?}\"\n                        );\n                        txn.rollback().await.map_err(|e| {\n                            log::error!(\n                                \"Txn rollback fail after failing to store the token: {e:?}\"\n                            );\n                            Urls::SettingsApiTokens.redirect()\n                        })?;\n                        return Err(Urls::SettingsApiTokens.redirect());\n                    };\n\n                    if let Err(error) = session\n                        .insert(\"new_api_tokenkey\", \u0026api_token.token_key)\n                        .await\n                    {\n                        log::error!(\n                            \"Failed to store new API tokenkey in the session, ruh roh? {error:?}\"\n                        );\n                        txn.rollback().await.map_err(|e| {\n                            log::error!(\"Txn rollback fail: {e:?}\");\n                            Urls::SettingsApiTokens.redirect()\n                        })?;\n                        // TODO: bail, which should roll back the txn\n                        error!(\n                            \"Failed to store new API tokenkey in the session, ruh roh? {error:?}\"\n                        );\n                        return Err(Urls::SettingsApiTokens.redirect());\n                    };\n\n                    if let Err(error) = txn.commit().await {\n                        log::error!(\n                            \"Failed to save the API token to storage, oh no? {:?}\",\n                            error\n                        );\n                        return Err(Urls::SettingsApiTokens.redirect());\n                    };\n                }\n            };\n            // redirect the user to the display page\n            let csrftoken = store_api_csrf_token(\u0026mut session, Some(30))\n                .await\n                .map_err(|err| {\n                    error!(\"{:?}\", err);\n                    Urls::SettingsApiTokens.redirect()\n                })?;\n\n            return Err(Urls::SettingsApiTokens.redirect_with_query(HashMap::from([\n                (\"state\".to_string(), csrftoken),\n                (\"token_created\".to_string(), \"1\".to_string()),\n            ])));\n        }\n\n        ApiTokenCreatePageState::Finished =\u003e {\n            info!(\"Created token, redirecting to the homepage\");\n            return Err(Urls::SettingsApiTokens.redirect());\n        }\n        ApiTokenCreatePageState::Error =\u003e {\n            error!(\"Got an error state in the form, redirecting to the start\");\n            return Err(Urls::SettingsApiTokens.redirect());\n        }\n    };\n    Ok(context)\n\n    // Html::from(\"Welcome to the api tokens page\".to_string())\n}\n\n#[derive(Deserialize, Serialize, Debug, Clone, Template)]\n#[template(path = \"user_api_token_delete.html\")]\npub struct ApiTokenDeleteTemplate {\n    pub id: i64,\n    pub token_name: Option\u003cString\u003e,\n    pub csrftoken: String,\n    pub user_is_admin: bool,\n}\n#[derive(Deserialize, Serialize, Debug, Clone)]\npub struct ApiTokenDeleteForm {\n    pub id: i64,\n    pub token_name: Option\u003cString\u003e,\n    pub csrftoken: String,\n}\n\npub async fn api_tokens_delete_get(\n    axum::extract::State(state): axum::extract::State\u003cGoatState\u003e,\n    // Form(form): Form\u003cApiTokenPage\u003e,\n    Path(id): Path\u003cString\u003e,\n    mut session: Session,\n) -\u003e Result\u003cApiTokenDeleteTemplate, Redirect\u003e {\n    let user = check_logged_in(\n        \u0026mut session,\n        Uri::from_static(Urls::SettingsApiTokens.as_ref()),\n    )\n    .await?;\n\n    let csrftoken = match store_api_csrf_token(\u0026mut session, None).await {\n        Ok(val) =\u003e val,\n        Err(err) =\u003e {\n            log::error!(\"Failed to store CSRF token in the session store: {err:?}\");\n            return Err(Urls::SettingsApiTokens.redirect());\n        }\n    };\n\n    let id = match i64::from_str(\u0026id) {\n        Ok(val) =\u003e val,\n        Err(error) =\u003e {\n            log::debug!(\"Got an invalid id parsing the URL: {error:?}\");\n            return Err(Urls::Home.redirect());\n        }\n    };\n\n    let state_reader = state.read().await;\n    let pool = state_reader.connpool.clone();\n    let uat = match UserAuthToken::get(\u0026pool, id).await {\n        Err(err) =\u003e {\n            log::debug!(\"Requested delete for token: {err:?}\");\n            return Err(Urls::SettingsApiTokens.redirect());\n        }\n        Ok(res) =\u003e {\n            let user_id = match user.id {\n                Some(val) =\u003e val,\n                None =\u003e {\n                    log::debug!(\"Couldn't get user id from session store\");\n                    return Err(Urls::Dashboard.redirect());\n                }\n            };\n\n            if res.userid != user_id {\n                log::debug!(\n                    \"You can't delete another user's tokens! uid={} token.userid={}\",\n                    user_id,\n                    res.userid\n                );\n                return Err(Urls::SettingsApiTokens.redirect());\n            };\n\n            res\n        }\n    };\n\n    Ok(ApiTokenDeleteTemplate {\n        id,\n        token_name: Some(uat.name.clone()),\n        csrftoken,\n        user_is_admin: user.admin,\n    })\n}\n\npub async fn api_tokens_delete_post(\n    State(state): State\u003cGoatState\u003e,\n    mut session: Session,\n    OriginalUri(path): OriginalUri,\n    Form(form): Form\u003cApiTokenDeleteForm\u003e,\n) -\u003e Result\u003cHtml\u003cString\u003e, Redirect\u003e {\n    let user: User = check_logged_in(\u0026mut session, path).await?;\n\n    if !validate_csrf_expiry(\u0026form.csrftoken, \u0026mut session).await {\n        // TODO: redirect to the start\n        log::debug!(\"Failed to validate CSRF expiry\");\n        return Err(Urls::SettingsApiTokens.redirect());\n    }\n\n    log::debug!(\"Deleting token from Form: {form:?}\");\n\n    let pool = state.read().await.connpool.clone();\n\n    let user_id = match user.id {\n        Some(val) =\u003e val,\n        None =\u003e {\n            log::debug!(\"Couldn't get user id from session store\");\n            return Err(Urls::Dashboard.redirect());\n        }\n    };\n\n    let uat = match UserAuthToken::get(\u0026pool, form.id).await {\n        Err(err) =\u003e {\n            log::debug!(\"Requested delete for existing token: {err:?}\");\n            return Err(Urls::SettingsApiTokens.redirect());\n        }\n        Ok(res) =\u003e {\n            if res.userid != user_id {\n                log::debug!(\n                    \"You can't delete another user's tokens! uid={} token.userid={}\",\n                    user_id,\n                    res.userid\n                );\n                return Err(Urls::SettingsApiTokens.redirect());\n            };\n\n            res\n        }\n    };\n\n    if let Err(error) = uat.delete(\u0026pool).await {\n        log::debug!(\"Failed to delete token {:?}: {error:?}\", uat.id);\n    };\n\n    log::info!(\n        \"id={} action=api_token_delete token_id={}\",\n        uat.userid,\n        uat.id.unwrap_or(-1)\n    );\n    Err(Urls::SettingsApiTokens.redirect())\n}\n/// Build the router for user settings\npub fn router() -\u003e Router\u003cGoatState\u003e {\n    Router::new()\n        .route(\"/\", get(settings))\n        .route(\"/api_tokens\", get(api_tokens_get))\n        .route(\"/api_tokens\", post(api_tokens_post))\n        .route(\"/api_tokens/delete/:id\", get(api_tokens_delete_get))\n        .route(\"/api_tokens/delete/:id\", post(api_tokens_delete_post))\n}\n","traces":[{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":10}},{"line":642,"address":[],"length":0,"stats":{"Line":10}},{"line":643,"address":[],"length":0,"stats":{"Line":10}},{"line":644,"address":[],"length":0,"stats":{"Line":10}},{"line":645,"address":[],"length":0,"stats":{"Line":10}},{"line":646,"address":[],"length":0,"stats":{"Line":10}},{"line":647,"address":[],"length":0,"stats":{"Line":10}}],"covered":7,"coverable":275},{"path":["/","Users","yaleman","Projects","goatns","src","web","ui","zones.rs"],"content":"//! Zone-ui-things\n\nuse std::collections::HashMap;\n\nuse axum::extract::{OriginalUri, State};\nuse axum::response::Redirect;\nuse axum::Form;\nuse goat_lib::validators::dns_name;\nuse serde::Deserialize;\nuse tower_sessions::Session;\nuse tracing::debug;\n\nuse crate::datastore::Command;\nuse crate::db::User;\nuse crate::web::ui::check_logged_in;\nuse crate::web::utils::Urls;\nuse crate::web::GoatState;\nuse crate::zones::FileZone;\n\n#[derive(Deserialize, Debug)]\npub(crate) struct NewZoneForm {\n    name: String,\n}\n\npub(crate) async fn zones_new_post(\n    State(state): State\u003cGoatState\u003e,\n    mut session: Session,\n    OriginalUri(path): OriginalUri,\n    Form(form): Form\u003cNewZoneForm\u003e,\n) -\u003e Result\u003cRedirect, Redirect\u003e {\n    debug!(\"Received new zone form: name={:?}\", form.name);\n\n    let user: User = check_logged_in(\u0026mut session, path).await?;\n\n    let userid = match user.id {\n        Some(id) =\u003e id,\n        None =\u003e {\n            return Err(Urls::Home.redirect_with_query(HashMap::from([(\n                \"error\".to_string(),\n                \"No user ID found\".to_string(),\n            )])));\n        }\n    };\n\n    // validate the zone is valid\n    if form.name.is_empty() {\n        return Err(Urls::Home.redirect_with_query(HashMap::from([(\n            \"error\".to_string(),\n            \"Zone name cannot be empty!\".to_string(),\n        )])));\n    }\n    // Validate that form.name is a valid DNS entry\n    if !dns_name(\u0026form.name) {\n        return Err(Urls::Home.redirect_with_query(HashMap::from([(\n            \"error\".to_string(),\n            \"Invalid DNS name\".to_string(),\n        )])));\n    }\n\n    // check if the zone already exists\n    let (os_tx, os_rx) = tokio::sync::oneshot::channel();\n\n    log::debug!(\"Checking if {} exists\", form.name);\n\n    let getzonemsg = Command::GetZone {\n        id: None,\n        name: Some(form.name.clone()),\n        resp: os_tx,\n    };\n    if let Err(err) = state.read().await.tx.send(getzonemsg).await {\n        log::error!(\"Error sending message to datastore: {:?}\", err);\n        return Err(Urls::Home.redirect_with_query(HashMap::from([(\n            \"error\".to_string(),\n            \"Error checking if zone exists... please try again.\".to_string(),\n        )])));\n    };\n\n    match os_rx.await {\n        Ok(Some(_)) =\u003e {\n            log::debug!(\"Zone already exists: {:?}\", form.name);\n            return Err(Urls::Home.redirect_with_query(HashMap::from([(\n                \"error\".to_string(),\n                \"Zone already exists!\".to_string(),\n            )])));\n        }\n        Ok(None) =\u003e {\n            log::debug!(\"Zone {} doesn't exist, we can continue\", form.name);\n        }\n        Err(err) =\u003e {\n            log::error!(\"Error getting zone {}: {:?}\", form.name, err);\n            return Err(Urls::Home.redirect_with_query(HashMap::from([(\n                \"error\".to_string(),\n                \"Error checking if zone exists... please try again.\".to_string(),\n            )])));\n        }\n    };\n\n    if user.email.is_empty() {\n        return Err(Urls::Home.redirect_with_query(HashMap::from([(\n            \"error\".to_string(),\n            \"No email associate with your account, please update your profile!\".to_string(),\n        )])));\n    }\n\n    let zone = FileZone {\n        id: None,\n        name: form.name.clone(),\n        records: vec![],\n        rname: user.email.replace(\"@\", \".\"),\n        serial: 0,\n        refresh: Default::default(),\n        retry: Default::default(),\n        expire: Default::default(),\n        minimum: Default::default(),\n    };\n\n    let (os_tx, os_rx) = tokio::sync::oneshot::channel();\n    let msg = Command::CreateZone {\n        zone,\n        userid,\n        resp: os_tx,\n    };\n\n    if let Err(err) = state.read().await.tx.send(msg).await {\n        log::error!(\"Error sending message to datastore: {:?}\", err);\n        return Err(Urls::Home.redirect_with_query(HashMap::from([(\n            \"error\".to_string(),\n            \"Error creating zone!\".to_string(),\n        )])));\n    };\n\n    match os_rx.await {\n        Ok(zone) =\u003e {\n            log::info!(\"Zone {} created successfully\", form.name);\n            if let Some(id) = zone.id {\n                log::info!(\"Redirecting to /ui/zones/{}\", id);\n                Ok(Redirect::to(\u0026format!(\"/ui/zones/{}\", id)))\n            } else {\n                log::error!(\"Redirecting to /ui/zones because zone didn't have an ID?\");\n                Err(Urls::ZonesList.redirect())\n            }\n        }\n        Err(err) =\u003e {\n            log::error!(\"Error creating zone {}: {:?}\", form.name, err);\n            Err(Urls::Home.redirect_with_query(HashMap::from([(\n                \"error\".to_string(),\n                \"Error creating zone!\".to_string(),\n            )])))\n        }\n    }\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":63},{"path":["/","Users","yaleman","Projects","goatns","src","web","utils.rs"],"content":"use std::collections::HashMap;\n\nuse argon2::password_hash::SaltString;\nuse argon2::{Argon2, PasswordHasher, PasswordVerifier};\nuse axum::http::StatusCode;\nuse axum::response::Redirect;\nuse chrono::{DateTime, TimeDelta, Utc};\nuse rand::distributions::{Alphanumeric, DistString};\nuse rand_core::OsRng;\nuse sha2::{Digest, Sha256};\n\nuse crate::db::TokenSearchRow;\n\n/// URLs for the web interface\npub(crate) enum Urls {\n    /// Home page\n    Home,\n    /// Login page\n    Login,\n    /// User Dashboard\n    Dashboard,\n    /// List of zones\n    ZonesList,\n    /// Admin UI\n    Admin,\n    /// Settings page\n    Settings,\n    /// User settings, API tokens page\n    SettingsApiTokens,\n}\n\nimpl AsRef\u003cstr\u003e for Urls {\n    fn as_ref(\u0026self) -\u003e \u0026str {\n        match self {\n            Urls::Home =\u003e \"/\",\n            Urls::Login =\u003e \"/auth/login\",\n            Urls::Admin =\u003e \"/ui/admin\",\n            Urls::Dashboard =\u003e \"/ui\",\n            Urls::ZonesList =\u003e \"/ui/zones/list\",\n            Urls::Settings =\u003e \"/ui/settings\",\n            Urls::SettingsApiTokens =\u003e \"/ui/settings/api_tokens\",\n        }\n    }\n}\n\nimpl Urls {\n    /// Get the URL for the given enum\n    pub fn redirect(\u0026self) -\u003e Redirect {\n        Redirect::to(self.as_ref())\n    }\n\n    /// Redirect to a url with query params\n    pub fn redirect_with_query(\u0026self, query: HashMap\u003cimpl ToString, impl ToString\u003e) -\u003e Redirect {\n        if query.is_empty() {\n            return self.redirect();\n        }\n        let queryparts: String = query\n            .into_iter()\n            .map(|(key, value)| format!(\"{}={}\", key.to_string(), value.to_string()))\n            .collect::\u003cVec\u003cString\u003e\u003e()\n            .join(\"\u0026\");\n        let url = format!(\"{}?{}\", self.as_ref(), queryparts);\n        Redirect::to(\u0026url)\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct ApiToken {\n    /// The username\n    pub token_key: String,\n    /// The password\n    pub token_secret: String,\n    /// This goes into the database\n    pub token_hash: String,\n    /// Guess?\n    pub issued: DateTime\u003cUtc\u003e,\n    /// For a time or forever!\n    pub expiry: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n/// Create an API token\npub fn create_api_token(api_cookie_secret: \u0026[u8], lifetime: i32, userid: i64) -\u003e ApiToken {\n    let issued = Utc::now();\n    let expiry = match lifetime {\n        -1 =\u003e None,\n        _ =\u003e Some(issued + TimeDelta::seconds(lifetime.into())),\n    };\n    let api_token_to_hash = format!(\"{api_cookie_secret:?}-{userid:?}-{issued:?}-{lifetime:?}-\");\n\n    let api_token = hex::encode(Sha256::digest(api_token_to_hash));\n    let token_secret = format!(\"goatns_{api_token}\");\n    log::trace!(\"Final token: {token_secret}\");\n\n    // TODO: is rand_core the thing we want to use for generating randomness?\n    let salt = SaltString::generate(\u0026mut OsRng);\n\n    log::debug!(\"generating hash\");\n    // Argon2 with default params (Argon2id v19)\n    let argon2 = Argon2::default();\n    #[allow(clippy::expect_used)]\n    let password_hash = argon2\n        .hash_password(token_secret.as_bytes(), \u0026salt)\n        .expect(\"Failed to hash password!\");\n\n    let password_hash_string = password_hash.to_string();\n    log::debug!(\"Done hashing password\");\n\n    let token_key = Alphanumeric.sample_string(\u0026mut rand::thread_rng(), 12);\n    let token_key = format!(\"GA{}\", token_key);\n    ApiToken {\n        token_key,\n        token_secret,\n        token_hash: password_hash_string,\n        issued,\n        expiry,\n    }\n}\n\n/// validate an API token matches our thingamajig\npub fn validate_api_token(token: \u0026TokenSearchRow, payload_token: \u0026str) -\u003e Result\u003c(), String\u003e {\n    let passwordhash =\n        match argon2::PasswordHash::parse(\u0026token.tokenhash, argon2::password_hash::Encoding::B64) {\n            Ok(val) =\u003e {\n                #[cfg(test)]\n                println!(\"Hashed payload: {val:?}\");\n                val\n            }\n            Err(err) =\u003e {\n                return Err(format!(\n                    \"Failed to parse token ({:?}) into hash: {err:?}\",\n                    token.tokenhash\n                ));\n            }\n        };\n    Argon2::default()\n        .verify_password(payload_token.as_bytes(), \u0026passwordhash)\n        .map_err(|e| format!(\"validation error: {e:?}\"))\n}\n\npub async fn handler_404() -\u003e (StatusCode, \u0026'static str) {\n    (StatusCode::NOT_FOUND, \"\u003ch1\u003eOh no!\u003c/h1\u003e\u003cp\u003eYou've found a 404, try \u003ca href='#' onclick='history.back();'\u003egoing back\u003c/a\u003e or \u003ca href='/'\u003ehome!\u003c/a\u003e\u003c/p\u003e\")\n}\n","traces":[{"line":33,"address":[],"length":0,"stats":{"Line":22}},{"line":34,"address":[],"length":0,"stats":{"Line":22}},{"line":35,"address":[],"length":0,"stats":{"Line":10}},{"line":36,"address":[],"length":0,"stats":{"Line":12}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":5}},{"line":83,"address":[],"length":0,"stats":{"Line":5}},{"line":84,"address":[],"length":0,"stats":{"Line":10}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":5}},{"line":88,"address":[],"length":0,"stats":{"Line":5}},{"line":90,"address":[],"length":0,"stats":{"Line":5}},{"line":91,"address":[],"length":0,"stats":{"Line":5}},{"line":92,"address":[],"length":0,"stats":{"Line":5}},{"line":95,"address":[],"length":0,"stats":{"Line":5}},{"line":97,"address":[],"length":0,"stats":{"Line":5}},{"line":99,"address":[],"length":0,"stats":{"Line":5}},{"line":101,"address":[],"length":0,"stats":{"Line":5}},{"line":102,"address":[],"length":0,"stats":{"Line":5}},{"line":105,"address":[],"length":0,"stats":{"Line":5}},{"line":106,"address":[],"length":0,"stats":{"Line":5}},{"line":108,"address":[],"length":0,"stats":{"Line":5}},{"line":109,"address":[],"length":0,"stats":{"Line":5}},{"line":120,"address":[],"length":0,"stats":{"Line":5}},{"line":121,"address":[],"length":0,"stats":{"Line":5}},{"line":122,"address":[],"length":0,"stats":{"Line":5}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}}],"covered":24,"coverable":44},{"path":["/","Users","yaleman","Projects","goatns","src","zones.rs"],"content":"use crate::enums::RecordClass;\nuse crate::error::GoatNsError;\nuse crate::resourcerecord::InternalResourceRecord;\nuse log::*;\n\nuse serde::{Deserialize, Serialize};\nuse sqlx::SqliteConnection;\nuse std::fmt::Display;\nuse std::fs::File;\nuse std::io::Read;\nuse std::path::Path;\nuse std::str::from_utf8;\nuse utoipa::ToSchema;\n\n/// A DNS Zone\n#[derive(Clone, Debug, Default, Deserialize, Serialize, Eq, PartialEq)]\n#[serde(rename(serialize = \"UPPERCASE\"))]\npub struct FileZone {\n    /// Database row ID\n    pub id: Option\u003ci64\u003e,\n    /// MNAME The `domain-name` of the name server that was the original or primary source of data for this zone.\n    // #[serde(rename(serialize = \"MNAME\"))]\n    pub name: String,\n    /// RNAME A `domain-name` which specifies the mailbox of the person responsible for this zone.\n    // #[serde(rename(serialize = \"RNAME\"), default = \"rname_default\")]\n    #[serde(default = \"rname_default\")]\n    pub rname: String,\n    /// SERIAL - The unsigned 32 bit version number of the original copy of the zone.  Zone transfers preserve this value.  This value wraps and should be compared using sequence space arithmetic.\n    #[serde(default)]\n    pub serial: u32,\n    /// REFRESH - A 32 bit time interval before the zone should be refreshed.\n    #[serde(default)]\n    pub refresh: u32,\n    /// RETRY - A 32 bit time interval that should elapse before a failed refresh should be retried.\n    #[serde(default)]\n    pub retry: u32,\n    ///  EXPIRE - A 32 bit time value that specifies the upper limit on the time interval that can elapse before the zone is no longer authoritative.\n    #[serde(default)]\n    pub expire: u32,\n    /// MINIMUM - The unsigned 32 bit minimum TTL field that should be exported with any RR from this zone.\n    #[serde(default)]\n    pub minimum: u32,\n    /// The records associated with this zone\n    pub records: Vec\u003cFileZoneRecord\u003e,\n}\n\nimpl FileZone {\n    /// Checks if they're equal, ignores the zone id and records\n    pub fn matching_data(\u0026self, cmp: \u0026FileZone) -\u003e bool {\n        self.expire == cmp.expire\n            \u0026\u0026 self.minimum == cmp.minimum\n            \u0026\u0026 self.name == cmp.name\n            \u0026\u0026 self.refresh == cmp.refresh\n            \u0026\u0026 self.retry == cmp.retry\n            \u0026\u0026 self.rname == cmp.rname\n            \u0026\u0026 self.serial == cmp.serial\n    }\n}\n/// default RNAME value for FileZone\npub fn rname_default() -\u003e String {\n    String::from(\"barry.dot.goat\")\n}\n\n/// A DNS Record from the JSON file\n#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Clone, ToSchema)]\npub struct FileZoneRecord {\n    /// Database row ID\n    #[serde(default)]\n    pub id: Option\u003ci64\u003e,\n    /// Foreign key to id in [FileZone::id]\n    pub zoneid: Option\u003ci64\u003e,\n    #[serde(default = \"default_record_name\")]\n    /// The name of the record\n    pub name: String,\n    /// The type of record\n    pub rrtype: String,\n    #[serde(default = \"default_record_class\")]\n    /// The class of the record\n    pub class: RecordClass,\n    /// The actual data for the record\n    pub rdata: String,\n    /// Time to live\n    pub ttl: u32,\n}\n/// If you don't specify a name, it's the root.\nfn default_record_name() -\u003e String {\n    String::from(\"@\")\n}\n/// Sets a default of IN because well, what else would you use?\nfn default_record_class() -\u003e RecordClass {\n    RecordClass::Internet\n}\n\nimpl Display for FileZoneRecord {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        f.write_fmt(format_args!(\n            \"FileZoneRecord {{ name={} class={} rrtype={}, ttl={}, zoneid={:#?}, id={:#?}, rdata={} }}\",\n            self.name, self.class, self.rrtype, self.ttl, self.zoneid, self.id, self.rdata\n        ))\n    }\n}\n\n#[derive(Debug, PartialEq, Eq, Clone)]\n/// A list of records associated with a given name - ie `foo.example.com -\u003e [A { 1.2.3.4}, AAAA { 2000:cafe:beef }` etc\npub struct ZoneRecord {\n    /// the full name including the zone\n    pub name: Vec\u003cu8\u003e,\n    /// the records associated with this name\n    pub typerecords: Vec\u003cInternalResourceRecord\u003e,\n}\n\nimpl Display for ZoneRecord {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        f.write_fmt(format_args!(\n            \"Name: {:?} Name Bytes: {:?} Records: {:?}\",\n            from_utf8(\u0026self.name),\n            \u0026self.name,\n            self.typerecords,\n        ))\n    }\n}\n\n/// Loads a zone file\npub fn load_zone_from_file(filename: \u0026Path) -\u003e Result\u003cFileZone, GoatNsError\u003e {\n    let mut file = match File::open(filename) {\n        Ok(value) =\u003e value,\n        Err(error) =\u003e {\n            return Err(GoatNsError::FileError(format!(\n                \"Failed to open zone file: {:?}\",\n                error\n            )));\n        }\n    };\n    let mut buf: String = String::new();\n    file.read_to_string(\u0026mut buf)\n        .inspect_err(|err| error!(\"Failed to read {}: {:?}\", \u0026filename.display(), err))?;\n    let jsonstruct: FileZone = match json5::from_str(\u0026buf) {\n        Ok(value) =\u003e value,\n        Err(error) =\u003e {\n            let emsg = format!(\"Failed to read JSON file: {:?}\", error);\n            error!(\"{}\", emsg);\n            return Err(GoatNsError::FileError(emsg));\n        }\n    };\n    Ok(jsonstruct)\n}\n\n/// Loads a zone file\npub fn load_zones(filename: \u0026str) -\u003e Result\u003cVec\u003cFileZone\u003e, GoatNsError\u003e {\n    let mut file = match File::open(filename) {\n        Ok(value) =\u003e value,\n        Err(error) =\u003e {\n            return Err(GoatNsError::FileError(format!(\n                \"Failed to open zone file: {:?}\",\n                error\n            )));\n        }\n    };\n\n    let mut buf: String = String::new();\n    file.read_to_string(\u0026mut buf)\n        .inspect_err(|err| error!(\"Failed to read {}: {:?}\", filename, err))?;\n    let jsonstruct: Result\u003cVec\u003cFileZone\u003e, GoatNsError\u003e = json5::from_str(\u0026buf)\n        .map_err(|e| GoatNsError::FileError(format!(\"Failed to read JSON file: {e:?}\")));\n    jsonstruct\n}\n\nimpl FileZone {\n    pub(crate) async fn get_unowned(\n        pool: \u0026mut SqliteConnection,\n    ) -\u003e Result\u003cVec\u003cFileZone\u003e, GoatNsError\u003e {\n        let rows = sqlx::query(\n            \"select * from zones where id not in (select DISTINCT zoneid from ownership)\",\n        )\n        .fetch_all(\u0026mut *pool)\n        .await?\n        .into_iter()\n        .map(|row| row.into())\n        .collect();\n        Ok(rows)\n    }\n}\n","traces":[{"line":49,"address":[],"length":0,"stats":{"Line":2}},{"line":50,"address":[],"length":0,"stats":{"Line":2}},{"line":51,"address":[],"length":0,"stats":{"Line":2}},{"line":52,"address":[],"length":0,"stats":{"Line":2}},{"line":53,"address":[],"length":0,"stats":{"Line":2}},{"line":54,"address":[],"length":0,"stats":{"Line":2}},{"line":55,"address":[],"length":0,"stats":{"Line":2}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":20}},{"line":87,"address":[],"length":0,"stats":{"Line":20}},{"line":90,"address":[],"length":0,"stats":{"Line":77}},{"line":91,"address":[],"length":0,"stats":{"Line":77}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":1}},{"line":125,"address":[],"length":0,"stats":{"Line":2}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":2}},{"line":138,"address":[],"length":0,"stats":{"Line":1}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":1}},{"line":149,"address":[],"length":0,"stats":{"Line":3}},{"line":150,"address":[],"length":0,"stats":{"Line":6}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":3}},{"line":164,"address":[],"length":0,"stats":{"Line":6}},{"line":165,"address":[],"length":0,"stats":{"Line":3}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}}],"covered":21,"coverable":53}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>